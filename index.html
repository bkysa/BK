<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ìˆ¨ì‰¬ëŠ” ê¹¡í†µ</title>
    
    <!-- ğŸŒŸ í™ˆ í™”ë©´ ì•„ì´ì½˜ ì„¤ì • (BK ë¡œê³ ) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%230f172a'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-size='250' font-family='sans-serif' font-weight='bold' dy='.1em'%3EBK%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%230f172a'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-size='250' font-family='sans-serif' font-weight='bold' dy='.1em'%3EBK%3C/text%3E%3C/svg%3E">

    <!-- 1. Tailwind CSS (Design) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Fonts (Pretendard) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        /* ê¸°ë³¸ í°íŠ¸ ë° ìŠ¤í¬ë¡¤ ë™ì‘ ìµœì í™” */
        body { 
            font-family: 'Pretendard', sans-serif; 
            overscroll-behavior: none; /* ëª¨ë°”ì¼ì—ì„œ ë‹¹ê²¨ì„œ ìƒˆë¡œê³ ì¹¨ ë“± ë°©ì§€ */
        }
        
        /* ì „ì²´ í™”ë©´ ê³ ì • (ë©”ë‰´ ê³ ì •, ë‚´ë¶€ ìŠ¤í¬ë¡¤ì„ ìœ„í•¨) */
        html, body, #root {
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ ì²˜ë¦¬ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ëª¨ë°”ì¼ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ (ê´€ì„± ìŠ¤í¬ë¡¤) */
        .scroll-touch {
            -webkit-overflow-scrolling: touch;
        }

        /* Animation */
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Loading Spinner Animation */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ì•„ì´í° í•˜ë‹¨ ì•ˆì „ ì˜ì—­ ëŒ€ì‘ */
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>

    <!-- 3. Import Map (ìŠ¤í† ë¦¬ì§€ ì¶”ê°€ë¨) -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.330.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
            "firebase/storage": "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js"
        }
    }
    </script>

    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createPortal } from 'react-dom';
        import { createRoot } from 'react-dom/client';
        import {
            LayoutDashboard, Plus, FileText, Calendar as CalendarIcon,
            Package, ChevronRight, ChevronLeft, Trash2, Edit3, Download,
            ChevronDown, ChevronUp, Wifi, ArrowRight, Phone, MapPin, Bell, X, Truck, 
            Search, AlertCircle, Sparkles, Paperclip, File, Lock, Key, User, HardHat, 
            MinusCircle, Save, CheckCircle, Navigation, History, ShieldAlert, UploadCloud, Users, Boxes, Settings
        } from 'lucide-react';

        // --- Firebase Imports ---
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import {
            getFirestore, collection, addDoc, updateDoc, deleteDoc, setDoc,
            doc, onSnapshot, query, orderBy, serverTimestamp, limit, where
        } from 'firebase/firestore';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'firebase/storage';

        // ---------------------------------------------------------
        // âœ… Firebase Config
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyB5W8qJbYMNyzPu8jmbAifCBH9qgZsQOJA",
            authDomain: "bk-manager-784a5.firebaseapp.com",
            projectId: "bk-manager-784a5",
            storageBucket: "bk-manager-784a5.firebasestorage.app",
            messagingSenderId: "16230700058",
            appId: "1:16230700058:web:833a3d16f54cdd73d2ada3",
            measurementId: "G-PMGKK5F8CP"
        };

        // --- Constants & Mock Data ---
        const COMPANY_INFO = {
            name: 'ìˆ¨ì‰¬ëŠ” ê¹¡í†µ',
            address: 'ê²½ê¸°ë„ í¬ì²œì‹œ êµ°ë‚´ë©´ ìœ êµë¦¬ 243-7',
            lat: 37.885, 
            lng: 127.205, 
            mapUrl: 'https://map.naver.com/p/search/ê²½ê¸°ë„ í¬ì²œì‹œ êµ°ë‚´ë©´ ìœ êµë¦¬ 243-7'
        };

        const BASE_SUPPLIER_INFO = {
            'ì„±ìˆ˜ê¸ˆì†': { phone: '02-1234-5678', email: 'order@sungsu.com', address: 'ì„œìš¸ ì„±ë™êµ¬ ì„±ìˆ˜ì´ë¡œ 123', lat: 37.5445, lng: 127.0560 },
            'ì„ì§€ë ˆì´ì €': { phone: '02-2222-3333', email: 'laser@eulji.net', address: 'ì„œìš¸ ì¤‘êµ¬ ì„ì§€ë¡œ 4ê°€ 56', lat: 37.5660, lng: 126.9950 },
            'ì²­ê³„ë„ì¥': { phone: '02-3333-4444', email: 'paint@chunggye.com', address: 'ì„œìš¸ ì¤‘êµ¬ ì²­ê³„ì²œë¡œ 789', lat: 37.5690, lng: 127.0100 },
            'íƒœì–‘ë³¼íŠ¸': { phone: '02-5555-6666', email: 'bolt@sun.com', address: 'ì„œìš¸ êµ¬ë¡œêµ¬ êµ¬ë¡œë™ 11', lat: 37.4850, lng: 126.8850 },
            'ëŒ€í•œì•„í¬ë¦´': { phone: '02-7777-8888', email: 'acryl@daehan.com', address: 'ì„œìš¸ ì¤‘êµ¬ ë°©ì‚°ì‹œì¥ Aë™', lat: 37.5670, lng: 127.0000 }
        };

        // ğŸŒŸ ê¸°ë³¸ ì‘ì—…ì ëª©ë¡ (DB ì—†ì„ ì‹œ ì´ˆê¸°ê°’)
        const DEFAULT_WORKERS = ['ì •ëŒ€ì¢…', 'ì¡°ìœ¤ì„', 'ì´íƒœì˜', 'ìœ ì‹œì•ˆ', 'ìœ¤ì§„í›„', 'ê¹€ì •íƒœ', 'ê¹€í•œì†”'];

        const MOCK_DATA = [
            {
                id: 'mock-1',
                displayId: 'ORD-24-101',
                itemName: 'í…ŒìŠ¤íŠ¸ ì‘ì—… (ì„œë²„ ì—°ê²° í•„ìš”)',
                clientName: 'í…ŒìŠ¤íŠ¸ ì—…ì²´',
                status: 'ì‘ì—…ì¤‘',
                deliveryDate: new Date().toISOString().split('T')[0],
                completedDate: '', 
                description: 'ì„œë²„ì— ì—°ê²°ë˜ë©´ ì‹¤ì œ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤.',
                materials: []
            }
        ]; 

        // --- Helper Functions ---
        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        };

        const getMockCoordinates = (address) => {
            return { lat: 37.54 + (Math.random() * 0.05), lng: 127.05 + (Math.random() * 0.05) };
        };

        const formatTime = (timestamp) => {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        };

        // --- Helper Components ---
        
        const ModalOverlay = ({ children, onClose }) => {
            return createPortal(
                <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/50 animate-fade-in" onClick={onClose}>
                    {children}
                </div>,
                document.body
            );
        };

        const StatusBadge = ({ status, onClick }) => {
            const colors = {
                'ì„¤ê³„ì¤‘': 'bg-gray-100 text-gray-600 border border-gray-300',
                'ìì¬ë°œì£¼ì¤‘': 'bg-yellow-100 text-yellow-700 border border-yellow-200', // ğŸŒŸ ìì¬ë°œì£¼ì¤‘ ì¶”ê°€
                'ì‘ì—…ì¤‘': 'bg-blue-100 text-blue-700 border border-blue-200',
                'ì‘ì—…ì™„ë£Œ': 'bg-green-100 text-green-700 border border-green-200 font-bold',
                'ë„ì¥/ë§ˆê°ì¤‘': 'bg-purple-100 text-purple-700 border border-purple-200',
                'ë‚©í’ˆëŒ€ê¸°': 'bg-teal-100 text-teal-700 border border-teal-200 font-bold animate-pulse',
                'ë‚©í’ˆì™„ë£Œ': 'bg-slate-200 text-slate-500 line-through border border-slate-300',
                'ëŒ€ê¸°': 'bg-gray-100 text-gray-600',
            };
            
            return (
                <span 
                    onClick={(e) => {
                        if (onClick) {
                            e.stopPropagation();
                            onClick();
                        }
                    }}
                    className={`flex-shrink-0 px-2 py-1 rounded-full text-xs font-bold whitespace-nowrap ${colors[status] || 'bg-gray-100'} ${onClick ? 'cursor-pointer hover:opacity-80 hover:scale-105 transition-transform' : ''}`}
                >
                    {status}
                </span>
            );
        };

        const MaterialStatusBadge = ({ status, onClick }) => {
            const colors = {
                'ë°œì£¼': 'bg-yellow-100 text-yellow-700',
                'ì ‘ìˆ˜': 'bg-orange-100 text-orange-700',
                'ë°°ì°¨': 'bg-cyan-100 text-cyan-700 font-bold', 
                'íšŒìˆ˜ëŒ€ê¸°': 'bg-red-100 text-red-700 font-bold animate-pulse cursor-pointer',
                'íšŒìˆ˜ì™„ë£Œ': 'bg-gray-200 text-gray-500',
                'ì •ë³´': 'bg-slate-100 text-slate-500 border border-slate-200', 
            };
            return (
                <span 
                    onClick={onClick}
                    className={`flex-shrink-0 px-2 py-0.5 rounded text-[11px] whitespace-nowrap select-none ${colors[status] || 'bg-gray-100'} ${onClick && status !== 'ì •ë³´' ? 'cursor-pointer hover:opacity-80 ring-1 ring-transparent hover:ring-current' : ''}`}
                >
                    {status}
                </span>
            );
        };

        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>{children}</div>
        );

        const FileBox = ({size}) => <Package size={size}/>;

        // --- Login Gate Component ---
        const LoginView = ({ onLogin }) => {
            const [code, setCode] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (code === '4545') {
                    onLogin('employee');
                } else if (code === '2203') {
                    onLogin('admin');
                } else {
                    setError('ì¸ì¦ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <Card className="w-full max-w-md p-8 space-y-6 shadow-xl">
                        <div className="text-center space-y-2">
                            <div className="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Lock className="text-indigo-600" size={32} />
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800">ìˆ¨ì‰¬ëŠ” ê¹¡í†µ</h1>
                            <p className="text-slate-500">íšŒì‚¬ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <input 
                                    type="password" 
                                    value={code}
                                    onChange={(e) => {setCode(e.target.value); setError('');}}
                                    placeholder="ì¸ì¦ ì½”ë“œ ì…ë ¥ (4ìë¦¬)"
                                    className="w-full text-center text-2xl tracking-widest p-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all"
                                    maxLength={4}
                                    autoFocus
                                />
                                {error && <p className="text-red-500 text-sm text-center mt-2 font-bold animate-pulse">{error}</p>}
                            </div>
                            <button 
                                type="submit"
                                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2"
                            >
                                <Key size={20}/> ì…ì¥í•˜ê¸°
                            </button>
                        </form>
                    </Card>
                </div>
            );
        };

        // --- Components ---

        const Dashboard = ({ orders, stats, suppliers, onNavigate, onStatusClick }) => {
            const [activeStat, setActiveStat] = useState(null);
            const [activeRoutePopup, setActiveRoutePopup] = useState(null);

            // ë™ì„  ìµœì í™” ë¡œì§
            const optimizedRoute = useMemo(() => {
                const pickupTargets = Object.keys(suppliers).filter(name => 
                    suppliers[name].some(m => ['íšŒìˆ˜ëŒ€ê¸°', 'ì ‘ìˆ˜'].includes(m.status))
                );

                if (pickupTargets.length === 0) return [];

                let currentLoc = { lat: COMPANY_INFO.lat, lng: COMPANY_INFO.lng, name: 'start' };
                
                let unvisited = pickupTargets.map(name => {
                    const materials = suppliers[name];
                    const customInfo = materials[0]?.supplierInfo || {};
                    const baseInfo = BASE_SUPPLIER_INFO[name] || {};
                    
                    const lat = customInfo.lat || baseInfo.lat || 37.55; 
                    const lng = customInfo.lng || baseInfo.lng || 127.0;
                    const address = customInfo.address || baseInfo.address || 'ì£¼ì†Œ ë¯¸ìƒ';

                    return {
                        name,
                        lat,
                        lng,
                        address,
                        count: materials.filter(m => ['íšŒìˆ˜ëŒ€ê¸°', 'ì ‘ìˆ˜'].includes(m.status)).length
                    };
                });

                const route = [];
                while (unvisited.length > 0) {
                    let nearest = null;
                    let minDist = Infinity;
                    let nearestIdx = -1;
                    unvisited.forEach((node, idx) => {
                        const dist = getDistance(currentLoc.lat, currentLoc.lng, node.lat, node.lng);
                        if (dist < minDist) {
                            minDist = dist;
                            nearest = node;
                            nearestIdx = idx;
                        }
                    });
                    if (nearest) {
                        route.push(nearest);
                        currentLoc = nearest; 
                        unvisited.splice(nearestIdx, 1);
                    } else {
                        break;
                    }
                }
                return route;
            }, [suppliers]);

            const statList = useMemo(() => {
                if (!activeStat) return [];
                if (activeStat === 'pickup') {
                    const list = [];
                    orders.forEach(o => (o.materials || []).forEach(m => {
                        if (m.status === 'íšŒìˆ˜ëŒ€ê¸°') {
                            list.push({ ...m, orderName: o.itemName, orderId: o.id, type: 'material' });
                        }
                    }));
                    return list;
                }
                
                const priority = {
                    'ì‘ì—…ì¤‘': 1,
                    'ì‘ì—…ì™„ë£Œ': 2,
                    'ë„ì¥/ë§ˆê°ì¤‘': 3,
                    'ë‚©í’ˆëŒ€ê¸°': 4,
                    'ìì¬ë°œì£¼ì¤‘': 5, // ğŸŒŸ ìš°ì„ ìˆœìœ„ ì¶”ê°€
                    'ì„¤ê³„ì¤‘': 6
                };

                return orders
                    .filter(o => {
                        if (activeStat === 'ongoing') {
                            return !['ë‚©í’ˆì™„ë£Œ'].includes(o.status) && o.itemName !== 'ê¸°íƒ€ ìì¬ ë°œì£¼';
                        }
                        if (activeStat === 'urgent') {
                            if (!o.deliveryDate || ['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(o.status)) return false;
                            return Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2;
                        }
                        if (activeStat === 'pendingDelivery') {
                            return o.status === 'ë‚©í’ˆëŒ€ê¸°';
                        }
                        return false;
                    })
                    .sort((a, b) => {
                        if (activeStat === 'ongoing') {
                            const pa = priority[a.status] || 99;
                            const pb = priority[b.status] || 99;
                            return pa - pb;
                        }
                        return 0;
                    });
            }, [activeStat, orders]);

            return (
                <>
                    <div className="space-y-6 animate-fade-in pb-10 relative">
                        {/* Stats Grid */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <Card className="p-4 border-l-4 border-blue-600 cursor-pointer hover:bg-blue-50" onClick={()=>setActiveStat('ongoing')}>
                                <div className="text-xs text-gray-500">ì§„í–‰ ì¤‘</div>
                                <div className="text-2xl font-bold">{stats.ongoing}ê±´</div>
                            </Card>
                            <Card className="p-4 border-l-4 border-indigo-500 cursor-pointer hover:bg-indigo-50" onClick={()=>setActiveStat('pickup')}>
                                <div className="text-xs text-gray-500">íšŒìˆ˜ ëŒ€ê¸°</div>
                                <div className="text-2xl font-bold text-indigo-600 animate-pulse">{stats.pickup}ê±´</div>
                            </Card>
                            <Card className="p-4 border-l-4 border-red-500 cursor-pointer hover:bg-red-50" onClick={()=>setActiveStat('urgent')}>
                                <div className="text-xs text-gray-500">ë§ˆê° ì„ë°•</div>
                                <div className="text-2xl font-bold text-red-600">{stats.urgent}ê±´</div>
                            </Card>
                            <Card className="p-4 border-l-4 border-teal-500 cursor-pointer hover:bg-teal-50" onClick={()=>setActiveStat('pendingDelivery')}>
                                <div className="text-xs text-gray-500">ë‚©í’ˆ ëŒ€ê¸°</div>
                                <div className="text-2xl font-bold text-teal-600">{stats.pendingDelivery}ê±´</div>
                            </Card>
                        </div>

                        <div>
                            <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2"><FileText size={18}/> ìµœì‹  ì‘ì—…</h3>
                            <div className="grid gap-3">
                            {orders.filter(o => !['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(o.status) && o.itemName !== 'ê¸°íƒ€ ìì¬ ë°œì£¼').slice(0, 3).map(o => (
                                <Card key={o.id} className="p-4 flex justify-between items-center hover:border-blue-400">
                                    <div className="flex-1 cursor-pointer" onClick={() => onNavigate(o)}>
                                        <div className="flex items-center gap-2 mb-1">
                                            <StatusBadge status={o.status} onClick={() => onStatusClick(o)} />
                                            <span className="text-xs text-gray-400">{o.displayId}</span>
                                        </div>
                                        <div className="font-bold">{o.itemName}</div>
                                    </div>
                                    <div className="text-sm font-bold text-red-500">{o.deliveryDate} ë§ˆê°</div>
                                </Card>
                            ))}
                            </div>
                        </div>

                        <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-5">
                            <div className="flex items-center gap-2 text-indigo-900 font-bold mb-3"><Truck size={20} /><h3>ìµœì  íšŒìˆ˜ ë™ì„ </h3></div>
                            {optimizedRoute.length > 0 ? (
                            <div className="flex flex-wrap gap-2 items-center">
                                <span className="text-xs bg-white px-2 py-1 rounded border">ì¶œë°œ</span>
                                {optimizedRoute.map((stop, i) => (
                                    <React.Fragment key={i}>
                                        <ArrowRight size={14} className="text-indigo-300" />
                                        <button onClick={() => setActiveRoutePopup(stop)} className="bg-indigo-600 text-white px-3 py-2 rounded shadow text-sm font-bold hover:bg-indigo-700">
                                            {i+1}. {stop.name} <span className="bg-white/20 px-1 rounded text-[10px] ml-1">{stop.count}</span>
                                        </button>
                                    </React.Fragment>
                                ))}
                                <ArrowRight size={14} className="text-indigo-300" />
                                <span className="text-xs bg-white px-2 py-1 rounded border">ë³µê·€</span>
                            </div>
                            ) : <div className="text-sm text-indigo-400">íšŒìˆ˜í•  ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
                        </div>
                    </div>
                    
                    {/* Stat Modal */}
                    {activeStat && (
                        <ModalOverlay onClose={()=>setActiveStat(null)}>
                            <div className="bg-white w-full max-w-md rounded-xl shadow-2xl p-4 max-h-[80vh] overflow-y-auto scroll-touch" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between mb-4">
                                    <h3 className="font-bold text-lg">ìƒì„¸ ë‚´ì—­ ({statList.length})</h3>
                                    <button onClick={()=>setActiveStat(null)}><X size={20}/></button>
                                </div>
                                <div className="space-y-2">
                                    {statList.length === 0 && <div className="text-gray-400">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                                    {statList.map((item, i) => (
                                        <div key={i} className="border p-3 rounded hover:bg-slate-50 flex justify-between items-center" >
                                            <div className="cursor-pointer flex-1" onClick={()=>{
                                                const order = activeStat === 'pickup' ? orders.find(o=>o.id===item.orderId) : item;
                                                if(order) { onNavigate(order); setActiveStat(null); }
                                            }}>
                                                <div className="font-bold">{activeStat==='pickup' ? item.item : item.itemName}</div>
                                                <div className="text-xs text-gray-500">{activeStat==='pickup' ? `${item.supplier} - ${item.quantity}` : item.status}</div>
                                            </div>
                                            {activeStat !== 'pickup' && (
                                                <StatusBadge status={item.status} onClick={() => { onStatusClick(item); setActiveStat(null); }} />
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </ModalOverlay>
                    )}
                    
                    {/* Route Modal */}
                    {activeRoutePopup && (
                        <ModalOverlay onClose={()=>setActiveRoutePopup(null)}>
                            <div className="bg-white w-full max-w-sm rounded-xl p-4" onClick={e=>e.stopPropagation()}>
                                <h3 className="font-bold text-lg mb-2">{activeRoutePopup.name}</h3>
                                <div className="text-sm text-gray-500 mb-4">{activeRoutePopup.address}</div>
                                <div className="space-y-2 mb-4">
                                    {(suppliers[activeRoutePopup.name] || []).filter(m=>['íšŒìˆ˜ëŒ€ê¸°', 'ì ‘ìˆ˜'].includes(m.status)).map((item, i)=>(
                                        <div key={i} className="bg-slate-50 p-2 rounded text-sm flex justify-between items-center">
                                            <div className="flex items-center gap-2">
                                                <span className={`text-[10px] px-1.5 py-0.5 rounded text-white ${item.status === 'ì ‘ìˆ˜' ? 'bg-orange-500' : 'bg-indigo-500'}`}>{item.status}</span>
                                                <span>{item.item}</span>
                                            </div>
                                            <span className="font-bold">{item.quantity}</span>
                                        </div>
                                    ))}
                                </div>
                                <a href={`https://map.naver.com/p/search/${activeRoutePopup.address}`} target="_blank" className="w-full bg-[#03C75A] text-white flex items-center justify-center gap-2 py-3 rounded font-bold mb-2 hover:opacity-90">
                                    <Navigation size={18}/> ë„¤ì´ë²„ ì§€ë„ ë³´ê¸°
                                </a>
                                <button onClick={()=>setActiveRoutePopup(null)} className="w-full bg-slate-100 text-slate-600 py-3 rounded font-bold">ë‹«ê¸°</button>
                            </div>
                        </ModalOverlay>
                    )}
                </>
            );
        };

        const ListView = ({ orders, onSelect, onAdd, onStatusClick }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [open, setOpen] = useState({ design: true, prod: true, done: false });
            const groups = { design: [], prod: [], done: [] };
            
            orders
                .filter(o => (o.itemName || '').toLowerCase().includes(searchTerm.toLowerCase()))
                .filter(o => o.itemName !== 'ê¸°íƒ€ ìì¬ ë°œì£¼') 
                .forEach(o => {
                    // ğŸŒŸ 'ìì¬ë°œì£¼ì¤‘'ì€ ì„¤ê³„ ë‹¨ê³„(ì¤€ë¹„ ë‹¨ê³„)ì— í¬í•¨
                    if (['ì„¤ê³„ì¤‘', 'ëŒ€ê¸°', 'ìì¬ë°œì£¼ì¤‘'].includes(o.status)) groups.design.push(o);
                    else if (['ì‘ì—…ì¤‘', 'ì‘ì—…ì™„ë£Œ', 'ë„ì¥/ë§ˆê°ì¤‘'].includes(o.status)) groups.prod.push(o);
                    else groups.done.push(o);
                });

            const Section = ({ id, title, items }) => (
                <div className="mb-4">
                <div onClick={() => setOpen({ ...open, [id]: !open[id] })} className={`flex justify-between p-3 rounded cursor-pointer transition-colors ${open[id] ? 'bg-slate-800 text-white' : 'bg-white border hover:bg-slate-50'}`}>
                    <span className="font-bold">{title} ({items.length})</span>{open[id] ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                </div>
                {open[id] && <div className="mt-2 pl-2 border-l-2 border-slate-200 space-y-2">
                    {items.map(o => (
                    <Card key={o.id} className="p-3 bg-white transition-colors hover:border-blue-500 flex justify-between items-center">
                        <div className="flex-1 cursor-pointer" onClick={() => onSelect(o)}>
                            <div className="font-bold truncate mr-2 mb-1">{o.itemName}</div>
                            <div className="text-xs text-gray-500 flex gap-2">
                                <span>{o.clientName}</span>
                                <span className="text-gray-300">|</span>
                                <span>{o.deliveryDate} ë‚©í’ˆ</span>
                            </div>
                        </div>
                        <StatusBadge status={o.status} onClick={() => onStatusClick(o)} />
                    </Card>
                    ))}
                    {items.length === 0 && <div className="text-sm text-gray-400 p-2">í•­ëª© ì—†ìŒ</div>}
                </div>}
                </div>
            );

            return (
                <div className="space-y-4 animate-fade-in pb-10">
                <div className="flex gap-2 bg-white p-3 rounded-xl border shadow-sm sticky top-0 z-10">
                    <Search size={20} className="text-gray-400"/>
                    <input 
                    className="flex-1 outline-none bg-transparent min-w-0" 
                    placeholder="ì‘ì—…ëª… ê²€ìƒ‰..." 
                    value={searchTerm} 
                    onChange={e => setSearchTerm(e.target.value)} 
                    />
                    <button onClick={onAdd} className="bg-slate-800 text-white px-3 py-1 rounded text-sm font-bold flex items-center gap-1 flex-shrink-0">
                    <Plus size={16} /> <span className="hidden sm:inline">ì‘ì—…ë“±ë¡</span>
                    </button>
                </div>
                <Section id="design" title="ì„¤ê³„/ë°œì£¼ ë‹¨ê³„" items={groups.design} />
                <Section id="prod" title="ì œì‘/ë§ˆê° ë‹¨ê³„" items={groups.prod} />
                <Section id="done" title="ë‚©í’ˆ ëŒ€ê¸°/ì™„ë£Œ" items={groups.done} />
                </div>
            );
        };

        const CalendarView = ({ orders, onSelect, scheduleData, onUpdateSchedule, onAddSchedule, workers, onAddWorker, onDeleteWorker }) => {
            const [viewMode, setViewMode] = useState('delivery'); // 'delivery' | 'worker' | 'material_weekly'
            const [date, setDate] = useState(new Date());
            const [scheduleModal, setScheduleModal] = useState(null); // { worker, date, content, id }
            const [isEditingSchedule, setIsEditingSchedule] = useState(false);
            
            // ì‘ì—…ì ê´€ë¦¬ ëª¨ë‹¬ ìƒíƒœ
            const [manageWorkersModal, setManageWorkersModal] = useState(false);
            const [newWorkerName, setNewWorkerName] = useState('');

            useEffect(() => {
                if (!scheduleModal) setIsEditingSchedule(false);
            }, [scheduleModal]);

            // --- Delivery Calendar Logic (Monthly) ---
            const days = [];
            const year = date.getFullYear();
            const month = date.getMonth();
            
            let firstDayIndex = new Date(year, month, 1).getDay();
            firstDayIndex = firstDayIndex === 0 ? 6 : firstDayIndex - 1; 
            
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < firstDayIndex; i++) days.push(null);
            for (let i = 1; i <= lastDate; i++) days.push(new Date(year, month, i));

            // --- Worker/Material Weekly Logic ---
            const getWeekDates = (baseDate) => {
                const current = new Date(baseDate);
                const day = current.getDay();
                const diff = current.getDate() - day + (day === 0 ? -6 : 1); // Monday based
                const monday = new Date(current.setDate(diff));
                const week = [];
                for(let i=0; i<7; i++) {
                    const d = new Date(monday);
                    d.setDate(monday.getDate() + i);
                    week.push(d);
                }
                return week;
            };

            const weekDates = getWeekDates(date);
            const weekStr = `${weekDates[0].getMonth()+1}.${weekDates[0].getDate()} - ${weekDates[6].getMonth()+1}.${weekDates[6].getDate()}`;

            const getLocalDateString = (d) => {
                if (!d) return null;
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const da = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${da}`;
            };

            const handleScheduleClick = (worker, dateStr, existingSchedule) => {
                setScheduleModal({
                    worker,
                    date: dateStr,
                    content: existingSchedule ? existingSchedule.content : '',
                    id: existingSchedule ? existingSchedule.id : null
                });
            };

            const saveSchedule = () => {
                if(scheduleModal) {
                    if(scheduleModal.id) {
                        onUpdateSchedule(scheduleModal);
                    } else {
                        onAddSchedule(scheduleModal);
                    }
                    setScheduleModal(null);
                }
            };

            // ğŸŒŸ ìì¬ ìº˜ë¦°ë”ìš© ë°ì´í„° ê°€ê³µ (íšŒìˆ˜ì™„ë£Œëœ ê²ƒë„ ëª¨ë‘ í¬í•¨)
            const getMaterialsForDate = (dateStr) => {
                const list = [];
                orders.forEach(o => {
                    (o.materials || []).forEach(m => {
                        if (m.date === dateStr && m.status !== 'ì •ë³´') {
                            list.push({ ...m, orderName: o.itemName });
                        }
                    });
                });
                return list;
            };

            return (
                <div className="h-full flex flex-col animate-fade-in pb-10 min-h-0">
                    <div className="flex justify-between items-center mb-4 flex-shrink-0">
                        <div className="flex bg-slate-200 p-1 rounded-lg">
                            <button onClick={()=>setViewMode('delivery')} className={`px-2 py-1 text-[10px] md:text-xs font-bold rounded ${viewMode==='delivery'?'bg-white shadow text-indigo-900':'text-gray-500'}`}>ë§ˆê°(ì›”ê°„)</button>
                            <button onClick={()=>setViewMode('worker')} className={`px-2 py-1 text-[10px] md:text-xs font-bold rounded ${viewMode==='worker'?'bg-white shadow text-indigo-900':'text-gray-500'}`}>ì‘ì—…(ì£¼ê°„)</button>
                            <button onClick={()=>setViewMode('material_weekly')} className={`px-2 py-1 text-[10px] md:text-xs font-bold rounded ${viewMode==='material_weekly'?'bg-white shadow text-indigo-900':'text-gray-500'}`}>ë°œì£¼(ì£¼ê°„)</button>
                        </div>
                        <div className="flex gap-2 items-center">
                            <h2 className="text-sm md:text-lg font-bold whitespace-nowrap">
                                {viewMode === 'delivery' ? `${year}.${month + 1}` : weekStr}
                            </h2>
                            <div className="flex rounded border bg-white">
                                <button onClick={() => {
                                    const newDate = new Date(date);
                                    if(viewMode==='delivery') newDate.setMonth(month - 1);
                                    else newDate.setDate(newDate.getDate() - 7);
                                    setDate(newDate);
                                }} className="p-1 hover:bg-slate-50 border-r"><ChevronLeft size={16}/></button>
                                <button onClick={() => setDate(new Date())} className="text-xs px-2 hover:bg-slate-50 font-bold whitespace-nowrap">ì˜¤ëŠ˜</button>
                                <button onClick={() => {
                                    const newDate = new Date(date);
                                    if(viewMode==='delivery') newDate.setMonth(month + 1);
                                    else newDate.setDate(newDate.getDate() + 7);
                                    setDate(newDate);
                                }} className="p-1 hover:bg-slate-50 border-l"><ChevronRight size={16}/></button>
                            </div>
                        </div>
                    </div>

                    {viewMode === 'delivery' ? (
                        <div className="flex-1 bg-white border rounded-xl overflow-hidden flex flex-col shadow-sm min-h-0">
                            <div className="grid grid-cols-7 bg-slate-50 border-b text-center py-2 font-bold text-slate-600 text-sm flex-shrink-0">
                            <div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div className="text-blue-500">í† </div><div className="text-red-500">ì¼</div>
                            </div>
                            <div className="flex-1 grid grid-cols-7 grid-rows-5 overflow-y-auto">
                            {days.map((d, i) => {
                                if (!d) return <div key={i} className="bg-slate-50 border-r border-b"></div>;
                                const dateStr = getLocalDateString(d);
                                
                                const events = orders.filter(o => {
                                    let targetDate = o.deliveryDate;
                                    if (o.status === 'ë‚©í’ˆì™„ë£Œ' && o.completedDate) {
                                        targetDate = o.completedDate;
                                    }
                                    return targetDate === dateStr;
                                });
                                
                                const isToday = dateStr === getLocalDateString(new Date());
                                return (
                                <div key={i} className={`border-r border-b p-1 bg-white min-h-[60px] flex flex-col ${isToday ? 'bg-blue-50' : ''}`}>
                                    <div className={`text-xs font-bold mb-1 text-center ${isToday ? 'text-blue-600' : 'text-gray-500'}`}>{d.getDate()}</div>
                                    <div className="space-y-1 overflow-y-auto flex-1 no-scrollbar">
                                    {events.map(ev => {
                                        const isDone = ['ë‚©í’ˆì™„ë£Œ'].includes(ev.status);
                                        return (
                                        <div key={ev.id} onClick={() => onSelect(ev)} className={`text-[10px] p-1 truncate cursor-pointer rounded hover:opacity-80 ${isDone ? 'bg-slate-100 text-slate-500 border-l-2 border-slate-400 line-through' : 'bg-red-50 text-red-800 border-l-2 border-red-500'}`}>
                                        {ev.itemName}
                                        </div>
                                    )})}
                                    </div>
                                </div>
                                )
                            })}
                            </div>
                        </div>
                    ) : viewMode === 'worker' ? (
                        <div className="flex-1 bg-white border rounded-xl overflow-hidden flex flex-col shadow-sm min-h-0 relative">
                            {/* Worker Header with Manage Button */}
                            <div className="absolute top-2 right-2 z-10">
                                <button onClick={()=>setManageWorkersModal(true)} className="bg-white border text-gray-600 px-2 py-1 rounded text-xs font-bold shadow hover:bg-slate-50 flex items-center gap-1">
                                    <Settings size={12}/> ì‘ì—…ì ê´€ë¦¬
                                </button>
                            </div>

                            <div className="grid grid-cols-[80px_1fr_1fr_1fr_1fr_1fr_1fr_1fr] bg-slate-100 border-b flex-shrink-0 mt-8 md:mt-0">
                                <div className="p-2 text-center font-bold text-xs flex items-center justify-center bg-slate-200">ì´ë¦„</div>
                                {weekDates.map((d, i) => {
                                    const isToday = getLocalDateString(d) === getLocalDateString(new Date());
                                    return (
                                        <div key={i} className={`p-2 text-center border-l text-xs font-bold flex flex-col ${isToday ? 'bg-indigo-50 text-indigo-700' : ''}`}>
                                            <span className={`${i===5?'text-blue-500':i===6?'text-red-500':''}`}>{['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'][i]}</span>
                                            <span className="text-[10px] text-gray-500">{d.getDate()}</span>
                                        </div>
                                    );
                                })}
                            </div>
                            {/* Worker Grid */}
                            <div className="flex-1 overflow-y-auto">
                                {workers.map(worker => (
                                    <div key={worker.id || worker.name} className="grid grid-cols-[80px_1fr_1fr_1fr_1fr_1fr_1fr_1fr] border-b min-h-[80px]">
                                        <div className="p-2 bg-slate-50 font-bold text-xs flex items-center justify-center border-r">
                                            {worker.name}
                                        </div>
                                        {weekDates.map((d, i) => {
                                            const dateStr = getLocalDateString(d);
                                            const schedules = scheduleData.filter(s => s.worker === worker.name && s.date === dateStr);
                                            return (
                                                <div 
                                                    key={i} 
                                                    onClick={() => handleScheduleClick(worker.name, dateStr, schedules[0])}
                                                    className="border-l p-1 hover:bg-indigo-50 cursor-pointer relative group transition-colors"
                                                >
                                                    {schedules.length > 0 ? (
                                                        schedules.map(s => (
                                                            <div key={s.id} className="bg-indigo-100 text-indigo-800 p-1 rounded text-[10px] font-bold whitespace-pre-wrap break-words border border-indigo-200 shadow-sm h-full">
                                                                {s.content}
                                                            </div>
                                                        ))
                                                    ) : (
                                                        <div className="h-full w-full flex items-center justify-center opacity-0 group-hover:opacity-100">
                                                            <Plus size={14} className="text-gray-300"/>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                ))}
                                {workers.length === 0 && <div className="p-8 text-center text-gray-400 text-sm">ë“±ë¡ëœ ì‘ì—…ìê°€ ì—†ìŠµë‹ˆë‹¤. [ì‘ì—…ì ê´€ë¦¬]ì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>}
                            </div>
                        </div>
                    ) : (
                        // ğŸŒŸ ìƒˆë¡œìš´ ìì¬(ë°œì£¼) ìº˜ë¦°ë” ë·° (ì£¼ê°„)
                        <div className="flex-1 bg-white border rounded-xl overflow-hidden flex flex-col shadow-sm min-h-0">
                            {/* Material Header */}
                            <div className="grid grid-cols-7 bg-slate-100 border-b flex-shrink-0">
                                {weekDates.map((d, i) => {
                                    const isToday = getLocalDateString(d) === getLocalDateString(new Date());
                                    return (
                                        <div key={i} className={`p-2 text-center border-l first:border-l-0 text-xs font-bold flex flex-col ${isToday ? 'bg-indigo-50 text-indigo-700' : ''}`}>
                                            <span className={`${i===5?'text-blue-500':i===6?'text-red-500':''}`}>{['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'][i]}</span>
                                            <span className="text-[10px] text-gray-500">{d.getDate()}</span>
                                        </div>
                                    );
                                })}
                            </div>
                            {/* Material Grid */}
                            <div className="flex-1 overflow-y-auto grid grid-cols-7">
                                {weekDates.map((d, i) => {
                                    const dateStr = getLocalDateString(d);
                                    const materials = getMaterialsForDate(dateStr);
                                    const isToday = dateStr === getLocalDateString(new Date());
                                    
                                    return (
                                        <div key={i} className={`border-l first:border-l-0 border-b p-1 min-h-[150px] ${isToday ? 'bg-indigo-50/30' : ''}`}>
                                            <div className="space-y-1">
                                                {materials.map((m, idx) => {
                                                    const isCompleted = m.status === 'íšŒìˆ˜ì™„ë£Œ';
                                                    return (
                                                        <div key={idx} className={`text-[10px] p-1.5 rounded border shadow-sm ${isCompleted ? 'bg-gray-100 text-gray-500 border-gray-200' : 'bg-white border-indigo-100'}`}>
                                                            <div className="flex justify-between mb-0.5">
                                                                <span className={`font-bold ${isCompleted ? 'line-through' : 'text-indigo-700'}`}>{m.item}</span>
                                                                <span className="text-gray-400">({m.quantity})</span>
                                                            </div>
                                                            <div className="truncate text-gray-500">{m.supplier}</div>
                                                            <div className={`text-[9px] mt-1 inline-block px-1 rounded ${
                                                                m.status==='ë°œì£¼'?'bg-yellow-100 text-yellow-700':
                                                                m.status==='ì ‘ìˆ˜'?'bg-orange-100 text-orange-700':
                                                                m.status==='ë°°ì°¨'?'bg-cyan-100 text-cyan-700':
                                                                m.status==='íšŒìˆ˜ëŒ€ê¸°'?'bg-red-100 text-red-700 font-bold':
                                                                'bg-gray-200 text-gray-500'
                                                            }`}>{m.status}</div>
                                                        </div>
                                                    );
                                                })}
                                                {materials.length === 0 && <div className="text-[10px] text-gray-300 text-center mt-4">-</div>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* Schedule Detail/Edit Modal */}
                    {scheduleModal && (
                        <ModalOverlay onClose={() => setScheduleModal(null)}>
                            <div className="bg-white w-full max-w-lg rounded-xl shadow-2xl animate-fade-in flex flex-col max-h-[90vh]" onClick={e=>e.stopPropagation()}>
                                <div className="p-4 border-b flex justify-between items-center">
                                    <div>
                                        <h3 className="font-bold text-xl">{scheduleModal.worker}</h3>
                                        <p className="text-sm text-gray-500">{scheduleModal.date} ì¼ì •</p>
                                    </div>
                                    <button onClick={() => setScheduleModal(null)} className="text-gray-400 hover:text-gray-600"><X size={24}/></button>
                                </div>
                                
                                <div className="p-6 overflow-y-auto flex-1">
                                    {isEditingSchedule ? (
                                        <textarea 
                                            className="w-full h-64 border rounded-lg p-4 text-base focus:ring-2 focus:ring-indigo-500 outline-none resize-none bg-slate-50" 
                                            placeholder="ì‘ì—… ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
                                            value={scheduleModal.content}
                                            onChange={e => setScheduleModal({...scheduleModal, content: e.target.value})}
                                            autoFocus
                                        />
                                    ) : (
                                        <div className="whitespace-pre-wrap text-lg leading-relaxed text-slate-800 min-h-[150px]">
                                            {scheduleModal.content || <span className="text-gray-400">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</span>}
                                        </div>
                                    )}
                                </div>
                                
                                <div className="p-4 border-t bg-slate-50 flex gap-2">
                                    {isEditingSchedule ? (
                                        <>
                                            <button onClick={() => setIsEditingSchedule(false)} className="flex-1 bg-white border border-gray-300 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-50">ì·¨ì†Œ</button>
                                            <button onClick={saveSchedule} className="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg flex items-center justify-center gap-2"><Save size={18}/> ì €ì¥</button>
                                        </>
                                    ) : (
                                        <button onClick={() => setIsEditingSchedule(true)} className="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg flex items-center justify-center gap-2"><Edit3 size={18}/> ë‚´ìš© ìˆ˜ì •</button>
                                    )}
                                </div>
                            </div>
                        </ModalOverlay>
                    )}

                    {/* Manage Workers Modal */}
                    {manageWorkersModal && (
                        <ModalOverlay onClose={() => setManageWorkersModal(null)}>
                            <div className="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl animate-fade-in" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg">ì‘ì—…ì ëª…ë‹¨ ê´€ë¦¬</h3>
                                    <button onClick={()=>setManageWorkersModal(null)}><X size={20}/></button>
                                </div>
                                <div className="mb-4 flex gap-2">
                                    <input 
                                        className="border rounded px-3 py-2 text-sm flex-1"
                                        placeholder="ì´ë¦„ ì…ë ¥"
                                        value={newWorkerName}
                                        onChange={e => setNewWorkerName(e.target.value)}
                                        onKeyPress={e => e.key === 'Enter' && newWorkerName && (onAddWorker(newWorkerName), setNewWorkerName(''))}
                                    />
                                    <button 
                                        onClick={() => { if(newWorkerName) { onAddWorker(newWorkerName); setNewWorkerName(''); }}}
                                        className="bg-indigo-600 text-white px-3 rounded text-sm font-bold"
                                    >
                                        ì¶”ê°€
                                    </button>
                                </div>
                                <div className="max-h-[300px] overflow-y-auto space-y-2">
                                    {workers.map(w => (
                                        <div key={w.id} className="flex justify-between items-center bg-slate-50 p-2 rounded">
                                            <span>{w.name}</span>
                                            <button onClick={() => onDeleteWorker(w.id)} className="text-red-500 hover:bg-red-100 p-1 rounded"><Trash2 size={16}/></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </ModalOverlay>
                    )}
                </div>
            )
        };

        const DetailView = ({ order, onBack, onUpdate, isAdmin, currentUserId, onStatusClick, onMaterialStatusClick }) => {
            if (!order) return null;
            const canEdit = isAdmin || order.userId === currentUserId;
            const [mat, setMat] = useState({ supplier: '', item: '', quantity: '', status: 'ë°œì£¼', date: new Date().toISOString().split('T')[0] });
            const [link, setLink] = useState({ name: '', url: '' });
            const [showSuggestions, setShowSuggestions] = useState(false);
            const supplierOptions = Object.keys(BASE_SUPPLIER_INFO);
            const filteredSuppliers = supplierOptions.filter(s => s.includes(mat.supplier));

            const updateOrder = (newData, logMessage = null) => {
                onUpdate({ ...order, ...newData }, null, false, logMessage);
            };

            const handleDownload = (e, fileUrl) => {
                e.stopPropagation(); 
                if (!fileUrl) {
                    e.preventDefault();
                    alert('íŒŒì¼ ì£¼ì†Œê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                }
            };

            return (
                <div className="h-full overflow-y-auto animate-fade-in pb-10 scroll-touch" onClick={()=>setShowSuggestions(false)}>
                    <div className="flex items-center gap-2 text-slate-500 cursor-pointer mb-4" onClick={onBack}>
                        <ChevronLeft size={20}/> <span className="text-sm font-bold">ëª©ë¡</span>
                    </div>
                    <div className="flex justify-between items-start mb-6">
                        <div>
                            <div className="flex items-center gap-2 mb-2">
                                <span className="text-gray-400 text-sm">{order.displayId}</span>
                                <StatusBadge status={order.status} onClick={() => onStatusClick(order)} />
                            </div>
                            <h1 className="text-2xl font-bold">{order.itemName}</h1>
                        </div>
                        {canEdit && <button onClick={() => onUpdate(null, 'form')} className="bg-slate-100 px-3 py-2 rounded flex gap-2 text-sm font-bold"><Edit3 size={16} /> ìˆ˜ì •</button>}
                    </div>

                    <Card className="p-5 mb-4 text-sm space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                             <div><div className="text-gray-400 text-xs uppercase mb-1">Client</div><div className="font-bold">{order.clientName}</div></div>
                             <div><div className="text-gray-400 text-xs uppercase mb-1">Delivery Addr</div><div className="font-bold break-keep">{order.deliveryAddress || '-'}</div></div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div><div className="text-gray-400 text-xs uppercase mb-1">Manager</div><div className="font-bold flex items-center gap-1"><User size={12}/>{order.manager || '-'}</div></div>
                            <div><div className="text-gray-400 text-xs uppercase mb-1">Worker</div><div className="font-bold flex items-center gap-1"><HardHat size={12}/>{order.technician || '-'}</div></div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                             <div><div className="text-gray-400 text-xs uppercase mb-1">Ordered</div><div className="font-bold">{order.orderDate}</div></div>
                             <div>
                                <div className="text-gray-400 text-xs uppercase mb-1">
                                    {['ë‚©í’ˆì™„ë£Œ', 'ë‚©í’ˆëŒ€ê¸°'].includes(order.status) ? 'Completed' : 'Deadline'}
                                </div>
                                <div className={`font-bold ${['ë‚©í’ˆì™„ë£Œ', 'ë‚©í’ˆëŒ€ê¸°'].includes(order.status) ? 'text-blue-600' : 'text-red-600'}`}>
                                    {['ë‚©í’ˆì™„ë£Œ', 'ë‚©í’ˆëŒ€ê¸°'].includes(order.status) && order.completedDate ? order.completedDate : order.deliveryDate}
                                </div>
                             </div>
                        </div>
                        <div><div className="text-gray-400 text-xs uppercase mb-1">Memo</div><div className="text-slate-700 whitespace-pre-wrap">{order.description || '-'}</div></div>
                    </Card>

                    <div className="bg-white p-4 rounded-xl border border-slate-200 flex flex-col mb-4">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="font-bold text-sm text-slate-700 flex gap-2"><FileBox size={16} /> ë„ë©´/íŒŒì¼</h3>
                            <span className="text-xs text-gray-400">{(order.files || []).length}ê°œ</span>
                        </div>
                        
                        <div className="flex-1 space-y-2 mb-3 max-h-[150px] overflow-y-auto">
                            {(order.files || []).length === 0 && <div className="text-center text-xs text-gray-400 py-2">ë“±ë¡ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                            {(order.files || []).map((f, i) => (
                            <div key={i} className="flex justify-between items-center p-2 bg-blue-50 rounded text-xs group">
                                <div className="flex items-center gap-2 truncate flex-1 min-w-0">
                                {f.name.endsWith('.pdf') ? <FileText size={12} className="text-red-500 flex-shrink-0"/> : <File size={12} className="text-blue-500 flex-shrink-0"/>}
                                <span className="truncate text-blue-800 font-medium">{f.name}</span>
                                </div>
                                
                                {f.url ? (
                                    <a 
                                        href={f.url} 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        onClick={(e) => handleDownload(e, f.url)}
                                        className="bg-white p-1 rounded text-blue-600 hover:bg-blue-100 flex-shrink-0 ml-2 cursor-pointer"
                                        title="ë‹¤ìš´ë¡œë“œ/ì—´ê¸°"
                                    >
                                        <Download size={12} />
                                    </a>
                                ) : (
                                    <span className="text-red-400 text-[10px] ml-2 flex-shrink-0 bg-white p-1 rounded border border-red-200">
                                        ë§í¬ì˜¤ë¥˜
                                    </span>
                                )}
                            </div>
                            ))}
                        </div>
                    </div>

                    <h3 className="font-bold mb-2 flex items-center gap-2"><Package size={18}/> ìì¬ ë°œì£¼ ë‚´ì—­</h3>
                    <p className="text-xs text-gray-500 mb-2">* ìƒíƒœë¥¼ í´ë¦­í•˜ë©´ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <Card className="p-0 overflow-hidden mb-10">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 border-b"><tr><th className="p-2">ê±°ë˜ì²˜</th><th className="p-2">í’ˆëª©</th><th className="p-2">ìƒíƒœ</th></tr></thead>
                            <tbody>
                                {(order.materials || []).map((m, i) => (
                                    <tr key={i} className="border-b">
                                        <td className="p-2 font-bold">{m.supplier}</td>
                                        <td className="p-2">{m.item} ({m.quantity})</td>
                                        <td className="p-2">
                                            <MaterialStatusBadge status={m.status} onClick={() => onMaterialStatusClick(m, m.status)} />
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {canEdit && (
                            <div className="p-3 bg-slate-50 border-t">
                                <div className="text-xs font-bold text-slate-500 mb-2">ìì¬ ì¶”ê°€</div>
                                <div className="flex flex-col md:flex-row gap-2 mb-2 items-start">
                                    <div className="relative flex-1 min-w-0 w-full" onClick={e=>e.stopPropagation()}>
                                    <input 
                                        placeholder="ê±°ë˜ì²˜" 
                                        className="border p-2 rounded w-full text-sm" 
                                        value={mat.supplier} 
                                        onFocus={()=>setShowSuggestions(true)}
                                        onChange={e => {
                                        setMat({ ...mat, supplier: e.target.value });
                                        setShowSuggestions(true);
                                        }} 
                                    />
                                    {showSuggestions && filteredSuppliers.length > 0 && (
                                        <ul className="absolute z-50 left-0 top-full mt-1 w-full bg-white border rounded-md shadow-lg max-h-40 overflow-y-auto">
                                        {filteredSuppliers.map((s, idx) => (
                                            <li key={idx} className="p-2 text-sm hover:bg-indigo-50 cursor-pointer text-slate-700 border-b last:border-0" onClick={() => { setMat({ ...mat, supplier: s }); setShowSuggestions(false); }}>
                                            {s}
                                            </li>
                                        ))}
                                        </ul>
                                    )}
                                    </div>
                                    <input placeholder="í’ˆëª©ëª…" className="border p-2 rounded flex-1 text-sm min-w-0 w-full" value={mat.item} onChange={e => setMat({ ...mat, item: e.target.value })} />
                                    <input placeholder="ìˆ˜ëŸ‰" className="border p-2 rounded w-full md:w-20 text-sm" value={mat.quantity} onChange={e => setMat({ ...mat, quantity: e.target.value })} />
                                </div>
                                <div className="flex gap-4 mb-2 text-xs">
                                    <label className="flex items-center gap-1 cursor-pointer">
                                        <input type="radio" name="matStatus" checked={mat.status === 'ë°œì£¼'} onChange={()=>setMat({...mat, status:'ë°œì£¼'})} /> êµ¬ë§¤ (ë°œì£¼)
                                    </label>
                                    <label className="flex items-center gap-1 cursor-pointer">
                                        <input type="radio" name="matStatus" checked={mat.status === 'ì ‘ìˆ˜'} onChange={()=>setMat({...mat, status:'ì ‘ìˆ˜'})} /> ê°€ê³µ (ì ‘ìˆ˜)
                                    </label>
                                </div>
                                <button onClick={()=>{
                                    if(!mat.supplier || !mat.item) return;
                                    updateOrder({ materials: [...(order.materials||[]), {...mat, id:Date.now()}] }, { type: 'material', msg: `${mat.item} ìì¬ ì¶”ê°€ (${mat.supplier})` });
                                    setMat({...mat, supplier:'', item:'', quantity:'', status:'ë°œì£¼'});
                                    setShowSuggestions(false);
                                }} className="bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold w-full">ì¶”ê°€</button>
                            </div>
                        )}
                    </Card>
                </div>
            );
        };

        const FormView = ({ order, onSave, onDelete, onCancel, isAdmin, currentUserId, storage }) => {
            const [data, setData] = useState(order || {
                clientName: '', itemName: '', 
                manager: '', technician: '', 
                deliveryAddress: '', 
                orderDate: new Date().toISOString().split('T')[0], 
                deliveryDate: '', 
                completedDate: '', 
                status: 'ì„¤ê³„ì¤‘', description: '', clientContact: '', files: []
            });
            const [isUploading, setIsUploading] = useState(false);
            const fileInputRef = useRef(null);

            const canEdit = !order || isAdmin || order.userId === currentUserId;

            useEffect(() => {
                if (['ë‚©í’ˆì™„ë£Œ', 'ë‚©í’ˆëŒ€ê¸°'].includes(data.status) && !data.completedDate) {
                    setData(prev => ({ ...prev, completedDate: new Date().toISOString().split('T')[0] }));
                }
            }, [data.status]);

            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (!storage) {
                    alert("ìŠ¤í† ë¦¬ì§€ ì„œë¹„ìŠ¤ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¸í„°ë„· ìƒíƒœë‚˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    return;
                }

                setIsUploading(true);
                try {
                    const storagePath = `uploads/${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, storagePath);
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    const fullPath = snapshot.ref.fullPath;
                    const newFile = { id: Date.now(), name: file.name, url: downloadURL, fullPath: fullPath };
                    setData(prev => ({ ...prev, files: [...(prev.files || []), newFile] }));
                } catch (error) {
                    alert("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message);
                } finally {
                    setIsUploading(false);
                    if(fileInputRef.current) fileInputRef.current.value = '';
                }
            };

            const removeFile = async (fileObj) => {
                if(!window.confirm("ì²¨ë¶€ëœ íŒŒì¼ì„ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³µêµ¬ ë¶ˆê°€)")) return;
                const { id, url, fullPath } = fileObj;
                try {
                    if (storage) {
                        let fileRef;
                        if (fullPath) fileRef = ref(storage, fullPath);
                        else if (url) fileRef = ref(storage, url);

                        if (fileRef) await deleteObject(fileRef);
                    }
                } catch (error) {
                    alert("ì£¼ì˜: ìŠ¤í† ë¦¬ì§€ íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ëª©ë¡ì—ì„œëŠ” ì œê±°í•©ë‹ˆë‹¤.");
                }
                setData(prev => ({ ...prev, files: prev.files.filter(f => f.id !== id) }));
            };

            const handleSave = () => {
                if (isUploading) {
                    alert('íŒŒì¼ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
                    return;
                }
                let logInfo = null;
                if (!order) {
                    logInfo = { type: 'create', msg: `ì‹ ê·œ ì‘ì—… ë“±ë¡: ${data.itemName}` };
                } else if (order.status !== data.status) {
                    logInfo = { type: 'status', msg: `ì‘ì—… ìƒíƒœ ë³€ê²½: ${order.status} â†’ ${data.status}` };
                }

                onSave(data, logInfo);
            };

            if (!canEdit) return <div className="p-10 text-center">ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.<button onClick={onCancel} className="block mx-auto mt-4 bg-gray-200 px-4 py-2 rounded">ëŒì•„ê°€ê¸°</button></div>;

            return (
                <div className="max-w-2xl mx-auto animate-fade-in pb-10 scroll-touch">
                    <div onClick={onCancel} className="mb-4 cursor-pointer text-slate-500 font-bold">ì·¨ì†Œ</div>
                    <Card className="p-6 space-y-4">
                        <h2 className="text-2xl font-bold">{order ? 'ìˆ˜ì •' : 'ìƒˆ ì‘ì—… ë“±ë¡'}</h2>
                        <div className="grid gap-4">
                            <div className="grid grid-cols-1 gap-1">
                                <label className="text-xs font-bold text-gray-500">ì‘ì—…ëª…</label>
                                <input className="border p-2 rounded w-full" value={data.itemName} onChange={e=>setData({...data, itemName:e.target.value})}/>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500">ë‹´ë‹¹ì (Manager)</label>
                                    <input className="border p-2 rounded w-full" value={data.manager} onChange={e=>setData({...data, manager:e.target.value})}/>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500">ì‘ì—…ì (Technician)</label>
                                    <input className="border p-2 rounded w-full" value={data.technician} onChange={e=>setData({...data, technician:e.target.value})}/>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500">í´ë¼ì´ì–¸íŠ¸</label>
                                    <input className="border p-2 rounded w-full" value={data.clientName} onChange={e=>setData({...data, clientName:e.target.value})}/>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500">ì—°ë½ì²˜</label>
                                    <input className="border p-2 rounded w-full" value={data.clientContact} onChange={e=>setData({...data, clientContact:e.target.value})}/>
                                </div>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-gray-500">ë‚©í’ˆ/ì‹œê³µ ì£¼ì†Œ</label>
                                <input className="border p-2 rounded w-full" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" value={data.deliveryAddress} onChange={e=>setData({...data, deliveryAddress:e.target.value})}/>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500">ë°œì£¼(ì ‘ìˆ˜) ë‚ ì§œ</label>
                                    <input type="date" className="border p-2 rounded w-full" value={data.orderDate} onChange={e=>setData({...data, orderDate:e.target.value})}/>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 text-red-500">ë‚©í’ˆ(ë§ˆê°) ë‚ ì§œ</label>
                                    <input type="date" className="border p-2 rounded w-full" value={data.deliveryDate} onChange={e=>setData({...data, deliveryDate:e.target.value})}/>
                                </div>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-gray-500">ì§„í–‰ ìƒíƒœ</label>
                                <select className="border p-2 rounded w-full" value={data.status} onChange={e=>setData({...data, status:e.target.value})}>
                                    <option>ì„¤ê³„ì¤‘</option>
                                    <option>ìì¬ë°œì£¼ì¤‘</option> {/* ğŸŒŸ ì¶”ê°€ë¨ */}
                                    <option>ì‘ì—…ì¤‘</option>
                                    <option>ì‘ì—…ì™„ë£Œ</option>
                                    <option>ë„ì¥/ë§ˆê°ì¤‘</option>
                                    <option>ë‚©í’ˆëŒ€ê¸°</option>
                                    <option>ë‚©í’ˆì™„ë£Œ</option>
                                </select>
                            </div>

                            {['ì‘ì—…ì™„ë£Œ', 'ë‚©í’ˆì™„ë£Œ', 'ë‚©í’ˆëŒ€ê¸°'].includes(data.status) && (
                                <div>
                                    <label className="text-xs font-bold text-gray-500 text-blue-600">ì‹¤ì œ ì™„ë£Œì¼ (ì‹œê³µ/ë‚©í’ˆ ì™„ë£Œ)</label>
                                    <input type="date" className="border p-2 rounded w-full bg-blue-50 border-blue-200" value={data.completedDate || ''} onChange={e=>setData({...data, completedDate:e.target.value})}/>
                                </div>
                            )}

                            <div>
                                <div className="flex justify-between mb-1">
                                    <label className="text-xs font-bold text-gray-500">ì‘ì—… ë‚´ìš© / ë©”ëª¨</label>
                                </div>
                                <textarea className="border p-2 rounded w-full h-24" value={data.description} onChange={e=>setData({...data, description:e.target.value})}/>
                            </div>

                            <div className="border-t pt-4 mt-2">
                                <label className="text-xs font-bold text-gray-500 mb-2 block">ë„ë©´ / íŒŒì¼ ì²¨ë¶€</label>
                                <div className="space-y-2">
                                {(data.files || []).map(f => (
                                    <div key={f.id} className="flex justify-between items-center p-2 bg-slate-50 rounded border text-sm">
                                    <div className="flex items-center gap-2 truncate">
                                        <Paperclip size={14} className="text-gray-400"/>
                                        <span className="truncate">{f.name}</span>
                                    </div>
                                    <button onClick={() => removeFile(f)} className="text-red-500 hover:text-red-700"><X size={14}/></button>
                                    </div>
                                ))}
                                </div>
                                
                                {isUploading && (
                                    <div className="text-center py-2 flex items-center justify-center gap-2 text-sm text-indigo-600 font-bold">
                                        <div className="loader"></div> ì—…ë¡œë“œ ì¤‘...
                                    </div>
                                )}

                                <div className="mt-2 flex items-center gap-2">
                                    <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileChange} />
                                    <button onClick={() => !isUploading && fileInputRef.current.click()} disabled={isUploading} className="text-sm bg-gray-100 border border-gray-300 px-3 py-1.5 rounded flex items-center gap-2 hover:bg-gray-200 disabled:opacity-50">
                                        <UploadCloud size={14}/> {isUploading ? 'ì—…ë¡œë“œ ì¤‘' : 'íŒŒì¼ ì—…ë¡œë“œ'}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-end gap-2 pt-4 border-t">
                            {order && <button onClick={()=>onDelete(order.id)} className="text-red-500 text-sm font-bold px-4">ì‚­ì œ</button>}
                            <button onClick={handleSave} disabled={isUploading} className="bg-slate-800 text-white px-6 py-2 rounded font-bold disabled:bg-gray-400">
                                {isUploading ? 'ì²˜ë¦¬ì¤‘...' : 'ì €ì¥'}
                            </button>
                        </div>
                    </Card>
                </div>
            );
        };

        // ğŸŒŸ ë³µì›ë¨: ìˆ˜ì •í•„ìš”html.txt ë²„ì „ì˜ MaterialManageView (12ì‹œê°„ ìˆ¨ê¹€ ë¡œì§ ì¶”ê°€)
        const MaterialManageView = ({ suppliers, orders, onUpdateOrder, onMaterialStatusClick }) => {
            const [selectedSupplier, setSelectedSupplier] = useState(null);
            const [isCustomMode, setIsCustomMode] = useState(false);
            const [editingMaterial, setEditingMaterial] = useState(null);
            const [isEditingInfo, setIsEditingInfo] = useState(false);
            const [editingInfoData, setEditingInfoData] = useState({ phone: '', email: '', address: '' });
            const baseInfo = BASE_SUPPLIER_INFO[selectedSupplier];
            const [quickAdd, setQuickAdd] = useState(false);
            const [batchHeader, setBatchHeader] = useState({ orderId: '', supplier: '', date: new Date().toISOString().split('T')[0] });
            const [batchItems, setBatchItems] = useState([{ id: Date.now(), item: '', quantity: '' }]);
            const [quickAddType, setQuickAddType] = useState('ë°œì£¼');
            const [newSupplierInfo, setNewSupplierInfo] = useState({ phone: '', email: '', address: '' });

            useEffect(() => { 
                if (selectedSupplier && !isCustomMode) {
                    setBatchHeader(prev => ({ ...prev, supplier: selectedSupplier }));
                } else if (isCustomMode) {
                    setBatchHeader(prev => ({ ...prev, supplier: '' }));
                }
            }, [selectedSupplier, isCustomMode]);

            // ğŸŒŸ ìˆ˜ì •ë¨: íšŒìˆ˜ì™„ë£Œëœ ìì¬ ì¤‘ 12ì‹œê°„ì´ ì§€ë‚œ ê²ƒì€ ëª©ë¡ì—ì„œë§Œ ìˆ¨ê¹€ ì²˜ë¦¬ (ë°ì´í„°ëŠ” ë³´ì¡´)
            const displayedMaterials = useMemo(() => {
                const all = [];
                orders.forEach(o => { (o.materials || []).forEach(m => { all.push({ ...m, orderId: o.id, orderName: o.itemName }); }); });
                const sorted = all.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));

                let list = (selectedSupplier && !isCustomMode) 
                    ? (suppliers[selectedSupplier] || [])
                    : sorted;
                
                // ğŸŒŸ ì¤‘ìš”: 12ì‹œê°„ ì§€ë‚œ íšŒìˆ˜ì™„ë£Œ í•­ëª© ìˆ¨ê¸°ê¸° í•„í„°
                const twelveHoursAgo = new Date(Date.now() - 12 * 60 * 60 * 1000);
                
                return list.filter(m => {
                    if (m.status === 'ì •ë³´') return false;
                    // íšŒìˆ˜ì™„ë£Œì´ê³  ì™„ë£Œì‹œê°„ì´ ì¡´ì¬í•˜ë©° 12ì‹œê°„ì´ ì§€ë‚¬ìœ¼ë©´ ìˆ¨ê¹€
                    if (m.status === 'íšŒìˆ˜ì™„ë£Œ' && m.completedAt) {
                        const completedDate = new Date(m.completedAt);
                        if (completedDate < twelveHoursAgo) return false;
                    }
                    return true;
                });
            }, [orders, suppliers, selectedSupplier, isCustomMode]);

            const currentSupplierInfo = useMemo(() => {
                if (baseInfo) return baseInfo;
                if (selectedSupplier && suppliers[selectedSupplier]) {
                    const infoItem = suppliers[selectedSupplier].find(m => m.status === 'ì •ë³´') || suppliers[selectedSupplier][0];
                    return infoItem?.supplierInfo || {};
                }
                return {};
            }, [selectedSupplier, suppliers, baseInfo]);

            useEffect(() => {
                if (selectedSupplier && !isCustomMode) {
                    setEditingInfoData({ phone: currentSupplierInfo.phone || '', email: currentSupplierInfo.email || '', address: currentSupplierInfo.address || '' });
                    setIsEditingInfo(false);
                }
            }, [selectedSupplier, currentSupplierInfo, isCustomMode]);

            const sortedSuppliers = useMemo(() => {
                const list = Object.keys(suppliers).map(name => {
                    const items = suppliers[name];
                    const hasActive = items.some(m => ['ë°œì£¼', 'ì ‘ìˆ˜', 'íšŒìˆ˜ëŒ€ê¸°', 'ì‘ì—…ì¤‘', 'ë°°ì°¨'].includes(m.status));
                    const pickupCnt = items.filter(m => m.status === 'íšŒìˆ˜ëŒ€ê¸°').length;
                    const activeCnt = items.filter(m => ['ë°œì£¼', 'ì ‘ìˆ˜', 'ë°°ì°¨'].includes(m.status)).length;
                    return { name, hasActive, pickupCnt, activeCnt, items };
                });
                return list.sort((a, b) => {
                    if (a.hasActive && !b.hasActive) return -1;
                    if (!a.hasActive && b.hasActive) return 1;
                    return a.name.localeCompare(b.name, 'ko');
                });
            }, [suppliers]);

            const addRow = () => setBatchItems([...batchItems, { id: Date.now() + Math.random(), item: '', quantity: '' }]);
            const removeRow = (id) => batchItems.length === 1 ? setBatchItems([{ id: Date.now(), item: '', quantity: '' }]) : setBatchItems(batchItems.filter(i => i.id !== id));
            const updateRow = (id, field, value) => setBatchItems(batchItems.map(i => i.id === id ? { ...i, [field]: value } : i));

            const handleBatchAdd = async () => {
                const validItems = batchItems.filter(i => i.item.trim() !== '');
                if (validItems.length === 0 && !isCustomMode) return alert("í’ˆëª©ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”");
                if (isCustomMode && !batchHeader.supplier) return alert("ê±°ë˜ì²˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
                
                let targetOrder = orders.find(o => o.id === batchHeader.orderId);
                if (!targetOrder && !batchHeader.orderId) {
                    targetOrder = orders.find(o => o.itemName === 'ê¸°íƒ€ ìì¬ ë°œì£¼' && !['ë‚©í’ˆì™„ë£Œ'].includes(o.status));
                    if (!targetOrder) targetOrder = { id: `mock-misc-${Date.now()}`, itemName: 'ê¸°íƒ€ ìì¬ ë°œì£¼', clientName: 'ë‚´ë¶€', status: 'ì‘ì—…ì¤‘', orderDate: new Date().toISOString().split('T')[0], deliveryDate: '', materials: [] };
                }

                const finalSupplier = isCustomMode ? batchHeader.supplier : selectedSupplier;
                const isInfoRegistration = isCustomMode && validItems.length === 0;
                const newMaterials = [];

                if (isInfoRegistration) {
                    newMaterials.push({ id: Date.now(), supplier: finalSupplier, item: "ê±°ë˜ì²˜ ì •ë³´", quantity: "-", status: "ì •ë³´", date: batchHeader.date, supplierInfo: { ...newSupplierInfo, ...getMockCoordinates(newSupplierInfo.address) } });
                } else {
                    validItems.forEach((itemData, index) => {
                        const materialData = { id: Date.now() + index, supplier: finalSupplier, item: itemData.item, quantity: itemData.quantity, status: quickAddType, date: batchHeader.date };
                        if (isCustomMode && index === 0) materialData.supplierInfo = { ...newSupplierInfo, ...getMockCoordinates(newSupplierInfo.address) };
                        newMaterials.push(materialData);
                    });
                }

                const updatedMaterials = [...(targetOrder.materials || []), ...newMaterials];
                await onUpdateOrder({ ...targetOrder, materials: updatedMaterials }, isInfoRegistration ? null : { type: 'material', msg: `${quickAddType} ì¼ê´„ ë“±ë¡ (${validItems.length}ê±´) - ${finalSupplier}` });
                setQuickAdd(false); setBatchItems([{ id: Date.now(), item: '', quantity: '' }]); setNewSupplierInfo({ phone: '', email: '', address: '' });
                if(isCustomMode) setSelectedSupplier(null); 
            };
            
            const handleDelete = async (m) => {
                if(!window.confirm(`${m.item} í•­ëª©ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                const order = orders.find(o => o.id === m.orderId);
                if(order) {
                    const updated = order.materials.filter(x => x.id !== m.id);
                    await onUpdateOrder({ ...order, materials: updated }, {type: 'material', msg: `ìì¬ ì‚­ì œ: ${m.item}`});
                }
            };

            const toggleStatus = async (m) => {
                if (m.status === 'ì •ë³´') return;
                onMaterialStatusClick(m, m.status);
            };

            // ğŸŒŸ ìˆ˜ì • í•¨ìˆ˜ ì¶”ê°€: ìì¬ ë‚´ìš© ìˆ˜ì • ì €ì¥
            const handleEditSave = async () => {
                if (!editingMaterial) return;
                const order = orders.find(o => o.id === editingMaterial.orderId);
                if (order) {
                    // ê¸°ì¡´ ìì¬ ë°°ì—´ì—ì„œ ìˆ˜ì •í•  ìì¬ë¥¼ ì°¾ì•„ ì—…ë°ì´íŠ¸
                    const updatedMaterials = (order.materials || []).map(m => 
                        m.id === editingMaterial.id ? { ...m, item: editingMaterial.item, quantity: editingMaterial.quantity, supplier: editingMaterial.supplier } : m
                    );
                    await onUpdateOrder({ ...order, materials: updatedMaterials }, { type: 'material', msg: `ìì¬ ìˆ˜ì •: ${editingMaterial.item}` });
                    setEditingMaterial(null);
                }
            };

            return (
                <div className="flex h-full gap-4 animate-fade-in flex-col md:flex-row overflow-hidden relative">
                    <div className="w-full md:w-1/3 overflow-y-auto space-y-2 pr-0 md:pr-2 max-h-[200px] md:max-h-full flex-shrink-0 scroll-touch">
                        <div onClick={() => { setIsCustomMode(true); setSelectedSupplier(null); setBatchHeader(prev=>({...prev, supplier: ''})); }} className={`p-3 border rounded-lg cursor-pointer transition-all flex items-center gap-2 ${isCustomMode ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white hover:bg-slate-50'}`}>
                        <Plus size={16} /> <span className="font-bold">ì§ì ‘ ì…ë ¥ (ìƒˆ ê±°ë˜ì²˜)</span>
                        </div>
                        <div onClick={() => { setSelectedSupplier(null); setIsCustomMode(false); }} className={`p-3 border rounded-lg cursor-pointer transition-all flex items-center gap-2 ${!selectedSupplier && !isCustomMode ? 'bg-slate-800 text-white shadow-lg' : 'bg-white hover:bg-slate-50'}`}>
                            <FileText size={16} /> <span className="font-bold">ì „ì²´ ë³´ê¸°</span>
                        </div>
                        {sortedSuppliers.map(s => (
                            <div key={s.name} onClick={() => { setSelectedSupplier(s.name); setIsCustomMode(false); }} className={`p-3 border rounded-lg cursor-pointer transition-all ${selectedSupplier === s.name && !isCustomMode ? 'bg-slate-800 text-white shadow-lg' : 'bg-white hover:bg-slate-50'}`}>
                                <div className="flex justify-between items-center mb-1"><span className="font-bold">{s.name}</span>{s.pickupCnt > 0 && <span className="bg-indigo-500 text-white text-[10px] px-1.5 py-0.5 rounded font-bold animate-pulse">íšŒìˆ˜ {s.pickupCnt}</span>}</div>
                                <div className="text-xs opacity-70">ì§„í–‰ì¤‘ {s.activeCnt}ê±´ / ì´ {s.items.length}ê±´</div>
                            </div>
                        ))}
                    </div>
                    <div className="w-full md:w-2/3 bg-white border rounded-xl p-4 md:p-6 flex flex-col overflow-hidden">
                        <div className="mb-4 pb-4 border-b flex-shrink-0 flex justify-between">
                            {isCustomMode ? <input className="text-2xl font-bold border-b border-gray-300 focus:border-indigo-500 outline-none w-full" placeholder="ê±°ë˜ì²˜ëª… ì…ë ¥" value={batchHeader.supplier} onChange={e => setBatchHeader({...batchHeader, supplier: e.target.value})}/> : <h2 className="text-2xl font-bold truncate">{selectedSupplier || "ì „ì²´ ë°œì£¼ ë‚´ì—­"}</h2>}
                            <button onClick={() => setQuickAdd(!quickAdd)} className="bg-indigo-600 text-white px-3 py-1.5 rounded text-sm font-bold flex items-center gap-1 flex-shrink-0 ml-2"><Plus size={14} /> ìì¬ ë“±ë¡</button>
                        </div>
                        {(quickAdd || isCustomMode) && (
                            <div className="mb-4 p-3 bg-indigo-50 rounded border border-indigo-100 animate-fade-in flex-shrink-0">
                                <div className="flex gap-2 mb-2">
                                    <input type="date" className="border p-2 rounded text-sm w-1/3 min-w-[120px]" value={batchHeader.date} onChange={e => setBatchHeader({ ...batchHeader, date: e.target.value })} />
                                    <select className="border p-2 rounded flex-1 text-sm min-w-0" value={batchHeader.orderId} onChange={e => setBatchHeader({ ...batchHeader, orderId: e.target.value })}>
                                        <option value="">í”„ë¡œì íŠ¸ ì„ íƒ (ì—†ìœ¼ë©´ ê¸°íƒ€)</option>
                                        {orders.filter(o => !['ë‚©í’ˆì™„ë£Œ'].includes(o.status)).map(o => <option key={o.id} value={o.id}>{o.itemName}</option>)}
                                    </select>
                                </div>
                                {isCustomMode && (
                                    <div className="mb-2 space-y-2 p-2 bg-white rounded border border-indigo-100">
                                        <div className="text-xs font-bold text-indigo-900">ì‹ ê·œ ê±°ë˜ì²˜ ì •ë³´ (íšŒìˆ˜ ë™ì„ ì— ì‚¬ìš©ë¨)</div>
                                        <div className="flex gap-2">
                                            <input placeholder="ì „í™”ë²ˆí˜¸" className="border p-2 rounded flex-1 text-sm" value={newSupplierInfo.phone} onChange={e => setNewSupplierInfo({...newSupplierInfo, phone: e.target.value})} />
                                            <input placeholder="ì´ë©”ì¼" className="border p-2 rounded flex-1 text-sm" value={newSupplierInfo.email} onChange={e => setNewSupplierInfo({...newSupplierInfo, email: e.target.value})} />
                                        </div>
                                        <input placeholder="ì£¼ì†Œ (ë„¤ì´ë²„ ì§€ë„ ì—°ë™)" className="border p-2 rounded w-full text-sm" value={newSupplierInfo.address} onChange={e => setNewSupplierInfo({...newSupplierInfo, address: e.target.value})} />
                                    </div>
                                )}
                                <div className="flex gap-4 text-sm p-1 mb-2">
                                    <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="quickAddType" checked={quickAddType === 'ë°œì£¼'} onChange={()=>setQuickAddType('ë°œì£¼')}/> <span>êµ¬ë§¤ (ë°œì£¼)</span></label>
                                    <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="quickAddType" checked={quickAddType === 'ì ‘ìˆ˜'} onChange={()=>setQuickAddType('ì ‘ìˆ˜')}/> <span>ê°€ê³µ (ì ‘ìˆ˜)</span></label>
                                    <label className="flex items-center gap-2 cursor-pointer"><input type="radio" name="quickAddType" checked={quickAddType === 'ë°°ì°¨'} onChange={()=>setQuickAddType('ë°°ì°¨')}/> <span>ë°°ì°¨</span></label>
                                </div>
                                {batchItems.map((row, index) => (
                                    <div key={row.id} className="flex gap-2 items-center mb-2">
                                        <input placeholder="í’ˆëª©ëª…" className="border p-2 rounded flex-1 text-sm" value={row.item} onChange={e => updateRow(row.id, 'item', e.target.value)} />
                                        <input placeholder="ìˆ˜ëŸ‰" className="border p-2 rounded w-20 text-sm" value={row.quantity} onChange={e => updateRow(row.id, 'quantity', e.target.value)} />
                                        <button onClick={() => removeRow(row.id)} className="text-gray-400 hover:text-red-500"><X size={18} /></button>
                                    </div>
                                ))}
                                <button onClick={addRow} className="text-xs text-indigo-600 font-bold flex items-center gap-1 hover:underline mt-1 mb-2"><Plus size={14}/> í’ˆëª© ì¶”ê°€í•˜ê¸°</button>
                                <button onClick={handleBatchAdd} className="w-full bg-indigo-600 text-white py-2 rounded font-bold text-sm">ë“±ë¡</button>
                            </div>
                        )}
                        <div className="flex-1 overflow-y-auto scroll-touch">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 border-b sticky top-0"><tr><th className="p-2 w-16">ìƒíƒœ</th>{!selectedSupplier && <th className="p-2 w-20">ê±°ë˜ì²˜</th>}<th className="p-2">í’ˆëª©/ìˆ˜ëŸ‰</th><th className="p-2 text-right w-16">ê´€ë¦¬</th></tr></thead>
                                <tbody>
                                    {displayedMaterials.map((m, i) => (
                                        <tr key={i} className="border-b hover:bg-slate-50 group">
                                            <td className="p-2 align-top pt-3"><MaterialStatusBadge status={m.status} onClick={() => toggleStatus(m)} /></td>
                                            {!selectedSupplier && <td className="p-2 align-top pt-3 font-bold text-slate-700 text-xs break-words">{m.supplier}</td>}
                                            <td className="p-2">
                                                <div className="text-[10px] text-gray-400 mb-0.5">{m.date}</div>
                                                <div className="font-bold text-slate-700">{m.item}</div>
                                                <div className="text-xs text-gray-500">{m.quantity}</div>
                                                <div className="text-[10px] text-indigo-500 mt-0.5">{m.orderName}</div>
                                            </td>
                                            <td className="p-2 text-right align-top pt-2 flex justify-end gap-1">
                                                <button onClick={()=>setEditingMaterial({...m})} className="p-1.5 hover:bg-blue-100 text-blue-600 rounded opacity-0 group-hover:opacity-100 transition-opacity"><Edit3 size={14}/></button>
                                                <button onClick={()=>handleDelete(m)} className="p-1.5 hover:bg-red-100 text-red-600 rounded opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 size={14}/></button>
                                            </td>
                                        </tr>
                                    ))}
                                    {displayedMaterials.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-gray-400">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* ğŸŒŸ ìì¬ ìˆ˜ì • íŒì—… (ëª¨ë‹¬) ì¶”ê°€ */}
                    {editingMaterial && (
                        <ModalOverlay onClose={() => setEditingMaterial(null)}>
                            <div className="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl animate-fade-in" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg">ìì¬ ë‚´ìš© ìˆ˜ì •</h3>
                                    <button onClick={()=>setEditingMaterial(null)}><X size={20}/></button>
                                </div>
                                <div className="space-y-3 mb-4">
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 block mb-1">ê±°ë˜ì²˜</label>
                                        <input className="border p-2 rounded w-full text-sm" value={editingMaterial.supplier} onChange={e => setEditingMaterial({ ...editingMaterial, supplier: e.target.value })} />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 block mb-1">í’ˆëª©ëª…</label>
                                        <input className="border p-2 rounded w-full text-sm" value={editingMaterial.item} onChange={e => setEditingMaterial({ ...editingMaterial, item: e.target.value })} />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500 block mb-1">ìˆ˜ëŸ‰</label>
                                        <input className="border p-2 rounded w-full text-sm" value={editingMaterial.quantity} onChange={e => setEditingMaterial({ ...editingMaterial, quantity: e.target.value })} />
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setEditingMaterial(null)} className="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-600">ì·¨ì†Œ</button>
                                    <button onClick={handleEditSave} className="flex-1 bg-indigo-600 py-3 rounded-xl font-bold text-white shadow-lg">ì €ì¥</button>
                                </div>
                            </div>
                        </ModalOverlay>
                    )}
                </div>
            );
        };

        // --- Main App Component ---

        function App() {
            const [user, setUser] = useState(null);
            const [orders, setOrders] = useState([]);
            const [schedules, setSchedules] = useState([]); 
            const [workers, setWorkers] = useState([]); // ğŸŒŸ ì‘ì—…ì ìƒíƒœ ì¶”ê°€
            const [loading, setLoading] = useState(true);
            const [isOnline, setIsOnline] = useState(false);
            const [connectionError, setConnectionError] = useState(null);
            
            const [isAuthenticated, setIsAuthenticated] = useState(() => localStorage.getItem('bk_auth') === 'true');
            const [isAdmin, setIsAdmin] = useState(() => localStorage.getItem('bk_role') === 'admin');

            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedOrder, setSelectedOrder] = useState(null);
            // ğŸŒŸ [ìˆ˜ì •] ì´ì „ í™”ë©´ì„ ê¸°ì–µí•˜ê¸° ìœ„í•œ ìƒíƒœ ë³€ìˆ˜ ì¶”ê°€
            const [returnView, setReturnView] = useState('list');
            
            const [urgentCount, setUrgentCount] = useState(0);
            const [showAlertPopup, setShowAlertPopup] = useState(false);
            const [showLogPopup, setShowLogPopup] = useState(false); 

            const [statusPopupOrder, setStatusPopupOrder] = useState(null);
            const [pendingStatus, setPendingStatus] = useState(null);
            
            const [materialPopupData, setMaterialPopupData] = useState(null);
            const [logs, setLogs] = useState([]); 
            
            const hasCheckedCleanup = useRef(false);
            const hasCheckedFileExpiration = useRef(false);
            const hasSeededWorkers = useRef(false); // ì‘ì—…ì ì´ˆê¸°í™” ì²´í¬

            const menuItems = [
                { id: 'dashboard', icon: LayoutDashboard, label: 'í˜„í™©' },
                { id: 'calendar', icon: CalendarIcon, label: 'ì¼ì •' },
                { id: 'list', icon: FileText, label: 'ì‘ì—…' },
                { id: 'materials', icon: Truck, label: 'ë°œì£¼' },
            ];

            useEffect(() => {
                const handlePopState = (e) => {
                    if (currentView === 'detail' || currentView === 'form') {
                        setSelectedOrder(null);
                        // ğŸŒŸ [ìˆ˜ì •] ë¬´ì¡°ê±´ 'list'ê°€ ì•„ë‹ˆë¼ ì €ì¥ëœ returnViewë¡œ ë³µê·€
                        setCurrentView(returnView);
                    }
                };

                window.addEventListener('popstate', handlePopState);
                return () => window.removeEventListener('popstate', handlePopState);
            }, [currentView, returnView]); // ğŸŒŸ ì˜ì¡´ì„± ë°°ì—´ì— returnView ì¶”ê°€

            const { auth, db, storage, appId } = useMemo(() => {
                try {
                    const app = initializeApp(firebaseConfig);
                    return { auth: getAuth(app), db: getFirestore(app), storage: getStorage(app), appId: firebaseConfig.appId };
                } catch (e) { 
                    return { auth: null, db: null, storage: null, appId: null }; 
                }
            }, []);

            useEffect(() => {
                let unsubAuth = null;
                const init = async () => {
                    if (!auth) { setOrders(MOCK_DATA); setLoading(false); return; }
                    try { await signInAnonymously(auth); } 
                    catch (error) { setConnectionError("ì¸ì¦ ì‹¤íŒ¨"); setOrders(MOCK_DATA); setLoading(false); return; }
                    unsubAuth = onAuthStateChanged(auth, (u) => { setUser(u); if (!u) { setOrders(MOCK_DATA); setLoading(false); } });
                };
                init();
                return () => { if (unsubAuth) unsubAuth(); }
            }, [auth]);

            // Data Subscriptions
            useEffect(() => {
                if (!user || !db) return;

                // 1. Orders
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderBy('createdAt', 'desc'));
                const unsubOrders = onSnapshot(q, (snap) => {
                    setOrders(snap.docs.map(d => ({ id: d.id, ...d.data() }))); 
                    setIsOnline(true); setLoading(false);
                }, () => { setIsOnline(false); setOrders(MOCK_DATA); setLoading(false); });

                // 2. Schedules
                const sQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'schedules'));
                const unsubSchedules = onSnapshot(sQ, (snap) => {
                    setSchedules(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                // 3. Workers (ğŸŒŸ New)
                const wQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'workers'), orderBy('createdAt', 'asc'));
                const unsubWorkers = onSnapshot(wQ, (snap) => {
                    if (snap.empty && !hasSeededWorkers.current) {
                        // DBê°€ ë¹„ì–´ìˆìœ¼ë©´ ì´ˆê¸° ë Œë”ë§ ì‹œì—ëŠ” ê¸°ë³¸ê°’ ì‚¬ìš© (ìë™ ì €ì¥ì€ í•˜ì§€ ì•ŠìŒ)
                        setWorkers(DEFAULT_WORKERS.map(name => ({ id: name, name }))); 
                    } else {
                        setWorkers(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    }
                    hasSeededWorkers.current = true;
                });

                // 4. Logs
                let unsubLogs = null;
                if (isAdmin) {
                    const logQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), orderBy('createdAt', 'desc'), limit(50));
                    unsubLogs = onSnapshot(logQ, (snap) => setLogs(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                }

                return () => { unsubOrders(); unsubSchedules(); unsubWorkers(); if(unsubLogs) unsubLogs(); };
            }, [user, db, appId, isAdmin]);

            // ğŸŒŸ ì‘ì—…ì ì¶”ê°€/ì‚­ì œ í•¨ìˆ˜
            const addWorker = async (name) => {
                if (!db || !isOnline) return;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'workers'), {
                        name,
                        createdAt: serverTimestamp()
                    });
                } catch (e) { alert("ì¶”ê°€ ì‹¤íŒ¨: " + e.message); }
            };

            const deleteWorker = async (id) => {
                if (!db || !isOnline) return;
                if (!window.confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                try {
                    // IDê°€ ì´ë¦„ê³¼ ê°™ìœ¼ë©´(ì´ˆê¸°ê°’) ì‹¤ì œ ë¬¸ì„œ IDê°€ ì—†ì–´ì„œ ì‚­ì œ ë¶ˆê°€í•˜ë¯€ë¡œ ê²½ê³ 
                    if (DEFAULT_WORKERS.includes(id) && !workers.some(w => w.id === id && w.createdAt)) {
                        alert("ê¸°ë³¸ ì‘ì—…ìëŠ” DBì— ì €ì¥ë˜ê¸° ì „ê¹Œì§€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ì‘ì—…ìë¥¼ ì¶”ê°€í•˜ë©´ DBê°€ í™œì„±í™”ë©ë‹ˆë‹¤.");
                        return;
                    }
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'workers', id));
                } catch (e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); }
            };

            // Auto Cleanup Logics (File expiration only)
            useEffect(() => {
                if (orders.length > 0 && isOnline && db && storage && !hasCheckedFileExpiration.current) {
                    const checkExpiredFiles = async () => {
                        const now = new Date();
                        const col = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                        for (const order of orders) {
                            if (order.status === 'ë‚©í’ˆì™„ë£Œ' && order.completedDate && (order.files && order.files.length > 0)) {
                                const diffTime = Math.abs(now - new Date(order.completedDate));
                                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                                if (diffDays > 7) {
                                    try {
                                        for (const file of order.files) {
                                            if (file.fullPath) await deleteObject(ref(storage, file.fullPath));
                                            else if (file.url) await deleteObject(ref(storage, file.url));
                                        }
                                        await updateDoc(doc(col, order.id), { files: [] });
                                    } catch (err) { console.warn("Cleanup failed", err); }
                                }
                            }
                        }
                    };
                    checkExpiredFiles();
                    hasCheckedFileExpiration.current = true;
                }
            }, [orders, isOnline, db, storage, appId]);

            useEffect(() => {
                const urgent = orders.filter(o => o.deliveryDate && !['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(o.status) && Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2).length;
                setUrgentCount(urgent);
            }, [orders]);

            const handleLogin = (role) => {
                setIsAuthenticated(true);
                setIsAdmin(role === 'admin');
                localStorage.setItem('bk_auth', 'true');
                localStorage.setItem('bk_role', role);
            };

            const saveOrder = async (data, logInfo = null) => {
                if (!isOnline || !db) return alert("ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤.");
                try {
                    const col = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                    if (data.id && !data.id.startsWith('mock')) await updateDoc(doc(col, data.id), { ...data, updatedAt: serverTimestamp() });
                    else {
                        const { id, ...rest } = data; 
                        await addDoc(col, { ...rest, displayId: `ORD-24-${Math.floor(100 + Math.random() * 900)}`, createdAt: serverTimestamp(), userId: user?.uid });
                    }
                    if (logInfo && !isAdmin) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), { ...logInfo, createdAt: serverTimestamp(), userId: user?.uid });
                } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
            };

            // ğŸŒŸ ìŠ¤ì¼€ì¤„ ì €ì¥/ìˆ˜ì • í•¨ìˆ˜
            const updateSchedule = async (scheduleData) => {
                if (!isOnline || !db) return;
                try {
                    const col = collection(db, 'artifacts', appId, 'public', 'data', 'schedules');
                    if(scheduleData.content.trim() === '') {
                        // ë‚´ìš©ì´ ë¹„ë©´ ì‚­ì œ
                        await deleteDoc(doc(col, scheduleData.id));
                    } else {
                        await updateDoc(doc(col, scheduleData.id), { content: scheduleData.content, updatedAt: serverTimestamp() });
                    }
                } catch(e) { console.error(e); }
            };

            const addSchedule = async (scheduleData) => {
                if (!isOnline || !db) return;
                if (scheduleData.content.trim() === '') return;
                try {
                    const col = collection(db, 'artifacts', appId, 'public', 'data', 'schedules');
                    await addDoc(col, { 
                        worker: scheduleData.worker, 
                        date: scheduleData.date, 
                        content: scheduleData.content, 
                        createdAt: serverTimestamp() 
                    });
                } catch(e) { console.error(e); }
            };

            const executeStatusChange = async () => {
                if(!statusPopupOrder || !pendingStatus) return;
                const newData = { ...statusPopupOrder, status: pendingStatus };
                if (['ë‚©í’ˆì™„ë£Œ', 'ë‚©í’ˆëŒ€ê¸°'].includes(pendingStatus) && !statusPopupOrder.completedDate) newData.completedDate = new Date().toISOString().split('T')[0];
                await saveOrder(newData, { type: 'status', msg: `ìƒíƒœ ë³€ê²½: ${statusPopupOrder.status} â†’ ${pendingStatus}` }); 
                setPendingStatus(null); setStatusPopupOrder(null);
            };
            
            const executeMaterialStatusChange = async () => {
                if (!materialPopupData) return;
                const { material, nextStatus } = materialPopupData;
                const order = orders.find(o => o.id === material.orderId);
                if (order) {
                    // ğŸŒŸ FIX: Handle undefined completedAt by defaulting to null
                    const updated = order.materials.map(x => x.id === material.id ? { 
                        ...x, 
                        status: nextStatus, 
                        completedAt: nextStatus === 'íšŒìˆ˜ì™„ë£Œ' ? new Date().toISOString() : (x.completedAt || null) 
                    } : x);
                    await saveOrder({ ...order, materials: updated }, { type: 'material', msg: `ìì¬ ë³€ê²½: ${material.item} (${material.status} â†’ ${nextStatus})` });
                }
                setMaterialPopupData(null);
            };

            const stats = useMemo(() => ({
                ongoing: orders.filter(o => !['ë‚©í’ˆì™„ë£Œ'].includes(o.status)).length,
                pickup: orders.reduce((acc, cur) => acc + (cur.materials || []).filter(m => m.status === 'íšŒìˆ˜ëŒ€ê¸°').length, 0),
                urgent: urgentCount,
                completed: orders.filter(o => ['ë‚©í’ˆì™„ë£Œ'].includes(o.status)).length,
                pendingDelivery: orders.filter(o => o.status === 'ë‚©í’ˆëŒ€ê¸°').length
            }), [orders, urgentCount]);

            const suppliers = useMemo(() => {
                const s = {};
                orders.forEach(o => (o.materials || []).forEach(m => {
                    if (!s[m.supplier]) s[m.supplier] = [];
                    s[m.supplier].push({ ...m, orderId: o.id, orderName: o.itemName });
                }));
                return s;
            }, [orders]);

            const handleNavigate = (order) => {
                // ğŸŒŸ [ìˆ˜ì •] ìƒì„¸ í˜ì´ì§€ë¡œ ê°€ê¸° ì „ì— í˜„ì¬ ë·°ë¥¼ ì €ì¥
                setReturnView(currentView);
                window.history.pushState({ page: 'detail' }, '', '');
                setSelectedOrder(order); setCurrentView('detail'); setShowAlertPopup(false);
            };
            
            if (!isAuthenticated) return <LoginView onLogin={handleLogin} />;
            if (loading) return <div className="flex h-screen items-center justify-center bg-slate-100 flex-col gap-4"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-slate-800"></div><p className="text-slate-500 text-sm animate-pulse">ì‹œìŠ¤í…œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>;

            return (
                <div className="flex flex-col-reverse md:flex-row h-[100dvh] bg-slate-100 font-sans text-slate-800 overflow-hidden">
                    {/* Navigation Bar: ëª¨ë°”ì¼(í•˜ë‹¨), ë°ìŠ¤í¬íƒ‘(ì¢Œì¸¡) */}
                    <div className="w-full md:w-60 bg-slate-900 text-slate-300 flex flex-row md:flex-col flex-shrink-0 z-20 border-t md:border-t-0 border-slate-700 md:border-none safe-area-bottom">
                        {/* ë¡œê³  ì˜ì—­: ëª¨ë°”ì¼ì—ì„œëŠ” ìˆ¨ê¹€, ë°ìŠ¤í¬íƒ‘ì—ì„œë§Œ í‘œì‹œ */}
                        <div className="hidden md:flex p-4 items-center gap-3 justify-start font-bold text-xl text-white">
                            <div className="bg-white text-slate-900 rounded px-1 flex-shrink-0">BK</div>
                            <span className="text-sm whitespace-nowrap">ìˆ¨ì‰¬ëŠ” ê¹¡í†µ</span>
                        </div>
                        
                        {/* ë©”ë‰´ ë²„íŠ¼ ì˜ì—­ */}
                        <nav className="flex-1 flex flex-row md:flex-col justify-around md:justify-start items-center md:items-stretch p-0 md:p-2 md:space-y-2">
                            {menuItems.map(m => (
                                <button key={m.id} onClick={() => { setCurrentView(m.id); setSelectedOrder(null); }} 
                                    className={`
                                        flex-1 md:flex-none
                                        flex flex-col md:flex-row items-center justify-center md:justify-start
                                        gap-1 md:gap-3
                                        py-3 md:py-3 px-1 md:px-4
                                        rounded-none md:rounded-lg
                                        transition-colors
                                        ${currentView === m.id ? 'bg-indigo-600 text-white' : 'hover:bg-slate-800 text-slate-400 hover:text-slate-100'}
                                    `}
                                >
                                    <m.icon size={20} className="mb-0.5 md:mb-0" />
                                    <span className="text-[10px] md:text-sm font-bold md:font-normal">{m.label}</span>
                                </button>
                            ))}
                        </nav>
                        
                        {/* í•˜ë‹¨ ì •ë³´ ì˜ì—­: ëª¨ë°”ì¼ì—ì„œëŠ” ìˆ¨ê¹€ */}
                        <div className="hidden md:block p-4 text-xs text-slate-500 text-center md:text-left">
                            <div className="font-bold text-slate-300 mb-1">{isAdmin ? 'ADMIN' : 'STAFF'}</div>
                            <div className={`flex items-center gap-1 justify-center md:justify-start ${isOnline ? 'text-green-500' : 'text-red-500'}`}>
                                <Wifi size={10}/> {isOnline ? 'Online' : 'Offline'}
                            </div>
                        </div>
                    </div>

                    <main className="flex-1 flex flex-col overflow-hidden relative bg-slate-100 z-10">
                        <header className="h-14 md:h-16 bg-white border-b flex items-center justify-between px-4 md:px-6 shadow-sm flex-shrink-0 relative">
                            <h2 className="font-bold text-lg md:text-xl uppercase text-slate-800">
                                {currentView === 'dashboard' && 'í˜„í™©'}
                                {currentView === 'calendar' && 'ì¼ì •'}
                                {currentView === 'list' && 'ì‘ì—…'}
                                {currentView === 'materials' && 'ë°œì£¼'}
                                {currentView === 'detail' && 'ì‘ì—… ìƒì„¸'}
                                {currentView === 'form' && (selectedOrder ? 'ì‘ì—… ìˆ˜ì •' : 'ìƒˆ ì‘ì—… ë“±ë¡')}
                            </h2>
                            <div className="flex items-center gap-3">
                                {/* ëª¨ë°”ì¼ì—ì„œë§Œ ë³´ì´ëŠ” ìƒíƒœ í‘œì‹œê¸° (ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸) */}
                                <div className={`md:hidden flex items-center gap-1 text-[10px] ${isOnline ? 'text-green-500' : 'text-red-500'}`}>
                                    <Wifi size={14}/>
                                </div>

                                {isAdmin && (
                                    <button onClick={()=>setShowLogPopup(!showLogPopup)} className="p-2 bg-yellow-100 text-yellow-600 hover:bg-yellow-200 rounded-full relative shadow-sm">
                                        <ShieldAlert size={20} />
                                        {logs.length > 0 && <span className="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>}
                                    </button>
                                )}
                                <div className="relative">
                                    <button onClick={()=>setShowAlertPopup(!showAlertPopup)} className="p-2 hover:bg-slate-100 rounded-full relative"><Bell className="text-slate-600" /></button>
                                </div>
                            </div>
                        </header>

                        <div className="h-full overflow-y-auto p-4 md:p-6 scroll-touch">
                            <div className={`max-w-5xl mx-auto ${['calendar', 'materials', 'detail'].includes(currentView) ? 'h-full' : ''}`}>
                                {currentView === 'dashboard' && <Dashboard orders={orders} stats={stats} suppliers={suppliers} onNavigate={handleNavigate} onStatusClick={setStatusPopupOrder} isAdmin={isAdmin} currentUserId={user?.uid} />}
                                {currentView === 'calendar' && (
                                    <CalendarView 
                                        orders={orders} 
                                        onSelect={handleNavigate} 
                                        scheduleData={schedules} 
                                        onUpdateSchedule={updateSchedule} 
                                        onAddSchedule={addSchedule} 
                                        workers={workers}
                                        onAddWorker={addWorker}
                                        onDeleteWorker={deleteWorker}
                                    />
                                )}
                                {/* ğŸŒŸ [ìˆ˜ì •] ì‘ì—… ë“±ë¡ ì‹œì—ëŠ” 'list'ë¡œ ëŒì•„ê°€ë„ë¡ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì • */}
                                {currentView === 'list' && !selectedOrder && <ListView orders={orders} onSelect={handleNavigate} onAdd={() => { setReturnView('list'); window.history.pushState({ page: 'form' }, '', ''); setSelectedOrder(null); setCurrentView('form'); }} onStatusClick={setStatusPopupOrder} />}
                                {currentView === 'detail' && <DetailView order={selectedOrder} onBack={() => window.history.back()} onUpdate={(data, logInfo, navigate, msg) => { if(data === null && logInfo === 'form') { window.history.pushState({ page: 'form' }, '', ''); setCurrentView('form'); } else { saveOrder(data, msg); } }} isAdmin={isAdmin} currentUserId={user?.uid} onStatusClick={setStatusPopupOrder} onMaterialStatusClick={(m, next)=>setMaterialPopupData({material:m, nextStatus:next})} />}
                                {currentView === 'form' && <FormView order={selectedOrder} storage={storage} onSave={(data, logInfo) => { saveOrder(data, logInfo); window.history.back(); }} onDelete={async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id)); window.history.back(); }} onCancel={() => window.history.back()} isAdmin={isAdmin} currentUserId={user?.uid} />}
                                {currentView === 'materials' && <MaterialManageView suppliers={suppliers} orders={orders} onUpdateOrder={saveOrder} onMaterialStatusClick={(m, next)=>setMaterialPopupData({material:m, nextStatus:next})} />}
                            </div>
                        </div>

                        {statusPopupOrder && !pendingStatus && (
                            <ModalOverlay onClose={() => setStatusPopupOrder(null)}>
                                <div className="bg-white w-full max-w-xs rounded-xl shadow-2xl p-4 animate-fade-in" onClick={e=>e.stopPropagation()}>
                                    <h3 className="font-bold text-center mb-4 text-lg">ìƒíƒœ ë³€ê²½</h3>
                                    <div className="grid gap-2">
                                        {/* ğŸŒŸ ìì¬ë°œì£¼ì¤‘ ë²„íŠ¼ ì¶”ê°€ */}
                                        {['ì„¤ê³„ì¤‘', 'ìì¬ë°œì£¼ì¤‘', 'ì‘ì—…ì¤‘', 'ì‘ì—…ì™„ë£Œ', 'ë„ì¥/ë§ˆê°ì¤‘', 'ë‚©í’ˆëŒ€ê¸°', 'ë‚©í’ˆì™„ë£Œ'].map(st => (
                                            <button key={st} onClick={() => setPendingStatus(st)} className={`py-3 rounded-lg font-bold text-sm transition-colors ${statusPopupOrder.status === st ? 'bg-slate-800 text-white' : 'bg-slate-50 hover:bg-slate-100 text-slate-700'}`}>{st}</button>
                                        ))}
                                    </div>
                                </div>
                            </ModalOverlay>
                        )}

                        {pendingStatus && (
                            <ModalOverlay onClose={() => setPendingStatus(null)}>
                                <div className="bg-white w-full max-w-xs rounded-xl shadow-2xl p-6 animate-fade-in text-center" onClick={e=>e.stopPropagation()}>
                                    <h3 className="font-bold text-lg mb-2">ìƒíƒœë¥¼ ë³€ê²½í• ê¹Œìš”?</h3>
                                    <div className="flex gap-2 mt-4">
                                        <button onClick={() => setPendingStatus(null)} className="flex-1 bg-gray-200 py-3 rounded-xl font-bold text-gray-600">ì·¨ì†Œ</button>
                                        <button onClick={executeStatusChange} className="flex-1 bg-indigo-600 py-3 rounded-xl font-bold text-white shadow-lg">í™•ì¸</button>
                                    </div>
                                </div>
                            </ModalOverlay>
                        )}
                        
                        {materialPopupData && (
                            <ModalOverlay onClose={() => setMaterialPopupData(null)}>
                                <div className="bg-white w-full max-w-xs rounded-xl shadow-2xl p-6 animate-fade-in text-center" onClick={e=>e.stopPropagation()}>
                                    <h3 className="font-bold text-lg mb-4">ìì¬ ìƒíƒœ ë³€ê²½</h3>
                                    <div className="grid grid-cols-2 gap-2 mb-4">
                                        {['ë°œì£¼', 'ì ‘ìˆ˜', 'ë°°ì°¨', 'íšŒìˆ˜ëŒ€ê¸°', 'íšŒìˆ˜ì™„ë£Œ'].map((status) => (
                                            <button key={status} onClick={() => setMaterialPopupData({ ...materialPopupData, nextStatus: status })} className={`py-2 rounded text-xs font-bold border transition-all ${materialPopupData.nextStatus === status ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}>{status}</button>
                                        ))}
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setMaterialPopupData(null)} className="flex-1 bg-gray-200 py-2 rounded font-bold text-gray-600 text-xs">ì·¨ì†Œ</button>
                                        <button onClick={executeMaterialStatusChange} className="flex-1 bg-indigo-600 py-2 rounded font-bold text-white shadow-lg text-xs">ë³€ê²½í•˜ê¸°</button>
                                    </div>
                                </div>
                            </ModalOverlay>
                        )}
                        
                         {/* Log Popup */}
                        {showLogPopup && isAdmin && (
                            <ModalOverlay onClose={() => setShowLogPopup(false)}>
                                <div className="bg-white w-full max-w-sm rounded-xl shadow-2xl overflow-hidden animate-fade-in" onClick={e=>e.stopPropagation()}>
                                    <div className="bg-yellow-50 p-3 border-b border-yellow-100 flex justify-between items-center">
                                        <h4 className="font-bold text-sm flex items-center gap-2 text-yellow-800"><History size={16}/> ìŠ¤íƒœí”„ í™œë™ ê¸°ë¡</h4>
                                        <button onClick={()=>setShowLogPopup(false)}><X size={16} className="text-yellow-600"/></button>
                                    </div>
                                    <div className="max-h-[60vh] overflow-y-auto scroll-touch p-2 space-y-1">
                                        {logs.length === 0 && <div className="text-xs text-gray-400 text-center py-8">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                                        {logs.map(log => (
                                            <div key={log.id} className="text-xs p-3 hover:bg-slate-50 rounded border-b last:border-0">
                                                <div className="flex justify-between items-start mb-1">
                                                    <span className={`font-bold px-2 py-0.5 rounded text-[10px] text-white ${log.type === 'create' ? 'bg-blue-500' : log.type === 'status' ? 'bg-green-500' : 'bg-orange-500'}`}>{log.type}</span>
                                                    <span className="text-gray-400 text-[10px]">{formatTime(log.createdAt)}</span>
                                                </div>
                                                <div className="font-bold text-slate-700 mb-1 text-sm">{log.orderName}</div>
                                                <div className="text-gray-600">{log.message}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </ModalOverlay>
                        )}
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
