import React, { useState, useEffect, useMemo, useRef } from 'react';
import {
  LayoutDashboard, Plus, FileText, Calendar as CalendarIcon,
  Package, ChevronRight, ChevronLeft, Trash2, Edit3, Download, Link as LinkIcon,
  ChevronDown, ChevronUp, Wifi, Mail, CheckCircle2, Factory, ArrowRight,
  Phone, MapPin, Bell, X, Truck, Search, AlertCircle, Map, Sparkles, Paperclip, File, Lock, Key
} from 'lucide-react';

// --- Firebase Imports ---
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import {
  getFirestore, collection, addDoc, updateDoc, deleteDoc,
  doc, onSnapshot, query, orderBy, serverTimestamp
} from 'firebase/firestore';

// --- Gemini API Helper ---
const callGemini = async (prompt) => {
  const apiKey = ""; // API Key is provided by the environment
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
  
  const payload = {
    contents: [{ parts: [{ text: prompt }] }]
  };

  let retries = 0;
  const maxRetries = 3;
  const delays = [1000, 2000, 4000];

  while (retries <= maxRetries) {
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      
      const data = await response.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || "ì‘ë‹µì„ ìƒì„±í•˜ì§€ ëª»í–ˆì–´ìš”.";
    } catch (e) {
      retries++;
      if (retries > maxRetries) {
        console.error("Gemini API failed:", e);
        return "AI ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
      }
      await new Promise(resolve => setTimeout(resolve, delays[retries - 1]));
    }
  }
};

// --- Constants & Mock Data ---
const COMPANY_INFO = {
  name: 'ìˆ¨ì‰¬ëŠ” ê¹¡í†µ',
  address: 'ê²½ê¸°ë„ í¬ì²œì‹œ êµ°ë‚´ë©´ ìœ êµë¦¬ 243-7',
  lat: 37.885, 
  lng: 127.205, 
  mapUrl: 'https://map.naver.com/p/search/ê²½ê¸°ë„ í¬ì²œì‹œ êµ°ë‚´ë©´ ìœ êµë¦¬ 243-7'
};

const SUPPLIER_INFO = {
  'ì„±ìˆ˜ê¸ˆì†': { phone: '02-1234-5678', email: 'order@sungsu.com', address: 'ì„œìš¸ ì„±ë™êµ¬ ì„±ìˆ˜ì´ë¡œ 123', lat: 37.5445, lng: 127.0560 },
  'ì„ì§€ë ˆì´ì €': { phone: '02-2222-3333', email: 'laser@eulji.net', address: 'ì„œìš¸ ì¤‘êµ¬ ì„ì§€ë¡œ 4ê°€ 56', lat: 37.5660, lng: 126.9950 },
  'ì²­ê³„ë„ì¥': { phone: '02-3333-4444', email: 'paint@chunggye.com', address: 'ì„œìš¸ ì¤‘êµ¬ ì²­ê³„ì²œë¡œ 789', lat: 37.5690, lng: 127.0100 },
  'íƒœì–‘ë³¼íŠ¸': { phone: '02-5555-6666', email: 'bolt@sun.com', address: 'ì„œìš¸ êµ¬ë¡œêµ¬ êµ¬ë¡œë™ 11', lat: 37.4850, lng: 126.8850 },
  'ëŒ€í•œì•„í¬ë¦´': { phone: '02-7777-8888', email: 'acryl@daehan.com', address: 'ì„œìš¸ ì¤‘êµ¬ ë°©ì‚°ì‹œì¥ Aë™', lat: 37.5670, lng: 127.0000 }
};

// Mock data remains for fallback, but real logic relies on Firestore
const MOCK_DATA = []; 

// --- Helper Function: Distance Calculation (Haversine) ---
const getDistance = (lat1, lon1, lat2, lon2) => {
  const R = 6371; 
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
};

// --- Helper Components ---
const StatusBadge = ({ status }) => {
  const colors = {
    'ëŒ€ê¸°': 'bg-gray-100 text-gray-600',
    'ì„¤ê³„ì¤‘': 'bg-blue-100 text-blue-700',
    'ì œì‘ì¤‘': 'bg-amber-100 text-amber-700',
    'ë„ì¥/ë§ˆê°': 'bg-purple-100 text-purple-700',
    'ì™„ë£Œëœ ì‘ì—…': 'bg-slate-200 text-slate-500 font-medium',
    'ë‚©í’ˆì™„ë£Œ': 'bg-green-100 text-green-700',
  };
  return <span className={`flex-shrink-0 px-2 py-1 rounded-full text-xs font-bold whitespace-nowrap ${colors[status] || 'bg-gray-100'}`}>{status}</span>;
};

const MaterialStatusBadge = ({ status }) => {
  const colors = {
    'ë°œì£¼ì¤‘': 'bg-yellow-100 text-yellow-700',
    'ì œì‘ì™„ë£Œ': 'bg-indigo-100 text-indigo-700 font-bold animate-pulse',
    'ì…ê³ ì™„ë£Œ': 'bg-green-100 text-green-700',
  };
  return <span className={`flex-shrink-0 px-2 py-0.5 rounded text-[11px] whitespace-nowrap ${colors[status] || 'bg-gray-100'}`}>{status}</span>;
};

const Card = ({ children, className = "", onClick }) => (
  <div onClick={onClick} className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>{children}</div>
);

// --- Login Gate Component ---
const LoginView = ({ onLogin }) => {
  const [code, setCode] = useState('');
  const [error, setError] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (code === '4545') {
      onLogin('employee');
    } else if (code === '2203') {
      onLogin('admin');
    } else {
      setError('ì¸ì¦ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì•„! ë‹¤ì‹œ í™•ì¸í•´ ì¤˜ ğŸ¥º');
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
      <Card className="w-full max-w-md p-8 space-y-6 shadow-xl">
        <div className="text-center space-y-2">
          <div className="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
            <Lock className="text-indigo-600" size={32} />
          </div>
          <h1 className="text-2xl font-bold text-slate-800">ìˆ¨ì‰¬ëŠ” ê¹¡í†µ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
          <p className="text-slate-500">íšŒì‚¬ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        </div>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <input 
              type="password" 
              value={code}
              onChange={(e) => {setCode(e.target.value); setError('');}}
              placeholder="ì¸ì¦ ì½”ë“œ ì…ë ¥ (4ìë¦¬)"
              className="w-full text-center text-2xl tracking-widest p-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all"
              maxLength={4}
              autoFocus
            />
            {error && <p className="text-red-500 text-sm text-center mt-2 font-bold animate-pulse">{error}</p>}
          </div>
          <button 
            type="submit"
            className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2"
          >
            <Key size={20}/> ì…ì¥í•˜ê¸°
          </button>
        </form>
        {/* ì½”ë“œ íŒíŠ¸ ì‚­ì œë¨! ì´ì œ ë³´ì•ˆ ì² ì €í•´! */}
      </Card>
    </div>
  );
};

// --- Sub Components ---

const Dashboard = ({ orders, stats, suppliers, onNavigate, isAdmin, currentUserId }) => {
  const [activeStat, setActiveStat] = useState(null);
  const [activeRoutePopup, setActiveRoutePopup] = useState(null);
  const [aiBriefing, setAiBriefing] = useState(null);
  const [isGeneratingBriefing, setIsGeneratingBriefing] = useState(false);

  // --- AI Feature: Generate Daily Briefing ---
  const generateBriefing = async () => {
    setIsGeneratingBriefing(true);
    const urgentTasks = orders.filter(o => {
        if (!o.deliveryDate || ['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status)) return false;
        return Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2;
    }).map(o => `${o.itemName}(${o.deliveryDate}ë§ˆê°)`).join(', ');

    const prompt = `
      ë„ˆëŠ” ê¸ˆì† ì¸í…Œë¦¬ì–´ íšŒì‚¬ 'ìˆ¨ì‰¬ëŠ” ê¹¡í†µ'ì˜ ë°ì´í„° ë¶„ì„ê°€ì•¼.
      ì˜¤ëŠ˜ì˜ ì‘ì—… í˜„í™©ì„ ë°”íƒ•ìœ¼ë¡œ íŒ€ì›ë“¤ì—ê²Œ ê³µìœ í•  'ì¼ì¼ ë¸Œë¦¬í•‘'ì„ ì‘ì„±í•´ ì¤˜.
      
      [í˜„í™© ë°ì´í„°]
      - ì§„í–‰ ì¤‘: ${stats.ongoing}ê±´
      - íšŒìˆ˜ ëŒ€ê¸°: ${stats.pickup}ê±´
      - ê¸´ê¸‰(ë§ˆê°ì„ë°•): ${stats.urgent}ê±´ (${urgentTasks || 'ì—†ìŒ'})
      - ì™„ë£Œ: ${stats.completed}ê±´

      **ìš”êµ¬ì‚¬í•­:**
      1. ì¸ì‚¬ë§, ê²©ë ¤ì˜ ë§, ì´ëª¨í‹°ì½˜ ë“± ë¶ˆí•„ìš”í•œ ì—¬ë‹´ì€ ëª¨ë‘ ë¹¼.
      2. ì˜¤ì§ ì‚¬ì‹¤ê³¼ ë°ì´í„°ë§Œ ê°„ê²°í•˜ê²Œ ìš”ì•½í•´ì„œ ê°œì¡°ì‹ìœ¼ë¡œ ì‘ì„±í•´.
      3. 'ê¸´ê¸‰' í•­ëª©ì€ ëˆˆì— ë„ê²Œ í‘œì‹œí•´.
      4. ì „ì²´ ê¸¸ì´ëŠ” 5ì¤„ ì´ë‚´ë¡œ ì œí•œí•´.
    `;

    const result = await callGemini(prompt);
    setAiBriefing(result);
    setIsGeneratingBriefing(false);
  };

  // --- Route Optimization Logic ---
  const optimizedRoute = useMemo(() => {
    const pickupTargets = Object.keys(suppliers).filter(n => 
      suppliers[n].some(m => m.status === 'ì œì‘ì™„ë£Œ')
    );

    if (pickupTargets.length === 0) return [];

    let currentLoc = { lat: COMPANY_INFO.lat, lng: COMPANY_INFO.lng, name: 'start' };
    let unvisited = pickupTargets.map(name => ({
      name,
      lat: SUPPLIER_INFO[name]?.lat || 37.5, 
      lng: SUPPLIER_INFO[name]?.lng || 127.0,
      count: suppliers[name].filter(m => m.status === 'ì œì‘ì™„ë£Œ').length
    }));

    const route = [];

    while (unvisited.length > 0) {
      let nearest = null;
      let minDist = Infinity;
      let nearestIdx = -1;

      unvisited.forEach((node, idx) => {
        const dist = getDistance(currentLoc.lat, currentLoc.lng, node.lat, node.lng);
        if (dist < minDist) {
          minDist = dist;
          nearest = node;
          nearestIdx = idx;
        }
      });

      if (nearest) {
        route.push(nearest);
        currentLoc = nearest; 
        unvisited.splice(nearestIdx, 1);
      } else {
        break;
      }
    }

    return route;
  }, [suppliers]);

  // Get list items based on active stat
  const statList = useMemo(() => {
    if (!activeStat) return [];
    if (activeStat === 'pickup') {
      const list = [];
      orders.forEach(o => (o.materials || []).forEach(m => {
        if (m.status === 'ì œì‘ì™„ë£Œ') {
          list.push({ ...m, orderName: o.itemName, orderId: o.id, type: 'material' });
        }
      }));
      return list;
    }
    
    return orders.filter(o => {
      if (activeStat === 'ongoing') return !['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status);
      if (activeStat === 'urgent') {
         if (!o.deliveryDate || ['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status)) return false;
         return Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2;
      }
      if (activeStat === 'completed') {
          const isDone = ['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status);
          const oneMonthAgo = new Date();
          oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);
          const delDate = new Date(o.deliveryDate);
          return isDone && delDate >= oneMonthAgo;
      }
      return false;
    });
  }, [activeStat, orders]);

  // Stat Modal
  const StatModal = () => {
     if(!activeStat) return null;
     const titles = { ongoing: 'ì§„í–‰ ì¤‘ì¸ ì‘ì—…', pickup: 'íšŒìˆ˜ ëŒ€ê¸° ìì¬', urgent: 'ë§ˆê° ì„ë°• ì‘ì—…', completed: 'ìµœê·¼ ì™„ë£Œëœ ì‘ì—… (30ì¼)' };
     const colors = { ongoing: 'blue', pickup: 'indigo', urgent: 'red', completed: 'slate' };
     const color = colors[activeStat];

     return (
       <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 animate-fade-in" onClick={()=>setActiveStat(null)}>
          <div className="bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]" onClick={e=>e.stopPropagation()}>
             <div className={`bg-${color}-50 p-4 border-b border-${color}-100 flex justify-between items-center`}>
                <h3 className={`font-bold text-${color}-700 flex items-center gap-2`}>
                   {titles[activeStat]} ({statList.length})
                </h3>
                <button onClick={()=>setActiveStat(null)} className="p-1 hover:bg-white rounded-full"><X size={16}/></button>
             </div>
             <div className="flex-1 overflow-y-auto p-2 space-y-2 bg-slate-50">
                {statList.length === 0 && <div className="p-8 text-center text-gray-400 text-sm">í•´ë‹¹í•˜ëŠ” í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                {statList.map((item, i) => (
                   activeStat === 'pickup' ? (
                      <div key={i} className="bg-white p-3 rounded border shadow-sm hover:border-indigo-400 transition-colors" onClick={()=>{
                          const order = orders.find(o=>o.id===item.orderId);
                          if(order) onNavigate(order);
                      }}>
                         <div className="flex justify-between mb-1">
                            <span className="font-bold text-indigo-700 text-sm">{item.supplier}</span>
                            <span className="text-[10px] bg-indigo-100 text-indigo-600 px-1.5 py-0.5 rounded font-bold">ì œì‘ì™„ë£Œ</span>
                         </div>
                         <div className="font-medium text-slate-800">{item.item}</div>
                         <div className="text-xs text-gray-500 mt-1 flex justify-between">
                            <span>{item.quantity}</span>
                            <span className="text-indigo-400">Project: {item.orderName}</span>
                         </div>
                      </div>
                   ) : (
                      <div key={item.id} className="bg-white p-3 rounded border shadow-sm cursor-pointer hover:border-blue-400 transition-colors" onClick={()=>onNavigate(item)}>
                         <div className="flex justify-between items-center mb-1">
                            <span className="text-xs text-gray-400">{item.displayId}</span>
                            {activeStat==='urgent' && <span className="text-xs font-bold text-red-600 animate-pulse">{item.deliveryDate} ë§ˆê°</span>}
                         </div>
                         <div className="font-bold text-slate-800 mb-1">{item.itemName}</div>
                         <div className="flex justify-between items-center">
                            <StatusBadge status={item.status}/>
                            <span className="text-xs text-gray-500">{item.clientName}</span>
                         </div>
                      </div>
                   )
                ))}
             </div>
          </div>
       </div>
     )
  };

  // Route Details Modal
  const RouteModal = () => {
    if(!activeRoutePopup) return null;
    const supplierItems = suppliers[activeRoutePopup]?.filter(m => m.status === 'ì œì‘ì™„ë£Œ') || [];
    const supplierInfo = SUPPLIER_INFO[activeRoutePopup];

    return (
       <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 animate-fade-in" onClick={()=>setActiveRoutePopup(null)}>
          <div className="bg-white w-full max-w-sm rounded-xl shadow-2xl overflow-hidden flex flex-col" onClick={e=>e.stopPropagation()}>
             <div className="bg-indigo-600 p-4 text-white flex justify-between items-start">
                <div>
                  <div className="text-xs font-bold text-indigo-200 mb-1">íšŒìˆ˜ ì§€ì  ìƒì„¸</div>
                  <h3 className="font-bold text-lg flex items-center gap-2">{activeRoutePopup}</h3>
                  <div className="text-xs text-indigo-100 mt-1 flex items-center gap-1"><MapPin size={12}/> {supplierInfo?.address}</div>
                </div>
                <button onClick={()=>setActiveRoutePopup(null)} className="p-1 bg-indigo-500 hover:bg-indigo-400 rounded text-white"><X size={16}/></button>
             </div>
             <div className="p-4 bg-slate-50 flex-1 overflow-y-auto max-h-[60vh]">
                <h4 className="font-bold text-sm text-slate-700 mb-3 flex items-center gap-1"><Package size={14}/> íšŒìˆ˜í•  ìì¬ ({supplierItems.length})</h4>
                <div className="space-y-2">
                   {supplierItems.map((item, i) => (
                      <div key={i} className="bg-white p-3 rounded border shadow-sm">
                         <div className="font-bold text-slate-800 text-sm">{item.item}</div>
                         <div className="flex justify-between items-center mt-1">
                            <span className="text-xs bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded font-bold">{item.quantity}</span>
                            <span className="text-[10px] text-gray-400">{item.orderName}</span>
                         </div>
                      </div>
                   ))}
                </div>
             </div>
             <div className="p-3 border-t bg-white">
                <a href={`https://map.naver.com/p/search/${supplierInfo?.address}`} target="_blank" rel="noreferrer" className="w-full bg-indigo-600 text-white py-2 rounded font-bold text-sm flex items-center justify-center gap-2 hover:bg-indigo-700">
                   <Map size={16}/> ì§€ë„/ë„¤ë¹„ê²Œì´ì…˜ ì—´ê¸°
                </a>
             </div>
          </div>
       </div>
    );
  };

  // AI Briefing Modal
  const BriefingModal = () => {
    if(!aiBriefing) return null;
    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 animate-fade-in" onClick={()=>setAiBriefing(null)}>
        <div className="bg-white w-full max-w-md rounded-xl shadow-2xl p-6 space-y-4" onClick={e=>e.stopPropagation()}>
          <div className="flex justify-between items-center border-b pb-3">
            <h3 className="text-lg font-bold text-indigo-800 flex items-center gap-2">
              <Sparkles className="text-yellow-500" size={20}/> ê¸ˆì¼ í˜„í™© ë¸Œë¦¬í•‘
            </h3>
            <button onClick={()=>setAiBriefing(null)}><X size={20} className="text-gray-400"/></button>
          </div>
          <div className="bg-gray-50 p-4 rounded-xl text-sm text-gray-700 whitespace-pre-wrap leading-relaxed border font-mono">
            {aiBriefing}
          </div>
          <button 
            onClick={() => {
              navigator.clipboard.writeText(aiBriefing);
              alert('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
              setAiBriefing(null);
            }}
            className="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700"
          >
            ë³µì‚¬í•˜ê¸°
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6 animate-fade-in pb-10 relative">
      <StatModal />
      <RouteModal />
      <BriefingModal />
      
      {/* Stats Grid */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <Card className="p-4 border-l-4 border-blue-600 cursor-pointer hover:bg-blue-50 transition-colors active:scale-95 transform duration-100" onClick={()=>setActiveStat('ongoing')}>
           <div className="text-xs text-gray-500 flex justify-between items-center">ì§„í–‰ ì¤‘ <ChevronRight size={12}/></div>
           <div className="text-2xl font-bold">{stats.ongoing}ê±´</div>
        </Card>
        <Card className="p-4 border-l-4 border-indigo-500 cursor-pointer hover:bg-indigo-50 transition-colors active:scale-95 transform duration-100" onClick={()=>setActiveStat('pickup')}>
           <div className="text-xs text-gray-500 flex justify-between items-center">íšŒìˆ˜ ëŒ€ê¸° <ChevronRight size={12}/></div>
           <div className="text-2xl font-bold text-indigo-600 animate-pulse">{stats.pickup}ê±´</div>
        </Card>
        <Card className="p-4 border-l-4 border-red-500 cursor-pointer hover:bg-red-50 transition-colors active:scale-95 transform duration-100" onClick={()=>setActiveStat('urgent')}>
           <div className="text-xs text-gray-500 flex justify-between items-center">ë§ˆê° ì„ë°• <ChevronRight size={12}/></div>
           <div className="text-2xl font-bold text-red-600">{stats.urgent}ê±´</div>
        </Card>
        <Card className="p-4 border-l-4 border-slate-400 cursor-pointer hover:bg-slate-100 transition-colors active:scale-95 transform duration-100" onClick={()=>setActiveStat('completed')}>
           <div className="text-xs text-gray-500 flex justify-between items-center">ìµœê·¼ ì™„ë£Œ (30ì¼) <ChevronRight size={12}/></div>
           <div className="text-2xl font-bold text-slate-500">{stats.completed}ê±´</div>
        </Card>
      </div>

      {/* AI Briefing Button */}
      <button 
        onClick={generateBriefing}
        disabled={isGeneratingBriefing}
        className="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 rounded-xl shadow-lg font-bold flex items-center justify-center gap-2 hover:from-indigo-600 hover:to-purple-700 transition-all disabled:opacity-70"
      >
        {isGeneratingBriefing ? (
          <span className="animate-pulse">âœ¨ AIê°€ ë¸Œë¦¬í•‘ ìš”ì•½ ì¤‘...</span>
        ) : (
          <>
            <Sparkles size={20} className="text-yellow-300"/> âœ¨ AI ì¼ì¼ ë¸Œë¦¬í•‘ ìƒì„±
          </>
        )}
      </button>

      {/* Ongoing Jobs */}
      <div>
        <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2"><FileText size={18}/> ì§„í–‰ ì¤‘ì¸ ì‘ì—… (ìµœì‹ ìˆœ)</h3>
        <div className="grid gap-3">
          {orders.filter(o => !['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status)).slice(0, 3).map(o => (
            <Card key={o.id} className="p-4 flex justify-between items-center cursor-pointer hover:border-blue-400 transition-colors" onClick={() => onNavigate(o)}>
              <div className="flex-1 min-w-0 pr-4">
                <div className="flex items-center gap-2 mb-1">
                  <StatusBadge status={o.status} />
                  <span className="text-xs text-gray-400 truncate">{o.displayId}</span>
                </div>
                <div className="font-bold truncate">{o.itemName}</div>
              </div>
              <div className="text-sm font-bold text-red-500 whitespace-nowrap">{o.deliveryDate} ë§ˆê°</div>
            </Card>
          ))}
          {orders.filter(o => !['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status)).length === 0 && <div className="text-gray-400 text-sm p-2">ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
        </div>
      </div>

      {/* Smart Pickup Course Route */}
      <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-5">
        <div className="flex items-center justify-between mb-3">
           <div className="flex items-center gap-2 text-indigo-900 font-bold"><Truck size={20} /><h3>ìµœì  íšŒìˆ˜ ë™ì„  (ê±°ë¦¬ìˆœ)</h3></div>
           <div className="text-[10px] text-indigo-400 bg-white px-2 py-1 rounded-full border border-indigo-100">í¬ì²œ ë³¸ì‚¬ ê¸°ì¤€</div>
        </div>
        {optimizedRoute.length > 0 ? (
          <div className="flex flex-wrap gap-2 items-center">
            {/* Start Point */}
            <a href={COMPANY_INFO.mapUrl} target="_blank" rel="noreferrer" className="bg-white px-3 py-2 rounded shadow-sm text-xs font-bold flex items-center gap-1 text-indigo-700 hover:bg-indigo-50 border border-indigo-100 group" title={COMPANY_INFO.address}>
                <Factory size={14} className="group-hover:scale-110 transition-transform"/> {COMPANY_INFO.name}
            </a>
            {/* Route Points */}
            {optimizedRoute.map((stop, i) => (
              <React.Fragment key={i}>
                <ArrowRight size={16} className="text-indigo-400" />
                <button onClick={() => setActiveRoutePopup(stop.name)} className="bg-indigo-600 text-white px-3 py-2 rounded shadow-md text-sm font-bold hover:bg-indigo-700 transition-colors flex items-center gap-1 focus:outline-none active:scale-95 transform duration-100">
                   <span>{i+1}. {stop.name}</span>
                   <span className="bg-white/20 px-1.5 rounded text-[10px]">{stop.count}</span>
                </button>
              </React.Fragment>
            ))}
            <ArrowRight size={16} className="text-indigo-400" />
            {/* End Point */}
            <a href={COMPANY_INFO.mapUrl} target="_blank" rel="noreferrer" className="bg-white px-3 py-2 rounded shadow-sm text-xs font-bold flex items-center gap-1 text-indigo-700 hover:bg-indigo-50 border border-indigo-100 group" title="ë³µê·€">
                <Factory size={14} className="group-hover:scale-110 transition-transform"/> ë³µê·€
            </a>
          </div>
        ) : <div className="text-sm text-indigo-400">í˜„ì¬ íšŒìˆ˜í•  ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
      </div>
    </div>
  );
};

const ListView = ({ orders, onSelect, onAdd }) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [open, setOpen] = useState({ design: true, prod: true, done: false });
  const groups = { design: [], prod: [], done: [] };
  
  orders.filter(o => (o.itemName || '').toLowerCase().includes(searchTerm.toLowerCase())).forEach(o => {
    if (['ëŒ€ê¸°', 'ì„¤ê³„ì¤‘'].includes(o.status)) groups.design.push(o);
    else if (['ì œì‘ì¤‘', 'ë„ì¥/ë§ˆê°'].includes(o.status)) groups.prod.push(o);
    else groups.done.push(o);
  });

  const Section = ({ id, title, items }) => (
    <div className="mb-4">
      <div onClick={() => setOpen({ ...open, [id]: !open[id] })} className={`flex justify-between p-3 rounded cursor-pointer transition-colors ${open[id] ? 'bg-slate-800 text-white' : 'bg-white border hover:bg-slate-50'}`}>
        <span className="font-bold">{title} ({items.length})</span>{open[id] ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
      </div>
      {open[id] && <div className="mt-2 pl-2 border-l-2 border-slate-200 space-y-2">
        {items.map(o => (
          <Card key={o.id} className="p-3 cursor-pointer hover:border-blue-500 bg-white transition-colors" onClick={() => onSelect(o)}>
            <div className="flex justify-between items-center mb-1">
              <span className="font-bold truncate mr-2">{o.itemName}</span>
              <StatusBadge status={o.status} />
            </div>
            <div className="text-xs text-gray-500 flex justify-between">
               <span>{o.clientName}</span>
               <span>{o.deliveryDate} ë‚©í’ˆ</span>
            </div>
          </Card>
        ))}
        {items.length === 0 && <div className="text-sm text-gray-400 p-2">í•­ëª© ì—†ìŒ</div>}
      </div>}
    </div>
  );

  return (
    <div className="space-y-4 animate-fade-in pb-10">
      <div className="flex gap-2 bg-white p-3 rounded-xl border shadow-sm sticky top-0 z-10">
        <Search size={20} className="text-gray-400"/>
        <input 
          className="flex-1 outline-none bg-transparent min-w-0" 
          placeholder="ì‘ì—…ëª… ê²€ìƒ‰..." 
          value={searchTerm} 
          onChange={e => setSearchTerm(e.target.value)} 
        />
        <button onClick={onAdd} className="bg-slate-800 text-white px-3 py-1 rounded text-sm font-bold flex items-center gap-1 flex-shrink-0">
          <Plus size={16} /> <span className="hidden sm:inline">ì‘ì—…ë“±ë¡</span>
        </button>
      </div>
      <Section id="design" title="ì„¤ê³„ ë‹¨ê³„" items={groups.design} />
      <Section id="prod" title="ì œì‘ ë‹¨ê³„" items={groups.prod} />
      <Section id="done" title="ì™„ë£Œ" items={groups.done} />
    </div>
  );
};

const DetailView = ({ order, onBack, onUpdate, isAdmin, currentUserId }) => {
  if (!order) return null;
  const [mat, setMat] = useState({ supplier: '', item: '', quantity: '', status: 'ë°œì£¼ì¤‘', date: new Date().toISOString().split('T')[0] });
  const [link, setLink] = useState({ name: '', url: '' });
  
  // ê¶Œí•œ í™•ì¸: ê´€ë¦¬ìì´ê±°ë‚˜, ë³¸ì¸ì´ ì‘ì„±í•œ ê¸€ì¼ ê²½ìš°
  const canEdit = isAdmin || order.userId === currentUserId;

  // Autocomplete State
  const [showSuggestions, setShowSuggestions] = useState(false);
  const supplierOptions = Object.keys(SUPPLIER_INFO);
  const filteredSuppliers = supplierOptions.filter(s => s.includes(mat.supplier));

  const updateOrder = (newData) => {
    onUpdate({ ...order, ...newData });
  };

  return (
    <div className="h-full overflow-y-auto animate-fade-in pb-10 pr-1" onClick={()=>setShowSuggestions(false)}>
      {/* Header */}
      <div className="flex items-center gap-2 text-slate-500 cursor-pointer hover:text-slate-800 mb-4" onClick={onBack}>
          <ChevronLeft size={20}/> <span className="text-sm font-bold">ëª©ë¡ìœ¼ë¡œ</span>
      </div>
      <div className="flex justify-between items-start gap-4 mb-6">
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2 mb-2 flex-wrap">
            <span className="font-mono text-gray-400 text-sm">{order.displayId}</span>
            <StatusBadge status={order.status} />
          </div>
          <h1 className="text-2xl md:text-3xl font-bold break-words leading-tight">{order.itemName}</h1>
        </div>
        {canEdit && (
          <button onClick={() => onUpdate(null, 'form')} className="bg-slate-100 px-3 py-2 rounded flex gap-2 hover:bg-slate-200 flex-shrink-0 text-sm font-bold">
            <Edit3 size={16} /> ìˆ˜ì •
          </button>
        )}
      </div>

      {/* Basic Info Card */}
      <Card className="p-5 mb-4">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
              <div>
                <div className="font-bold text-gray-400 uppercase text-xs mb-1">Client</div>
                <div className="text-lg font-bold text-slate-800">{order.clientName}</div>
                <div className="text-gray-500">{order.clientContact}</div>
              </div>
              <div>
                <div className="font-bold text-gray-400 uppercase text-xs mb-1">Order Date</div>
                <div className="text-lg text-slate-700 font-medium">{order.orderDate || '-'}</div>
              </div>
              <div>
                <div className="font-bold text-gray-400 uppercase text-xs mb-1">Delivery</div>
                <div className="text-lg text-red-600 font-bold">{order.deliveryDate}</div>
              </div>
          </div>
      </Card>

      {/* Split View: Memo & Files (Balanced Layout) */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
          {/* Memo Section */}
          <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
             <div className="font-bold text-slate-500 text-xs uppercase mb-2">Memo / Description</div>
             <div className="text-sm whitespace-pre-wrap text-slate-700 min-h-[80px]">{order.description || "ë©”ëª¨ ì—†ìŒ"}</div>
          </div>

          {/* Files Section (Compact) */}
          <div className="bg-white p-4 rounded-xl border border-slate-200 flex flex-col">
             <div className="flex justify-between items-center mb-3">
                <h3 className="font-bold text-sm text-slate-700 flex gap-2"><FileBox size={16} /> ë„ë©´/íŒŒì¼</h3>
                <span className="text-xs text-gray-400">{(order.files || []).length}ê°œ</span>
             </div>
             
             <div className="flex-1 space-y-2 mb-3 max-h-[150px] overflow-y-auto">
                {(order.files || []).length === 0 && <div className="text-center text-xs text-gray-400 py-2">ë“±ë¡ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                {(order.files || []).map((f, i) => (
                  <div key={i} className="flex justify-between items-center p-2 bg-blue-50 rounded text-xs group">
                    <div className="flex items-center gap-2 truncate flex-1 min-w-0">
                      {f.name.endsWith('.pdf') ? <FileText size={12} className="text-red-500 flex-shrink-0"/> : <File size={12} className="text-blue-500 flex-shrink-0"/>}
                      <span className="truncate text-blue-800 font-medium">{f.name}</span>
                    </div>
                    <a href={f.url} target="_blank" rel="noreferrer" className="bg-white p-1 rounded text-blue-600 hover:bg-blue-100 flex-shrink-0 ml-2">
                      <Download size={12} />
                    </a>
                  </div>
                ))}
             </div>

             {/* Compact Add Form */}
             {canEdit && (
               <div className="flex gap-1 border-t pt-2">
                  <input placeholder="íŒŒì¼ëª…" className="w-1/3 border p-1.5 rounded text-xs bg-gray-50" value={link.name} onChange={e => setLink({ ...link, name: e.target.value })} />
                  <input placeholder="URL" className="flex-1 border p-1.5 rounded text-xs bg-gray-50" value={link.url} onChange={e => setLink({ ...link, url: e.target.value })} />
                  <button onClick={() => {
                    if (!link.name || !link.url) return;
                    updateOrder({ files: [...(order.files || []), { ...link, id: Date.now() }] });
                    setLink({ name: '', url: '' });
                  }} className="bg-slate-700 text-white px-3 rounded text-xs font-bold hover:bg-slate-800">ë“±ë¡</button>
               </div>
             )}
          </div>
      </div>

      {/* Materials Section (Full Width) */}
      <div className="space-y-2">
        <h3 className="font-bold flex gap-2 text-slate-700"><Package className="text-indigo-600" /> ìì¬ ë°œì£¼ ë‚´ì—­</h3>
        <Card className="p-0 overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full text-sm text-left min-w-[400px]">
              <thead className="bg-slate-50 border-b"><tr><th className="p-2">ì¼ì</th><th className="p-2">ê±°ë˜ì²˜</th><th className="p-2">í’ˆëª©/ìˆ˜ëŸ‰</th><th className="p-2">ìƒíƒœ</th></tr></thead>
              <tbody>
                {(order.materials || []).map((m, i) => (
                  <tr key={i} className="border-b last:border-0 hover:bg-slate-50">
                    <td className="p-2 text-gray-500 text-xs">{m.date}</td>
                    <td className="p-2 font-medium">{m.supplier}</td>
                    <td className="p-2"><div className="font-medium">{m.item}</div><div className="text-xs text-gray-500">{m.quantity}</div></td>
                    <td className="p-2">
                      <select 
                        value={m.status} 
                        className="bg-transparent font-bold cursor-pointer text-xs outline-none" 
                        disabled={!canEdit}
                        onChange={(e) => {
                          const updated = order.materials.map(x => x.id === m.id ? { ...x, status: e.target.value } : x);
                          updateOrder({ materials: updated });
                        }}
                      >
                        <option>ë°œì£¼ì¤‘</option><option>ì œì‘ì™„ë£Œ</option><option>ì…ê³ ì™„ë£Œ</option>
                      </select>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          {canEdit && (
            <div className="p-3 bg-slate-50 border-t">
              <div className="text-xs font-bold text-slate-500 mb-2">ìì¬ ì¶”ê°€</div>
              <div className="flex flex-col md:flex-row gap-2 mb-2 items-start">
                <div className="relative flex-1 min-w-0 w-full" onClick={e=>e.stopPropagation()}>
                  <input 
                    placeholder="ê±°ë˜ì²˜ (í´ë¦­í•˜ì—¬ ì„ íƒ)" 
                    className="border p-2 rounded w-full text-sm" 
                    value={mat.supplier} 
                    onFocus={()=>setShowSuggestions(true)}
                    onChange={e => {
                      setMat({ ...mat, supplier: e.target.value });
                      setShowSuggestions(true);
                    }} 
                  />
                  {showSuggestions && filteredSuppliers.length > 0 && (
                    <ul className="absolute z-50 left-0 top-full mt-1 w-full bg-white border rounded-md shadow-lg max-h-40 overflow-y-auto">
                      {filteredSuppliers.map((s, idx) => (
                        <li key={idx} className="p-2 text-sm hover:bg-indigo-50 cursor-pointer text-slate-700 border-b last:border-0" onClick={() => { setMat({ ...mat, supplier: s }); setShowSuggestions(false); }}>
                          {s}
                        </li>
                      ))}
                    </ul>
                  )}
                </div>
                <input placeholder="í’ˆëª©ëª…" className="border p-2 rounded flex-1 text-sm min-w-0 w-full" value={mat.item} onChange={e => setMat({ ...mat, item: e.target.value })} />
                <input placeholder="ìˆ˜ëŸ‰" className="border p-2 rounded w-full md:w-20 text-sm" value={mat.quantity} onChange={e => setMat({ ...mat, quantity: e.target.value })} />
              </div>
              <button onClick={() => {
                if (!mat.supplier || !mat.item) return;
                updateOrder({ materials: [...(order.materials || []), { ...mat, id: Date.now() }] });
                setMat({ ...mat, supplier: '', item: '', quantity: '', status: 'ë°œì£¼ì¤‘' });
                setShowSuggestions(false);
              }} className="bg-indigo-600 text-white w-full py-2 rounded text-sm font-bold hover:bg-indigo-700">+ ë°œì£¼ ì¶”ê°€</button>
            </div>
          )}
        </Card>
      </div>
    </div>
  );
};

const FormView = ({ order, onSave, onDelete, onCancel, isAdmin, currentUserId }) => {
  const [data, setData] = useState(order || {
    clientName: '', itemName: '', manager: '', technician: '',
    orderDate: new Date().toISOString().split('T')[0], 
    deliveryDate: '', status: 'ëŒ€ê¸°', description: '', clientContact: '', files: []
  });
  const [isAiSuggesting, setIsAiSuggesting] = useState(false);
  const fileInputRef = useRef(null);

  // ê¶Œí•œ í™•ì¸: ê´€ë¦¬ìì´ê±°ë‚˜, ë³¸ì¸ì´ ì‘ì„±í•œ ê¸€ì¼ ê²½ìš° (ìƒˆ ê¸€ì€ í•­ìƒ true)
  const canEdit = !order || isAdmin || order.userId === currentUserId;

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const mockFile = { id: Date.now(), name: file.name, url: '#' };
      setData(prev => ({ ...prev, files: [...(prev.files || []), mockFile] }));
    }
  };

  const removeFile = (fileId) => {
    setData(prev => ({ ...prev, files: prev.files.filter(f => f.id !== fileId) }));
  };

  // --- AI Feature: Suggest Task Description ---
  const handleAiSuggest = async () => {
    if (!data.itemName) {
      alert('ì‘ì—…ëª…ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!');
      return;
    }
    setIsAiSuggesting(true);
    const prompt = `ë‚˜ëŠ” ê¸ˆì† ì œì¡° ë° ì¸í…Œë¦¬ì–´ íšŒì‚¬ 'ìˆ¨ì‰¬ëŠ” ê¹¡í†µ'ì˜ ì§ì›ì´ì•¼. ì‘ì—…ëª… '${data.itemName}'ì— í•„ìš”í•œ ìƒì„¸ ë‚´ìš©ì„ 200ì ì´ë‚´ë¡œ í•œêµ­ì–´ë¡œ ì¶”ì²œí•´ ì¤˜.`;
    const suggestion = await callGemini(prompt);
    setData(prev => ({ ...prev, description: suggestion }));
    setIsAiSuggesting(false);
  };

  if (!canEdit && order) {
    return (
      <div className="max-w-2xl mx-auto animate-fade-in pt-10 text-center">
        <AlertCircle size={48} className="mx-auto text-red-500 mb-4"/>
        <h2 className="text-xl font-bold text-gray-800">ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</h2>
        <p className="text-gray-500 mt-2">ë³¸ì¸ì´ ì‘ì„±í•œ ê¸€ì´ë‚˜ ê´€ë¦¬ìë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆì–´ìš”.</p>
        <button onClick={onCancel} className="mt-6 bg-slate-800 text-white px-6 py-2 rounded font-bold">ëŒì•„ê°€ê¸°</button>
      </div>
    );
  }

  return (
    <div className="max-w-2xl mx-auto animate-fade-in pb-10">
      <div onClick={onCancel} className="mb-4 cursor-pointer text-slate-500 flex items-center gap-1 hover:text-slate-800"><ChevronLeft /> ì·¨ì†Œ</div>
      <Card className="p-6 space-y-4">
        <h2 className="text-2xl font-bold">{order ? 'ì‘ì—… ìˆ˜ì •' : 'ìƒˆ ì‘ì—… ë“±ë¡'}</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div className="md:col-span-2">
             <label className="text-xs font-bold text-gray-500">ì‘ì—…ëª…</label>
             <input className="w-full border p-2 rounded mt-1" placeholder="ì˜ˆ: ì„±ìˆ˜ë™ ì¹´í˜ í…Œì´ë¸”" value={data.itemName} onChange={e => setData({ ...data, itemName: e.target.value })} />
          </div>
          <div>
             <label className="text-xs font-bold text-gray-500">ì˜ë¢°ì¸/ì—…ì²´ëª…</label>
             <input className="w-full border p-2 rounded mt-1" value={data.clientName} onChange={e => setData({ ...data, clientName: e.target.value })} />
          </div>
          <div>
             <label className="text-xs font-bold text-gray-500">ì˜ë¢°ì¸ ì—°ë½ì²˜</label>
             <input className="w-full border p-2 rounded mt-1" value={data.clientContact} onChange={e => setData({ ...data, clientContact: e.target.value })} />
          </div>
          <div>
             <label className="text-xs font-bold text-gray-500">ë‹´ë‹¹ì (ì„¤ê³„)</label>
             <input className="w-full border p-2 rounded mt-1" value={data.manager} onChange={e => setData({ ...data, manager: e.target.value })} />
          </div>
          <div>
             <label className="text-xs font-bold text-gray-500">ì‘ì—…ì (ì œì‘)</label>
             <input className="w-full border p-2 rounded mt-1" value={data.technician} onChange={e => setData({ ...data, technician: e.target.value })} />
          </div>
          
          {/* Date Fields */}
          <div>
             <label className="text-xs font-bold text-gray-500">ì˜ë¢°ì¼ (ì£¼ë¬¸ì¼)</label>
             <input type="date" className="w-full border p-2 rounded mt-1" value={data.orderDate} onChange={e => setData({ ...data, orderDate: e.target.value })} />
          </div>
          <div>
             <label className="text-xs font-bold text-gray-500">ë‚©í’ˆ/ì‹œê³µ ì˜ˆì •ì¼</label>
             <input type="date" className="w-full border p-2 rounded mt-1 font-bold text-red-600" value={data.deliveryDate} onChange={e => setData({ ...data, deliveryDate: e.target.value })} />
          </div>

          <div className="md:col-span-2">
             <label className="text-xs font-bold text-gray-500">ì§„í–‰ ìƒíƒœ</label>
             <select className="w-full border p-2 rounded mt-1" value={data.status} onChange={e => setData({ ...data, status: e.target.value })}>
               <option>ëŒ€ê¸°</option><option>ì„¤ê³„ì¤‘</option><option>ì œì‘ì¤‘</option><option>ë„ì¥/ë§ˆê°</option><option>ì™„ë£Œëœ ì‘ì—…</option><option>ë‚©í’ˆì™„ë£Œ</option>
             </select>
          </div>
          <div className="md:col-span-2">
             <div className="flex justify-between items-center mb-1">
                <label className="text-xs font-bold text-gray-500">ë©”ëª¨ / íŠ¹ì´ì‚¬í•­</label>
                <button 
                  onClick={handleAiSuggest} 
                  className="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded flex items-center gap-1 hover:bg-indigo-200"
                  disabled={isAiSuggesting}
                >
                  <Sparkles size={12}/> {isAiSuggesting ? 'ìƒê° ì¤‘...' : 'AI ìë™ ì¶”ì²œ'}
                </button>
             </div>
             <textarea className="w-full border p-2 rounded mt-1" rows="3" value={data.description} onChange={e => setData({ ...data, description: e.target.value })} />
          </div>

          {/* File Attachment Section */}
          <div className="md:col-span-2 border-t pt-4 mt-2">
            <label className="text-xs font-bold text-gray-500 mb-2 block">ë„ë©´ / íŒŒì¼ ì²¨ë¶€</label>
            <div className="space-y-2">
              {(data.files || []).map(f => (
                <div key={f.id} className="flex justify-between items-center p-2 bg-slate-50 rounded border text-sm">
                  <div className="flex items-center gap-2 truncate">
                    <Paperclip size={14} className="text-gray-400"/>
                    <span className="truncate">{f.name}</span>
                  </div>
                  <button onClick={() => removeFile(f.id)} className="text-red-500 hover:text-red-700"><X size={14}/></button>
                </div>
              ))}
            </div>
            <div className="mt-2 flex items-center gap-2">
              <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileChange} />
              <button onClick={() => fileInputRef.current.click()} className="text-sm bg-gray-100 border border-gray-300 px-3 py-1.5 rounded flex items-center gap-2 hover:bg-gray-200">
                <Plus size={14}/> íŒŒì¼ ì¶”ê°€
              </button>
            </div>
          </div>

        </div>
        <div className="flex justify-end gap-2 pt-4 border-t">
          {/* Delete Button: Visible if editing an existing order AND (is Admin OR is Owner) */}
          {order && (isAdmin || order.userId === currentUserId) && (
            <button onClick={() => onDelete(order.id)} className="text-red-500 px-4 font-bold text-sm hover:bg-red-50 rounded">ì‚­ì œ</button>
          )}
          <button onClick={() => onSave(data)} className="bg-slate-800 text-white px-6 py-2 rounded font-bold hover:bg-slate-900">ì €ì¥</button>
        </div>
      </Card>
    </div>
  );
};

const MaterialManageView = ({ suppliers, orders, onUpdateOrder }) => {
  const [selectedSupplier, setSelectedSupplier] = useState(null);
  const [isCustomMode, setIsCustomMode] = useState(false);
  const info = SUPPLIER_INFO[selectedSupplier];
  const [quickAdd, setQuickAdd] = useState(false);
  const [newMat, setNewMat] = useState({ orderId: '', item: '', quantity: '', status: 'ë°œì£¼ì¤‘', supplier: '' });

  useEffect(() => { 
    if (selectedSupplier && !isCustomMode) {
      setNewMat(prev => ({ ...prev, supplier: selectedSupplier }));
    }
  }, [selectedSupplier, isCustomMode]);

  const handleQuickAdd = async () => {
    if(!newMat.item) return alert("í’ˆëª©ì„ ì…ë ¥í•˜ì„¸ìš”");
    
    let targetOrder = orders.find(o => o.id === newMat.orderId);
    
    if (!targetOrder && !newMat.orderId) {
       if(window.confirm("ì„ íƒëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. 'ê¸°íƒ€ ë°œì£¼' í•­ëª©ìœ¼ë¡œ ìƒˆë¡œ ë§Œë“¤ê¹Œìš”?")) {
          const miscTask = {
            id: `misc-${Date.now()}`,
            itemName: 'ê¸°íƒ€ ìì¬ ë°œì£¼',
            clientName: 'ë‚´ë¶€',
            status: 'ì œì‘ì¤‘',
            createdAt: new Date(), 
            deadline: new Date().toISOString().split('T')[0],
            materials: []
          };
          targetOrder = miscTask;
       } else {
         return;
       }
    }

    const finalSupplier = isCustomMode ? newMat.supplier : selectedSupplier;
    if(!finalSupplier) return alert("ê±°ë˜ì²˜ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”.");

    const materialData = {
      id: Date.now(), 
      supplier: finalSupplier, 
      item: newMat.item,
      quantity: newMat.quantity, 
      status: 'ë°œì£¼ì¤‘', 
      date: new Date().toISOString().split('T')[0]
    };

    const updatedMaterials = [...(targetOrder.materials || []), materialData];
    await onUpdateOrder({ ...targetOrder, materials: updatedMaterials });
    
    setQuickAdd(false);
    setNewMat({ ...newMat, item: '', quantity: '' });
    alert("ë°œì£¼ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
  };

  return (
    <div className="flex h-full gap-4 animate-fade-in flex-col md:flex-row overflow-hidden">
      <div className="w-full md:w-1/3 overflow-y-auto space-y-2 pr-0 md:pr-2 max-h-[200px] md:max-h-full flex-shrink-0">
        <div onClick={() => { setIsCustomMode(true); setSelectedSupplier(null); setNewMat(prev=>({...prev, supplier: ''})); }} className={`p-3 border rounded-lg cursor-pointer transition-all flex items-center gap-2 ${isCustomMode ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white hover:bg-slate-50'}`}>
          <Plus size={16} />
          <span className="font-bold">ì§ì ‘ ì…ë ¥ (ìƒˆ ê±°ë˜ì²˜)</span>
        </div>
        {Object.keys(suppliers).map(s => {
          const items = suppliers[s];
          const pickupCnt = items.filter(m => m.status === 'ì œì‘ì™„ë£Œ').length;
          const activeCnt = items.filter(m => m.status === 'ë°œì£¼ì¤‘').length;
          return (
            <div key={s} onClick={() => { setSelectedSupplier(s); setIsCustomMode(false); }} className={`p-3 border rounded-lg cursor-pointer transition-all ${selectedSupplier === s && !isCustomMode ? 'bg-slate-800 text-white shadow-lg' : 'bg-white hover:bg-slate-50'}`}>
              <div className="flex justify-between items-center mb-1">
                <span className="font-bold">{s}</span>
                {pickupCnt > 0 && <span className="bg-indigo-500 text-white text-[10px] px-1.5 py-0.5 rounded font-bold animate-pulse">íšŒìˆ˜ {pickupCnt}</span>}
              </div>
              <div className="text-xs opacity-70">ì‘ì—…ì¤‘ {activeCnt}ê±´ / ì´ {items.length}ê±´</div>
            </div>
          )
        })}
      </div>

      <div className="w-full md:w-2/3 bg-white border rounded-xl p-4 md:p-6 flex flex-col overflow-hidden">
        {selectedSupplier || isCustomMode ? <>
          <div className="mb-4 pb-4 border-b flex-shrink-0">
            <div className="flex justify-between items-start mb-2">
              {isCustomMode ? (
                 <input className="text-2xl font-bold border-b border-gray-300 focus:border-indigo-500 outline-none placeholder-gray-300" placeholder="ê±°ë˜ì²˜ëª… ì…ë ¥" value={newMat.supplier} onChange={e => setNewMat({...newMat, supplier: e.target.value})}/>
              ) : (
                 <h2 className="text-2xl font-bold truncate">{selectedSupplier}</h2>
              )}
              <button onClick={() => setQuickAdd(!quickAdd)} className="bg-indigo-600 text-white px-3 py-1.5 rounded text-sm font-bold flex items-center gap-1 flex-shrink-0"><Plus size={14} /> ìì¬ ë“±ë¡</button>
            </div>
            {!isCustomMode && info ? (
              <div className="flex flex-wrap gap-4 text-xs md:text-sm text-gray-600 bg-slate-50 p-3 rounded">
                <div className="flex items-center gap-1"><Phone size={14} /> {info.phone}</div>
                <div className="flex items-center gap-1"><MapPin size={14} /> {info.address}</div>
              </div>
            ) : !isCustomMode ? <div className="text-sm text-gray-400">ì—°ë½ì²˜ ì •ë³´ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div> : null}
          </div>

          {(quickAdd || isCustomMode) && (
            <div className="mb-4 p-3 bg-indigo-50 rounded border border-indigo-100 animate-fade-in flex-shrink-0">
              <div className="text-sm font-bold text-indigo-800 mb-2">ìƒˆ ìì¬ ë°œì£¼ ì¶”ê°€</div>
              <div className="flex flex-col md:flex-row gap-2 mb-2">
                <select className="border p-2 rounded flex-1 text-sm min-w-0" value={newMat.orderId} onChange={e => setNewMat({ ...newMat, orderId: e.target.value })}>
                  <option value="">í”„ë¡œì íŠ¸ ì„ íƒ (ì—†ìœ¼ë©´ ê¸°íƒ€)</option>
                  {orders.filter(o => !['ë‚©í’ˆì™„ë£Œ'].includes(o.status)).map(o => <option key={o.id} value={o.id}>{o.itemName}</option>)}
                </select>
                <input placeholder="í’ˆëª©ëª…" className="border p-2 rounded flex-1 text-sm min-w-0" value={newMat.item} onChange={e => setNewMat({ ...newMat, item: e.target.value })} />
                <input placeholder="ìˆ˜ëŸ‰" className="border p-2 rounded w-full md:w-20 text-sm" value={newMat.quantity} onChange={e => setNewMat({ ...newMat, quantity: e.target.value })} />
              </div>
              <button onClick={handleQuickAdd} className="w-full bg-indigo-600 text-white py-2 rounded text-sm font-bold hover:bg-indigo-700">ë“±ë¡í•˜ê¸°</button>
            </div>
          )}

          <div className="flex-1 overflow-y-auto">
            <table className="w-full text-sm text-left min-w-[300px]">
              <thead className="bg-slate-50 border-b sticky top-0 z-10"><tr><th className="p-2">ìƒíƒœ</th><th className="p-2">í’ˆëª©/ìˆ˜ëŸ‰</th><th className="p-2 hidden md:table-cell">ê´€ë ¨ í”„ë¡œì íŠ¸</th><th className="p-2 text-right">ê´€ë¦¬</th></tr></thead>
              <tbody>
                {(!isCustomMode && suppliers[selectedSupplier]) ? suppliers[selectedSupplier].map((m, i) => (
                <tr key={i} className="border-b hover:bg-slate-50">
                  <td className="p-2"><MaterialStatusBadge status={m.status} /></td>
                  <td className="p-2"><div className="font-bold text-slate-700">{m.item}</div><div className="text-xs text-gray-500">{m.quantity}</div><div className="md:hidden text-xs text-indigo-500 mt-1">{m.orderName}</div></td>
                  <td className="p-2 hidden md:table-cell text-gray-500 text-xs">{m.orderName}</td>
                  <td className="p-2 text-right">
                    {m.status === 'ì œì‘ì™„ë£Œ' && (
                      <button onClick={async () => {
                        const order = orders.find(o => o.id === m.orderId);
                        if (order) {
                          const updated = order.materials.map(x => x.id === m.id ? { ...x, status: 'ì…ê³ ì™„ë£Œ' } : x);
                          await onUpdateOrder({ ...order, materials: updated });
                        }
                      }} className="bg-green-500 text-white px-2 py-1 rounded text-xs font-bold inline-flex items-center gap-1 hover:bg-green-600">
                        <CheckCircle2 size={12} /> íšŒìˆ˜
                      </button>
                    )}
                  </td>
                </tr>
              )) : isCustomMode ? (
                 <tr><td colSpan="4" className="p-4 text-center text-gray-400">ë“±ë¡ëœ ìì¬ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ìƒˆë¡œ ë“±ë¡í•´ë³´ì„¸ìš”!</td></tr>
              ) : null}
              </tbody>
            </table>
          </div>
        </> : <div className="flex h-full items-center justify-center text-gray-400">ì¢Œì¸¡ì—ì„œ ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ê±°ë‚˜ 'ì§ì ‘ ì…ë ¥'ì„ ëˆ„ë¥´ì„¸ìš”.</div>}
      </div>
    </div>
  );
};

const CalendarView = ({ orders, onSelect }) => {
  const [date, setDate] = useState(new Date());
  const days = [];
  const year = date.getFullYear();
  const month = date.getMonth();
  const firstDay = new Date(year, month, 1).getDay();
  const lastDate = new Date(year, month + 1, 0).getDate();
  
  for (let i = 0; i < firstDay; i++) days.push(null);
  for (let i = 1; i <= lastDate; i++) days.push(new Date(year, month, i));

  return (
    <div className="h-full flex flex-col animate-fade-in pb-10">
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-2xl font-bold">{year}ë…„ {month + 1}ì›”</h2>
        <div className="flex gap-2">
          <button onClick={() => setDate(new Date(year, month - 1, 1))} className="p-1 hover:bg-slate-200 rounded"><ChevronLeft /></button>
          <button onClick={() => setDate(new Date())} className="text-sm border px-2 rounded hover:bg-slate-50">ì˜¤ëŠ˜</button>
          <button onClick={() => setDate(new Date(year, month + 1, 1))} className="p-1 hover:bg-slate-200 rounded"><ChevronRight /></button>
        </div>
      </div>
      <div className="flex-1 bg-white border rounded-xl overflow-hidden flex flex-col shadow-sm">
        <div className="grid grid-cols-7 bg-slate-50 border-b text-center py-2 font-bold text-slate-600 text-sm">
          <div className="text-red-500">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div className="text-blue-500">í† </div>
        </div>
        <div className="flex-1 grid grid-cols-7 grid-rows-5">
          {days.map((d, i) => {
            if (!d) return <div key={i} className="bg-slate-50 border-r border-b"></div>;
            const dateStr = d.toISOString().split('T')[0];
            const events = orders.filter(o => o.deliveryDate === dateStr);
            const isToday = dateStr === new Date().toISOString().split('T')[0];
            return (
              <div key={i} className={`border-r border-b p-1 bg-white min-h-[60px] flex flex-col ${isToday ? 'bg-blue-50' : ''}`}>
                <div className={`text-xs font-bold mb-1 text-center ${isToday ? 'text-blue-600' : 'text-gray-500'}`}>{d.getDate()}</div>
                <div className="space-y-1 overflow-y-auto flex-1 no-scrollbar">
                  {events.map(ev => (
                    <div key={ev.id} onClick={() => onSelect(ev)} className="text-[10px] p-1 bg-red-50 text-red-800 border-l-2 border-red-500 truncate cursor-pointer rounded hover:opacity-80">
                      {ev.itemName}
                    </div>
                  ))}
                </div>
              </div>
            )
          })}
        </div>
      </div>
    </div>
  )
};

const FileBox = ({size}) => <Package size={size}/>; // Fallback if missing

// --- Main App Component ---

export default function App() {
  // State
  const [user, setUser] = useState(null);
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(true);
  const [isOnline, setIsOnline] = useState(false);
  
  // Authentication State for Simple Code Gate
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [isAdmin, setIsAdmin] = useState(false);

  // UI State
  const [currentView, setCurrentView] = useState('dashboard');
  const [selectedOrder, setSelectedOrder] = useState(null);
  const [showNotiPanel, setShowNotiPanel] = useState(false);

  // Firebase setup
  const { auth, db, appId } = useMemo(() => {
    try {
      const config = JSON.parse(__firebase_config);
      const app = initializeApp(config);
      return { auth: getAuth(app), db: getFirestore(app), appId: typeof __app_id !== 'undefined' ? __app_id : 'default-bk' };
    } catch (e) { return { auth: null, db: null, appId: null }; }
  }, []);

  // Auth & Data Sync
  useEffect(() => {
    if (!auth) {
      setOrders(MOCK_DATA);
      setLoading(false);
      return;
    }
    const init = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
      else await signInAnonymously(auth);
    };
    init();
    onAuthStateChanged(auth, u => setUser(u));
  }, [auth]);

  useEffect(() => {
    if (!user || !db) return;
    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderBy('createdAt', 'desc'));
    const unsub = onSnapshot(q, (snap) => {
      const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      if (data.length === 0) setOrders(MOCK_DATA);
      else setOrders(data);
      setIsOnline(true);
      setLoading(false);
    }, (err) => {
      console.warn("Offline:", err);
      setOrders(MOCK_DATA);
      setLoading(false);
    });
    return () => unsub();
  }, [user, db, appId]);

  // Handle Simple Login
  const handleLogin = (role) => {
    setIsAuthenticated(true);
    setIsAdmin(role === 'admin');
  };

  // CRUD Actions
  const saveOrder = async (data) => {
    if (!db) {
       // Local fallback
       if(data.id && !data.id.startsWith('mock')) setOrders(orders.map(o=>o.id===data.id?data:o));
       else setOrders([...orders, {...data, id: `mock-new-${Date.now()}`, displayId: `ORD-24-${Math.floor(100+Math.random()*900)}`}]);
       setCurrentView('list');
       setSelectedOrder(null);
       return;
    }
    const col = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
    if (data.id && !data.id.startsWith('mock')) {
      await updateDoc(doc(col, data.id), { ...data, updatedAt: serverTimestamp() });
    } else {
      const { id, ...rest } = data; 
      const displayId = `ORD-24-${Math.floor(100 + Math.random() * 900)}`;
      // Save userId to document for ownership check
      await addDoc(col, { ...rest, displayId, createdAt: serverTimestamp(), materials: data.materials || [], files: data.files || [], userId: user?.uid });
    }
    setCurrentView('list');
    setSelectedOrder(null);
  };

  const deleteOrder = async (id) => {
    if (!db || id.startsWith('mock')) {
      setOrders(orders.filter(o => o.id !== id));
      setCurrentView('list'); 
      return;
    }
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
    setCurrentView('list');
  };

  // Derived Data & Stats & Notifications... (Same as before)
  const stats = useMemo(() => {
    const oneMonthAgo = new Date();
    oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);
    return {
      ongoing: orders.filter(o => !['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status)).length,
      pickup: orders.reduce((acc, cur) => acc + (cur.materials || []).filter(m => m.status === 'ì œì‘ì™„ë£Œ').length, 0),
      urgent: orders.filter(o => {
        if (!o.deliveryDate || ['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status)) return false;
        return Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2;
      }).length,
      completed: orders.filter(o => {
        const isDone = ['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status);
        const delDate = new Date(o.deliveryDate);
        return isDone && delDate >= oneMonthAgo;
      }).length
    };
  }, [orders]);

  const notifications = useMemo(() => {
    const notis = [];
    const today = new Date().toISOString().split('T')[0];
    const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
    orders.forEach(o => {
      if (['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status)) return;
      if (o.deliveryDate === today) notis.push({ msg: `'${o.itemName}' ì˜¤ëŠ˜ ë§ˆê°ì…ë‹ˆë‹¤!`, type: 'critical' });
      else if (o.deliveryDate === tomorrow) notis.push({ msg: `'${o.itemName}' ë§ˆê° í•˜ë£¨ ì „ì…ë‹ˆë‹¤.`, type: 'warning' });
    });
    return notis;
  }, [orders]);

  const suppliers = useMemo(() => {
    const s = {};
    orders.forEach(o => (o.materials || []).forEach(m => {
      if (!s[m.supplier]) s[m.supplier] = [];
      s[m.supplier].push({ ...m, orderId: o.id, orderName: o.itemName });
    }));
    return s;
  }, [orders]);

  const handleNavigate = (order) => {
    setSelectedOrder(order);
    setCurrentView('detail');
  };

  // --- Render Logic ---
  if (!isAuthenticated) {
    return <LoginView onLogin={handleLogin} />;
  }

  if (loading) return <div className="flex h-screen items-center justify-center bg-slate-100"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-slate-800"></div></div>;

  return (
    <div className="flex h-screen bg-slate-100 font-sans text-slate-800 overflow-hidden">
      {/* Sidebar */}
      <div className="w-16 md:w-60 bg-slate-900 text-slate-300 flex flex-col flex-shrink-0 transition-all duration-300">
        <div className="p-4 md:p-6 flex items-center gap-3 border-b border-slate-800 justify-center md:justify-start">
          <div className="w-8 h-8 md:w-10 md:h-10 bg-white text-slate-900 rounded flex items-center justify-center font-bold text-lg md:text-xl flex-shrink-0">BK</div>
          <span className="font-bold text-lg text-white hidden md:block">Breathe Kkangtong</span>
        </div>
        <nav className="flex-1 p-2 md:p-4 space-y-2 overflow-y-auto">
          {[
            { id: 'dashboard', icon: LayoutDashboard, label: 'í˜„í™©' },
            { id: 'calendar', icon: CalendarIcon, label: 'ìŠ¤ì¼€ì¤„ëŸ¬' },
            { id: 'list', icon: FileText, label: 'ì‘ì—…' },
            { id: 'materials', icon: Truck, label: 'ë°œì£¼' },
          ].map(m => (
            <button key={m.id} onClick={() => { setCurrentView(m.id); setSelectedOrder(null); }} className={`w-full flex items-center justify-center md:justify-start gap-3 px-2 md:px-4 py-3 rounded transition-colors ${currentView === m.id ? 'bg-indigo-600 text-white' : 'hover:bg-slate-800'}`}>
              <m.icon size={20} className="flex-shrink-0" />
              <span className="hidden md:block font-medium">{m.label}</span>
            </button>
          ))}
        </nav>
        {/* User Status Footer */}
        <div className="p-4 border-t border-slate-800 text-xs text-center md:text-left">
          <p className="text-slate-400 font-bold">{isAdmin ? 'ê´€ë¦¬ì ëª¨ë“œ (2203)' : 'ì§ì› ëª¨ë“œ (4545)'}</p>
          <p className="text-slate-600 mt-1 truncate">ID: {user?.uid?.substring(0,8)}...</p>
        </div>
      </div>

      {/* Main Content */}
      <div className="flex-1 flex flex-col overflow-hidden relative">
        {/* Header */}
        <header className="h-14 md:h-16 bg-white border-b flex items-center justify-between px-4 md:px-6 shadow-sm flex-shrink-0">
          <h2 className="font-bold text-lg md:text-xl uppercase text-slate-800">{
             currentView === 'list' && selectedOrder ? 'ì‘ì—… ìƒì„¸' : 
             currentView === 'dashboard' ? 'ì‘ì—… í˜„í™©' : 
             currentView === 'calendar' ? 'ìŠ¤ì¼€ì¤„ëŸ¬' : 
             currentView === 'list' ? 'ì‘ì—… ëª©ë¡' : 
             currentView === 'materials' ? 'ìì¬/ë°œì£¼ ê´€ë¦¬' : 'BK Manager'
          }</h2>
          <div className="flex items-center gap-4">
            <span className={`text-[10px] md:text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1 whitespace-nowrap ${isOnline ? 'text-green-600 bg-green-50' : 'text-gray-400 bg-gray-100'}`}>
              <Wifi size={12} /> <span className="hidden md:inline">{isOnline ? 'Online' : 'Offline'}</span>
            </span>
            <div className="relative cursor-pointer" onClick={() => setShowNotiPanel(!showNotiPanel)}>
              <Bell size={20} className="text-gray-500 hover:text-slate-800" />
              {notifications.length > 0 && <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-[10px] text-white flex items-center justify-center animate-pulse">{notifications.length}</span>}
              {showNotiPanel && (
                <>
                  <div className="fixed inset-0 z-40" onClick={()=>setShowNotiPanel(false)}></div>
                  <div className="absolute right-0 mt-3 w-72 bg-white rounded-xl shadow-xl border border-slate-100 z-50 overflow-hidden animate-fade-in">
                    <div className="p-3 bg-slate-50 border-b font-bold text-sm text-slate-700 flex justify-between"><span>ì•Œë¦¼</span><X size={14} className="cursor-pointer" onClick={() => setShowNotiPanel(false)} /></div>
                    <div className="max-h-[300px] overflow-y-auto">
                      {notifications.length === 0 ? <div className="p-4 text-center text-gray-400 text-xs">ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div> :
                        notifications.map((n, i) => <div key={i} className="p-3 border-b text-sm hover:bg-slate-50"><span className="font-bold text-red-500 mr-1">!</span> {n.msg}</div>)}
                    </div>
                  </div>
                </>
              )}
            </div>
          </div>
        </header>

        {/* View Container */}
        <main className="flex-1 overflow-x-hidden overflow-y-auto p-4 md:p-6 bg-slate-100">
          <div className="max-w-7xl mx-auto h-full">
             {currentView === 'dashboard' && <Dashboard orders={orders} stats={stats} suppliers={suppliers} onNavigate={handleNavigate} isAdmin={isAdmin} currentUserId={user?.uid} />}
             {currentView === 'list' && !selectedOrder && <ListView orders={orders} onSelect={handleNavigate} onAdd={() => { setSelectedOrder(null); setCurrentView('form'); }} />}
             {currentView === 'detail' && <DetailView order={selectedOrder} onBack={() => { setSelectedOrder(null); setCurrentView('list'); }} onUpdate={(data, view) => { if(view) setCurrentView(view); else saveOrder(data); }} isAdmin={isAdmin} currentUserId={user?.uid} />}
             {currentView === 'form' && <FormView order={selectedOrder} onSave={saveOrder} onDelete={deleteOrder} onCancel={() => { setSelectedOrder(null); setCurrentView('list'); }} isAdmin={isAdmin} currentUserId={user?.uid} />}
             {currentView === 'materials' && <MaterialManageView suppliers={suppliers} orders={orders} onUpdateOrder={saveOrder} />}
             {currentView === 'calendar' && <CalendarView orders={orders} onSelect={handleNavigate} />}
          </div>
        </main>
      </div>
    </div>
  );
}
