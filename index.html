<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>숨쉬는 깡통</title>
    
    <!-- 1. Tailwind CSS (디자인) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 폰트 (Pretendard) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body { font-family: 'Pretendard', sans-serif; }
        /* 스크롤바 숨김 처리 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* 애니메이션 */
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-bounce-slight { animation: bounceSlight 2s infinite; }
        @keyframes bounceSlight { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
    </style>

    <!-- 3. Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.330.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            LayoutDashboard, Plus, FileText, Calendar as CalendarIcon,
            Package, ChevronRight, ChevronLeft, Trash2, Edit3, Download, Link as LinkIcon,
            ChevronDown, ChevronUp, Wifi, Mail, CheckCircle2, Factory, ArrowRight,
            Phone, MapPin, Bell, X, Truck, Search, AlertCircle, Map, Sparkles, Paperclip, File, Lock, Key, User, Hammer, Truck as TruckIcon
        } from 'lucide-react';

        // --- Firebase Imports ---
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import {
            getFirestore, collection, addDoc, updateDoc, deleteDoc,
            doc, onSnapshot, query, orderBy, serverTimestamp
        } from 'firebase/firestore';

        // ---------------------------------------------------------
        // ✅ Firebase 설정
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyB5W8qJbYMNyzPu8jmbAifCBH9qgZsQOJA",
            authDomain: "bk-manager-784a5.firebaseapp.com",
            projectId: "bk-manager-784a5",
            storageBucket: "bk-manager-784a5.firebasestorage.app",
            messagingSenderId: "16230700058",
            appId: "1:16230700058:web:833a3d16f54cdd73d2ada3",
            measurementId: "G-PMGKK5F8CP"
        };

        // ---------------------------------------------------------
        // ✅ Gemini API 키
        // ---------------------------------------------------------
        const GEMINI_API_KEY = "AIzaSyAAuopjonzUutbkTZXv5PbqfKz2hDsNRes";

        // --- Gemini API Helper ---
        const callGemini = async (prompt) => {
            const apiKey = GEMINI_API_KEY; 
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`HTTP error!`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "응답 없음";
            } catch (e) {
                console.error("Gemini API Error:", e);
                return "AI 연결 실패";
            }
        };

        // --- Constants ---
        const COMPANY_INFO = {
            name: '숨쉬는 깡통',
            address: '경기도 포천시 군내면 유교리 243-7',
            lat: 37.885, 
            lng: 127.205, 
            mapUrl: 'https://map.naver.com/p/search/경기도 포천시 군내면 유교리 243-7'
        };

        // 기본 거래처 정보 (수정 불가)
        const DEFAULT_SUPPLIERS = {
            '성수금속': { phone: '02-1234-5678', address: '서울 성동구 성수이로 123', lat: 37.5445, lng: 127.0560 },
            '을지레이저': { phone: '02-2222-3333', address: '서울 중구 을지로 4가 56', lat: 37.5660, lng: 126.9950 },
            '청계도장': { phone: '02-3333-4444', address: '서울 중구 청계천로 789', lat: 37.5690, lng: 127.0100 }
        };

        // --- Helper Function ---
        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        };

        // --- UI Components ---
        const StatusBadge = ({ status }) => {
            const colors = {
                '설계중': 'bg-blue-100 text-blue-700',
                '작업중': 'bg-amber-100 text-amber-700',
                '도장/마감중': 'bg-purple-100 text-purple-700',
                '작업완료': 'bg-slate-200 text-slate-600 font-bold',
                '납품완료': 'bg-green-100 text-green-700',
            };
            return <span className={`flex-shrink-0 px-2 py-1 rounded-full text-xs font-bold whitespace-nowrap ${colors[status] || 'bg-gray-100'}`}>{status}</span>;
        };

        const MaterialStatusBadge = ({ status }) => {
            const colors = {
                '발주': 'bg-yellow-100 text-yellow-700',
                '회수대기': 'bg-indigo-100 text-indigo-700 font-bold animate-pulse',
                '회수완료': 'bg-green-100 text-green-700',
            };
            return <span className={`flex-shrink-0 px-2 py-0.5 rounded text-[11px] whitespace-nowrap cursor-pointer select-none ${colors[status] || 'bg-gray-100'}`}>{status}</span>;
        };

        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>{children}</div>
        );

        // --- Sub Components ---

        const Dashboard = ({ orders, stats, suppliers, onNavigate }) => {
            const [aiBriefing, setAiBriefing] = useState(null);
            const [isGeneratingBriefing, setIsGeneratingBriefing] = useState(false);

            const generateBriefing = async () => {
                setIsGeneratingBriefing(true);
                const urgentTasks = orders.filter(o => {
                    if (!o.deliveryDate || ['납품완료', '작업완료'].includes(o.status)) return false;
                    return Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2;
                }).map(o => o.itemName).join(', ');

                const prompt = `
                    너는 '숨쉬는 깡통'의 관리자야. 아래 데이터를 바탕으로 아주 간단명료하게 브리핑해.
                    [데이터] 진행중:${stats.ongoing}, 회수대기:${stats.pickup}, 긴급:${stats.urgent} (${urgentTasks || '없음'}).
                    서론 없이 핵심만 3줄로 요약할 것.
                `;
                const result = await callGemini(prompt);
                setAiBriefing(result);
                setIsGeneratingBriefing(false);
            };

            // Route Logic (주소가 있는 거래처만 포함)
            const optimizedRoute = useMemo(() => {
                // 회수대기 상태인 자재가 있는 거래처들
                const targetNames = Object.keys(suppliers).filter(name => 
                    suppliers[name].items.some(m => m.status === '회수대기')
                );
                if (targetNames.length === 0) return [];

                let currentLoc = { lat: COMPANY_INFO.lat, lng: COMPANY_INFO.lng };
                let unvisited = targetNames.map(name => {
                    const info = suppliers[name].info;
                    return {
                        name,
                        lat: info?.lat || 37.5, // 좌표 없으면 서울 중심 임시값
                        lng: info?.lng || 127.0,
                        hasLoc: !!info?.lat,
                        count: suppliers[name].items.filter(m => m.status === '회수대기').length
                    };
                });

                const route = [];
                // 좌표가 있는 곳들만 정렬 (단순 거리 계산)
                while (unvisited.length > 0) {
                    let nearest = null;
                    let minDist = Infinity;
                    let nearestIdx = -1;
                    unvisited.forEach((node, idx) => {
                        const dist = getDistance(currentLoc.lat, currentLoc.lng, node.lat, node.lng);
                        if (dist < minDist) {
                            minDist = dist;
                            nearest = node;
                            nearestIdx = idx;
                        }
                    });
                    if (nearest) {
                        route.push(nearest);
                        currentLoc = nearest; 
                        unvisited.splice(nearestIdx, 1);
                    } else break;
                }
                return route;
            }, [suppliers]);

            return (
                <div className="space-y-6 animate-fade-in pb-10 relative">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <Card className="p-4 border-l-4 border-blue-600">
                            <div className="text-xs text-gray-500">진행 중</div>
                            <div className="text-2xl font-bold">{stats.ongoing}건</div>
                        </Card>
                        <Card className="p-4 border-l-4 border-indigo-500">
                            <div className="text-xs text-gray-500">회수 대기 자재</div>
                            <div className="text-2xl font-bold text-indigo-600">{stats.pickup}건</div>
                        </Card>
                        <Card className="p-4 border-l-4 border-red-500">
                            <div className="text-xs text-gray-500">마감 임박</div>
                            <div className="text-2xl font-bold text-red-600">{stats.urgent}건</div>
                        </Card>
                        <Card className="p-4 border-l-4 border-slate-400">
                            <div className="text-xs text-gray-500">이번 달 완료</div>
                            <div className="text-2xl font-bold text-slate-500">{stats.completed}건</div>
                        </Card>
                    </div>

                    {/* AI Briefing */}
                    {aiBriefing && (
                        <div className="bg-white p-4 rounded-xl border border-indigo-100 shadow-lg relative animate-fade-in">
                            <h3 className="font-bold text-indigo-800 flex items-center gap-2 mb-2"><Sparkles size={16} className="text-yellow-500"/> AI 요약 브리핑</h3>
                            <p className="text-sm text-slate-700 whitespace-pre-line leading-relaxed">{aiBriefing}</p>
                            <button onClick={()=>setAiBriefing(null)} className="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><X size={16}/></button>
                        </div>
                    )}
                    {!aiBriefing && (
                        <button onClick={generateBriefing} disabled={isGeneratingBriefing} className="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 rounded-xl shadow font-bold flex items-center justify-center gap-2">
                            {isGeneratingBriefing ? 'AI가 분석 중...' : <><Sparkles size={18}/> AI 일일 브리핑 생성</>}
                        </button>
                    )}

                    {/* Urgent Tasks List */}
                    <div>
                        <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2"><AlertCircle size={18} className="text-red-500"/> 긴급 / 진행 중 작업</h3>
                        <div className="space-y-3">
                            {orders.filter(o => !['납품완료', '작업완료'].includes(o.status)).slice(0, 3).map(o => (
                                <Card key={o.id} className="p-4 flex justify-between items-center cursor-pointer hover:border-indigo-500 transition-all" onClick={() => onNavigate(o)}>
                                    <div>
                                        <div className="flex items-center gap-2 mb-1">
                                            <StatusBadge status={o.status} />
                                            <span className="text-xs text-gray-500">{o.clientName}</span>
                                        </div>
                                        <div className="font-bold">{o.itemName}</div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-xs text-gray-400">납품일</div>
                                        <div className="text-sm font-bold text-red-600">{o.deliveryDate}</div>
                                    </div>
                                </Card>
                            ))}
                            {orders.filter(o => !['납품완료', '작업완료'].includes(o.status)).length === 0 && <div className="text-gray-400 text-center py-4 text-sm">진행 중인 작업이 없습니다.</div>}
                        </div>
                    </div>

                    {/* Route Info */}
                    <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-5">
                        <div className="flex items-center gap-2 text-indigo-900 font-bold mb-3"><Truck size={20} /><h3>자재 회수 추천 동선</h3></div>
                        {optimizedRoute.length > 0 ? (
                        <div className="flex flex-wrap gap-2 items-center">
                            <span className="text-xs bg-white px-2 py-1 rounded border font-bold">본사</span>
                            {optimizedRoute.map((stop, i) => (
                                <React.Fragment key={i}>
                                    <ArrowRight size={14} className="text-indigo-300" />
                                    <div className="bg-indigo-600 text-white px-3 py-1.5 rounded shadow text-sm font-bold">
                                        {i+1}. {stop.name} <span className="bg-white/20 px-1 rounded text-[10px] ml-1">{stop.count}개</span>
                                    </div>
                                </React.Fragment>
                            ))}
                            <ArrowRight size={14} className="text-indigo-300" />
                            <span className="text-xs bg-white px-2 py-1 rounded border font-bold">복귀</span>
                        </div>
                        ) : <div className="text-sm text-indigo-400">현재 회수 대기 중인 자재가 없거나 위치 정보가 부족합니다.</div>}
                    </div>
                </div>
            );
        };

        const DetailView = ({ order, onBack, onUpdate, isAdmin }) => {
            if (!order) return null;
            const [mat, setMat] = useState({ supplier: '', item: '', quantity: '', status: '발주', date: new Date().toISOString().split('T')[0] });

            // Status Toggler for Materials
            const toggleMatStatus = (m) => {
                const statusFlow = { '발주': '회수대기', '회수대기': '회수완료', '회수완료': '발주' };
                const nextStatus = statusFlow[m.status] || '발주';
                const updated = order.materials.map(x => x.id === m.id ? { ...x, status: nextStatus } : x);
                onUpdate({ materials: updated });
            };

            return (
                <div className="h-full overflow-y-auto animate-fade-in pb-10">
                    <div className="flex items-center gap-2 text-slate-500 cursor-pointer mb-4" onClick={onBack}>
                        <ChevronLeft size={20}/> <span className="text-sm font-bold">목록으로</span>
                    </div>
                    
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <StatusBadge status={order.status} />
                            <h1 className="text-2xl font-bold mt-1">{order.itemName}</h1>
                            <div className="text-sm text-gray-500 mt-1">{order.clientName}</div>
                        </div>
                        <button onClick={() => onUpdate(null, 'form')} className="bg-slate-100 px-3 py-2 rounded flex gap-2 text-sm font-bold hover:bg-slate-200"><Edit3 size={16} /> 수정</button>
                    </div>

                    <div className="grid md:grid-cols-2 gap-4 mb-6">
                        <Card className="p-4 text-sm space-y-2">
                            <div className="flex justify-between border-b pb-2"><span className="text-gray-500">담당자(설계)</span> <span className="font-bold">{order.manager || '-'}</span></div>
                            <div className="flex justify-between border-b pb-2"><span className="text-gray-500">작업자(제작)</span> <span className="font-bold">{order.worker || '-'}</span></div>
                            <div className="flex justify-between pt-1"><span className="text-gray-500">연락처</span> <span className="font-bold">{order.clientContact || '-'}</span></div>
                        </Card>
                        <Card className="p-4 text-sm space-y-2">
                            <div className="flex justify-between border-b pb-2"><span className="text-gray-500">발주(시작)일</span> <span className="font-bold">{order.orderDate}</span></div>
                            <div className="flex justify-between border-b pb-2"><span className="text-gray-500">납품(마감)일</span> <span className="font-bold text-red-600">{order.deliveryDate}</span></div>
                            <div className="pt-1"><span className="text-gray-500 block mb-1">납품 주소</span> <span className="font-bold block break-words">{order.deliveryAddress || '-'}</span></div>
                        </Card>
                    </div>

                    <h3 className="font-bold mb-2 flex items-center gap-2"><Package size={18}/> 자재 발주 현황</h3>
                    <div className="bg-white border rounded-xl overflow-hidden mb-6">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 border-b"><tr><th className="p-3">거래처</th><th className="p-3">품목</th><th className="p-3 text-center">상태 (클릭변경)</th></tr></thead>
                            <tbody>
                                {(order.materials || []).map((m, i) => (
                                    <tr key={i} className="border-b last:border-0 hover:bg-slate-50">
                                        <td className="p-3 font-bold">{m.supplier}</td>
                                        <td className="p-3">{m.item} ({m.quantity})</td>
                                        <td className="p-3 text-center" onClick={() => toggleMatStatus(m)}>
                                            <MaterialStatusBadge status={m.status} />
                                        </td>
                                    </tr>
                                ))}
                                {(!order.materials || order.materials.length === 0) && <tr><td colSpan="3" className="p-4 text-center text-gray-400">내역 없음</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const FormView = ({ order, onSave, onDelete, onCancel }) => {
            const [data, setData] = useState(order || {
                itemName: '', clientName: '', clientContact: '', deliveryAddress: '',
                manager: '', worker: '',
                orderDate: new Date().toISOString().split('T')[0], 
                deliveryDate: '', status: '설계중', description: '', materials: []
            });

            const handleAiSuggest = async () => {
                if (!data.itemName) return alert('작업명을 먼저 입력해주세요.');
                const prompt = `금속 인테리어 작업 '${data.itemName}'에 대한 일반적인 상세 시방서나 작업 내용을 3줄로 추천해줘.`;
                const res = await callGemini(prompt);
                setData(prev => ({ ...prev, description: res }));
            };

            return (
                <div className="max-w-2xl mx-auto animate-fade-in pb-10">
                    <div onClick={onCancel} className="mb-4 cursor-pointer text-slate-500 font-bold flex items-center gap-1"><ChevronLeft size={18}/> 취소</div>
                    <Card className="p-6 space-y-5">
                        <h2 className="text-2xl font-bold">{order ? '작업 수정' : '새 작업 등록'}</h2>
                        
                        <div className="grid gap-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">작업명 <span className="text-red-500">*</span></label>
                                <input className="border p-2 rounded w-full font-bold" value={data.itemName} onChange={e=>setData({...data, itemName:e.target.value})} placeholder="예: 성수동 카페 철제 파티션"/>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">담당자 (설계)</label>
                                    <input className="border p-2 rounded w-full" value={data.manager} onChange={e=>setData({...data, manager:e.target.value})} placeholder="설계 담당자"/>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">작업자 (제작)</label>
                                    <input className="border p-2 rounded w-full" value={data.worker} onChange={e=>setData({...data, worker:e.target.value})} placeholder="제작 담당자"/>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">발주받은 날 (시작)</label>
                                    <input type="date" className="border p-2 rounded w-full" value={data.orderDate} onChange={e=>setData({...data, orderDate:e.target.value})}/>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">납품해야 하는 날 (마감)</label>
                                    <input type="date" className="border p-2 rounded w-full font-bold text-red-600" value={data.deliveryDate} onChange={e=>setData({...data, deliveryDate:e.target.value})}/>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">클라이언트 (업체명)</label>
                                    <input className="border p-2 rounded w-full" value={data.clientName} onChange={e=>setData({...data, clientName:e.target.value})}/>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">연락처</label>
                                    <input className="border p-2 rounded w-full" value={data.clientContact} onChange={e=>setData({...data, clientContact:e.target.value})}/>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">납품/시공 주소</label>
                                <input className="border p-2 rounded w-full" value={data.deliveryAddress} onChange={e=>setData({...data, deliveryAddress:e.target.value})} placeholder="주소 입력"/>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">진행 상태</label>
                                <select className="border p-2 rounded w-full font-bold" value={data.status} onChange={e=>setData({...data, status:e.target.value})}>
                                    <option>설계중</option>
                                    <option>작업중</option>
                                    <option>도장/마감중</option>
                                    <option>작업완료</option>
                                    <option>납품완료</option>
                                </select>
                            </div>

                            <div>
                                <div className="flex justify-between items-center mb-1">
                                    <label className="block text-xs font-bold text-slate-500">작업 메모 / 특이사항</label>
                                    <button onClick={handleAiSuggest} className="text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded hover:bg-indigo-200">AI 자동 작성</button>
                                </div>
                                <textarea className="border p-2 rounded w-full h-24" value={data.description} onChange={e=>setData({...data, description:e.target.value})}/>
                            </div>
                        </div>

                        <div className="flex justify-end gap-2 pt-4 border-t">
                            {order && <button onClick={()=>onDelete(order.id)} className="text-red-500 px-4 py-2 rounded font-bold text-sm hover:bg-red-50">삭제</button>}
                            <button onClick={()=>onSave(data)} className="bg-slate-800 text-white px-6 py-2 rounded font-bold hover:bg-slate-900">저장</button>
                        </div>
                    </Card>
                </div>
            );
        };

        const MaterialManageView = ({ suppliers, orders, onUpdateOrder }) => {
            const [mode, setMode] = useState('list'); // list or form
            const [newSupplier, setNewSupplier] = useState({ name: '', phone: '', email: '', address: '' });
            const [itemData, setItemData] = useState({ orderId: '', item: '', quantity: '' });

            const handleAdd = async () => {
                if (!newSupplier.name || !itemData.item) return alert('거래처명과 품목은 필수입니다.');
                
                let targetOrder = orders.find(o => o.id === itemData.orderId);
                // '기타 발주'용 더미 오더 생성 로직은 생략하고, 기존 오더에만 추가하도록 간소화 (또는 기타 오더 자동생성)
                if (!targetOrder && itemData.orderId === '') {
                     // 기타 오더가 없으면 생성 로직 필요하지만 여기선 기존 오더 필수라고 가정
                     return alert("발주할 관련 작업을 선택해주세요.");
                }

                const material = {
                    id: Date.now(),
                    supplier: newSupplier.name,
                    supplierInfo: { // 거래처 정보 저장 (회수 동선용)
                        phone: newSupplier.phone,
                        address: newSupplier.address,
                        email: newSupplier.email,
                        lat: null, lng: null // 주소 기반 좌표는 API 필요. 여기선 저장만.
                    },
                    item: itemData.item,
                    quantity: itemData.quantity,
                    status: '발주',
                    date: new Date().toISOString().split('T')[0]
                };
                
                const updatedMaterials = [...(targetOrder.materials || []), material];
                await onUpdateOrder({ ...targetOrder, materials: updatedMaterials });
                setMode('list');
                setNewSupplier({ name: '', phone: '', email: '', address: '' });
                setItemData({ orderId: '', item: '', quantity: '' });
            };
            
            const toggleStatus = async (m, order) => {
                const flow = { '발주': '회수대기', '회수대기': '회수완료', '회수완료': '발주' };
                const next = flow[m.status];
                const updated = order.materials.map(x => x.id === m.id ? { ...x, status: next } : x);
                await onUpdateOrder({ ...order, materials: updated });
            };

            return (
                <div className="animate-fade-in pb-10">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold">자재/발주 통합 관리</h2>
                        <button onClick={()=>setMode(mode==='list'?'form':'list')} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold text-sm flex items-center gap-1">
                            {mode==='list' ? <><Plus size={16}/> 발주 등록</> : '목록 보기'}
                        </button>
                    </div>

                    {mode === 'form' && (
                        <Card className="p-6 mb-6 animate-fade-in">
                            <h3 className="font-bold mb-4 text-lg">새 자재 발주 등록</h3>
                            <div className="grid md:grid-cols-2 gap-6">
                                <div className="space-y-3">
                                    <div className="text-sm font-bold text-slate-500 border-b pb-1 mb-2">거래처 정보 입력</div>
                                    <input className="border p-2 rounded w-full" placeholder="거래처명 (필수)" value={newSupplier.name} onChange={e=>setNewSupplier({...newSupplier, name:e.target.value})}/>
                                    <input className="border p-2 rounded w-full" placeholder="전화번호" value={newSupplier.phone} onChange={e=>setNewSupplier({...newSupplier, phone:e.target.value})}/>
                                    <input className="border p-2 rounded w-full" placeholder="이메일" value={newSupplier.email} onChange={e=>setNewSupplier({...newSupplier, email:e.target.value})}/>
                                    <input className="border p-2 rounded w-full" placeholder="주소 (회수 동선에 사용)" value={newSupplier.address} onChange={e=>setNewSupplier({...newSupplier, address:e.target.value})}/>
                                </div>
                                <div className="space-y-3">
                                    <div className="text-sm font-bold text-slate-500 border-b pb-1 mb-2">발주 품목 정보</div>
                                    <select className="border p-2 rounded w-full" value={itemData.orderId} onChange={e=>setItemData({...itemData, orderId:e.target.value})}>
                                        <option value="">관련 작업 선택 (필수)</option>
                                        {orders.filter(o=>!['납품완료'].includes(o.status)).map(o=>(
                                            <option key={o.id} value={o.id}>{o.itemName}</option>
                                        ))}
                                    </select>
                                    <input className="border p-2 rounded w-full" placeholder="품목명 (예: 3T 레이저)" value={itemData.item} onChange={e=>setItemData({...itemData, item:e.target.value})}/>
                                    <input className="border p-2 rounded w-full" placeholder="수량/규격" value={itemData.quantity} onChange={e=>setItemData({...itemData, quantity:e.target.value})}/>
                                </div>
                            </div>
                            <button onClick={handleAdd} className="w-full bg-slate-800 text-white py-3 rounded font-bold mt-6 hover:bg-slate-900">발주 등록하기</button>
                        </Card>
                    )}

                    {/* Material List */}
                    <div className="bg-white border rounded-xl overflow-hidden shadow-sm">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 border-b"><tr><th className="p-3">상태 (클릭)</th><th className="p-3">거래처</th><th className="p-3">품목</th><th className="p-3 hidden md:table-cell">관련 작업</th><th className="p-3 hidden md:table-cell">주소/연락처</th></tr></thead>
                            <tbody>
                                {orders.flatMap(o => (o.materials || []).map(m => ({ ...m, order: o }))).map((m, i) => (
                                    <tr key={i} className="border-b hover:bg-slate-50 transition-colors">
                                        <td className="p-3" onClick={()=>toggleStatus(m, m.order)}>
                                            <MaterialStatusBadge status={m.status} />
                                        </td>
                                        <td className="p-3 font-bold">{m.supplier}</td>
                                        <td className="p-3">{m.item} <span className="text-gray-400 text-xs">({m.quantity})</span></td>
                                        <td className="p-3 hidden md:table-cell text-gray-500">{m.order.itemName}</td>
                                        <td className="p-3 hidden md:table-cell text-xs text-gray-400">
                                            {m.supplierInfo?.address || DEFAULT_SUPPLIERS[m.supplier]?.address || '-'}<br/>
                                            {m.supplierInfo?.phone || DEFAULT_SUPPLIERS[m.supplier]?.phone || '-'}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const ListView = ({ orders, onSelect, onAdd }) => {
             return (
                <div className="space-y-4 animate-fade-in pb-10">
                    <div className="flex justify-between items-center">
                        <div className="flex gap-2 bg-white p-2 rounded-lg border shadow-sm flex-1 max-w-md">
                            <Search size={20} className="text-gray-400"/>
                            <input className="flex-1 outline-none text-sm" placeholder="작업명 검색..."/>
                        </div>
                        <button onClick={onAdd} className="bg-slate-800 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-1">
                            <Plus size={16}/> 작업등록
                        </button>
                    </div>
                    <div className="space-y-2">
                        {orders.map(o => (
                            <Card key={o.id} className="p-3 flex justify-between items-center cursor-pointer hover:border-indigo-500" onClick={()=>onSelect(o)}>
                                <div>
                                    <div className="font-bold">{o.itemName}</div>
                                    <div className="text-xs text-gray-500 mt-1">{o.clientName} | {o.deliveryDate} 납품</div>
                                </div>
                                <StatusBadge status={o.status} />
                            </Card>
                        ))}
                    </div>
                </div>
             );
        };

        const CalendarView = () => <div className="text-center p-10 text-gray-400">일정 보기 (준비중)</div>;

        // --- Main App ---

        function App() {
            const [user, setUser] = useState(null);
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isOnline, setIsOnline] = useState(true); // Default true, change if fails
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);
            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedOrder, setSelectedOrder] = useState(null);

            // Urgent Notifications Logic
            const [showNoti, setShowNoti] = useState(false);
            const urgentCount = orders.filter(o => o.deliveryDate && !['납품완료'].includes(o.status) && Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2).length;

            // Firebase Init
            const { auth, db, appId } = useMemo(() => {
                try {
                    const app = initializeApp(firebaseConfig);
                    return { auth: getAuth(app), db: getFirestore(app), appId: firebaseConfig.appId };
                } catch (e) { return { auth: null, db: null, appId: null }; }
            }, []);

            // Auth & Data Logic (with LocalStorage Fallback)
            useEffect(() => {
                const init = async () => {
                    if (!auth) return loadLocal();
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.warn("Auth failed, using local storage");
                        setIsOnline(false);
                        loadLocal();
                    }
                };
                init();
                onAuthStateChanged(auth, u => {
                    setUser(u);
                    if(!u) setIsOnline(false);
                });
            }, [auth]);

            // Data Sync
            useEffect(() => {
                if (!user || !db) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderBy('createdAt', 'desc'));
                const unsub = onSnapshot(q, (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setOrders(data);
                    setIsOnline(true);
                    saveLocal(data); // Sync to local backup
                    setLoading(false);
                }, (err) => {
                    console.warn("Firestore failed, switching to local:", err);
                    setIsOnline(false);
                    loadLocal();
                    setLoading(false);
                });
                return () => unsub();
            }, [user, db, appId]);

            // Local Storage Helpers
            const saveLocal = (data) => localStorage.setItem('bk_orders', JSON.stringify(data));
            const loadLocal = () => {
                const saved = localStorage.getItem('bk_orders');
                if (saved) setOrders(JSON.parse(saved));
                else setOrders(MOCK_DATA);
                setLoading(false);
            };

            const handleLogin = (role) => {
                setIsAuthenticated(true);
                setIsAdmin(role === 'admin');
            };

            // CRUD (Auto fallback to Local)
            const saveOrder = async (data) => {
                const newOrders = data.id && !data.id.startsWith('local') 
                    ? orders.map(o => o.id === data.id ? data : o)
                    : [{ ...data, id: data.id || `local-${Date.now()}`, createdAt: new Date().toISOString() }, ...orders];
                
                // 1. Update UI & Local immediately
                setOrders(newOrders);
                saveLocal(newOrders);
                setCurrentView('list');
                setSelectedOrder(null);

                // 2. Try Server
                if (isOnline && db) {
                    try {
                        const col = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                        if (data.id && !data.id.startsWith('local')) {
                            await updateDoc(doc(col, data.id), { ...data, updatedAt: serverTimestamp() });
                        } else {
                            const { id, ...rest } = data; // remove local id
                            await addDoc(col, { ...rest, createdAt: serverTimestamp() });
                        }
                    } catch (e) { console.error("Save to server failed:", e); }
                }
            };

            const deleteOrder = async (id) => {
                if(window.confirm('삭제하시겠습니까?')) {
                    const newOrders = orders.filter(o => o.id !== id);
                    setOrders(newOrders);
                    saveLocal(newOrders);
                    setCurrentView('list');
                    if (isOnline && db && !id.startsWith('local')) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
                    }
                }
            };

            // Computed Suppliers
            const suppliers = useMemo(() => {
                const s = {};
                // 기본 거래처 추가
                Object.keys(DEFAULT_SUPPLIERS).forEach(k => {
                    s[k] = { info: DEFAULT_SUPPLIERS[k], items: [] };
                });
                // 주문에서 거래처 정보 추출
                orders.forEach(o => (o.materials || []).forEach(m => {
                    if (!s[m.supplier]) s[m.supplier] = { info: m.supplierInfo, items: [] };
                    s[m.supplier].items.push(m);
                }));
                return s;
            }, [orders]);

            if (!isAuthenticated) return <LoginView onLogin={handleLogin} />;
            if (loading) return <div className="flex h-screen items-center justify-center bg-slate-100"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-slate-800"></div></div>;

            return (
                <div className="flex h-screen bg-slate-100 text-slate-800 overflow-hidden">
                    {/* Sidebar */}
                    <div className="w-16 md:w-64 bg-slate-900 text-white flex flex-col flex-shrink-0">
                        <div className="p-5 flex items-center gap-3 font-bold text-xl border-b border-slate-800">
                            <div className="bg-white text-slate-900 rounded px-1.5 py-0.5 text-sm">BK</div>
                            <span className="hidden md:block whitespace-nowrap">숨쉬는 깡통</span>
                        </div>
                        <nav className="flex-1 p-3 space-y-2">
                            {[
                                { id: 'dashboard', icon: LayoutDashboard, label: '현황' },
                                { id: 'calendar', icon: CalendarIcon, label: '일정' },
                                { id: 'list', icon: FileText, label: '작업' },
                                { id: 'materials', icon: Truck, label: '발주' },
                            ].map(m => (
                                <button key={m.id} onClick={() => { setCurrentView(m.id); setSelectedOrder(null); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${currentView === m.id ? 'bg-indigo-600 shadow-lg' : 'hover:bg-slate-800 text-slate-400 hover:text-white'}`}>
                                    <m.icon size={20} /><span className="hidden md:block font-medium">{m.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 text-xs text-slate-500 text-center md:text-left bg-slate-950">
                            <div className="flex items-center gap-2 justify-center md:justify-start mb-1">
                                <div className={`w-2 h-2 rounded-full ${isOnline ? 'bg-green-500' : 'bg-amber-500'}`}></div>
                                {isOnline ? 'Online System' : 'Local Mode (Saved)'}
                            </div>
                            {isAdmin ? '관리자 접속' : '직원 접속'}
                        </div>
                    </div>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col overflow-hidden relative bg-slate-100">
                        {/* Top Header */}
                        <header className="h-16 bg-white border-b flex items-center justify-between px-6 shadow-sm flex-shrink-0 z-20">
                            <h2 className="font-bold text-xl text-slate-800">
                                {currentView === 'dashboard' && '현황 대시보드'}
                                {currentView === 'calendar' && '일정 캘린더'}
                                {currentView === 'list' && '작업 관리'}
                                {currentView === 'materials' && '자재 발주 및 회수'}
                                {currentView === 'detail' && '작업 상세 정보'}
                                {currentView === 'form' && '작업 등록/수정'}
                            </h2>
                            
                            {/* Urgent Notification Icon */}
                            <div className="relative">
                                <button onClick={()=>setShowNoti(!showNoti)} className="p-2 hover:bg-slate-100 rounded-full relative transition-colors">
                                    <Bell size={22} className={urgentCount > 0 ? "text-slate-700 animate-bounce-slight" : "text-slate-400"}/>
                                    {urgentCount > 0 && <span className="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>}
                                </button>
                                
                                {showNoti && (
                                    <>
                                    <div className="fixed inset-0 z-10" onClick={()=>setShowNoti(false)}></div>
                                    <div className="absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-2xl border border-slate-100 z-20 overflow-hidden animate-fade-in">
                                        <div className="p-3 bg-slate-50 border-b font-bold text-sm text-slate-600">마감 임박 작업 ({urgentCount})</div>
                                        <div className="max-h-64 overflow-y-auto">
                                            {orders.filter(o => o.deliveryDate && !['납품완료'].includes(o.status) && Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2).map(o => (
                                                <div key={o.id} className="p-3 border-b hover:bg-indigo-50 cursor-pointer flex justify-between items-center" onClick={()=>{
                                                    handleNavigate(o);
                                                    setShowNoti(false);
                                                }}>
                                                    <div className="text-sm font-bold text-slate-700 truncate w-40">{o.itemName}</div>
                                                    <div className="text-xs font-bold text-red-500">{o.deliveryDate} 까지</div>
                                                </div>
                                            ))}
                                            {urgentCount === 0 && <div className="p-6 text-center text-gray-400 text-sm">급한 작업이 없습니다. 휴!</div>}
                                        </div>
                                    </div>
                                    </>
                                )}
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 md:p-8">
                            <div className="max-w-6xl mx-auto">
                                {currentView === 'dashboard' && <Dashboard orders={orders} stats={stats} suppliers={suppliers} onNavigate={handleNavigate} />}
                                {currentView === 'calendar' && <CalendarView />}
                                {currentView === 'list' && !selectedOrder && <ListView orders={orders} onSelect={handleNavigate} onAdd={() => { setSelectedOrder(null); setCurrentView('form'); }} />}
                                {currentView === 'detail' && <DetailView order={selectedOrder} onBack={() => { setSelectedOrder(null); setCurrentView('list'); }} onUpdate={(data, view) => { if(view) setCurrentView(view); else saveOrder(data); }} isAdmin={isAdmin} />}
                                {currentView === 'form' && <FormView order={selectedOrder} onSave={saveOrder} onDelete={deleteOrder} onCancel={() => { setSelectedOrder(null); setCurrentView('list'); }} />}
                                {currentView === 'materials' && <MaterialManageView suppliers={suppliers} orders={orders} onUpdateOrder={saveOrder} />}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
