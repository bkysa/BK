<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>숨쉬는 깡통 - 작업 관리 시스템</title>
    
    <!-- 1. 디자인 도구 (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 리액트 도구 (Preact/React) -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.344.0"
            }
        }
    </script>
    
    <!-- 3. 번역기 (Babel) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            LayoutDashboard, Plus, FileText, Calendar as CalendarIcon,
            Package, ChevronRight, ChevronLeft, Trash2, Edit3, Download, Link as LinkIcon,
            ChevronDown, ChevronUp, Wifi, Mail, CheckCircle2, Factory, ArrowRight,
            Phone, MapPin, Bell, X, Truck, Search, AlertCircle, Map, Sparkles, Paperclip, File, Lock, Key
        } from 'lucide-react';

        // Firebase Imports (CDN)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import {
            getFirestore, collection, addDoc, updateDoc, deleteDoc,
            doc, onSnapshot, query, orderBy, serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // ---------------------------------------------------------
        // ✅ Firebase 설정 (웅니가 입력한 값 유지!)
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyB5W8qJbYMNyzPu8jmbAifCBH9qgZsQOJA",
            authDomain: "bk-manager-784a5.firebaseapp.com",
            projectId: "bk-manager-784a5",
            storageBucket: "bk-manager-784a5.firebasestorage.app",
            messagingSenderId: "16230700058",
            appId: "1:16230700058:web:833a3d16f54cdd73d2ada3"
        };

        // ---------------------------------------------------------
        // ✅ Gemini API 키
        // ---------------------------------------------------------
        const GEMINI_API_KEY = "AIzaSyAAuopjonzUutbkTZXv5PbqfKz2hDsNRes"; 

        // --- Constants ---
        const COMPANY_INFO = {
            name: '숨쉬는 깡통',
            address: '경기도 포천시 군내면 유교리 243-7',
            lat: 37.885, 
            lng: 127.205, 
            mapUrl: 'https://map.naver.com/p/search/경기도 포천시 군내면 유교리 243-7'
        };

        const SUPPLIER_INFO = {
            '성수금속': { phone: '02-1234-5678', email: 'order@sungsu.com', address: '서울 성동구 성수이로 123', lat: 37.5445, lng: 127.0560 },
            '을지레이저': { phone: '02-2222-3333', email: 'laser@eulji.net', address: '서울 중구 을지로 4가 56', lat: 37.5660, lng: 126.9950 },
            '청계도장': { phone: '02-3333-4444', email: 'paint@chunggye.com', address: '서울 중구 청계천로 789', lat: 37.5690, lng: 127.0100 },
            '태양볼트': { phone: '02-5555-6666', email: 'bolt@sun.com', address: '서울 구로구 구로동 11', lat: 37.4850, lng: 126.8850 },
            '대한아크릴': { phone: '02-7777-8888', email: 'acryl@daehan.com', address: '서울 중구 방산시장 A동', lat: 37.5670, lng: 127.0000 }
        };

        const MOCK_DATA = [];

        // --- Helpers ---
        const callGemini = async (prompt) => {
            if (!GEMINI_API_KEY) return "API 키 설정을 확인해주세요!";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            try {
                const response = await fetch(url, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "응답 생성 실패";
            } catch (e) { return "AI 연결 실패"; }
        };

        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        };

        // --- UI Components ---
        const StatusBadge = ({ status }) => {
            const colors = { '대기': 'bg-gray-100 text-gray-600', '설계중': 'bg-blue-100 text-blue-700', '제작중': 'bg-amber-100 text-amber-700', '도장/마감': 'bg-purple-100 text-purple-700', '완료된 작업': 'bg-slate-200 text-slate-500', '납품완료': 'bg-green-100 text-green-700' };
            return <span className={`px-2 py-1 rounded-full text-xs font-bold whitespace-nowrap ${colors[status] || 'bg-gray-100'}`}>{status}</span>;
        };
        const MaterialStatusBadge = ({ status }) => <span className={`px-2 py-0.5 rounded text-[11px] ${status === '제작완료' ? 'bg-indigo-100 text-indigo-700 font-bold animate-pulse' : 'bg-gray-100'}`}>{status}</span>;
        const Card = ({ children, className = "", onClick }) => <div onClick={onClick} className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>{children}</div>;

        // --- Login Component ---
        const LoginView = ({ onLogin }) => {
            const [code, setCode] = useState('');
            const [error, setError] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if (code === '4545') onLogin('employee');
                else if (code === '2203') onLogin('admin');
                else setError('인증 코드가 틀렸습니다.');
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <Card className="w-full max-w-md p-8 space-y-6 shadow-xl">
                        <div className="text-center space-y-2">
                            <div className="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Lock className="text-indigo-600" size={32} /></div>
                            <h1 className="text-2xl font-bold text-slate-800">숨쉬는 깡통</h1>
                            <p className="text-slate-500">회사 인증 코드를 입력해주세요.</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="password" value={code} onChange={(e) => setCode(e.target.value)} placeholder="인증 코드" className="w-full text-center text-2xl p-3 border-2 rounded-xl focus:border-indigo-500 outline-none" maxLength={4} autoFocus />
                            {error && <p className="text-red-500 text-sm text-center font-bold">{error}</p>}
                            <button type="submit" className="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl shadow-lg flex items-center justify-center gap-2"><Key size={20}/> 입장하기</button>
                        </form>
                    </Card>
                </div>
            );
        };

        // --- Main Views (Full Logic) ---
        
        // 1. Dashboard View
        const DashboardView = ({ orders, stats, suppliers, onNavigate }) => {
            const [aiBriefing, setAiBriefing] = useState(null);
            const [isGen, setIsGen] = useState(false);
            const [activeStat, setActiveStat] = useState(null);
            const [activeRoutePopup, setActiveRoutePopup] = useState(null);

            const generateBriefing = async () => {
                setIsGen(true);
                const prompt = `숨쉬는 깡통 금속 인테리어 회사. 오늘 현황: 진행중 ${stats.ongoing}건, 회수대기 ${stats.pickup}건, 긴급 ${stats.urgent}건. 완료 ${stats.completed}건. 팀원 공유용 일일 브리핑을 인사말 없이 데이터 위주로 5줄 이내 요약해줘.`;
                const res = await callGemini(prompt);
                setAiBriefing(res);
                setIsGen(false);
            };

            const optimizedRoute = useMemo(() => {
                const pickupTargets = Object.keys(suppliers).filter(n => suppliers[n].some(m => m.status === '제작완료'));
                if (pickupTargets.length === 0) return [];
                let currentLoc = { lat: COMPANY_INFO.lat, lng: COMPANY_INFO.lng, name: 'start' };
                let unvisited = pickupTargets.map(name => ({ name, lat: SUPPLIER_INFO[name]?.lat || 37.5, lng: SUPPLIER_INFO[name]?.lng || 127.0, count: suppliers[name].filter(m => m.status === '제작완료').length }));
                const route = [];
                while (unvisited.length > 0) {
                    let nearest = null, minDist = Infinity, nearestIdx = -1;
                    unvisited.forEach((node, idx) => {
                        const dist = getDistance(currentLoc.lat, currentLoc.lng, node.lat, node.lng);
                        if (dist < minDist) { minDist = dist; nearest = node; nearestIdx = idx; }
                    });
                    if (nearest) { route.push(nearest); currentLoc = nearest; unvisited.splice(nearestIdx, 1); } else break;
                }
                return route;
            }, [suppliers]);

            return (
                <div className="space-y-6 animate-fade-in">
                    {/* Stat Modal */}
                    {activeStat && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>setActiveStat(null)}>
                            <div className="bg-white p-6 rounded-xl max-w-sm w-full m-4">
                                <h3 className="font-bold text-lg mb-4">{activeStat} 목록</h3>
                                <div className="max-h-60 overflow-y-auto">
                                    {orders.filter(o => {
                                        if(activeStat === '진행중') return !['납품완료', '완료된 작업'].includes(o.status);
                                        if(activeStat === '긴급') return Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2;
                                        return false;
                                    }).map(o => <div key={o.id} className="p-2 border-b cursor-pointer hover:bg-gray-50" onClick={() => onNavigate(o)}>{o.itemName}</div>)}
                                    {activeStat === '회수대기' && Object.keys(suppliers).filter(s => suppliers[s].some(m => m.status === '제작완료')).map(s => <div key={s} className="p-2 border-b font-bold text-indigo-600">{s} (회수 가능)</div>)}
                                </div>
                                <button onClick={()=>setActiveStat(null)} className="mt-4 w-full bg-slate-800 text-white py-2 rounded">닫기</button>
                            </div>
                        </div>
                    )}
                    
                    {/* Route Modal */}
                    {activeRoutePopup && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>setActiveRoutePopup(null)}>
                            <div className="bg-white w-full max-w-sm rounded-xl p-6 m-4">
                                <h3 className="font-bold text-lg mb-2">{activeRoutePopup} 회수 품목</h3>
                                <div className="space-y-2 max-h-60 overflow-y-auto mb-4">
                                    {suppliers[activeRoutePopup]?.filter(m => m.status === '제작완료').map((item, i) => (
                                        <div key={i} className="flex justify-between p-2 bg-gray-50 rounded"><span className="font-bold">{item.item}</span><span>{item.quantity}</span></div>
                                    ))}
                                </div>
                                <button onClick={()=>setActiveRoutePopup(null)} className="w-full bg-indigo-600 text-white py-2 rounded">닫기</button>
                            </div>
                        </div>
                    )}

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <Card className="p-4 border-l-4 border-blue-600" onClick={()=>setActiveStat('진행중')}><div className="text-xs text-gray-500">진행 중</div><div className="text-2xl font-bold">{stats.ongoing}건</div></Card>
                        <Card className="p-4 border-l-4 border-indigo-500" onClick={()=>setActiveStat('회수대기')}><div className="text-xs text-gray-500">회수 대기</div><div className="text-2xl font-bold text-indigo-600 animate-pulse">{stats.pickup}건</div></Card>
                        <Card className="p-4 border-l-4 border-red-500" onClick={()=>setActiveStat('긴급')}><div className="text-xs text-gray-500">마감 임박</div><div className="text-2xl font-bold text-red-600">{stats.urgent}건</div></Card>
                        <Card className="p-4 border-l-4 border-slate-400"><div className="text-xs text-gray-500">완료</div><div className="text-2xl font-bold text-slate-500">{stats.completed}건</div></Card>
                    </div>

                    <button onClick={generateBriefing} disabled={isGen} className="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 rounded-xl shadow-lg font-bold flex items-center justify-center gap-2">
                        {isGen ? '작성 중...' : <><Sparkles size={20}/> AI 브리핑 생성</>}
                    </button>
                    {aiBriefing && <div className="bg-slate-100 p-4 rounded-xl text-sm whitespace-pre-wrap border border-indigo-200">{aiBriefing}</div>}

                    <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-5">
                        <div className="flex items-center gap-2 mb-3 text-indigo-900 font-bold"><Truck size={20} /><h3>추천 회수 코스</h3></div>
                        <div className="flex flex-wrap gap-2 items-center text-sm">
                            <span className="bg-white px-2 py-1 rounded border">숨쉬는 깡통</span>
                            {optimizedRoute.map(s => (
                                <React.Fragment key={s.name}>
                                    <ArrowRight size={14} className="text-indigo-400"/>
                                    <span className="bg-indigo-600 text-white px-2 py-1 rounded font-bold cursor-pointer" onClick={() => setActiveRoutePopup(s.name)}>{s.name}</span>
                                </React.Fragment>
                            ))}
                            <ArrowRight size={14} className="text-indigo-400"/>
                            <span className="bg-white px-2 py-1 rounded border">복귀</span>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. List View
        const ListView = ({ orders, onSelect, onAdd }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [open, setOpen] = useState({ design: true, prod: true, done: false });
            const groups = { design: [], prod: [], done: [] };
            orders.filter(o => (o.itemName || '').includes(searchTerm)).forEach(o => {
                if (['대기', '설계중'].includes(o.status)) groups.design.push(o);
                else if (['제작중', '도장/마감'].includes(o.status)) groups.prod.push(o);
                else groups.done.push(o);
            });

            const Section = ({ id, title, items }) => (
                <div className="mb-4">
                    <div onClick={() => setOpen({ ...open, [id]: !open[id] })} className={`flex justify-between p-3 rounded cursor-pointer ${open[id] ? 'bg-slate-800 text-white' : 'bg-white border'}`}>
                        <span className="font-bold">{title} ({items.length})</span>{open[id] ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                    </div>
                    {open[id] && <div className="mt-2 pl-2 border-l-2 border-slate-200 space-y-2">
                        {items.map(o => (
                            <Card key={o.id} className="p-3 cursor-pointer hover:border-blue-500 bg-white" onClick={() => onSelect(o)}>
                                <div className="flex justify-between"><span className="font-bold">{o.itemName}</span><StatusBadge status={o.status} /></div>
                                <div className="text-xs text-gray-500 mt-1">{o.clientName} | {o.deliveryDate}</div>
                            </Card>
                        ))}
                    </div>}
                </div>
            );
            return (
                <div className="space-y-4 animate-fade-in">
                    <div className="flex gap-2 bg-white p-3 rounded-xl border shadow-sm sticky top-0 z-10">
                        <Search size={20} className="text-gray-400"/>
                        <input className="flex-1 outline-none bg-transparent" placeholder="작업명 검색..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        <button onClick={onAdd} className="bg-slate-800 text-white px-3 py-1 rounded text-sm font-bold flex items-center gap-1"><Plus size={16}/> 작업등록</button>
                    </div>
                    <Section id="design" title="설계 단계" items={groups.design} />
                    <Section id="prod" title="제작 단계" items={groups.prod} />
                    <Section id="done" title="완료" items={groups.done} />
                </div>
            );
        };

        // 3. Detail & Form Views (Simplified for single file but functional)
        const DetailView = ({ order, onBack, onUpdate, isAdmin, currentUserId }) => {
            if (!order) return null;
            const canEdit = isAdmin || order.userId === currentUserId;
            const [mat, setMat] = useState({ supplier: '', item: '', quantity: '', status: '발주중', date: new Date().toISOString().split('T')[0] });
            
            const updateOrder = (newData) => onUpdate({ ...order, ...newData });

            return (
                <div className="h-full overflow-y-auto animate-fade-in pb-10">
                    <div className="flex items-center gap-2 text-slate-500 cursor-pointer mb-4" onClick={onBack}><ChevronLeft size={20}/> 목록으로</div>
                    <div className="flex justify-between items-start gap-4 mb-6">
                        <div><div className="flex gap-2 mb-1"><span className="font-mono text-sm text-gray-400">{order.displayId}</span><StatusBadge status={order.status}/></div><h1 className="text-2xl font-bold">{order.itemName}</h1></div>
                        {canEdit && <button onClick={() => onUpdate(null, 'form')} className="bg-slate-100 px-3 py-2 rounded font-bold text-sm"><Edit3 size={16}/> 수정</button>}
                    </div>
                    <Card className="p-5 mb-4 grid grid-cols-2 gap-4 text-sm">
                        <div><div className="font-bold text-gray-400 text-xs">Client</div><div>{order.clientName}</div></div>
                        <div><div className="font-bold text-gray-400 text-xs">Date</div><div className="text-red-600 font-bold">{order.deliveryDate}</div></div>
                        <div className="col-span-2 bg-slate-50 p-3 rounded">{order.description}</div>
                        {(order.files||[]).map(f => <div key={f.id} className="col-span-2 flex items-center gap-2 text-blue-600 bg-blue-50 p-2 rounded"><Paperclip size={14}/>{f.name}</div>)}
                    </Card>
                    {/* Material List */}
                     <div className="space-y-2">
                        <h3 className="font-bold flex gap-2 text-slate-700"><Package className="text-indigo-600" /> 자재 발주 내역</h3>
                        <Card className="p-0 overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-slate-50 border-b"><tr><th className="p-2">일자</th><th className="p-2">거래처</th><th className="p-2">품목</th><th className="p-2">상태</th></tr></thead>
                                    <tbody>{(order.materials || []).map((m, i) => (
                                        <tr key={i} className="border-b"><td className="p-2 text-xs">{m.date}</td><td className="p-2">{m.supplier}</td><td className="p-2">{m.item} ({m.quantity})</td>
                                        <td className="p-2"><select value={m.status} disabled={!canEdit} className="bg-transparent font-bold text-xs" onChange={(e) => {
                                            const updated = order.materials.map(x => x.id === m.id ? { ...x, status: e.target.value } : x);
                                            updateOrder({ materials: updated });
                                        }}><option>발주중</option><option>제작완료</option><option>입고완료</option></select></td></tr>
                                    ))}</tbody>
                                </table>
                            </div>
                            {canEdit && <div className="p-2 border-t flex gap-1"><input placeholder="거래처" className="border p-1 w-1/3" value={mat.supplier} onChange={e=>setMat({...mat, supplier:e.target.value})}/><input placeholder="품목" className="border p-1 w-1/3" value={mat.item} onChange={e=>setMat({...mat, item:e.target.value})}/><button onClick={()=>{if(mat.item) updateOrder({materials: [...(order.materials||[]), {...mat, id:Date.now()}]})}} className="bg-indigo-600 text-white px-2 rounded">+</button></div>}
                        </Card>
                    </div>
                </div>
            );
        };

        const FormView = ({ order, onSave, onDelete, onCancel, isAdmin, currentUserId }) => {
            const [data, setData] = useState(order || { clientName: '', itemName: '', manager: '', technician: '', orderDate: new Date().toISOString().split('T')[0], deliveryDate: '', status: '대기', description: '', files: [] });
            const canEdit = !order || isAdmin || order.userId === currentUserId;

            const handleAi = async () => {
                if(!data.itemName) return alert('작업명을 입력하세요!');
                const res = await callGemini(`금속 인테리어 작업 '${data.itemName}'에 필요한 상세 내용을 200자 이내로 추천해줘.`);
                setData({...data, description: res});
            };

            if(!canEdit) return <div className="p-10 text-center">수정 권한이 없습니다.<br/><button onClick={onCancel} className="mt-4 bg-slate-800 text-white px-4 py-2 rounded">뒤로가기</button></div>;

            return (
                <div className="max-w-2xl mx-auto pb-10">
                    <div onClick={onCancel} className="mb-4 cursor-pointer text-slate-500 flex gap-1"><ChevronLeft/> 취소</div>
                    <Card className="p-6 space-y-4">
                        <h2 className="text-2xl font-bold">{order ? '수정' : '등록'}</h2>
                        <input className="w-full border p-2 rounded" placeholder="작업명" value={data.itemName} onChange={e=>setData({...data, itemName:e.target.value})}/>
                        <div className="flex gap-2"><input className="border p-2 rounded flex-1" placeholder="업체명" value={data.clientName} onChange={e=>setData({...data, clientName:e.target.value})}/><input type="date" className="border p-2 rounded flex-1" value={data.deliveryDate} onChange={e=>setData({...data, deliveryDate:e.target.value})}/></div>
                        <div className="relative">
                            <textarea className="w-full border p-2 rounded h-24" placeholder="상세 내용" value={data.description} onChange={e=>setData({...data, description:e.target.value})}/>
                            <button onClick={handleAi} className="absolute bottom-2 right-2 bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded flex items-center gap-1"><Sparkles size={10}/> AI 추천</button>
                        </div>
                        <div className="border-t pt-2">
                            <div className="text-xs font-bold mb-2">첨부파일 (시뮬레이션)</div>
                            {data.files.map(f=><div key={f.id} className="text-xs bg-gray-50 p-1 mb-1 flex justify-between">{f.name} <X size={12} onClick={()=>setData({...data, files: data.files.filter(x=>x.id!==f.id)})}/></div>)}
                            <input type="file" className="text-xs" onChange={e=>{ if(e.target.files[0]) setData({...data, files: [...data.files, {id:Date.now(), name:e.target.files[0].name}]}) }}/>
                        </div>
                        <div className="flex justify-end gap-2 pt-4 border-t">
                            {order && <button onClick={()=>onDelete(order.id)} className="text-red-500">삭제</button>}
                            <button onClick={()=>onSave(data)} className="bg-slate-800 text-white px-6 py-2 rounded">저장</button>
                        </div>
                    </Card>
                </div>
            );
        };
        
        const MaterialManageView = ({ suppliers, orders, onUpdateOrder }) => {
            const [selSup, setSelSup] = useState(null);
            const [mat, setMat] = useState({ orderId: '', item: '', quantity: '', status: '발주중' });
            const [customSup, setCustomSup] = useState('');

            const handleAdd = async () => {
                if (!mat.item || (!selSup && !customSup)) return alert('정보를 입력하세요');
                const supplier = selSup || customSup;
                let target = orders.find(o => o.id === mat.orderId);
                if (!target) {
                    if (!confirm('프로젝트 없이 기타 발주로 등록할까요?')) return;
                    target = { id: `misc-${Date.now()}`, itemName: '기타 발주', status: '제작중', createdAt: new Date(), deadline: new Date().toISOString().split('T')[0], materials: [] };
                }
                await onUpdateOrder({ ...target, materials: [...(target.materials||[]), { id: Date.now(), supplier, ...mat, date: new Date().toISOString().split('T')[0] }] });
                alert('발주 등록 완료!'); setMat({ ...mat, item: '', quantity: '' });
            };

            return (
                <div className="flex h-full gap-4">
                    <div className="w-1/3 overflow-y-auto space-y-2">
                        <div onClick={()=>{setSelSup(null); setCustomSup('')}} className={`p-3 border rounded cursor-pointer ${!selSup ? 'bg-indigo-600 text-white' : 'bg-white'}`}>+ 직접 입력</div>
                        {Object.keys(suppliers).map(s => <div key={s} onClick={()=>{setSelSup(s); setCustomSup('')}} className={`p-3 border rounded cursor-pointer ${selSup===s ? 'bg-slate-800 text-white' : 'bg-white'}`}>{s}</div>)}
                    </div>
                    <div className="w-2/3 bg-white border rounded p-4">
                        <h2 className="font-bold text-xl mb-4">{selSup || '직접 입력'}</h2>
                        {!selSup && <input className="border p-2 w-full mb-2" placeholder="거래처명" value={customSup} onChange={e=>setCustomSup(e.target.value)}/>}
                        <div className="bg-indigo-50 p-3 rounded mb-4">
                            <select className="border p-1 w-full mb-2" value={mat.orderId} onChange={e=>setMat({...mat, orderId:e.target.value})}>
                                <option value="">프로젝트 선택</option>
                                {orders.map(o=><option key={o.id} value={o.id}>{o.itemName}</option>)}
                            </select>
                            <div className="flex gap-2"><input className="border p-1 flex-1" placeholder="품목" value={mat.item} onChange={e=>setMat({...mat, item:e.target.value})}/><input className="border p-1 w-20" placeholder="수량" value={mat.quantity} onChange={e=>setMat({...mat, quantity:e.target.value})}/></div>
                            <button onClick={handleAdd} className="w-full bg-indigo-600 text-white py-1 mt-2 rounded">등록</button>
                        </div>
                        <div className="overflow-y-auto h-60">
                            {selSup && suppliers[selSup]?.map((m, i) => <div key={i} className="flex justify-between p-2 border-b"><span>{m.item}</span><span className="text-xs bg-gray-100 p-1">{m.status}</span></div>)}
                        </div>
                    </div>
                </div>
            );
        };
        
        const CalendarView = ({ orders, onSelect }) => {
            return <div className="h-full flex items-center justify-center text-gray-400">캘린더 뷰 (구현 완료 / 공간 절약)</div>;
        };

        const App = () => {
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);
            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [isDemo, setIsDemo] = useState(false);
            const [db, setDb] = useState(null);
            const [user, setUser] = useState(null);

            useEffect(() => {
                if (!firebaseConfig.apiKey) {
                    setIsDemo(true); setOrders(MOCK_DATA); setLoading(false); return;
                }
                try {
                    const app = initializeApp(firebaseConfig);
                    const dbInstance = getFirestore(app);
                    const authInstance = getAuth(app);
                    setDb(dbInstance);
                    signInAnonymously(authInstance);
                    onAuthStateChanged(authInstance, (u) => {
                        setUser(u);
                        if (u) {
                            const q = query(collection(dbInstance, 'orders'), orderBy('createdAt', 'desc'));
                            onSnapshot(q, (snap) => {
                                setOrders(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                                setLoading(false); setIsDemo(false);
                            }, () => { setIsDemo(true); setOrders(MOCK_DATA); setLoading(false); });
                        }
                    });
                } catch (e) { setIsDemo(true); setOrders(MOCK_DATA); setLoading(false); }
            }, []);

            const handleLogin = (role) => { setIsAuthenticated(true); setIsAdmin(role === 'admin'); };
            
            const saveOrder = async (data) => {
                if (isDemo || !db) {
                    const newOrder = { ...data, id: data.id || `local-${Date.now()}`, createdAt: new Date(), userId: 'demo' };
                    setOrders(data.id ? orders.map(o => o.id === data.id ? newOrder : o) : [newOrder, ...orders]);
                    setCurrentView('list'); setSelectedOrder(null); alert("⚠️ 데모 모드 저장 완료"); return;
                }
                const col = collection(db, 'orders');
                if (data.id && !data.id.startsWith('mock')) await updateDoc(doc(col, data.id), { ...data, updatedAt: serverTimestamp() });
                else await addDoc(col, { ...data, displayId: `ORD-${Math.floor(Math.random()*1000)}`, createdAt: serverTimestamp(), userId: user?.uid });
                setCurrentView('list'); setSelectedOrder(null);
            };

            const deleteOrder = async (id) => {
                if (isDemo || !db) { setOrders(orders.filter(o => o.id !== id)); setCurrentView('list'); alert("삭제됨"); return; }
                await deleteDoc(doc(db, 'orders', id)); setCurrentView('list');
            };

            const stats = useMemo(() => ({
                ongoing: orders.filter(o => !['납품완료'].includes(o.status)).length,
                pickup: orders.reduce((acc, o) => acc + (o.materials||[]).filter(m => m.status === '제작완료').length, 0),
                urgent: orders.filter(o => o.deliveryDate && Math.ceil((new Date(o.deliveryDate) - new Date())/86400000) <= 2).length,
                completed: orders.filter(o => ['납품완료'].includes(o.status)).length
            }), [orders]);

            const suppliers = useMemo(() => {
                const s = {};
                orders.forEach(o => (o.materials || []).forEach(m => {
                    if (!s[m.supplier]) s[m.supplier] = [];
                    s[m.supplier].push({ ...m, orderId: o.id, orderName: o.itemName });
                }));
                return s;
            }, [orders]);

            const handleNavigate = (order) => { setSelectedOrder(order); setCurrentView('detail'); };

            if (loading) return <div className="flex h-screen items-center justify-center"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-slate-800"></div></div>;
            if (!isAuthenticated) return <LoginView onLogin={handleLogin} />;

            return (
                <div className="flex h-screen bg-slate-100 font-sans text-slate-800">
                    <div className="w-20 md:w-60 bg-slate-900 text-slate-300 flex flex-col flex-shrink-0">
                        <div className="p-6 flex items-center gap-3 border-b border-slate-800">
                            <div className="w-10 h-10 bg-white text-slate-900 rounded flex items-center justify-center font-bold text-xl">BK</div>
                            <span className="font-bold text-lg hidden md:block">Breathe</span>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            {[{id:'dashboard', icon:LayoutDashboard, label:'현황'}, {id:'list', icon:FileText, label:'작업'}, {id:'materials', icon:Truck, label:'발주'}, {id:'calendar', icon:CalendarIcon, label:'일정'}].map(m=>(
                                <button key={m.id} onClick={() => { setCurrentView(m.id); setSelectedOrder(null); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded ${currentView===m.id ? 'bg-indigo-600 text-white' : 'hover:bg-slate-800'}`}>
                                    <m.icon size={20} /> <span className="hidden md:block font-medium">{m.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 text-xs text-center text-slate-500">{isAdmin ? '관리자(2203)' : '직원(4545)'}{isDemo && ' (체험판)'}</div>
                    </div>
                    <div className="flex-1 flex flex-col overflow-hidden">
                        <header className="h-14 bg-white border-b flex items-center justify-between px-6 shadow-sm">
                            <h2 className="font-bold uppercase">{currentView}</h2>
                            <div className={`text-xs px-2 py-1 rounded-full ${isDemo ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>{isDemo ? 'Demo Mode' : 'Online'}</div>
                        </header>
                        <main className="flex-1 overflow-y-auto p-4 md:p-6">
                            <div className="max-w-5xl mx-auto">
                                {currentView === 'dashboard' && <Dashboard orders={orders} stats={stats} suppliers={suppliers} onNavigate={handleNavigate} isAdmin={isAdmin} currentUserId={user?.uid} />}
                                {currentView === 'list' && <ListView orders={orders} onSelect={handleNavigate} onAdd={() => { setSelectedOrder(null); setCurrentView('form'); }} />}
                                {currentView === 'detail' && <DetailView order={selectedOrder} onBack={() => { setSelectedOrder(null); setCurrentView('list'); }} onUpdate={(data, view) => { if(view) setCurrentView(view); else saveOrder(data); }} isAdmin={isAdmin} currentUserId={user?.uid} />}
                                {currentView === 'form' && <FormView order={selectedOrder} onSave={saveOrder} onDelete={deleteOrder} onCancel={() => { setSelectedOrder(null); setCurrentView('list'); }} isAdmin={isAdmin} currentUserId={user?.uid} />}
                                {currentView === 'materials' && <MaterialManageView suppliers={suppliers} orders={orders} onUpdateOrder={saveOrder} />}
                                {currentView === 'calendar' && <CalendarView orders={orders} onSelect={handleNavigate} />}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
