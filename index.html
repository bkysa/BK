<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>숨쉬는 깡통 관리 시스템</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar Hide */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // Global Variable for App ID (Environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'breathable-can-manager';
        
        // Configuration (User Provided)
        const firebaseConfig = {
            apiKey: "AIzaSyB5W8qJbYMNyzPu8jmbAifCBH9qgZsQOJA",
            authDomain: "bk-manager-784a5.firebaseapp.com",
            projectId: "bk-manager-784a5",
            storageBucket: "bk-manager-784a5.firebasestorage.app",
            messagingSenderId: "16230700058",
            appId: "1:16230700058:web:833a3d16f54cdd73d2ada3",
            measurementId: "G-PMGKK5F8CP"
        };

        // Expose to window for React
        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        window.firebaseFunctions = {
            signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp,
            appId
        };
    </script>

    <!-- Main React Application -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { 
            LayoutDashboard, Plus, FileText, Calendar: CalendarIcon,
            Package, ChevronRight, ChevronLeft, Trash2, Edit3, Download, Link: LinkIcon,
            ChevronDown, ChevronUp, Wifi, Mail, CheckCircle2, Factory, ArrowRight,
            Phone, MapPin, Bell, X, Truck, Search, AlertCircle, Map, Sparkles, Paperclip, File, Lock, Key, FileBox, Save
        } = lucide;

        // --- Gemini API Helper ---
        const callGemini = async (prompt) => {
            const apiKey = "AIzaSyAAuopjonzUutbkTZXv5PbqfKz2hDsNRes"; // User Provided Key
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            let retries = 0;
            const maxRetries = 3;
            const delays = [1000, 2000, 4000];

            while (retries <= maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "응답을 생성하지 못했어요.";
                } catch (e) {
                    retries++;
                    if (retries > maxRetries) {
                        console.error("Gemini API failed:", e);
                        return "AI 서버 연결에 실패했습니다. 잠시 후 다시 시도해주세요.";
                    }
                    await new Promise(resolve => setTimeout(resolve, delays[retries - 1]));
                }
            }
        };

        // --- Constants & Mock Data ---
        const COMPANY_INFO = {
            name: '숨쉬는 깡통',
            address: '경기도 포천시 군내면 유교리 243-7',
            lat: 37.885, 
            lng: 127.205, 
            mapUrl: 'https://map.naver.com/p/search/경기도 포천시 군내면 유교리 243-7'
        };

        const SUPPLIER_INFO = {
            '성수금속': { phone: '02-1234-5678', email: 'order@sungsu.com', address: '서울 성동구 성수이로 123', lat: 37.5445, lng: 127.0560 },
            '을지레이저': { phone: '02-2222-3333', email: 'laser@eulji.net', address: '서울 중구 을지로 4가 56', lat: 37.5660, lng: 126.9950 },
            '청계도장': { phone: '02-3333-4444', email: 'paint@chunggye.com', address: '서울 중구 청계천로 789', lat: 37.5690, lng: 127.0100 },
            '태양볼트': { phone: '02-5555-6666', email: 'bolt@sun.com', address: '서울 구로구 구로동 11', lat: 37.4850, lng: 126.8850 },
            '대한아크릴': { phone: '02-7777-8888', email: 'acryl@daehan.com', address: '서울 중구 방산시장 A동', lat: 37.5670, lng: 127.0000 }
        };

        // --- Helper Function: Distance Calculation (Haversine) ---
        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        };

        // --- Components ---
        const StatusBadge = ({ status }) => {
            const colors = {
                '대기': 'bg-gray-100 text-gray-600',
                '설계중': 'bg-blue-100 text-blue-700',
                '제작중': 'bg-amber-100 text-amber-700',
                '도장/마감': 'bg-purple-100 text-purple-700',
                '완료된 작업': 'bg-slate-200 text-slate-500 font-medium',
                '납품완료': 'bg-green-100 text-green-700',
            };
            return <span className={`flex-shrink-0 px-2 py-1 rounded-full text-xs font-bold whitespace-nowrap ${colors[status] || 'bg-gray-100'}`}>{status}</span>;
        };

        const MaterialStatusBadge = ({ status }) => {
            const colors = {
                '발주중': 'bg-yellow-100 text-yellow-700',
                '제작완료': 'bg-indigo-100 text-indigo-700 font-bold animate-pulse',
                '입고완료': 'bg-green-100 text-green-700',
            };
            return <span className={`flex-shrink-0 px-2 py-0.5 rounded text-[11px] whitespace-nowrap ${colors[status] || 'bg-gray-100'}`}>{status}</span>;
        };

        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>{children}</div>
        );

        const LoginView = ({ onLogin }) => {
            const [code, setCode] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (code === '4545') {
                    onLogin('employee');
                } else if (code === '2203') {
                    onLogin('admin');
                } else {
                    setError('등록된 코드가 아닙니다.');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <Card className="w-full max-w-md p-8 space-y-6 shadow-xl">
                        <div className="text-center space-y-2">
                            <div className="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Lock className="text-indigo-600" size={32} />
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800">숨쉬는 깡통</h1>
                            <p className="text-slate-500">관리 시스템 접근 권한 확인</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <input 
                                    type="password" 
                                    value={code}
                                    onChange={(e) => {setCode(e.target.value); setError('');}}
                                    placeholder="인증 코드 (4자리)"
                                    className="w-full text-center text-2xl tracking-widest p-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all"
                                    maxLength={4}
                                    autoFocus
                                />
                                {error && <p className="text-red-500 text-sm text-center mt-2 font-bold animate-pulse">{error}</p>}
                            </div>
                            <button 
                                type="submit"
                                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2"
                            >
                                <Key size={20}/> 입장하기
                            </button>
                        </form>
                    </Card>
                </div>
            );
        };

        const NewOrderModal = ({ isOpen, onClose, onSubmit }) => {
            if (!isOpen) return null;
            
            const [formData, setFormData] = useState({
                itemName: '', clientName: '', deliveryDate: '', description: ''
            });
            const [newFile, setNewFile] = useState({ name: '', url: '' });
            const [files, setFiles] = useState([]);

            const handleAddFile = () => {
                if (!newFile.name || !newFile.url) return;
                setFiles([...files, { ...newFile, id: Date.now() }]);
                setNewFile({ name: '', url: '' });
            };

            const handleSubmit = () => {
                if(!formData.itemName) return alert('작업명을 입력해주세요.');
                onSubmit({ ...formData, files });
                onClose();
                setFormData({ itemName: '', clientName: '', deliveryDate: '', description: '' });
                setFiles([]);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 animate-fade-in">
                    <div className="bg-white w-full max-w-lg rounded-xl shadow-2xl flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="font-bold text-lg">새 작업 등록</h3>
                            <button onClick={onClose}><X size={20} className="text-gray-400"/></button>
                        </div>
                        <div className="p-6 space-y-4 overflow-y-auto">
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">작업명 (필수)</label>
                                <input className="w-full p-2 border rounded" placeholder="예: 성수동 카페 금속 집기" value={formData.itemName} onChange={e=>setFormData({...formData, itemName: e.target.value})} />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">발주처/고객</label>
                                    <input className="w-full p-2 border rounded" placeholder="고객사명" value={formData.clientName} onChange={e=>setFormData({...formData, clientName: e.target.value})} />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 mb-1">납품예정일</label>
                                    <input type="date" className="w-full p-2 border rounded" value={formData.deliveryDate} onChange={e=>setFormData({...formData, deliveryDate: e.target.value})} />
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1">메모</label>
                                <textarea className="w-full p-2 border rounded h-20" placeholder="특이사항 입력" value={formData.description} onChange={e=>setFormData({...formData, description: e.target.value})}></textarea>
                            </div>
                            
                            {/* File Attachment Section */}
                            <div className="bg-slate-50 p-4 rounded-lg border">
                                <label className="block text-xs font-bold text-gray-500 mb-2">도면/파일 첨부</label>
                                <div className="flex gap-2 mb-2">
                                    <input className="flex-1 p-2 border rounded text-sm" placeholder="파일명 (예: 도면.pdf)" value={newFile.name} onChange={e=>setNewFile({...newFile, name: e.target.value})}/>
                                    <input className="flex-1 p-2 border rounded text-sm" placeholder="파일 링크(URL)" value={newFile.url} onChange={e=>setNewFile({...newFile, url: e.target.value})}/>
                                    <button onClick={handleAddFile} className="bg-slate-700 text-white px-3 rounded font-bold text-sm">추가</button>
                                </div>
                                <div className="space-y-1 max-h-32 overflow-y-auto">
                                    {files.map((f, i) => (
                                        <div key={i} className="flex justify-between items-center bg-white p-2 rounded border text-xs">
                                            <span className="truncate text-blue-600">{f.name}</span>
                                            <button onClick={()=>setFiles(files.filter((_,idx)=>idx!==i))}><X size={14} className="text-red-400"/></button>
                                        </div>
                                    ))}
                                    {files.length === 0 && <div className="text-center text-gray-400 text-xs py-2">첨부된 파일이 없습니다.</div>}
                                </div>
                            </div>
                        </div>
                        <div className="p-4 border-t flex gap-2">
                            <button onClick={onClose} className="flex-1 py-3 rounded-lg bg-gray-100 text-gray-600 font-bold">취소</button>
                            <button onClick={handleSubmit} className="flex-1 py-3 rounded-lg bg-indigo-600 text-white font-bold">등록하기</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ orders, stats, suppliers, onNavigate, isAdmin, currentUserId }) => {
            const [activeStat, setActiveStat] = useState(null);
            const [activeRoutePopup, setActiveRoutePopup] = useState(null);
            const [aiBriefing, setAiBriefing] = useState(null);
            const [isGeneratingBriefing, setIsGeneratingBriefing] = useState(false);

            const generateBriefing = async () => {
                setIsGeneratingBriefing(true);
                const urgentTasks = orders.filter(o => {
                    if (!o.deliveryDate || ['납품완료', '완료된 작업'].includes(o.status)) return false;
                    return Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2;
                }).map(o => `${o.itemName}(${o.deliveryDate})`).join(', ');

                const prompt = `
                    역할: 금속 인테리어 회사 '숨쉬는 깡통'의 현장 관리자.
                    목표: 팀원들에게 오늘 업무 현황을 아주 간결하게 전달.
                    
                    [데이터]
                    - 진행중: ${stats.ongoing}건
                    - 회수대기: ${stats.pickup}건
                    - 긴급: ${stats.urgent}건 (${urgentTasks})
                    
                    [지침]
                    1. 인사말(안녕하세요 등), 응원 문구, 잡담 절대 금지.
                    2. 오직 핵심 정보만 짧은 문장이나 개조식으로 나열.
                    3. 긴급 건은 강조.
                    4. 전체 3~4줄 이내로 끝낼 것.
                `;

                const result = await callGemini(prompt);
                setAiBriefing(result);
                setIsGeneratingBriefing(false);
            };

            const optimizedRoute = useMemo(() => {
                const pickupTargets = Object.keys(suppliers).filter(n => 
                    suppliers[n].some(m => m.status === '제작완료')
                );

                if (pickupTargets.length === 0) return [];

                let currentLoc = { lat: COMPANY_INFO.lat, lng: COMPANY_INFO.lng, name: 'start' };
                let unvisited = pickupTargets.map(name => ({
                    name,
                    lat: SUPPLIER_INFO[name]?.lat || 37.5, 
                    lng: SUPPLIER_INFO[name]?.lng || 127.0,
                    count: suppliers[name].filter(m => m.status === '제작완료').length
                }));

                const route = [];

                while (unvisited.length > 0) {
                    let nearest = null;
                    let minDist = Infinity;
                    let nearestIdx = -1;

                    unvisited.forEach((node, idx) => {
                        const dist = getDistance(currentLoc.lat, currentLoc.lng, node.lat, node.lng);
                        if (dist < minDist) {
                            minDist = dist;
                            nearest = node;
                            nearestIdx = idx;
                        }
                    });

                    if (nearest) {
                        route.push(nearest);
                        currentLoc = nearest; 
                        unvisited.splice(nearestIdx, 1);
                    } else {
                        break;
                    }
                }

                return route;
            }, [suppliers]);

            const statList = useMemo(() => {
                if (!activeStat) return [];
                if (activeStat === 'pickup') {
                    const list = [];
                    orders.forEach(o => (o.materials || []).forEach(m => {
                        if (m.status === '제작완료') {
                            list.push({ ...m, orderName: o.itemName, orderId: o.id, type: 'material' });
                        }
                    }));
                    return list;
                }
                
                return orders.filter(o => {
                    if (activeStat === 'ongoing') return !['납품완료', '완료된 작업'].includes(o.status);
                    if (activeStat === 'urgent') {
                        if (!o.deliveryDate || ['납품완료', '완료된 작업'].includes(o.status)) return false;
                        return Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2;
                    }
                    if (activeStat === 'completed') {
                        const isDone = ['납품완료', '완료된 작업'].includes(o.status);
                        const oneMonthAgo = new Date();
                        oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);
                        const delDate = new Date(o.deliveryDate);
                        return isDone && delDate >= oneMonthAgo;
                    }
                    return false;
                });
            }, [activeStat, orders]);

            const StatModal = () => {
                if(!activeStat) return null;
                const titles = { ongoing: '진행 중인 작업', pickup: '회수 대기 자재', urgent: '마감 임박 작업', completed: '최근 완료된 작업 (30일)' };
                const color = { ongoing: 'blue', pickup: 'indigo', urgent: 'red', completed: 'slate' }[activeStat];

                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 animate-fade-in" onClick={()=>setActiveStat(null)}>
                        <div className="bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]" onClick={e=>e.stopPropagation()}>
                            <div className={`bg-${color}-50 p-4 border-b border-${color}-100 flex justify-between items-center`}>
                                <h3 className={`font-bold text-${color}-700 flex items-center gap-2`}>
                                    {titles[activeStat]} ({statList.length})
                                </h3>
                                <button onClick={()=>setActiveStat(null)} className="p-1 hover:bg-white rounded-full"><X size={16}/></button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-2 bg-slate-50">
                                {statList.length === 0 && <div className="p-8 text-center text-gray-400 text-sm">해당하는 항목이 없습니다.</div>}
                                {statList.map((item, i) => (
                                    activeStat === 'pickup' ? (
                                        <div key={i} className="bg-white p-3 rounded border shadow-sm hover:border-indigo-400 transition-colors" onClick={()=>{
                                            const order = orders.find(o=>o.id===item.orderId);
                                            if(order) onNavigate(order);
                                        }}>
                                            <div className="flex justify-between mb-1">
                                                <span className="font-bold text-indigo-700 text-sm">{item.supplier}</span>
                                                <span className="text-[10px] bg-indigo-100 text-indigo-600 px-1.5 py-0.5 rounded font-bold">제작완료</span>
                                            </div>
                                            <div className="font-medium text-slate-800">{item.item}</div>
                                            <div className="text-xs text-gray-500 mt-1 flex justify-between">
                                                <span>{item.quantity}</span>
                                                <span className="text-indigo-400">Project: {item.orderName}</span>
                                            </div>
                                        </div>
                                    ) : (
                                        <div key={item.id} className="bg-white p-3 rounded border shadow-sm cursor-pointer hover:border-blue-400 transition-colors" onClick={()=>onNavigate(item)}>
                                            <div className="flex justify-between items-center mb-1">
                                                <span className="text-xs text-gray-400">{item.displayId}</span>
                                                {activeStat==='urgent' && <span className="text-xs font-bold text-red-600 animate-pulse">{item.deliveryDate} 마감</span>}
                                            </div>
                                            <div className="font-bold text-slate-800 mb-1">{item.itemName}</div>
                                            <div className="flex justify-between items-center">
                                                <StatusBadge status={item.status}/>
                                                <span className="text-xs text-gray-500">{item.clientName}</span>
                                            </div>
                                        </div>
                                    )
                                ))}
                            </div>
                        </div>
                    </div>
                )
            };

            const RouteModal = () => {
                if(!activeRoutePopup) return null;
                const supplierItems = suppliers[activeRoutePopup]?.filter(m => m.status === '제작완료') || [];
                const supplierInfo = SUPPLIER_INFO[activeRoutePopup];

                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 animate-fade-in" onClick={()=>setActiveRoutePopup(null)}>
                        <div className="bg-white w-full max-w-sm rounded-xl shadow-2xl overflow-hidden flex flex-col" onClick={e=>e.stopPropagation()}>
                            <div className="bg-indigo-600 p-4 text-white flex justify-between items-start">
                                <div>
                                    <div className="text-xs font-bold text-indigo-200 mb-1">회수 지점 상세</div>
                                    <h3 className="font-bold text-lg flex items-center gap-2">{activeRoutePopup}</h3>
                                    <div className="text-xs text-indigo-100 mt-1 flex items-center gap-1"><MapPin size={12}/> {supplierInfo?.address}</div>
                                </div>
                                <button onClick={()=>setActiveRoutePopup(null)} className="p-1 bg-indigo-500 hover:bg-indigo-400 rounded text-white"><X size={16}/></button>
                            </div>
                            <div className="p-4 bg-slate-50 flex-1 overflow-y-auto max-h-[60vh]">
                                <h4 className="font-bold text-sm text-slate-700 mb-3 flex items-center gap-1"><Package size={14}/> 회수할 자재 ({supplierItems.length})</h4>
                                <div className="space-y-2">
                                    {supplierItems.length === 0 && <div className="text-center text-gray-400 text-sm py-4">회수할 자재가 없습니다.</div>}
                                    {supplierItems.map((item, i) => (
                                        <div key={i} className="bg-white p-3 rounded border shadow-sm cursor-pointer hover:bg-slate-50" onClick={()=>{
                                            const order = orders.find(o=>o.itemName===item.orderName); // Simple match
                                            if(order) onNavigate(order);
                                        }}>
                                            <div className="font-bold text-slate-800 text-sm">{item.item}</div>
                                            <div className="flex justify-between items-center mt-1">
                                                <span className="text-xs bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded font-bold">{item.quantity}</span>
                                                <span className="text-[10px] text-gray-400">{item.orderName}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="p-3 border-t bg-white">
                                <a href={`https://map.naver.com/p/search/${supplierInfo?.address}`} target="_blank" rel="noreferrer" className="w-full bg-indigo-600 text-white py-2 rounded font-bold text-sm flex items-center justify-center gap-2 hover:bg-indigo-700">
                                    <Map size={16}/> 지도/네비게이션 열기
                                </a>
                            </div>
                        </div>
                    </div>
                );
            };

            const BriefingModal = () => {
                if(!aiBriefing) return null;
                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 animate-fade-in" onClick={()=>setAiBriefing(null)}>
                        <div className="bg-white w-full max-w-md rounded-xl shadow-2xl p-6 space-y-4" onClick={e=>e.stopPropagation()}>
                            <div className="flex justify-between items-center border-b pb-3">
                                <h3 className="text-lg font-bold text-indigo-800 flex items-center gap-2">
                                    <Sparkles className="text-yellow-500" size={20}/> 금일 현황 브리핑
                                </h3>
                                <button onClick={()=>setAiBriefing(null)}><X size={20} className="text-gray-400"/></button>
                            </div>
                            <div className="bg-gray-50 p-4 rounded-xl text-sm text-gray-700 whitespace-pre-wrap leading-relaxed border font-mono">
                                {aiBriefing}
                            </div>
                            <button 
                                onClick={() => {
                                    navigator.clipboard.writeText(aiBriefing);
                                    alert('클립보드에 복사되었습니다!');
                                    setAiBriefing(null);
                                }}
                                className="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700"
                            >
                                복사하기
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6 animate-fade-in pb-10 relative">
                    <StatModal />
                    <RouteModal />
                    <BriefingModal />
                    
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <Card className="p-4 border-l-4 border-blue-600 cursor-pointer hover:bg-blue-50 transition-colors active:scale-95 transform duration-100" onClick={()=>setActiveStat('ongoing')}>
                            <div className="text-xs text-gray-500 flex justify-between items-center">진행 중 <ChevronRight size={12}/></div>
                            <div className="text-2xl font-bold">{stats.ongoing}건</div>
                        </Card>
                        <Card className="p-4 border-l-4 border-indigo-500 cursor-pointer hover:bg-indigo-50 transition-colors active:scale-95 transform duration-100" onClick={()=>setActiveStat('pickup')}>
                            <div className="text-xs text-gray-500 flex justify-between items-center">회수 대기 <ChevronRight size={12}/></div>
                            <div className="text-2xl font-bold text-indigo-600 animate-pulse">{stats.pickup}건</div>
                        </Card>
                        <Card className="p-4 border-l-4 border-red-500 cursor-pointer hover:bg-red-50 transition-colors active:scale-95 transform duration-100" onClick={()=>setActiveStat('urgent')}>
                            <div className="text-xs text-gray-500 flex justify-between items-center">마감 임박 <ChevronRight size={12}/></div>
                            <div className="text-2xl font-bold text-red-600">{stats.urgent}건</div>
                        </Card>
                        <Card className="p-4 border-l-4 border-slate-400 cursor-pointer hover:bg-slate-100 transition-colors active:scale-95 transform duration-100" onClick={()=>setActiveStat('completed')}>
                            <div className="text-xs text-gray-500 flex justify-between items-center">최근 완료 (30일) <ChevronRight size={12}/></div>
                            <div className="text-2xl font-bold text-slate-500">{stats.completed}건</div>
                        </Card>
                    </div>

                    <button 
                        onClick={generateBriefing}
                        disabled={isGeneratingBriefing}
                        className="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 rounded-xl shadow-lg font-bold flex items-center justify-center gap-2 hover:from-indigo-600 hover:to-purple-700 transition-all disabled:opacity-70"
                    >
                        {isGeneratingBriefing ? (
                            <span className="animate-pulse">✨ AI 요약 생성 중...</span>
                        ) : (
                            <>
                                <Sparkles size={20} className="text-yellow-300"/> ✨ AI 일일 브리핑 생성
                            </>
                        )}
                    </button>

                    <div>
                        <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2"><FileText size={18}/> 진행 중인 작업 (최신순)</h3>
                        <div className="grid gap-3">
                            {orders.filter(o => !['납품완료', '완료된 작업'].includes(o.status)).slice(0, 3).map(o => (
                                <Card key={o.id} className="p-4 flex justify-between items-center cursor-pointer hover:border-blue-400 transition-colors" onClick={() => onNavigate(o)}>
                                    <div className="flex-1 min-w-0 pr-4">
                                        <div className="flex items-center gap-2 mb-1">
                                            <StatusBadge status={o.status} />
                                            <span className="text-xs text-gray-400 truncate">{o.displayId}</span>
                                        </div>
                                        <div className="font-bold truncate">{o.itemName}</div>
                                    </div>
                                    <div className="text-sm font-bold text-red-500 whitespace-nowrap">{o.deliveryDate} 마감</div>
                                </Card>
                            ))}
                            {orders.filter(o => !['납품완료', '완료된 작업'].includes(o.status)).length === 0 && <div className="text-gray-400 text-sm p-2">진행 중인 작업이 없습니다.</div>}
                        </div>
                    </div>

                    <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-5">
                        <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2 text-indigo-900 font-bold"><Truck size={20} /><h3>최적 회수 동선 (거리순)</h3></div>
                            <div className="text-[10px] text-indigo-400 bg-white px-2 py-1 rounded-full border border-indigo-100">포천 본사 기준</div>
                        </div>
                        {optimizedRoute.length > 0 ? (
                            <div className="flex flex-wrap gap-2 items-center">
                                <a href={COMPANY_INFO.mapUrl} target="_blank" rel="noreferrer" className="bg-white px-3 py-2 rounded shadow-sm text-xs font-bold flex items-center gap-1 text-indigo-700 hover:bg-indigo-50 border border-indigo-100 group" title={COMPANY_INFO.address}>
                                    <Factory size={14} className="group-hover:scale-110 transition-transform"/> 본사
                                </a>
                                {optimizedRoute.map((stop, i) => (
                                    <React.Fragment key={i}>
                                        <ArrowRight size={16} className="text-indigo-400" />
                                        <button onClick={() => setActiveRoutePopup(stop.name)} className="bg-indigo-600 text-white px-3 py-2 rounded shadow-md text-sm font-bold hover:bg-indigo-700 transition-colors flex items-center gap-1 focus:outline-none active:scale-95 transform duration-100">
                                            <span>{i+1}. {stop.name}</span>
                                            <span className="bg-white/20 px-1.5 rounded text-[10px]">{stop.count}</span>
                                        </button>
                                    </React.Fragment>
                                ))}
                                <ArrowRight size={16} className="text-indigo-400" />
                                <a href={COMPANY_INFO.mapUrl} target="_blank" rel="noreferrer" className="bg-white px-3 py-2 rounded shadow-sm text-xs font-bold flex items-center gap-1 text-indigo-700 hover:bg-indigo-50 border border-indigo-100 group" title="복귀">
                                    <Factory size={14} className="group-hover:scale-110 transition-transform"/> 복귀
                                </a>
                            </div>
                        ) : <div className="text-sm text-indigo-400">현재 회수할 자재가 없습니다.</div>}
                    </div>
                </div>
            );
        };

        const ListView = ({ orders, onSelect, onOpenAdd }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [open, setOpen] = useState({ design: true, prod: true, done: false });
            const groups = { design: [], prod: [], done: [] };
            
            orders.filter(o => (o.itemName || '').toLowerCase().includes(searchTerm.toLowerCase())).forEach(o => {
                if (['대기', '설계중'].includes(o.status)) groups.design.push(o);
                else if (['제작중', '도장/마감'].includes(o.status)) groups.prod.push(o);
                else groups.done.push(o);
            });

            const Section = ({ id, title, items }) => (
                <div className="mb-4">
                    <div onClick={() => setOpen({ ...open, [id]: !open[id] })} className={`flex justify-between p-3 rounded cursor-pointer transition-colors ${open[id] ? 'bg-slate-800 text-white' : 'bg-white border hover:bg-slate-50'}`}>
                        <span className="font-bold">{title} ({items.length})</span>{open[id] ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                    </div>
                    {open[id] && <div className="mt-2 pl-2 border-l-2 border-slate-200 space-y-2">
                        {items.map(o => (
                            <Card key={o.id} className="p-3 cursor-pointer hover:border-blue-500 bg-white transition-colors" onClick={() => onSelect(o)}>
                                <div className="flex justify-between items-center mb-1">
                                    <span className="font-bold truncate mr-2">{o.itemName}</span>
                                    <StatusBadge status={o.status} />
                                </div>
                                <div className="text-xs text-gray-500 flex justify-between">
                                    <span>{o.clientName}</span>
                                    <span>{o.deliveryDate} 납품</span>
                                </div>
                            </Card>
                        ))}
                        {items.length === 0 && <div className="text-sm text-gray-400 p-2">항목 없음</div>}
                    </div>}
                </div>
            );

            return (
                <div className="space-y-4 animate-fade-in pb-10">
                    <div className="flex gap-2 bg-white p-3 rounded-xl border shadow-sm sticky top-0 z-10">
                        <Search size={20} className="text-gray-400"/>
                        <input 
                            className="flex-1 outline-none bg-transparent min-w-0" 
                            placeholder="작업명 검색..." 
                            value={searchTerm} 
                            onChange={e => setSearchTerm(e.target.value)} 
                        />
                        <button onClick={onOpenAdd} className="bg-slate-800 text-white px-3 py-1 rounded text-sm font-bold flex items-center gap-1 flex-shrink-0">
                            <Plus size={16} /> <span className="hidden sm:inline">작업등록</span>
                        </button>
                    </div>
                    <Section id="design" title="설계 단계" items={groups.design} />
                    <Section id="prod" title="제작 단계" items={groups.prod} />
                    <Section id="done" title="완료" items={groups.done} />
                </div>
            );
        };

        const DetailView = ({ order, onBack, onUpdate, onDelete, isAdmin, currentUserId }) => {
            if (!order) return null;
            const [mat, setMat] = useState({ supplier: '', item: '', quantity: '', status: '발주중', date: new Date().toISOString().split('T')[0] });
            const [link, setLink] = useState({ name: '', url: '' });
            
            // Permission Check: Admin OR Owner
            const canEdit = isAdmin || order.userId === currentUserId;

            const [showSuggestions, setShowSuggestions] = useState(false);
            const supplierOptions = Object.keys(SUPPLIER_INFO);
            const filteredSuppliers = supplierOptions.filter(s => s.includes(mat.supplier));

            const updateOrder = (newData) => {
                onUpdate({ ...order, ...newData });
            };

            const handleDelete = () => {
                if(confirm('정말로 이 작업을 삭제하시겠습니까? 복구할 수 없습니다.')) {
                    onDelete(order.id);
                }
            }

            const handleAddMaterial = () => {
                if(!mat.supplier || !mat.item) return;
                const newMaterials = [...(order.materials || []), { ...mat, id: Date.now() }];
                updateOrder({ materials: newMaterials });
                setMat({ supplier: '', item: '', quantity: '', status: '발주중', date: new Date().toISOString().split('T')[0] });
            };

            return (
                <div className="h-full overflow-y-auto animate-fade-in pb-10 pr-1" onClick={()=>setShowSuggestions(false)}>
                    <div className="flex items-center justify-between text-slate-500 mb-4">
                        <div className="flex items-center gap-2 cursor-pointer hover:text-slate-800" onClick={onBack}>
                            <ChevronLeft size={20}/> <span className="text-sm font-bold">목록으로</span>
                        </div>
                        {canEdit && (
                            <button onClick={handleDelete} className="text-red-400 hover:text-red-600 p-2 rounded-full hover:bg-red-50">
                                <Trash2 size={18}/>
                            </button>
                        )}
                    </div>
                    
                    <div className="flex justify-between items-start gap-4 mb-6">
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 mb-2 flex-wrap">
                                <span className="font-mono text-gray-400 text-sm">{order.displayId}</span>
                                <StatusBadge status={order.status} />
                            </div>
                            <h1 className="text-2xl md:text-3xl font-bold break-words leading-tight">{order.itemName}</h1>
                        </div>
                    </div>

                    {/* Status Controller */}
                    {canEdit && (
                        <div className="mb-4 overflow-x-auto">
                            <div className="flex gap-2 pb-2">
                                {['대기','설계중','제작중','도장/마감','납품완료'].map(s => (
                                    <button 
                                        key={s}
                                        onClick={() => updateOrder({status: s})}
                                        className={`px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap border transition-colors ${order.status === s ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-gray-500 border-gray-200 hover:border-slate-400'}`}
                                    >
                                        {s}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    <Card className="p-5 mb-4">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                            <div>
                                <div className="font-bold text-gray-400 uppercase text-xs mb-1">Client</div>
                                <div className="text-lg font-bold text-slate-800">{order.clientName}</div>
                                <div className="text-gray-500">{order.clientContact}</div>
                            </div>
                            <div>
                                <div className="font-bold text-gray-400 uppercase text-xs mb-1">Delivery</div>
                                <div className="text-lg text-red-600 font-bold">{order.deliveryDate}</div>
                            </div>
                            <div>
                                <div className="font-bold text-gray-400 uppercase text-xs mb-1">Registered By</div>
                                <div className="text-gray-500 font-mono text-xs">{order.userId === currentUserId ? '나 (Me)' : '동료'}</div>
                            </div>
                        </div>
                    </Card>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <div className="font-bold text-slate-500 text-xs uppercase mb-2">Memo / Description</div>
                            <div className="text-sm whitespace-pre-wrap text-slate-700 min-h-[80px]">{order.description || "메모 없음"}</div>
                        </div>

                        <div className="bg-white p-4 rounded-xl border border-slate-200 flex flex-col">
                            <div className="flex justify-between items-center mb-3">
                                <h3 className="font-bold text-sm text-slate-700 flex gap-2"><FileBox size={16} /> 도면/파일</h3>
                                <span className="text-xs text-gray-400">{(order.files || []).length}개</span>
                            </div>
                            
                            <div className="flex-1 space-y-2 mb-3 max-h-[150px] overflow-y-auto">
                                {(order.files || []).length === 0 && <div className="text-center text-xs text-gray-400 py-2">등록된 파일이 없습니다.</div>}
                                {(order.files || []).map((f, i) => (
                                    <div key={i} className="flex justify-between items-center p-2 bg-blue-50 rounded text-xs group">
                                        <div className="flex items-center gap-2 truncate flex-1 min-w-0">
                                            {f.name.endsWith('.pdf') ? <FileText size={12} className="text-red-500 flex-shrink-0"/> : <File size={12} className="text-blue-500 flex-shrink-0"/>}
                                            <span className="truncate text-blue-800 font-medium">{f.name}</span>
                                        </div>
                                        <a href={f.url} target="_blank" rel="noreferrer" className="bg-white p-1 rounded text-blue-600 hover:bg-blue-100 flex-shrink-0 ml-2">
                                            <Download size={12} />
                                        </a>
                                        {canEdit && (
                                            <button onClick={()=>{
                                                const newFiles = order.files.filter((_,idx)=>idx!==i);
                                                updateOrder({files: newFiles});
                                            }} className="ml-2 text-red-400 hover:text-red-600"><X size={12}/></button>
                                        )}
                                    </div>
                                ))}
                            </div>

                            {canEdit && (
                                <div className="flex gap-1 border-t pt-2">
                                    <input placeholder="파일명" className="w-1/3 border p-1.5 rounded text-xs bg-gray-50" value={link.name} onChange={e => setLink({ ...link, name: e.target.value })} />
                                    <input placeholder="URL" className="flex-1 border p-1.5 rounded text-xs bg-gray-50" value={link.url} onChange={e => setLink({ ...link, url: e.target.value })} />
                                    <button onClick={() => {
                                        if (!link.name || !link.url) return;
                                        updateOrder({ files: [...(order.files || []), { ...link, id: Date.now() }] });
                                        setLink({ name: '', url: '' });
                                    }} className="bg-slate-700 text-white px-3 rounded text-xs font-bold hover:bg-slate-800">등록</button>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="space-y-2">
                        <div className="flex justify-between items-end">
                            <h3 className="font-bold flex gap-2 text-slate-700"><Package className="text-indigo-600" /> 자재 발주 내역</h3>
                        </div>
                        
                        <Card className="p-0 overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left min-w-[400px]">
                                    <thead className="bg-slate-50 border-b"><tr><th className="p-2">일자</th><th className="p-2">거래처</th><th className="p-2">품목/수량</th><th className="p-2">상태</th><th className="p-2"></th></tr></thead>
                                    <tbody>
                                        {(order.materials || []).map((m, i) => (
                                            <tr key={i} className="border-b last:border-0 hover:bg-slate-50">
                                                <td className="p-2 text-xs text-gray-500">{m.date}</td>
                                                <td className="p-2 font-bold text-indigo-900">{m.supplier}</td>
                                                <td className="p-2">{m.item} ({m.quantity})</td>
                                                <td className="p-2"><MaterialStatusBadge status={m.status} /></td>
                                                <td className="p-2 text-right">
                                                    {canEdit && (
                                                        <div className="flex gap-1 justify-end">
                                                            <select 
                                                                className="text-xs border rounded p-1 bg-white"
                                                                value={m.status}
                                                                onChange={(e) => {
                                                                    const newMats = [...order.materials];
                                                                    newMats[i].status = e.target.value;
                                                                    updateOrder({materials: newMats});
                                                                }}
                                                            >
                                                                <option>발주중</option><option>제작완료</option><option>입고완료</option>
                                                            </select>
                                                            <button onClick={() => {
                                                                const newMats = order.materials.filter((_, idx) => idx !== i);
                                                                updateOrder({ materials: newMats });
                                                            }} className="text-red-400 hover:text-red-600"><Trash2 size={14}/></button>
                                                        </div>
                                                    )}
                                                </td>
                                            </tr>
                                        ))}
                                        {(order.materials || []).length === 0 && <tr><td colSpan="5" className="p-4 text-center text-gray-400 text-xs">등록된 자재 발주 내역이 없습니다.</td></tr>}
                                    </tbody>
                                    
                                    {canEdit && (
                                        <tfoot className="bg-indigo-50 border-t border-indigo-100">
                                            <tr>
                                                <td className="p-2">
                                                    <input type="date" className="w-full text-xs p-1 border rounded" value={mat.date} onChange={e=>setMat({...mat, date: e.target.value})}/>
                                                </td>
                                                <td className="p-2 relative">
                                                    <input 
                                                        className="w-full text-xs p-1 border rounded" 
                                                        placeholder="거래처명" 
                                                        value={mat.supplier} 
                                                        onChange={e=>{
                                                            setMat({...mat, supplier: e.target.value});
                                                            setShowSuggestions(true);
                                                        }}
                                                        onFocus={()=>setShowSuggestions(true)}
                                                    />
                                                    {showSuggestions && filteredSuppliers.length > 0 && (
                                                        <div className="absolute z-10 bottom-full left-0 w-full bg-white border shadow-lg max-h-32 overflow-y-auto rounded mb-1">
                                                            {filteredSuppliers.map(s => (
                                                                <div key={s} className="p-2 text-xs hover:bg-indigo-50 cursor-pointer" onClick={(e)=>{
                                                                    e.stopPropagation();
                                                                    setMat({...mat, supplier: s});
                                                                    setShowSuggestions(false);
                                                                }}>{s}</div>
                                                            ))}
                                                        </div>
                                                    )}
                                                </td>
                                                <td className="p-2 flex gap-1">
                                                    <input className="flex-1 text-xs p-1 border rounded" placeholder="품목명" value={mat.item} onChange={e=>setMat({...mat, item: e.target.value})}/>
                                                    <input className="w-12 text-xs p-1 border rounded" placeholder="수량" value={mat.quantity} onChange={e=>setMat({...mat, quantity: e.target.value})}/>
                                                </td>
                                                <td className="p-2">
                                                    <select className="w-full text-xs p-1 border rounded" value={mat.status} onChange={e=>setMat({...mat, status: e.target.value})}>
                                                        <option>발주중</option><option>제작완료</option><option>입고완료</option>
                                                    </select>
                                                </td>
                                                <td className="p-2 text-right">
                                                    <button onClick={handleAddMaterial} className="bg-indigo-600 text-white p-1.5 rounded hover:bg-indigo-700 shadow-sm w-full flex justify-center"><Plus size={14}/></button>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    )}
                                </table>
                            </div>
                        </Card>
                        <p className="text-[10px] text-gray-400 text-right">* 새 작업 등록 시 누락된 자재는 여기서 즉시 추가할 수 있습니다.</p>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null); // 'employee', 'admin'
            const [userId, setUserId] = useState(null); // Firebase Auth UID
            const [view, setView] = useState('login');
            const [activeOrder, setActiveOrder] = useState(null);
            const [orders, setOrders] = useState([]);
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);

            // Firestore Connection
            useEffect(() => {
                if(!window.firebaseFunctions) return;
                const { auth, db, signInAnonymously, onAuthStateChanged, collection, query, orderBy, onSnapshot, appId, signInWithCustomToken } = window.firebaseFunctions;

                // 1. Auth
                const initAuth = async () => {
                    await signInAnonymously(auth);
                };
                initAuth();

                const unsubscribeAuth = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUserId(u.uid);
                    }
                });

                // 2. Data Fetching
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderBy('serverTimestamp', 'desc'));
                const unsubscribeData = onSnapshot(q, (snapshot) => {
                    const loadedOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setOrders(loadedOrders);
                }, (error) => console.error("Data fetch error:", error));

                return () => {
                    unsubscribeAuth();
                    unsubscribeData();
                };
            }, []);

            // Mock Stats Calculation
            const stats = useMemo(() => {
                return {
                    ongoing: orders.filter(o => !['납품완료', '완료된 작업'].includes(o.status)).length,
                    pickup: orders.reduce((acc, o) => acc + (o.materials || []).filter(m => m.status === '제작완료').length, 0),
                    urgent: orders.filter(o => {
                        if (!o.deliveryDate || ['납품완료', '완료된 작업'].includes(o.status)) return false;
                        return Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2;
                    }).length,
                    completed: orders.filter(o => {
                        const isDone = ['납품완료', '완료된 작업'].includes(o.status);
                        const oneMonthAgo = new Date();
                        oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);
                        const delDate = new Date(o.deliveryDate);
                        return isDone && delDate >= oneMonthAgo;
                    }).length
                };
            }, [orders]);

            // Mock Suppliers Aggregation
            const suppliers = useMemo(() => {
                const agg = {};
                orders.forEach(o => {
                    (o.materials || []).forEach(m => {
                        if (!agg[m.supplier]) agg[m.supplier] = [];
                        agg[m.supplier].push({ ...m, orderName: o.itemName });
                    });
                });
                return agg;
            }, [orders]);

            const handleLogin = (role) => {
                setUser(role);
                setView('dashboard');
            };

            const handleAddOrder = async (orderData) => {
                if(!window.firebaseFunctions) return;
                const { addDoc, collection, serverTimestamp, appId, db } = window.firebaseFunctions;
                
                const newOrder = {
                    ...orderData,
                    displayId: `ORD-${new Date().getFullYear()}-${String(Math.floor(Math.random()*1000)).padStart(3,'0')}`,
                    status: '대기',
                    materials: [],
                    // Permissions: Store who created it
                    userId: userId,
                    serverTimestamp: serverTimestamp()
                };

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), newOrder);
                } catch (e) {
                    console.error("Error adding document: ", e);
                    alert("저장 실패");
                }
            };

            const handleUpdateOrder = async (updatedOrder) => {
                if(!updatedOrder || !updatedOrder.id) return;
                // Permission Check Logic (Redundant here as UI hides button, but good for safety)
                if(user !== 'admin' && updatedOrder.userId !== userId) {
                    // In a real app, this would be rejected by Firestore Rules
                    // For this frontend demo, we allow logic to proceed if they got past UI
                }

                if(!window.firebaseFunctions) return;
                const { updateDoc, doc, appId, db } = window.firebaseFunctions;

                try {
                    const orderRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', updatedOrder.id);
                    await updateDoc(orderRef, updatedOrder);
                    setActiveOrder(updatedOrder);
                } catch (e) {
                    console.error("Error updating document: ", e);
                }
            };

            const handleDeleteOrder = async (orderId) => {
                 if(!window.firebaseFunctions) return;
                 const { deleteDoc, doc, appId, db } = window.firebaseFunctions;

                 try {
                     await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId));
                     setView('list');
                     setActiveOrder(null);
                 } catch(e) {
                     console.error("Delete error", e);
                     alert("삭제 실패");
                 }
            };

            // View Router
            return (
                <div className="max-w-lg mx-auto min-h-screen bg-slate-100 relative shadow-2xl overflow-hidden flex flex-col">
                    {view === 'login' && <LoginView onLogin={handleLogin} />}
                    
                    {view !== 'login' && (
                        <>
                            {/* Top Navigation Bar */}
                            <div className="bg-white p-4 shadow-sm flex justify-between items-center z-20 relative">
                                <div className="font-bold text-lg text-indigo-800 flex items-center gap-2 cursor-pointer" onClick={()=>setView('dashboard')}>
                                    <Factory size={24} /> 숨쉬는 깡통
                                </div>
                                <div className="flex gap-3 text-slate-400">
                                    <Bell size={20} className="hover:text-indigo-500 cursor-pointer"/>
                                    <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${user === 'admin' ? 'bg-red-100 text-red-600' : 'bg-indigo-100 text-indigo-600'}`}>
                                        {user === 'admin' ? 'A' : 'E'}
                                    </div>
                                </div>
                            </div>

                            {/* Main Content Area */}
                            <div className="flex-1 overflow-y-auto p-4 scrollbar-hide">
                                {view === 'dashboard' && (
                                    <Dashboard 
                                        orders={orders} 
                                        stats={stats} 
                                        suppliers={suppliers} 
                                        onNavigate={(o) => { setActiveOrder(o); setView('detail'); }} 
                                        isAdmin={user === 'admin'}
                                        currentUserId={userId}
                                    />
                                )}
                                {view === 'list' && (
                                    <ListView 
                                        orders={orders} 
                                        onSelect={(o) => { setActiveOrder(o); setView('detail'); }} 
                                        onOpenAdd={() => setIsAddModalOpen(true)} 
                                    />
                                )}
                                {view === 'detail' && (
                                    <DetailView 
                                        order={activeOrder} 
                                        onBack={() => setView('list')} 
                                        onUpdate={handleUpdateOrder}
                                        onDelete={handleDeleteOrder}
                                        isAdmin={user === 'admin'}
                                        currentUserId={userId}
                                    />
                                )}
                            </div>
                            
                            {/* Modals */}
                            <NewOrderModal 
                                isOpen={isAddModalOpen} 
                                onClose={()=>setIsAddModalOpen(false)} 
                                onSubmit={handleAddOrder}
                            />

                            {/* Bottom Navigation Tab */}
                            <div className="bg-white border-t flex justify-around items-center p-3 pb-5 text-xs font-medium text-gray-400 z-20">
                                <button onClick={() => setView('dashboard')} className={`flex flex-col items-center gap-1 ${view === 'dashboard' ? 'text-indigo-600' : 'hover:text-gray-600'}`}>
                                    <LayoutDashboard size={22} strokeWidth={view === 'dashboard' ? 2.5 : 2} /> 대시보드
                                </button>
                                <button onClick={() => setView('list')} className={`flex flex-col items-center gap-1 ${view === 'list' || view === 'detail' ? 'text-indigo-600' : 'hover:text-gray-600'}`}>
                                    <FileText size={22} strokeWidth={view === 'list' || view === 'detail' ? 2.5 : 2} /> 작업목록
                                </button>
                                <button className="flex flex-col items-center gap-1 hover:text-gray-600">
                                    <CalendarIcon size={22} /> 일정
                                </button>
                                <button className="flex flex-col items-center gap-1 hover:text-gray-600">
                                    <LinkIcon size={22} /> 링크
                                </button>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
