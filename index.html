<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìˆ¨ì‰¬ëŠ” ê¹¡í†µ</title>
    
    <!-- 1. Tailwind CSS (Design) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Fonts (Pretendard) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        /* ê¸°ë³¸ í°íŠ¸ ë° ìŠ¤í¬ë¡¤ ë™ì‘ ìµœì í™” */
        body { 
            font-family: 'Pretendard', sans-serif; 
            overscroll-behavior: none; /* ëª¨ë°”ì¼ì—ì„œ ë‹¹ê²¨ì„œ ìƒˆë¡œê³ ì¹¨ ë“± ë°©ì§€ */
        }
        
        /* ì „ì²´ í™”ë©´ ê³ ì • (ë©”ë‰´ ê³ ì •, ë‚´ë¶€ ìŠ¤í¬ë¡¤ì„ ìœ„í•¨) */
        html, body, #root {
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ ì²˜ë¦¬ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ëª¨ë°”ì¼ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ (ê´€ì„± ìŠ¤í¬ë¡¤) */
        .scroll-touch {
            -webkit-overflow-scrolling: touch;
        }

        /* Animation */
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>

    <!-- 3. Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.330.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createPortal } from 'react-dom';
        import { createRoot } from 'react-dom/client';
        import {
            LayoutDashboard, Plus, FileText, Calendar as CalendarIcon,
            Package, ChevronRight, ChevronLeft, Trash2, Edit3, Download,
            ChevronDown, ChevronUp, Wifi, ArrowRight, Phone, MapPin, Bell, X, Truck, 
            Search, AlertCircle, Sparkles, Paperclip, File, Lock, Key, User, HardHat, MinusCircle, Save
        } from 'lucide-react';

        // --- Firebase Imports ---
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import {
            getFirestore, collection, addDoc, updateDoc, deleteDoc,
            doc, onSnapshot, query, orderBy, serverTimestamp
        } from 'firebase/firestore';

        // ---------------------------------------------------------
        // âœ… Firebase Config
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyB5W8qJbYMNyzPu8jmbAifCBH9qgZsQOJA",
            authDomain: "bk-manager-784a5.firebaseapp.com",
            projectId: "bk-manager-784a5",
            storageBucket: "bk-manager-784a5.firebasestorage.app",
            messagingSenderId: "16230700058",
            appId: "1:16230700058:web:833a3d16f54cdd73d2ada3",
            measurementId: "G-PMGKK5F8CP"
        };

        // ---------------------------------------------------------
        // âœ… Gemini API Key
        // ---------------------------------------------------------
        const GEMINI_API_KEY = "AIzaSyAAuopjonzUutbkTZXv5PbqfKz2hDsNRes";

        // --- Gemini API Helper ---
        const callGemini = async (prompt) => {
            const apiKey = GEMINI_API_KEY; 
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            let retries = 0;
            const maxRetries = 3;
            const delays = [1000, 2000, 4000];

            while (retries <= maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "ì‘ë‹µì„ ìƒì„±í•˜ì§€ ëª»í–ˆì–´ìš”.";
                } catch (e) {
                    retries++;
                    if (retries > maxRetries) {
                        console.error("Gemini API failed:", e);
                        return "AI ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                    }
                    await new Promise(resolve => setTimeout(resolve, delays[retries - 1]));
                }
            }
        };

        // --- Constants & Mock Data ---
        const COMPANY_INFO = {
            name: 'ìˆ¨ì‰¬ëŠ” ê¹¡í†µ',
            address: 'ê²½ê¸°ë„ í¬ì²œì‹œ êµ°ë‚´ë©´ ìœ êµë¦¬ 243-7',
            lat: 37.885, 
            lng: 127.205, 
            mapUrl: 'https://map.naver.com/p/search/ê²½ê¸°ë„ í¬ì²œì‹œ êµ°ë‚´ë©´ ìœ êµë¦¬ 243-7'
        };

        const BASE_SUPPLIER_INFO = {
            'ì„±ìˆ˜ê¸ˆì†': { phone: '02-1234-5678', email: 'order@sungsu.com', address: 'ì„œìš¸ ì„±ë™êµ¬ ì„±ìˆ˜ì´ë¡œ 123', lat: 37.5445, lng: 127.0560 },
            'ì„ì§€ë ˆì´ì €': { phone: '02-2222-3333', email: 'laser@eulji.net', address: 'ì„œìš¸ ì¤‘êµ¬ ì„ì§€ë¡œ 4ê°€ 56', lat: 37.5660, lng: 126.9950 },
            'ì²­ê³„ë„ì¥': { phone: '02-3333-4444', email: 'paint@chunggye.com', address: 'ì„œìš¸ ì¤‘êµ¬ ì²­ê³„ì²œë¡œ 789', lat: 37.5690, lng: 127.0100 },
            'íƒœì–‘ë³¼íŠ¸': { phone: '02-5555-6666', email: 'bolt@sun.com', address: 'ì„œìš¸ êµ¬ë¡œêµ¬ êµ¬ë¡œë™ 11', lat: 37.4850, lng: 126.8850 },
            'ëŒ€í•œì•„í¬ë¦´': { phone: '02-7777-8888', email: 'acryl@daehan.com', address: 'ì„œìš¸ ì¤‘êµ¬ ë°©ì‚°ì‹œì¥ Aë™', lat: 37.5670, lng: 127.0000 }
        };

        const MOCK_DATA = [
            {
                id: 'mock-1',
                displayId: 'ORD-24-101',
                itemName: 'í…ŒìŠ¤íŠ¸ ì‘ì—… (ì„œë²„ ì—°ê²° í•„ìš”)',
                clientName: 'í…ŒìŠ¤íŠ¸ ì—…ì²´',
                status: 'ì‘ì—…ì¤‘',
                deliveryDate: new Date().toISOString().split('T')[0],
                completedDate: '', 
                description: 'ì„œë²„ì— ì—°ê²°ë˜ë©´ ì‹¤ì œ ë°ì´í„°ê°€ í‘œì‹œë©ë‹ˆë‹¤.',
                materials: []
            }
        ]; 

        // --- Helper Function: Distance Calculation (Haversine) ---
        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        };

        const getMockCoordinates = (address) => {
            return { lat: 37.54 + (Math.random() * 0.05), lng: 127.05 + (Math.random() * 0.05) };
        };

        // --- Helper Components ---
        
        // ğŸŒŸ Portal Component for Modals (Fixes layout issues on mobile)
        const ModalOverlay = ({ children, onClose }) => {
            return createPortal(
                <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/50 animate-fade-in" onClick={onClose}>
                    {children}
                </div>,
                document.body
            );
        };

        const StatusBadge = ({ status }) => {
            const colors = {
                'ëŒ€ê¸°': 'bg-gray-100 text-gray-600',
                'ì„¤ê³„ì¤‘': 'bg-blue-100 text-blue-700',
                'ì‘ì—…ì¤‘': 'bg-amber-100 text-amber-700',
                'ë„ì¥/ë§ˆê°ì¤‘': 'bg-purple-100 text-purple-700',
                'ì‘ì—…ì™„ë£Œ': 'bg-teal-100 text-teal-700 font-bold',
                'ë‚©í’ˆì™„ë£Œ': 'bg-slate-200 text-slate-500 line-through',
            };
            return <span className={`flex-shrink-0 px-2 py-1 rounded-full text-xs font-bold whitespace-nowrap ${colors[status] || 'bg-gray-100'}`}>{status}</span>;
        };

        const MaterialStatusBadge = ({ status, onClick }) => {
            const colors = {
                'ë°œì£¼': 'bg-yellow-100 text-yellow-700',
                'íšŒìˆ˜ëŒ€ê¸°': 'bg-red-100 text-red-700 font-bold animate-pulse cursor-pointer',
                'íšŒìˆ˜ì™„ë£Œ': 'bg-gray-200 text-gray-500',
                'ì •ë³´': 'bg-slate-100 text-slate-500 border border-slate-200', 
            };
            return (
                <span 
                    onClick={onClick}
                    className={`flex-shrink-0 px-2 py-0.5 rounded text-[11px] whitespace-nowrap select-none ${colors[status] || 'bg-gray-100'} ${onClick && status !== 'ì •ë³´' ? 'cursor-pointer hover:opacity-80 ring-1 ring-transparent hover:ring-current' : ''}`}
                >
                    {status}
                </span>
            );
        };

        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>{children}</div>
        );

        const FileBox = ({size}) => <Package size={size}/>;

        // --- Login Gate Component ---
        const LoginView = ({ onLogin }) => {
            const [code, setCode] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (code === '4545') {
                    onLogin('employee');
                } else if (code === '2203') {
                    onLogin('admin');
                } else {
                    setError('ì¸ì¦ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <Card className="w-full max-w-md p-8 space-y-6 shadow-xl">
                        <div className="text-center space-y-2">
                            <div className="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Lock className="text-indigo-600" size={32} />
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800">ìˆ¨ì‰¬ëŠ” ê¹¡í†µ</h1>
                            <p className="text-slate-500">íšŒì‚¬ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <input 
                                    type="password" 
                                    value={code}
                                    onChange={(e) => {setCode(e.target.value); setError('');}}
                                    placeholder="ì¸ì¦ ì½”ë“œ ì…ë ¥ (4ìë¦¬)"
                                    className="w-full text-center text-2xl tracking-widest p-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all"
                                    maxLength={4}
                                    autoFocus
                                />
                                {error && <p className="text-red-500 text-sm text-center mt-2 font-bold animate-pulse">{error}</p>}
                            </div>
                            <button 
                                type="submit"
                                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2"
                            >
                                <Key size={20}/> ì…ì¥í•˜ê¸°
                            </button>
                        </form>
                    </Card>
                </div>
            );
        };

        // --- Components ---

        const Dashboard = ({ orders, stats, suppliers, onNavigate, isAdmin, currentUserId }) => {
            const [activeStat, setActiveStat] = useState(null);
            const [activeRoutePopup, setActiveRoutePopup] = useState(null);
            const [aiBriefing, setAiBriefing] = useState(null);
            const [isGeneratingBriefing, setIsGeneratingBriefing] = useState(false);

            const generateBriefing = async () => {
                setIsGeneratingBriefing(true);
                const urgentTasks = orders.filter(o => {
                    if (!o.deliveryDate || ['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(o.status)) return false;
                    return Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2;
                }).map(o => `${o.itemName}(${o.deliveryDate}ë§ˆê°)`).join(', ');

                const prompt = `
                    ë„ˆëŠ” ê¸ˆì† ì¸í…Œë¦¬ì–´ íšŒì‚¬ 'ìˆ¨ì‰¬ëŠ” ê¹¡í†µ'ì˜ ë§¤ë‹ˆì €ì•¼.
                    ì˜¤ëŠ˜ì˜ í˜„í™©: ì§„í–‰ì¤‘:${stats.ongoing}ê±´, íšŒìˆ˜ëŒ€ê¸°:${stats.pickup}ê±´, ê¸´ê¸‰:${stats.urgent}ê±´.
                    ê¸´ê¸‰í•­ëª©: ${urgentTasks || 'ì—†ìŒ'}.
                    ìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì•„ì£¼ ê°„ë‹¨ëª…ë£Œí•˜ê²Œ 3ì¤„ ì´ë‚´ë¡œ ë¸Œë¦¬í•‘í•´ì¤˜. êµ°ë”ë”ê¸° ì—†ì´ í•µì‹¬ë§Œ ë§í•´.
                `;

                const result = await callGemini(prompt);
                setAiBriefing(result);
                setIsGeneratingBriefing(false);
            };

            // ë™ì„  ìµœì í™”
            const optimizedRoute = useMemo(() => {
                const pickupTargets = Object.keys(suppliers).filter(name => 
                    suppliers[name].some(m => m.status === 'íšŒìˆ˜ëŒ€ê¸°')
                );

                if (pickupTargets.length === 0) return [];

                let currentLoc = { lat: COMPANY_INFO.lat, lng: COMPANY_INFO.lng, name: 'start' };
                
                let unvisited = pickupTargets.map(name => {
                    const materials = suppliers[name];
                    const customInfo = materials[0]?.supplierInfo || {};
                    const baseInfo = BASE_SUPPLIER_INFO[name] || {};
                    
                    const lat = customInfo.lat || baseInfo.lat || 37.55; 
                    const lng = customInfo.lng || baseInfo.lng || 127.0;
                    const address = customInfo.address || baseInfo.address || 'ì£¼ì†Œ ë¯¸ìƒ';

                    return {
                        name,
                        lat,
                        lng,
                        address,
                        count: materials.filter(m => m.status === 'íšŒìˆ˜ëŒ€ê¸°').length
                    };
                });

                const route = [];
                while (unvisited.length > 0) {
                    let nearest = null;
                    let minDist = Infinity;
                    let nearestIdx = -1;
                    unvisited.forEach((node, idx) => {
                        const dist = getDistance(currentLoc.lat, currentLoc.lng, node.lat, node.lng);
                        if (dist < minDist) {
                            minDist = dist;
                            nearest = node;
                            nearestIdx = idx;
                        }
                    });
                    if (nearest) {
                        route.push(nearest);
                        currentLoc = nearest; 
                        unvisited.splice(nearestIdx, 1);
                    } else {
                        break;
                    }
                }
                return route;
            }, [suppliers]);

            const statList = useMemo(() => {
                if (!activeStat) return [];
                if (activeStat === 'pickup') {
                    const list = [];
                    orders.forEach(o => (o.materials || []).forEach(m => {
                        if (m.status === 'íšŒìˆ˜ëŒ€ê¸°') {
                            list.push({ ...m, orderName: o.itemName, orderId: o.id, type: 'material' });
                        }
                    }));
                    return list;
                }
                return orders.filter(o => {
                    if (activeStat === 'ongoing') return !['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(o.status);
                    if (activeStat === 'urgent') {
                        if (!o.deliveryDate || ['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(o.status)) return false;
                        return Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2;
                    }
                    if (activeStat === 'completed') {
                        const isDone = ['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(o.status);
                        const oneMonthAgo = new Date();
                        oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);
                        const delDate = new Date(o.deliveryDate);
                        return isDone && delDate >= oneMonthAgo;
                    }
                    return false;
                });
            }, [activeStat, orders]);

            return (
                <>
                    {/* Main Content */}
                    <div className="space-y-6 animate-fade-in pb-10 relative">
                        {/* Stats Grid */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <Card className="p-4 border-l-4 border-blue-600 cursor-pointer hover:bg-blue-50" onClick={()=>setActiveStat('ongoing')}>
                                <div className="text-xs text-gray-500">ì§„í–‰ ì¤‘</div>
                                <div className="text-2xl font-bold">{stats.ongoing}ê±´</div>
                            </Card>
                            <Card className="p-4 border-l-4 border-indigo-500 cursor-pointer hover:bg-indigo-50" onClick={()=>setActiveStat('pickup')}>
                                <div className="text-xs text-gray-500">íšŒìˆ˜ ëŒ€ê¸°</div>
                                <div className="text-2xl font-bold text-indigo-600 animate-pulse">{stats.pickup}ê±´</div>
                            </Card>
                            <Card className="p-4 border-l-4 border-red-500 cursor-pointer hover:bg-red-50" onClick={()=>setActiveStat('urgent')}>
                                <div className="text-xs text-gray-500">ë§ˆê° ì„ë°•</div>
                                <div className="text-2xl font-bold text-red-600">{stats.urgent}ê±´</div>
                            </Card>
                            <Card className="p-4 border-l-4 border-slate-400 cursor-pointer hover:bg-slate-100" onClick={()=>setActiveStat('completed')}>
                                <div className="text-xs text-gray-500">ìµœê·¼ ì™„ë£Œ</div>
                                <div className="text-2xl font-bold text-slate-500">{stats.completed}ê±´</div>
                            </Card>
                        </div>

                        <button onClick={generateBriefing} disabled={isGeneratingBriefing} className="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 rounded-xl shadow-lg font-bold flex items-center justify-center gap-2 hover:opacity-90">
                            {isGeneratingBriefing ? 'AIê°€ ì‘ì„±ì¤‘...' : <><Sparkles size={18}/> AI ì¼ì¼ ë¸Œë¦¬í•‘ ìƒì„±</>}
                        </button>

                        <div>
                            <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2"><FileText size={18}/> ìµœì‹  ì‘ì—…</h3>
                            <div className="grid gap-3">
                            {orders.filter(o => !['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(o.status) && o.itemName !== 'ê¸°íƒ€ ìì¬ ë°œì£¼').slice(0, 3).map(o => (
                                <Card key={o.id} className="p-4 flex justify-between items-center cursor-pointer hover:border-blue-400" onClick={() => onNavigate(o)}>
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2 mb-1"><StatusBadge status={o.status} /><span className="text-xs text-gray-400">{o.displayId}</span></div>
                                        <div className="font-bold">{o.itemName}</div>
                                    </div>
                                    <div className="text-sm font-bold text-red-500">{o.deliveryDate} ë§ˆê°</div>
                                </Card>
                            ))}
                            </div>
                        </div>

                        <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-5">
                            <div className="flex items-center gap-2 text-indigo-900 font-bold mb-3"><Truck size={20} /><h3>ìµœì  íšŒìˆ˜ ë™ì„ </h3></div>
                            {optimizedRoute.length > 0 ? (
                            <div className="flex flex-wrap gap-2 items-center">
                                <span className="text-xs bg-white px-2 py-1 rounded border">ì¶œë°œ</span>
                                {optimizedRoute.map((stop, i) => (
                                    <React.Fragment key={i}>
                                        <ArrowRight size={14} className="text-indigo-300" />
                                        <button onClick={() => setActiveRoutePopup(stop)} className="bg-indigo-600 text-white px-3 py-2 rounded shadow text-sm font-bold hover:bg-indigo-700">
                                            {i+1}. {stop.name} <span className="bg-white/20 px-1 rounded text-[10px] ml-1">{stop.count}</span>
                                        </button>
                                    </React.Fragment>
                                ))}
                                <ArrowRight size={14} className="text-indigo-300" />
                                <span className="text-xs bg-white px-2 py-1 rounded border">ë³µê·€</span>
                            </div>
                            ) : <div className="text-sm text-indigo-400">íšŒìˆ˜í•  ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
                        </div>
                    </div>

                    {/* Modals using Portal to escape sidebar z-index issues */}
                    
                    {/* Stat Modal Overlay */}
                    {activeStat && (
                        <ModalOverlay onClose={()=>setActiveStat(null)}>
                            <div className="bg-white w-full max-w-md rounded-xl shadow-2xl p-4 max-h-[80vh] overflow-y-auto scroll-touch" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between mb-4">
                                    <h3 className="font-bold text-lg">ìƒì„¸ ë‚´ì—­ ({statList.length})</h3>
                                    <button onClick={()=>setActiveStat(null)}><X size={20}/></button>
                                </div>
                                <div className="space-y-2">
                                    {statList.length === 0 && <div className="text-gray-400">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                                    {statList.map((item, i) => (
                                        <div key={i} className="border p-3 rounded hover:bg-slate-50 cursor-pointer" onClick={()=>{
                                            const order = activeStat === 'pickup' ? orders.find(o=>o.id===item.orderId) : item;
                                            if(order) { onNavigate(order); setActiveStat(null); }
                                        }}>
                                            <div className="font-bold">{activeStat==='pickup' ? item.item : item.itemName}</div>
                                            <div className="text-xs text-gray-500">{activeStat==='pickup' ? `${item.supplier} - ${item.quantity}` : item.status}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </ModalOverlay>
                    )}

                    {/* Briefing Modal */}
                    {aiBriefing && (
                        <ModalOverlay onClose={()=>setAiBriefing(null)}>
                            <div className="bg-white w-full max-w-md rounded-xl p-6" onClick={e=>e.stopPropagation()}>
                                <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Sparkles className="text-yellow-500"/> AI ë¸Œë¦¬í•‘</h3>
                                <div className="bg-slate-50 p-4 rounded text-sm mb-4 whitespace-pre-wrap leading-relaxed font-medium text-slate-700">{aiBriefing}</div>
                                <button onClick={()=>setAiBriefing(null)} className="w-full bg-slate-800 text-white py-2 rounded font-bold">ë‹«ê¸°</button>
                            </div>
                        </ModalOverlay>
                    )}
                    
                    {/* Route Modal */}
                    {activeRoutePopup && (
                        <ModalOverlay onClose={()=>setActiveRoutePopup(null)}>
                            <div className="bg-white w-full max-w-sm rounded-xl p-4" onClick={e=>e.stopPropagation()}>
                                <h3 className="font-bold text-lg mb-2">{activeRoutePopup.name}</h3>
                                <div className="text-sm text-gray-500 mb-4">{activeRoutePopup.address}</div>
                                <div className="space-y-2 mb-4">
                                    {(suppliers[activeRoutePopup.name] || []).filter(m=>m.status==='íšŒìˆ˜ëŒ€ê¸°').map((item, i)=>(
                                        <div key={i} className="bg-slate-50 p-2 rounded text-sm flex justify-between">
                                            <span>{item.item}</span><span className="font-bold">{item.quantity}</span>
                                        </div>
                                    ))}
                                </div>
                                <a href={`https://map.naver.com/p/search/${activeRoutePopup.address}`} target="_blank" className="block w-full bg-indigo-600 text-white text-center py-3 rounded font-bold">ì§€ë„ ì—´ê¸°</a>
                            </div>
                        </ModalOverlay>
                    )}
                </>
            );
        };

        const ListView = ({ orders, onSelect, onAdd }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [open, setOpen] = useState({ design: true, prod: true, done: false });
            const groups = { design: [], prod: [], done: [] };
            
            orders.filter(o => (o.itemName || '').toLowerCase().includes(searchTerm.toLowerCase())).forEach(o => {
                if (['ëŒ€ê¸°', 'ì„¤ê³„ì¤‘'].includes(o.status)) groups.design.push(o);
                else if (['ì‘ì—…ì¤‘', 'ë„ì¥/ë§ˆê°ì¤‘'].includes(o.status)) groups.prod.push(o);
                else groups.done.push(o);
            });

            const Section = ({ id, title, items }) => (
                <div className="mb-4">
                <div onClick={() => setOpen({ ...open, [id]: !open[id] })} className={`flex justify-between p-3 rounded cursor-pointer transition-colors ${open[id] ? 'bg-slate-800 text-white' : 'bg-white border hover:bg-slate-50'}`}>
                    <span className="font-bold">{title} ({items.length})</span>{open[id] ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                </div>
                {open[id] && <div className="mt-2 pl-2 border-l-2 border-slate-200 space-y-2">
                    {items.map(o => (
                    <Card key={o.id} className="p-3 cursor-pointer hover:border-blue-500 bg-white transition-colors" onClick={() => onSelect(o)}>
                        <div className="flex justify-between items-center mb-1">
                        <span className="font-bold truncate mr-2">{o.itemName}</span>
                        <StatusBadge status={o.status} />
                        </div>
                        <div className="text-xs text-gray-500 flex justify-between">
                        <span>{o.clientName}</span>
                        <span>{o.deliveryDate} ë‚©í’ˆ</span>
                        </div>
                    </Card>
                    ))}
                    {items.length === 0 && <div className="text-sm text-gray-400 p-2">í•­ëª© ì—†ìŒ</div>}
                </div>}
                </div>
            );

            return (
                <div className="space-y-4 animate-fade-in pb-10">
                <div className="flex gap-2 bg-white p-3 rounded-xl border shadow-sm sticky top-0 z-10">
                    <Search size={20} className="text-gray-400"/>
                    <input 
                    className="flex-1 outline-none bg-transparent min-w-0" 
                    placeholder="ì‘ì—…ëª… ê²€ìƒ‰..." 
                    value={searchTerm} 
                    onChange={e => setSearchTerm(e.target.value)} 
                    />
                    <button onClick={onAdd} className="bg-slate-800 text-white px-3 py-1 rounded text-sm font-bold flex items-center gap-1 flex-shrink-0">
                    <Plus size={16} /> <span className="hidden sm:inline">ì‘ì—…ë“±ë¡</span>
                    </button>
                </div>
                <Section id="design" title="ì„¤ê³„ ë‹¨ê³„" items={groups.design} />
                <Section id="prod" title="ì œì‘/ë§ˆê° ë‹¨ê³„" items={groups.prod} />
                <Section id="done" title="ì™„ë£Œ" items={groups.done} />
                </div>
            );
        };

        const DetailView = ({ order, onBack, onUpdate, isAdmin, currentUserId }) => {
            if (!order) return null;
            const canEdit = isAdmin || order.userId === currentUserId;
            const [mat, setMat] = useState({ supplier: '', item: '', quantity: '', status: 'ë°œì£¼', date: new Date().toISOString().split('T')[0] });
            const [link, setLink] = useState({ name: '', url: '' });
            const [showSuggestions, setShowSuggestions] = useState(false);
            const supplierOptions = Object.keys(BASE_SUPPLIER_INFO);
            const filteredSuppliers = supplierOptions.filter(s => s.includes(mat.supplier));

            const updateOrder = (newData) => {
                onUpdate({ ...order, ...newData });
            };

            const cycleStatus = (currentStatus) => {
                if (currentStatus === 'ë°œì£¼') return 'íšŒìˆ˜ëŒ€ê¸°';
                if (currentStatus === 'íšŒìˆ˜ëŒ€ê¸°') return 'íšŒìˆ˜ì™„ë£Œ';
                return 'ë°œì£¼';
            };

            const handleStatusClick = (m) => {
                if (!canEdit) return;
                if (m.status === 'ì •ë³´') return; // ì •ë³´ íƒ€ì…ì€ ìƒíƒœ ë³€ê²½ ë¶ˆê°€
                const nextStatus = cycleStatus(m.status);
                const updated = order.materials.map(x => x.id === m.id ? { ...x, status: nextStatus } : x);
                // ìƒì„¸ í˜ì´ì§€ì—ì„œ ìì¬ ìƒíƒœ ë³€ê²½ ì‹œì—ëŠ” í™”ë©´ ì´ë™ ì•ˆí•¨ (ë‘ë²ˆì§¸ ì¸ì false)
                onUpdate({ materials: updated }, null, false);
            };

            return (
                <div className="h-full overflow-y-auto animate-fade-in pb-10 scroll-touch" onClick={()=>setShowSuggestions(false)}>
                    <div className="flex items-center gap-2 text-slate-500 cursor-pointer mb-4" onClick={onBack}>
                        <ChevronLeft size={20}/> <span className="text-sm font-bold">ëª©ë¡</span>
                    </div>
                    <div className="flex justify-between items-start mb-6">
                        <div>
                            <div className="flex items-center gap-2 mb-2"><span className="text-gray-400 text-sm">{order.displayId}</span><StatusBadge status={order.status} /></div>
                            <h1 className="text-2xl font-bold">{order.itemName}</h1>
                        </div>
                        {canEdit && <button onClick={() => onUpdate(null, 'form')} className="bg-slate-100 px-3 py-2 rounded flex gap-2 text-sm font-bold"><Edit3 size={16} /> ìˆ˜ì •</button>}
                    </div>

                    <Card className="p-5 mb-4 text-sm space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                             <div><div className="text-gray-400 text-xs uppercase mb-1">Client</div><div className="font-bold">{order.clientName}</div></div>
                             <div><div className="text-gray-400 text-xs uppercase mb-1">Delivery Addr</div><div className="font-bold break-keep">{order.deliveryAddress || '-'}</div></div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div><div className="text-gray-400 text-xs uppercase mb-1">Manager</div><div className="font-bold flex items-center gap-1"><User size={12}/>{order.manager || '-'}</div></div>
                            <div><div className="text-gray-400 text-xs uppercase mb-1">Worker</div><div className="font-bold flex items-center gap-1"><HardHat size={12}/>{order.technician || '-'}</div></div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                             <div><div className="text-gray-400 text-xs uppercase mb-1">Ordered</div><div className="font-bold">{order.orderDate}</div></div>
                             <div>
                                <div className="text-gray-400 text-xs uppercase mb-1">
                                    {['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(order.status) ? 'Completed' : 'Deadline'}
                                </div>
                                <div className={`font-bold ${['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(order.status) ? 'text-blue-600' : 'text-red-600'}`}>
                                    {['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(order.status) && order.completedDate ? order.completedDate : order.deliveryDate}
                                </div>
                             </div>
                        </div>
                        <div><div className="text-gray-400 text-xs uppercase mb-1">Memo</div><div className="text-slate-700 whitespace-pre-wrap">{order.description || '-'}</div></div>
                    </Card>

                    {/* Files Section */}
                    <div className="bg-white p-4 rounded-xl border border-slate-200 flex flex-col mb-4">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="font-bold text-sm text-slate-700 flex gap-2"><FileBox size={16} /> ë„ë©´/íŒŒì¼</h3>
                            <span className="text-xs text-gray-400">{(order.files || []).length}ê°œ</span>
                        </div>
                        
                        <div className="flex-1 space-y-2 mb-3 max-h-[150px] overflow-y-auto">
                            {(order.files || []).length === 0 && <div className="text-center text-xs text-gray-400 py-2">ë“±ë¡ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                            {(order.files || []).map((f, i) => (
                            <div key={i} className="flex justify-between items-center p-2 bg-blue-50 rounded text-xs group">
                                <div className="flex items-center gap-2 truncate flex-1 min-w-0">
                                {f.name.endsWith('.pdf') ? <FileText size={12} className="text-red-500 flex-shrink-0"/> : <File size={12} className="text-blue-500 flex-shrink-0"/>}
                                <span className="truncate text-blue-800 font-medium">{f.name}</span>
                                </div>
                                <a href={f.url} target="_blank" rel="noreferrer" className="bg-white p-1 rounded text-blue-600 hover:bg-blue-100 flex-shrink-0 ml-2">
                                <Download size={12} />
                                </a>
                            </div>
                            ))}
                        </div>

                        {canEdit && (
                        <div className="flex gap-1 border-t pt-2">
                            <input placeholder="íŒŒì¼ëª…" className="w-1/3 border p-1.5 rounded text-xs bg-gray-50" value={link.name} onChange={e => setLink({ ...link, name: e.target.value })} />
                            <input placeholder="URL" className="flex-1 border p-1.5 rounded text-xs bg-gray-50" value={link.url} onChange={e => setLink({ ...link, url: e.target.value })} />
                            <button onClick={() => {
                                if (!link.name || !link.url) return;
                                updateOrder({ files: [...(order.files || []), { ...link, id: Date.now() }] });
                                setLink({ name: '', url: '' });
                            }} className="bg-slate-700 text-white px-3 rounded text-xs font-bold hover:bg-slate-800">ë“±ë¡</button>
                        </div>
                        )}
                    </div>

                    <h3 className="font-bold mb-2 flex items-center gap-2"><Package size={18}/> ìì¬ ë°œì£¼ ë‚´ì—­</h3>
                    <p className="text-xs text-gray-500 mb-2">* ìƒíƒœë¥¼ í´ë¦­í•˜ë©´ ë°œì£¼/íšŒìˆ˜ëŒ€ê¸°/íšŒìˆ˜ì™„ë£Œ ìˆœìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.</p>
                    <Card className="p-0 overflow-hidden mb-10">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 border-b"><tr><th className="p-2">ê±°ë˜ì²˜</th><th className="p-2">í’ˆëª©</th><th className="p-2">ìƒíƒœ</th></tr></thead>
                            <tbody>
                                {(order.materials || []).map((m, i) => (
                                    <tr key={i} className="border-b">
                                        <td className="p-2 font-bold">{m.supplier}</td>
                                        <td className="p-2">{m.item} ({m.quantity})</td>
                                        <td className="p-2">
                                            <MaterialStatusBadge status={m.status} onClick={() => handleStatusClick(m)} />
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {canEdit && (
                            <div className="p-3 bg-slate-50 border-t">
                                <div className="text-xs font-bold text-slate-500 mb-2">ìì¬ ì¶”ê°€</div>
                                <div className="flex flex-col md:flex-row gap-2 mb-2 items-start">
                                    <div className="relative flex-1 min-w-0 w-full" onClick={e=>e.stopPropagation()}>
                                    <input 
                                        placeholder="ê±°ë˜ì²˜" 
                                        className="border p-2 rounded w-full text-sm" 
                                        value={mat.supplier} 
                                        onFocus={()=>setShowSuggestions(true)}
                                        onChange={e => {
                                        setMat({ ...mat, supplier: e.target.value });
                                        setShowSuggestions(true);
                                        }} 
                                    />
                                    {showSuggestions && filteredSuppliers.length > 0 && (
                                        <ul className="absolute z-50 left-0 top-full mt-1 w-full bg-white border rounded-md shadow-lg max-h-40 overflow-y-auto">
                                        {filteredSuppliers.map((s, idx) => (
                                            <li key={idx} className="p-2 text-sm hover:bg-indigo-50 cursor-pointer text-slate-700 border-b last:border-0" onClick={() => { setMat({ ...mat, supplier: s }); setShowSuggestions(false); }}>
                                            {s}
                                            </li>
                                        ))}
                                        </ul>
                                    )}
                                    </div>
                                    <input placeholder="í’ˆëª©ëª…" className="border p-2 rounded flex-1 text-sm min-w-0 w-full" value={mat.item} onChange={e => setMat({ ...mat, item: e.target.value })} />
                                    <input placeholder="ìˆ˜ëŸ‰" className="border p-2 rounded w-full md:w-20 text-sm" value={mat.quantity} onChange={e => setMat({ ...mat, quantity: e.target.value })} />
                                </div>
                                <button onClick={()=>{
                                    if(!mat.supplier || !mat.item) return;
                                    // ìƒì„¸í™”ë©´ì—ì„œ ìì¬ ì¶”ê°€ì‹œ í™”ë©´ì´ë™ ì•ˆí•¨
                                    onUpdate({ materials: [...(order.materials||[]), {...mat, id:Date.now()}] }, null, false);
                                    setMat({...mat, supplier:'', item:'', quantity:''});
                                    setShowSuggestions(false);
                                }} className="bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold w-full">ì¶”ê°€</button>
                            </div>
                        )}
                    </Card>
                </div>
            );
        };

        const FormView = ({ order, onSave, onDelete, onCancel, isAdmin, currentUserId }) => {
            const [data, setData] = useState(order || {
                clientName: '', itemName: '', 
                manager: '', technician: '', 
                deliveryAddress: '', 
                orderDate: new Date().toISOString().split('T')[0], 
                deliveryDate: '', 
                completedDate: '', // ì´ˆê¸°ê°’ ì„¤ì •
                status: 'ëŒ€ê¸°', description: '', clientContact: '', files: []
            });
            const [isAiSuggesting, setIsAiSuggesting] = useState(false);
            const fileInputRef = useRef(null);

            const canEdit = !order || isAdmin || order.userId === currentUserId;

            // ì™„ë£Œ ìƒíƒœì¼ ë•Œ ê¸°ë³¸ ì™„ë£Œì¼ì´ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
            useEffect(() => {
                if (['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(data.status) && !data.completedDate) {
                    setData(prev => ({ ...prev, completedDate: new Date().toISOString().split('T')[0] }));
                }
            }, [data.status]);

            const handleAiSuggest = async () => {
                if (!data.itemName) return alert('ì‘ì—…ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
                setIsAiSuggesting(true);
                const prompt = `ê¸ˆì† íšŒì‚¬ ì‘ì—…ëª… '${data.itemName}'ì— í•„ìš”í•œ ìƒì„¸ ë‚´ìš©ì„ 200ì ì´ë‚´ë¡œ ì¶”ì²œí•´ ì¤˜.`;
                const suggestion = await callGemini(prompt);
                setData(prev => ({ ...prev, description: suggestion }));
                setIsAiSuggesting(false);
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                const mockFile = { id: Date.now(), name: file.name, url: '#' };
                setData(prev => ({ ...prev, files: [...(prev.files || []), mockFile] }));
                }
            };

            const removeFile = (fileId) => {
                setData(prev => ({ ...prev, files: prev.files.filter(f => f.id !== fileId) }));
            };

            if (!canEdit) return <div className="p-10 text-center">ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.<button onClick={onCancel} className="block mx-auto mt-4 bg-gray-200 px-4 py-2 rounded">ëŒì•„ê°€ê¸°</button></div>;

            return (
                <div className="max-w-2xl mx-auto animate-fade-in pb-10 scroll-touch">
                    <div onClick={onCancel} className="mb-4 cursor-pointer text-slate-500 font-bold">ì·¨ì†Œ</div>
                    <Card className="p-6 space-y-4">
                        <h2 className="text-2xl font-bold">{order ? 'ìˆ˜ì •' : 'ìƒˆ ì‘ì—… ë“±ë¡'}</h2>
                        <div className="grid gap-4">
                            <div className="grid grid-cols-1 gap-1">
                                <label className="text-xs font-bold text-gray-500">ì‘ì—…ëª…</label>
                                <input className="border p-2 rounded w-full" value={data.itemName} onChange={e=>setData({...data, itemName:e.target.value})}/>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500">ë‹´ë‹¹ì (Manager)</label>
                                    <input className="border p-2 rounded w-full" value={data.manager} onChange={e=>setData({...data, manager:e.target.value})}/>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500">ì‘ì—…ì (Technician)</label>
                                    <input className="border p-2 rounded w-full" value={data.technician} onChange={e=>setData({...data, technician:e.target.value})}/>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500">í´ë¼ì´ì–¸íŠ¸</label>
                                    <input className="border p-2 rounded w-full" value={data.clientName} onChange={e=>setData({...data, clientName:e.target.value})}/>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500">ì—°ë½ì²˜</label>
                                    <input className="border p-2 rounded w-full" value={data.clientContact} onChange={e=>setData({...data, clientContact:e.target.value})}/>
                                </div>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-gray-500">ë‚©í’ˆ/ì‹œê³µ ì£¼ì†Œ</label>
                                <input className="border p-2 rounded w-full" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" value={data.deliveryAddress} onChange={e=>setData({...data, deliveryAddress:e.target.value})}/>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500">ë°œì£¼(ì ‘ìˆ˜) ë‚ ì§œ</label>
                                    <input type="date" className="border p-2 rounded w-full" value={data.orderDate} onChange={e=>setData({...data, orderDate:e.target.value})}/>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 text-red-500">ë‚©í’ˆ(ë§ˆê°) ë‚ ì§œ</label>
                                    <input type="date" className="border p-2 rounded w-full" value={data.deliveryDate} onChange={e=>setData({...data, deliveryDate:e.target.value})}/>
                                </div>
                            </div>

                            <div>
                                <label className="text-xs font-bold text-gray-500">ì§„í–‰ ìƒíƒœ</label>
                                <select className="border p-2 rounded w-full" value={data.status} onChange={e=>setData({...data, status:e.target.value})}>
                                    <option>ëŒ€ê¸°</option>
                                    <option>ì„¤ê³„ì¤‘</option>
                                    <option>ì‘ì—…ì¤‘</option>
                                    <option>ë„ì¥/ë§ˆê°ì¤‘</option>
                                    <option>ì‘ì—…ì™„ë£Œ</option>
                                    <option>ë‚©í’ˆì™„ë£Œ</option>
                                </select>
                            </div>

                            {/* ì™„ë£Œ ìƒíƒœì¼ ê²½ìš° ì‹¤ì œ ì™„ë£Œì¼ ì…ë ¥ í•„ë“œ ë…¸ì¶œ */}
                            {['ì‘ì—…ì™„ë£Œ', 'ë‚©í’ˆì™„ë£Œ'].includes(data.status) && (
                                <div>
                                    <label className="text-xs font-bold text-gray-500 text-blue-600">ì‹¤ì œ ì™„ë£Œì¼ (ì‹œê³µ/ë‚©í’ˆ ì™„ë£Œ)</label>
                                    <input type="date" className="border p-2 rounded w-full bg-blue-50 border-blue-200" value={data.completedDate || ''} onChange={e=>setData({...data, completedDate:e.target.value})}/>
                                </div>
                            )}

                            <div>
                                <div className="flex justify-between mb-1">
                                    <label className="text-xs font-bold text-gray-500">ì‘ì—… ë‚´ìš© / ë©”ëª¨</label>
                                    <button onClick={handleAiSuggest} className="text-xs text-indigo-600 font-bold">{isAiSuggesting ? 'ìƒì„±ì¤‘...' : 'AI ì¶”ì²œ'}</button>
                                </div>
                                <textarea className="border p-2 rounded w-full h-24" value={data.description} onChange={e=>setData({...data, description:e.target.value})}/>
                            </div>

                            <div className="border-t pt-4 mt-2">
                                <label className="text-xs font-bold text-gray-500 mb-2 block">ë„ë©´ / íŒŒì¼ ì²¨ë¶€</label>
                                <div className="space-y-2">
                                {(data.files || []).map(f => (
                                    <div key={f.id} className="flex justify-between items-center p-2 bg-slate-50 rounded border text-sm">
                                    <div className="flex items-center gap-2 truncate">
                                        <Paperclip size={14} className="text-gray-400"/>
                                        <span className="truncate">{f.name}</span>
                                    </div>
                                    <button onClick={() => removeFile(f.id)} className="text-red-500 hover:text-red-700"><X size={14}/></button>
                                    </div>
                                ))}
                                </div>
                                <div className="mt-2 flex items-center gap-2">
                                <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileChange} />
                                <button onClick={() => fileInputRef.current.click()} className="text-sm bg-gray-100 border border-gray-300 px-3 py-1.5 rounded flex items-center gap-2 hover:bg-gray-200">
                                    <Plus size={14}/> íŒŒì¼ ì¶”ê°€
                                </button>
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-end gap-2 pt-4 border-t">
                            {order && <button onClick={()=>onDelete(order.id)} className="text-red-500 text-sm font-bold px-4">ì‚­ì œ</button>}
                            <button onClick={()=>onSave(data, true)} className="bg-slate-800 text-white px-6 py-2 rounded font-bold">ì €ì¥</button>
                        </div>
                    </Card>
                </div>
            );
        };

        const MaterialManageView = ({ suppliers, orders, onUpdateOrder }) => {
            const [selectedSupplier, setSelectedSupplier] = useState(null);
            const [isCustomMode, setIsCustomMode] = useState(false);
            const [editingMaterial, setEditingMaterial] = useState(null); // ìˆ˜ì •í•  ìì¬ ìƒíƒœ
            const [isEditingInfo, setIsEditingInfo] = useState(false); // ê±°ë˜ì²˜ ì •ë³´ ìˆ˜ì • ëª¨ë“œ
            const [editingInfoData, setEditingInfoData] = useState({ phone: '', email: '', address: '' });
            const baseInfo = BASE_SUPPLIER_INFO[selectedSupplier];
            
            const [quickAdd, setQuickAdd] = useState(false);
            
            // --- ë‹¤ì¤‘ ì…ë ¥ ìƒíƒœ ê´€ë¦¬ ---
            const [batchHeader, setBatchHeader] = useState({
                orderId: '',
                supplier: '',
                date: new Date().toISOString().split('T')[0]
            });
            const [batchItems, setBatchItems] = useState([{ id: Date.now(), item: '', quantity: '' }]);
            
            const [newSupplierInfo, setNewSupplierInfo] = useState({ phone: '', email: '', address: '' });

            useEffect(() => { 
                if (selectedSupplier && !isCustomMode) {
                    setBatchHeader(prev => ({ ...prev, supplier: selectedSupplier }));
                } else if (isCustomMode) {
                    setBatchHeader(prev => ({ ...prev, supplier: '' }));
                }
            }, [selectedSupplier, isCustomMode]);

            // ì „ì²´ ìì¬ ëª©ë¡ (ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬)
            const allMaterials = useMemo(() => {
                const all = [];
                orders.forEach(o => {
                    (o.materials || []).forEach(m => {
                        all.push({ ...m, orderId: o.id, orderName: o.itemName });
                    });
                });
                return all.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
            }, [orders]);

            // í™”ë©´ì— í‘œì‹œí•  ìì¬ ëª©ë¡
            const displayedMaterials = (selectedSupplier && !isCustomMode) 
                ? (suppliers[selectedSupplier] || []) 
                : allMaterials;

            const currentSupplierInfo = useMemo(() => {
                if (baseInfo) return baseInfo;
                if (selectedSupplier && suppliers[selectedSupplier]) {
                    // ê±°ë˜ì²˜ ì •ë³´ê°€ ìˆëŠ” í•­ëª© ì°¾ê¸° (status: 'ì •ë³´'ê°€ ìš°ì„ , ì—†ìœ¼ë©´ ì•„ë¬´ê±°ë‚˜)
                    const infoItem = suppliers[selectedSupplier].find(m => m.status === 'ì •ë³´') || suppliers[selectedSupplier][0];
                    return infoItem?.supplierInfo || {};
                }
                return {};
            }, [selectedSupplier, suppliers, baseInfo]);

            // ê±°ë˜ì²˜ ì„ íƒ ì‹œ ìˆ˜ì • ë°ì´í„° ì´ˆê¸°í™”
            useEffect(() => {
                if (selectedSupplier && !isCustomMode) {
                    setEditingInfoData({
                        phone: currentSupplierInfo.phone || '',
                        email: currentSupplierInfo.email || '',
                        address: currentSupplierInfo.address || ''
                    });
                    setIsEditingInfo(false);
                }
            }, [selectedSupplier, currentSupplierInfo, isCustomMode]);

            // ì™¼ìª½ ì‚¬ì´ë“œë°” ì •ë ¬ëœ ê±°ë˜ì²˜ ëª©ë¡
            const sortedSuppliers = useMemo(() => {
                const list = Object.keys(suppliers).map(name => {
                    const items = suppliers[name];
                    // 'ë°œì£¼' ë˜ëŠ” 'íšŒìˆ˜ëŒ€ê¸°' ìƒíƒœê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ í™œì„± ìƒíƒœë¡œ ê°„ì£¼
                    const hasActive = items.some(m => ['ë°œì£¼', 'íšŒìˆ˜ëŒ€ê¸°', 'ì‘ì—…ì¤‘'].includes(m.status));
                    const pickupCnt = items.filter(m => m.status === 'íšŒìˆ˜ëŒ€ê¸°').length;
                    const activeCnt = items.filter(m => m.status === 'ë°œì£¼').length;
                    return { name, hasActive, pickupCnt, activeCnt, items };
                });

                return list.sort((a, b) => {
                    // 1ìˆœìœ„: í™œì„± ë°œì£¼ ìœ ë¬´ (ìˆëŠ” ê²ƒ ìš°ì„ )
                    if (a.hasActive && !b.hasActive) return -1;
                    if (!a.hasActive && b.hasActive) return 1;
                    
                    // 2ìˆœìœ„: ê°€ë‚˜ë‹¤ìˆœ
                    return a.name.localeCompare(b.name, 'ko');
                });
            }, [suppliers]);

            // í–‰ ì¶”ê°€/ì‚­ì œ í•¨ìˆ˜
            const addRow = () => {
                setBatchItems([...batchItems, { id: Date.now() + Math.random(), item: '', quantity: '' }]);
            };
            
            const removeRow = (id) => {
                if (batchItems.length === 1) {
                    setBatchItems([{ id: Date.now(), item: '', quantity: '' }]); // ë§ˆì§€ë§‰ í•˜ë‚˜ëŠ” ë‚´ìš©ë§Œ ì´ˆê¸°í™”
                } else {
                    setBatchItems(batchItems.filter(i => i.id !== id));
                }
            };

            const updateRow = (id, field, value) => {
                setBatchItems(batchItems.map(i => i.id === id ? { ...i, [field]: value } : i));
            };

            const handleBatchAdd = async () => {
                const validItems = batchItems.filter(i => i.item.trim() !== '');
                
                if (validItems.length === 0 && !isCustomMode) return alert("í’ˆëª©ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”");
                if (isCustomMode && !batchHeader.supplier) return alert("ê±°ë˜ì²˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
                
                let targetOrder = orders.find(o => o.id === batchHeader.orderId);
                
                if (!targetOrder && !batchHeader.orderId) {
                    targetOrder = orders.find(o => o.itemName === 'ê¸°íƒ€ ìì¬ ë°œì£¼' && !['ë‚©í’ˆì™„ë£Œ'].includes(o.status));
                    if (!targetOrder) {
                        targetOrder = {
                            id: `mock-misc-${Date.now()}`, 
                            itemName: 'ê¸°íƒ€ ìì¬ ë°œì£¼',
                            clientName: 'ë‚´ë¶€',
                            status: 'ì‘ì—…ì¤‘',
                            orderDate: new Date().toISOString().split('T')[0],
                            deliveryDate: '',
                            materials: []
                        };
                    }
                }

                const finalSupplier = isCustomMode ? batchHeader.supplier : selectedSupplier;
                const isInfoRegistration = isCustomMode && validItems.length === 0;
                const newMaterials = [];

                if (isInfoRegistration) {
                    newMaterials.push({
                        id: Date.now(),
                        supplier: finalSupplier,
                        item: "ê±°ë˜ì²˜ ì •ë³´",
                        quantity: "-",
                        status: "ì •ë³´",
                        date: batchHeader.date,
                        supplierInfo: {
                            ...newSupplierInfo,
                            ...getMockCoordinates(newSupplierInfo.address)
                        }
                    });
                } else {
                    validItems.forEach((itemData, index) => {
                        const materialData = {
                            id: Date.now() + index, 
                            supplier: finalSupplier, 
                            item: itemData.item,
                            quantity: itemData.quantity, 
                            status: "ë°œì£¼", 
                            date: batchHeader.date
                        };
                        
                        if (isCustomMode && index === 0) {
                            materialData.supplierInfo = {
                                ...newSupplierInfo,
                                ...getMockCoordinates(newSupplierInfo.address)
                            };
                        }
                        newMaterials.push(materialData);
                    });
                }

                const updatedMaterials = [...(targetOrder.materials || []), ...newMaterials];
                await onUpdateOrder({ ...targetOrder, materials: updatedMaterials }, false);
                
                setQuickAdd(false);
                setBatchItems([{ id: Date.now(), item: '', quantity: '' }]);
                setNewSupplierInfo({ phone: '', email: '', address: '' });
                if(isCustomMode) setSelectedSupplier(null); 
                alert(isInfoRegistration ? "ê±°ë˜ì²˜ ì •ë³´ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!" : `${newMaterials.length}ê±´ì˜ ë°œì£¼ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            };

            // ê±°ë˜ì²˜ ì •ë³´ ìˆ˜ì • ì €ì¥
            const handleSaveInfo = async () => {
                if (!selectedSupplier) return;

                // í•´ë‹¹ ê±°ë˜ì²˜ì˜ 'ì •ë³´' í•­ëª© ì°¾ê¸° (ì—†ìœ¼ë©´ ì²«ë²ˆì§¸ í•­ëª©)
                // ì •í™•í•œ ìˆ˜ì • ëŒ€ìƒ(Order)ì„ ì°¾ê¸° ìœ„í•´ ì „ì²´ ìŠ¤ìº” í•„ìš”í•  ìˆ˜ ìˆìŒ
                let targetOrder = null;
                let targetMaterialId = null;

                // 1. í˜„ì¬ ê±°ë˜ì²˜ ëª©ë¡ì—ì„œ 'ì •ë³´' íƒ€ì…ì´ ìˆëŠ”ì§€ í™•ì¸
                const items = suppliers[selectedSupplier];
                const infoItem = items.find(m => m.status === 'ì •ë³´');

                if (infoItem) {
                    // ê¸°ì¡´ ì •ë³´ í•­ëª© ì—…ë°ì´íŠ¸
                    targetOrder = orders.find(o => o.id === infoItem.orderId);
                    targetMaterialId = infoItem.id;
                } else {
                    // ì •ë³´ í•­ëª©ì´ ì—†ìœ¼ë©´(ì˜ˆ: ì¼ë°˜ ë°œì£¼ë§Œ ìˆëŠ” ê²½ìš°), 'ê¸°íƒ€ ìì¬ ë°œì£¼'ì— ì •ë³´ í•­ëª©ì„ ìƒˆë¡œ ìƒì„±í•´ì•¼ í•¨
                    // í˜¹ì€ ê¸°ì¡´ ì•„ì´í…œ ì¤‘ í•˜ë‚˜ì— ì •ë³´ë¥¼ ë®ì–´ì”Œìš¸ ìˆ˜ë„ ìˆì§€ë§Œ, 'ì •ë³´' íƒ€ì… í•­ëª©ì„ ë§Œë“œëŠ” ê²Œ ê¹”ë”í•¨.
                    targetOrder = orders.find(o => o.itemName === 'ê¸°íƒ€ ìì¬ ë°œì£¼' && !['ë‚©í’ˆì™„ë£Œ'].includes(o.status));
                    if (!targetOrder) {
                         // ê¸°íƒ€ í”„ë¡œì íŠ¸ê°€ ì—†ìœ¼ë©´ ìƒì„±í•´ì•¼í•¨ (ê¸°ì¡´ ë¡œì§ í™œìš©)
                         // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ alert ì²˜ë¦¬í•˜ê³  ë„˜ì–´ê°€ê±°ë‚˜ ë¡œì§ ë³µì¡í•´ì§. 
                         // í¸ì˜ìƒ ê¸°ì¡´ ì•„ì´í…œ ì¤‘ ì²«ë²ˆì§¸ì— ì •ë³´ë¥¼ ë°•ê±°ë‚˜, ì•„ê¹Œ handleQuickAdd ì²˜ëŸ¼ ìƒˆ í•­ëª© ì¶”ê°€ ë¡œì§ íƒœì›€
                    }
                }

                // ì •ë³´ ì—…ë°ì´íŠ¸ ë¡œì§ ì‹¤í–‰
                if (targetOrder && targetMaterialId) {
                    const updatedMaterials = targetOrder.materials.map(m => 
                        m.id === targetMaterialId ? { 
                            ...m, 
                            supplierInfo: { ...editingInfoData, ...getMockCoordinates(editingInfoData.address) } 
                        } : m
                    );
                    await onUpdateOrder({ ...targetOrder, materials: updatedMaterials }, false);
                } else {
                    // íƒ€ê²Ÿì´ ì—†ìœ¼ë©´(ìˆœìˆ˜ Base Supplierê±°ë‚˜ ì •ë³´ í•­ëª© ì—†ìŒ), ìƒˆë¡œ ì •ë³´ í•­ëª© ì¶”ê°€
                    let miscOrder = orders.find(o => o.itemName === 'ê¸°íƒ€ ìì¬ ë°œì£¼' && !['ë‚©í’ˆì™„ë£Œ'].includes(o.status));
                    if(!miscOrder) {
                        miscOrder = {
                            id: `mock-misc-${Date.now()}`, 
                            itemName: 'ê¸°íƒ€ ìì¬ ë°œì£¼',
                            clientName: 'ë‚´ë¶€',
                            status: 'ì‘ì—…ì¤‘',
                            orderDate: new Date().toISOString().split('T')[0],
                            deliveryDate: '',
                            materials: []
                        };
                    }
                    
                    const newInfoItem = {
                        id: Date.now(),
                        supplier: selectedSupplier,
                        item: "ê±°ë˜ì²˜ ì •ë³´",
                        quantity: "-",
                        status: "ì •ë³´",
                        date: new Date().toISOString().split('T')[0],
                        supplierInfo: { ...editingInfoData, ...getMockCoordinates(editingInfoData.address) }
                    };
                    
                    await onUpdateOrder({ ...miscOrder, materials: [...(miscOrder.materials || []), newInfoItem] }, false);
                }

                setIsEditingInfo(false);
            };

            const cycleStatus = (currentStatus) => {
                if (currentStatus === 'ë°œì£¼') return 'íšŒìˆ˜ëŒ€ê¸°';
                if (currentStatus === 'íšŒìˆ˜ëŒ€ê¸°') return 'íšŒìˆ˜ì™„ë£Œ';
                return 'ë°œì£¼';
            };

            const toggleStatus = async (m) => {
                if (m.status === 'ì •ë³´') return;
                const order = orders.find(o => o.id === m.orderId);
                if (order) {
                    const nextStatus = cycleStatus(m.status);
                    const updated = order.materials.map(x => x.id === m.id ? { ...x, status: nextStatus } : x);
                    await onUpdateOrder({ ...order, materials: updated }, false);
                }
            };

            const handleDelete = async (m) => {
                if(!window.confirm(`${m.item} í•­ëª©ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                const order = orders.find(o => o.id === m.orderId);
                if(order) {
                    const updated = order.materials.filter(x => x.id !== m.id);
                    await onUpdateOrder({ ...order, materials: updated }, false);
                }
            };

            const handleEditSave = async () => {
                if (!editingMaterial) return;
                const order = orders.find(o => o.id === editingMaterial.orderId);
                if(order) {
                    const updated = order.materials.map(x => x.id === editingMaterial.id ? { ...x, ...editingMaterial } : x);
                    await onUpdateOrder({ ...order, materials: updated }, false);
                    setEditingMaterial(null);
                }
            };

            return (
                <>
                {/* ìˆ˜ì • ëª¨ë‹¬ (Portal ì ìš©) */}
                {editingMaterial && (
                    <ModalOverlay onClose={()=>setEditingMaterial(null)}>
                        <Card className="w-full max-w-sm p-4 shadow-xl border-indigo-200 bg-white" onClick={e=>e.stopPropagation()}>
                            <h3 className="font-bold text-lg mb-3 flex items-center gap-2"><Edit3 size={18}/> ìì¬ ìˆ˜ì •</h3>
                            <div className="space-y-3">
                                <div>
                                    <label className="text-xs text-gray-500 font-bold">ë°œì£¼ì¼</label>
                                    <input type="date" className="w-full border p-2 rounded text-sm" value={editingMaterial.date || ''} onChange={e => setEditingMaterial({...editingMaterial, date: e.target.value})}/>
                                </div>
                                <div>
                                    <label className="text-xs text-gray-500 font-bold">ê±°ë˜ì²˜</label>
                                    <input className="w-full border p-2 rounded text-sm" value={editingMaterial.supplier} onChange={e => setEditingMaterial({...editingMaterial, supplier: e.target.value})}/>
                                </div>
                                <div>
                                    <label className="text-xs text-gray-500 font-bold">í’ˆëª©</label>
                                    <input className="w-full border p-2 rounded text-sm" value={editingMaterial.item} onChange={e => setEditingMaterial({...editingMaterial, item: e.target.value})}/>
                                </div>
                                <div>
                                    <label className="text-xs text-gray-500 font-bold">ìˆ˜ëŸ‰</label>
                                    <input className="w-full border p-2 rounded text-sm" value={editingMaterial.quantity} onChange={e => setEditingMaterial({...editingMaterial, quantity: e.target.value})}/>
                                </div>
                                <div className="flex gap-2 mt-4">
                                    <button onClick={()=>setEditingMaterial(null)} className="flex-1 bg-gray-200 py-2 rounded text-sm font-bold">ì·¨ì†Œ</button>
                                    <button onClick={handleEditSave} className="flex-1 bg-indigo-600 text-white py-2 rounded text-sm font-bold">ì €ì¥</button>
                                </div>
                            </div>
                        </Card>
                    </ModalOverlay>
                )}

                <div className="flex h-full gap-4 animate-fade-in flex-col md:flex-row overflow-hidden relative">
                    <div className="w-full md:w-1/3 overflow-y-auto space-y-2 pr-0 md:pr-2 max-h-[200px] md:max-h-full flex-shrink-0 scroll-touch">
                        <div onClick={() => { setIsCustomMode(true); setSelectedSupplier(null); setBatchHeader(prev=>({...prev, supplier: ''})); }} className={`p-3 border rounded-lg cursor-pointer transition-all flex items-center gap-2 ${isCustomMode ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white hover:bg-slate-50'}`}>
                        <Plus size={16} />
                        <span className="font-bold">ì§ì ‘ ì…ë ¥ (ìƒˆ ê±°ë˜ì²˜)</span>
                        </div>
                        <div onClick={() => { setSelectedSupplier(null); setIsCustomMode(false); }} className={`p-3 border rounded-lg cursor-pointer transition-all flex items-center gap-2 ${!selectedSupplier && !isCustomMode ? 'bg-slate-800 text-white shadow-lg' : 'bg-white hover:bg-slate-50'}`}>
                            <FileText size={16} />
                            <span className="font-bold">ì „ì²´ ë³´ê¸°</span>
                        </div>
                        {sortedSuppliers.map(s => {
                        return (
                            <div key={s.name} onClick={() => { setSelectedSupplier(s.name); setIsCustomMode(false); }} className={`p-3 border rounded-lg cursor-pointer transition-all ${selectedSupplier === s.name && !isCustomMode ? 'bg-slate-800 text-white shadow-lg' : 'bg-white hover:bg-slate-50'}`}>
                            <div className="flex justify-between items-center mb-1">
                                <span className="font-bold">{s.name}</span>
                                {s.pickupCnt > 0 && <span className="bg-indigo-500 text-white text-[10px] px-1.5 py-0.5 rounded font-bold animate-pulse">íšŒìˆ˜ {s.pickupCnt}</span>}
                            </div>
                            <div className="text-xs opacity-70">ë°œì£¼ì¤‘ {s.activeCnt}ê±´ / ì´ {s.items.length}ê±´</div>
                            </div>
                        )
                        })}
                    </div>

                    <div className="w-full md:w-2/3 bg-white border rounded-xl p-4 md:p-6 flex flex-col overflow-hidden">
                        <div className="mb-4 pb-4 border-b flex-shrink-0">
                            <div className="flex justify-between items-start mb-2">
                            {isCustomMode ? (
                                <input className="text-2xl font-bold border-b border-gray-300 focus:border-indigo-500 outline-none placeholder-gray-300 w-full" placeholder="ê±°ë˜ì²˜ëª… ì…ë ¥" value={batchHeader.supplier} onChange={e => setBatchHeader({...batchHeader, supplier: e.target.value})}/>
                            ) : (
                                <h2 className="text-2xl font-bold truncate">{selectedSupplier || "ì „ì²´ ë°œì£¼ ë‚´ì—­"}</h2>
                            )}
                            <button onClick={() => setQuickAdd(!quickAdd)} className="bg-indigo-600 text-white px-3 py-1.5 rounded text-sm font-bold flex items-center gap-1 flex-shrink-0 ml-2"><Plus size={14} /> ìì¬ ë“±ë¡</button>
                            </div>
                            
                            {!isCustomMode && selectedSupplier && (
                                <div className="bg-slate-50 p-3 rounded">
                                    {!isEditingInfo ? (
                                        <div className="flex flex-wrap gap-4 text-xs md:text-sm text-gray-600 items-center">
                                            {currentSupplierInfo.phone ? <div className="flex items-center gap-1"><Phone size={14} /> {currentSupplierInfo.phone}</div> : <span className="text-gray-400">ì „í™”ë²ˆí˜¸ ì—†ìŒ</span>}
                                            {currentSupplierInfo.address ? <div className="flex items-center gap-1"><MapPin size={14} /> {currentSupplierInfo.address}</div> : <span className="text-gray-400">ì£¼ì†Œ ì—†ìŒ</span>}
                                            <button onClick={() => setIsEditingInfo(true)} className="ml-auto p-1 hover:bg-slate-200 rounded text-indigo-600">
                                                <Edit3 size={14}/>
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                                                <input placeholder="ì „í™”ë²ˆí˜¸" className="border p-2 rounded text-sm" value={editingInfoData.phone} onChange={e => setEditingInfoData({...editingInfoData, phone: e.target.value})}/>
                                                <input placeholder="ì´ë©”ì¼" className="border p-2 rounded text-sm" value={editingInfoData.email} onChange={e => setEditingInfoData({...editingInfoData, email: e.target.value})}/>
                                                <input placeholder="ì£¼ì†Œ" className="border p-2 rounded text-sm" value={editingInfoData.address} onChange={e => setEditingInfoData({...editingInfoData, address: e.target.value})}/>
                                            </div>
                                            <div className="flex justify-end gap-2">
                                                <button onClick={() => setIsEditingInfo(false)} className="text-xs text-gray-500 hover:underline">ì·¨ì†Œ</button>
                                                <button onClick={handleSaveInfo} className="text-xs bg-indigo-600 text-white px-3 py-1 rounded font-bold">ì €ì¥</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {isCustomMode && (
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-2 bg-slate-50 p-3 rounded mt-2">
                                    <input placeholder="ì „í™”ë²ˆí˜¸" className="border p-2 rounded text-sm" value={newSupplierInfo.phone} onChange={e => setNewSupplierInfo({...newSupplierInfo, phone: e.target.value})}/>
                                    <input placeholder="ì´ë©”ì¼" className="border p-2 rounded text-sm" value={newSupplierInfo.email} onChange={e => setNewSupplierInfo({...newSupplierInfo, email: e.target.value})}/>
                                    <input placeholder="ì£¼ì†Œ (íšŒìˆ˜ ë™ì„ ìš©)" className="border p-2 rounded text-sm" value={newSupplierInfo.address} onChange={e => setNewSupplierInfo({...newSupplierInfo, address: e.target.value})}/>
                                </div>
                            )}
                        </div>

                        {(quickAdd || isCustomMode) && (
                            <div className="mb-4 p-3 bg-indigo-50 rounded border border-indigo-100 animate-fade-in flex-shrink-0">
                            <div className="text-sm font-bold text-indigo-800 mb-2">ìƒˆ ìì¬ ë°œì£¼ / ê±°ë˜ì²˜ ë“±ë¡</div>
                            <div className="space-y-2 mb-3">
                                 {/* ê³µí†µ ì •ë³´ ì…ë ¥ */}
                                <div className="flex gap-2">
                                    <input type="date" className="border p-2 rounded text-sm w-1/3 min-w-[120px]" value={batchHeader.date} onChange={e => setBatchHeader({ ...batchHeader, date: e.target.value })} />
                                    <select className="border p-2 rounded flex-1 text-sm min-w-0" value={batchHeader.orderId} onChange={e => setBatchHeader({ ...batchHeader, orderId: e.target.value })}>
                                    <option value="">í”„ë¡œì íŠ¸ ì„ íƒ (ì—†ìœ¼ë©´ ê¸°íƒ€)</option>
                                    {orders.filter(o => !['ë‚©í’ˆì™„ë£Œ'].includes(o.status)).map(o => <option key={o.id} value={o.id}>{o.itemName}</option>)}
                                    </select>
                                </div>
                                
                                {/* ë‹¤ì¤‘ í’ˆëª© ì…ë ¥ ë¦¬ìŠ¤íŠ¸ */}
                                <div className="space-y-2">
                                    {batchItems.map((row, index) => (
                                        <div key={row.id} className="flex gap-2 items-center animate-fade-in">
                                            <span className="text-xs font-bold text-gray-400 w-4 text-center">{index + 1}</span>
                                            <input 
                                                placeholder={isCustomMode ? "í’ˆëª©ëª… (ì •ë³´ë§Œ ì €ì¥ì‹œ ë¹ˆì¹¸)" : "í’ˆëª©ëª…"} 
                                                className="border p-2 rounded flex-1 text-sm min-w-0" 
                                                value={row.item} 
                                                onChange={e => updateRow(row.id, 'item', e.target.value)} 
                                            />
                                            <input 
                                                placeholder="ìˆ˜ëŸ‰" 
                                                className="border p-2 rounded w-16 md:w-20 text-sm text-center" 
                                                value={row.quantity} 
                                                onChange={e => updateRow(row.id, 'quantity', e.target.value)} 
                                            />
                                            <button onClick={() => removeRow(row.id)} className="text-gray-400 hover:text-red-500">
                                                <X size={18} />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                                
                                <button onClick={addRow} className="text-xs text-indigo-600 font-bold flex items-center gap-1 hover:underline mt-1">
                                    <Plus size={14}/> í’ˆëª© ì¶”ê°€í•˜ê¸°
                                </button>
                            </div>
                            <button onClick={handleBatchAdd} className="w-full bg-indigo-600 text-white py-2 rounded text-sm font-bold hover:bg-indigo-700">
                                {isCustomMode && batchItems.every(i => !i.item) ? "ê±°ë˜ì²˜ ì •ë³´ë§Œ ë“±ë¡" : "ì¼ê´„ ë“±ë¡í•˜ê¸°"}
                            </button>
                            </div>
                        )}

                        <div className="flex-1 overflow-y-auto scroll-touch">
                            <table className="w-full text-sm text-left min-w-[300px]">
                            <thead className="bg-slate-50 border-b sticky top-0 z-10">
                                <tr>
                                    <th className="p-2 w-16">ìƒíƒœ</th>
                                    {!selectedSupplier && <th className="p-2 w-20">ê±°ë˜ì²˜</th>}
                                    <th className="p-2">í’ˆëª©/ìˆ˜ëŸ‰</th>
                                    <th className="p-2 text-right w-16">ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody>
                                {displayedMaterials.length > 0 ? displayedMaterials.map((m, i) => (
                                <tr key={i} className="border-b hover:bg-slate-50 group">
                                    <td className="p-2 align-top pt-3"><MaterialStatusBadge status={m.status} onClick={() => toggleStatus(m)} /></td>
                                    {!selectedSupplier && <td className="p-2 align-top pt-3 font-bold text-slate-700 text-xs break-words">{m.supplier}</td>}
                                    <td className="p-2">
                                        <div className="text-[10px] text-gray-400 mb-0.5">{m.date}</div>
                                        <div className="font-bold text-slate-700">{m.item}</div>
                                        <div className="text-xs text-gray-500">{m.quantity}</div>
                                        <div className="text-[10px] text-indigo-500 mt-0.5">{m.orderName}</div>
                                    </td>
                                    <td className="p-2 text-right align-top pt-2">
                                        <div className="flex justify-end gap-1 md:opacity-50 md:group-hover:opacity-100 transition-opacity opacity-100">
                                            <button onClick={()=>setEditingMaterial(m)} className="p-1.5 hover:bg-blue-100 text-blue-600 rounded"><Edit3 size={14}/></button>
                                            <button onClick={()=>handleDelete(m)} className="p-1.5 hover:bg-red-100 text-red-600 rounded"><Trash2 size={14}/></button>
                                        </div>
                                    </td>
                                </tr>
                                )) : (
                                <tr><td colSpan="5" className="p-8 text-center text-gray-400">ë“±ë¡ëœ ë°œì£¼ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                )}
                            </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                </>
            );
        };

        const CalendarView = ({ orders, onSelect }) => {
            const [date, setDate] = useState(new Date());
            const days = [];
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < firstDay; i++) days.push(null);
            for (let i = 1; i <= lastDate; i++) days.push(new Date(year, month, i));

            return (
                <div className="h-full flex flex-col animate-fade-in pb-10">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-bold">{year}ë…„ {month + 1}ì›”</h2>
                    <div className="flex gap-2">
                    <button onClick={() => setDate(new Date(year, month - 1, 1))} className="p-1 hover:bg-slate-200 rounded"><ChevronLeft /></button>
                    <button onClick={() => setDate(new Date())} className="text-sm border px-2 rounded hover:bg-slate-50">ì˜¤ëŠ˜</button>
                    <button onClick={() => setDate(new Date(year, month + 1, 1))} className="p-1 hover:bg-slate-200 rounded"><ChevronRight /></button>
                    </div>
                </div>
                <div className="flex-1 bg-white border rounded-xl overflow-hidden flex flex-col shadow-sm">
                    <div className="grid grid-cols-7 bg-slate-50 border-b text-center py-2 font-bold text-slate-600 text-sm">
                    <div className="text-red-500">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div className="text-blue-500">í† </div>
                    </div>
                    <div className="flex-1 grid grid-cols-7 grid-rows-5">
                    {days.map((d, i) => {
                        if (!d) return <div key={i} className="bg-slate-50 border-r border-b"></div>;
                        const dateStr = d.toISOString().split('T')[0];
                        
                        // ì™„ë£Œëœ ì‘ì—…ì€ ì‹¤ì œ ì™„ë£Œì¼(completedDate) ê¸°ì¤€, ë¯¸ì™„ë£ŒëŠ” ë‚©í’ˆì¼(deliveryDate) ê¸°ì¤€ í‘œì‹œ
                        const events = orders.filter(o => {
                            let targetDate = o.deliveryDate;
                            if (['ì‘ì—…ì™„ë£Œ', 'ë‚©í’ˆì™„ë£Œ'].includes(o.status) && o.completedDate) {
                                targetDate = o.completedDate;
                            }
                            return targetDate === dateStr;
                        });
                        
                        const isToday = dateStr === new Date().toISOString().split('T')[0];
                        return (
                        <div key={i} className={`border-r border-b p-1 bg-white min-h-[60px] flex flex-col ${isToday ? 'bg-blue-50' : ''}`}>
                            <div className={`text-xs font-bold mb-1 text-center ${isToday ? 'text-blue-600' : 'text-gray-500'}`}>{d.getDate()}</div>
                            <div className="space-y-1 overflow-y-auto flex-1 no-scrollbar">
                            {events.map(ev => {
                                const isDone = ['ì‘ì—…ì™„ë£Œ', 'ë‚©í’ˆì™„ë£Œ'].includes(ev.status);
                                return (
                                <div key={ev.id} onClick={() => onSelect(ev)} className={`text-[10px] p-1 truncate cursor-pointer rounded hover:opacity-80 ${isDone ? 'bg-slate-100 text-slate-500 border-l-2 border-slate-400 line-through' : 'bg-red-50 text-red-800 border-l-2 border-red-500'}`}>
                                {ev.itemName}
                                </div>
                            )})}
                            </div>
                        </div>
                        )
                    })}
                    </div>
                </div>
                </div>
            )
        };

        // --- Main App Component ---

        function App() {
            const [user, setUser] = useState(null);
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isOnline, setIsOnline] = useState(false);
            const [connectionError, setConnectionError] = useState(null);
            
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);

            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedOrder, setSelectedOrder] = useState(null);
            
            const [urgentCount, setUrgentCount] = useState(0);
            const [showAlertPopup, setShowAlertPopup] = useState(false);

            // Firebase Initialization
            const { auth, db, appId } = useMemo(() => {
                try {
                    const app = initializeApp(firebaseConfig);
                    return { 
                        auth: getAuth(app), 
                        db: getFirestore(app), 
                        appId: firebaseConfig.appId 
                    };
                } catch (e) { 
                    console.error("Firebase Init Error:", e);
                    return { auth: null, db: null, appId: null }; 
                }
            }, []);

            // Auth & Data Loading Logic
            useEffect(() => {
                let unsubAuth = null;
                let unsubData = null;

                const init = async () => {
                    if (!auth) {
                        setOrders(MOCK_DATA);
                        setLoading(false);
                        return;
                    }

                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Firebase Auth Failed:", error);
                        setConnectionError("ì¸ì¦ ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
                        setOrders(MOCK_DATA);
                        setLoading(false);
                        return;
                    }

                    unsubAuth = onAuthStateChanged(auth, (u) => {
                        setUser(u);
                        if (!u) {
                             setOrders(MOCK_DATA);
                             setLoading(false);
                        }
                    });
                };

                init();

                return () => {
                    if (unsubAuth) unsubAuth();
                    if (unsubData) unsubData();
                }
            }, [auth]);

            useEffect(() => {
                if (!user || !db) return;

                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderBy('createdAt', 'desc'));
                
                const unsub = onSnapshot(q, (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setOrders(data.length > 0 ? data : []); 
                    setIsOnline(true); 
                    setConnectionError(null);
                    setLoading(false);
                }, (err) => {
                    console.warn("Firestore Data Error:", err);
                    setIsOnline(false);
                    setConnectionError("ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ê¶Œí•œì´ ì—†ê±°ë‚˜ ì˜¤í”„ë¼ì¸ì…ë‹ˆë‹¤.");
                    setOrders(MOCK_DATA); 
                    setLoading(false); 
                });

                return () => unsub();
            }, [user, db, appId]);

            useEffect(() => {
                const urgent = orders.filter(o => {
                    if (!o.deliveryDate || ['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(o.status)) return false;
                    return Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2;
                }).length;
                setUrgentCount(urgent);
            }, [orders]);

            const handleLogin = (role) => {
                setIsAuthenticated(true);
                setIsAdmin(role === 'admin');
            };

            // ìˆ˜ì •: shouldNavigate íŒŒë¼ë¯¸í„° ì¶”ê°€ (ê¸°ë³¸ê°’ true)
            const saveOrder = async (data, shouldNavigate = true) => {
                if (!isOnline || !db) {
                    alert("í˜„ì¬ ì˜¤í”„ë¼ì¸ ìƒíƒœì´ê±°ë‚˜ ê¶Œí•œì´ ì—†ì–´ ì„ì‹œ ì €ì¥ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    if(data.id && !data.id.startsWith('mock')) setOrders(orders.map(o=>o.id===data.id?data:o));
                    else setOrders([...orders, {...data, id: `mock-new-${Date.now()}`, displayId: `ORD-TEMP`, createdAt: new Date().toISOString()}]);
                    
                    if(shouldNavigate) {
                        setCurrentView('list');
                        setSelectedOrder(null);
                    }
                    return;
                }
                try {
                    const col = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                    if (data.id && !data.id.startsWith('mock')) {
                        await updateDoc(doc(col, data.id), { ...data, updatedAt: serverTimestamp() });
                    } else {
                        const { id, ...rest } = data; 
                        const displayId = `ORD-24-${Math.floor(100 + Math.random() * 900)}`;
                        await addDoc(col, { ...rest, displayId, createdAt: serverTimestamp(), userId: user?.uid });
                    }
                    
                    if(shouldNavigate) {
                        setCurrentView('list');
                        setSelectedOrder(null);
                    }
                } catch (e) {
                    alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
                }
            };

            const deleteOrder = async (id) => {
                if (!db || id.startsWith('mock') || !isOnline) {
                    setOrders(orders.filter(o => o.id !== id));
                    setCurrentView('list'); 
                    return;
                }
                if(window.confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
                    setCurrentView('list');
                }
            };

            const stats = useMemo(() => {
                return {
                    ongoing: orders.filter(o => !['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(o.status)).length,
                    pickup: orders.reduce((acc, cur) => acc + (cur.materials || []).filter(m => m.status === 'íšŒìˆ˜ëŒ€ê¸°').length, 0),
                    urgent: orders.filter(o => o.deliveryDate && !['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(o.status) && Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2).length,
                    completed: orders.filter(o => ['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(o.status)).length
                };
            }, [orders]);

            const suppliers = useMemo(() => {
                const s = {};
                orders.forEach(o => (o.materials || []).forEach(m => {
                    if (!s[m.supplier]) s[m.supplier] = [];
                    s[m.supplier].push({ ...m, orderId: o.id, orderName: o.itemName });
                }));
                return s;
            }, [orders]);

            const handleNavigate = (order) => {
                setSelectedOrder(order);
                setCurrentView('detail');
                setShowAlertPopup(false);
            };

            if (!isAuthenticated) return <LoginView onLogin={handleLogin} />;
            
            if (loading) return (
                <div className="flex h-screen items-center justify-center bg-slate-100 flex-col gap-4">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-slate-800"></div>
                    <p className="text-slate-500 text-sm animate-pulse">ì‹œìŠ¤í…œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            );

            return (
                <div className="flex h-[100dvh] bg-slate-100 font-sans text-slate-800 overflow-hidden">
                    <div className="w-16 md:w-60 bg-slate-900 text-slate-300 flex flex-col flex-shrink-0 z-20">
                        <div className="p-4 flex items-center gap-3 justify-center md:justify-start font-bold text-xl text-white">
                            <div className="bg-white text-slate-900 rounded px-1 flex-shrink-0">BK</div>
                            <span className="hidden md:block text-sm whitespace-nowrap">ìˆ¨ì‰¬ëŠ” ê¹¡í†µ</span>
                        </div>
                        <nav className="flex-1 p-2 space-y-2">
                            {[
                                { id: 'dashboard', icon: LayoutDashboard, label: 'í˜„í™©' },
                                { id: 'calendar', icon: CalendarIcon, label: 'ì¼ì •' },
                                { id: 'list', icon: FileText, label: 'ì‘ì—…' },
                                { id: 'materials', icon: Truck, label: 'ë°œì£¼' },
                            ].map(m => (
                                <button key={m.id} onClick={() => { setCurrentView(m.id); setSelectedOrder(null); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded ${currentView === m.id ? 'bg-indigo-600 text-white' : 'hover:bg-slate-800'}`}>
                                    <m.icon size={20} /><span className="hidden md:block">{m.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 text-xs text-slate-500 text-center md:text-left">
                            <div className="font-bold text-slate-300 mb-1">{isAdmin ? 'ADMIN' : 'STAFF'}</div>
                            <div className={`flex items-center gap-1 justify-center md:justify-start ${isOnline ? 'text-green-500' : 'text-red-500'}`}>
                                <Wifi size={10}/> {isOnline ? 'Online' : 'Offline'}
                            </div>
                            {!isOnline && <div className="text-[10px] mt-1 text-red-400">{connectionError}</div>}
                        </div>
                    </div>

                    <main className="flex-1 flex flex-col overflow-hidden relative bg-slate-100 z-10">
                        <header className="h-14 md:h-16 bg-white border-b flex items-center justify-between px-4 md:px-6 shadow-sm flex-shrink-0 relative">
                            <h2 className="font-bold text-lg md:text-xl uppercase text-slate-800">
                                {currentView === 'dashboard' && 'í˜„í™©'}
                                {currentView === 'calendar' && 'ì¼ì •'}
                                {currentView === 'list' && 'ì‘ì—…'}
                                {currentView === 'materials' && 'ë°œì£¼'}
                                {currentView === 'detail' && 'ì‘ì—… ìƒì„¸'}
                                {currentView === 'form' && (selectedOrder ? 'ì‘ì—… ìˆ˜ì •' : 'ìƒˆ ì‘ì—… ë“±ë¡')}
                            </h2>
                            
                            <div className="relative">
                                <button onClick={()=>setShowAlertPopup(!showAlertPopup)} className="p-2 hover:bg-slate-100 rounded-full relative">
                                    <Bell className={urgentCount > 0 ? 'text-red-500' : 'text-gray-400'} />
                                    {urgentCount > 0 && <span className="absolute top-1 right-1 w-4 h-4 bg-red-600 text-white text-[10px] font-bold rounded-full flex items-center justify-center animate-pulse">{urgentCount}</span>}
                                </button>
                                {showAlertPopup && (
                                    <div className="absolute right-0 top-full mt-2 w-72 bg-white border rounded-xl shadow-xl p-3 z-50">
                                        <h4 className="font-bold text-sm mb-2 flex items-center gap-2 text-red-600"><AlertCircle size={16}/> ë§ˆê° ì„ë°• ({urgentCount})</h4>
                                        <div className="space-y-1 max-h-60 overflow-y-auto scroll-touch">
                                            {orders.filter(o => o.deliveryDate && !['ë‚©í’ˆì™„ë£Œ', 'ì‘ì—…ì™„ë£Œ'].includes(o.status) && Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2).map(o => (
                                                <div key={o.id} onClick={()=>handleNavigate(o)} className="text-xs p-2 hover:bg-slate-50 rounded cursor-pointer border-b last:border-0">
                                                    <div className="font-bold truncate">{o.itemName}</div>
                                                    <div className="text-gray-500 flex justify-between"><span>{o.displayId}</span><span>{o.deliveryDate} ë§ˆê°</span></div>
                                                </div>
                                            ))}
                                            {urgentCount === 0 && <div className="text-xs text-gray-400 text-center py-4">ì„ë°•í•œ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </header>

                        <div className="h-full overflow-y-auto p-4 md:p-6 scroll-touch">
                            <div className="max-w-5xl mx-auto">
                                {currentView === 'dashboard' && <Dashboard orders={orders} stats={stats} suppliers={suppliers} onNavigate={handleNavigate} isAdmin={isAdmin} currentUserId={user?.uid} />}
                                {currentView === 'calendar' && <CalendarView orders={orders} onSelect={handleNavigate} />}
                                {currentView === 'list' && !selectedOrder && <ListView orders={orders} onSelect={handleNavigate} onAdd={() => { setSelectedOrder(null); setCurrentView('form'); }} />}
                                {currentView === 'detail' && <DetailView order={selectedOrder} onBack={() => { setSelectedOrder(null); setCurrentView('list'); }} onUpdate={(data, view, navigate) => { if(view) setCurrentView(view); else saveOrder(data, navigate); }} isAdmin={isAdmin} currentUserId={user?.uid} />}
                                {currentView === 'form' && <FormView order={selectedOrder} onSave={(data) => saveOrder(data, true)} onDelete={deleteOrder} onCancel={() => { setSelectedOrder(null); setCurrentView('list'); }} isAdmin={isAdmin} currentUserId={user?.uid} />}
                                {currentView === 'materials' && <MaterialManageView suppliers={suppliers} orders={orders} onUpdateOrder={saveOrder} />}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
