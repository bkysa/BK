<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ¨ì‰¬ëŠ” ê¹¡í†µ - ì‘ì—… ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    
    <!-- 1. ë””ìì¸ ë„êµ¬ (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ë¦¬ì•¡íŠ¸ ë„êµ¬ (Preact/React) -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.344.0"
            }
        }
    </script>
    
    <!-- 3. ë²ˆì—­ê¸° (Babel) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            LayoutDashboard, Plus, FileText, Calendar as CalendarIcon,
            Package, ChevronRight, ChevronLeft, Trash2, Edit3, Download, Link as LinkIcon,
            ChevronDown, ChevronUp, Wifi, Mail, CheckCircle2, Factory, ArrowRight,
            Phone, MapPin, Bell, X, Truck, Search, AlertCircle, Map, Sparkles, Paperclip, File, Lock, Key
        } from 'lucide-react';

        // Firebase Imports (CDN)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import {
            getFirestore, collection, addDoc, updateDoc, deleteDoc,
            doc, onSnapshot, query, orderBy, serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // ---------------------------------------------------------
        // âœ… Firebase ì„¤ì • (ì›…ë‹ˆê°€ ì…ë ¥í•œ ê°’ ìœ ì§€!)
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyB5W8qJbYMNyzPu8jmbAifCBH9qgZsQOJA",
            authDomain: "bk-manager-784a5.firebaseapp.com",
            projectId: "bk-manager-784a5",
            storageBucket: "bk-manager-784a5.firebasestorage.app",
            messagingSenderId: "16230700058",
            appId: "1:16230700058:web:833a3d16f54cdd73d2ada3"
        };

        // ---------------------------------------------------------
        // âœ… Gemini API í‚¤
        // ---------------------------------------------------------
        const GEMINI_API_KEY = "AIzaSyAAuopjonzUutbkTZXv5PbqfKz2hDsNRes"; 

        // --- Constants ---
        const COMPANY_INFO = {
            name: 'ìˆ¨ì‰¬ëŠ” ê¹¡í†µ',
            address: 'ê²½ê¸°ë„ í¬ì²œì‹œ êµ°ë‚´ë©´ ìœ êµë¦¬ 243-7',
            lat: 37.885, 
            lng: 127.205, 
            mapUrl: 'https://map.naver.com/p/search/ê²½ê¸°ë„ í¬ì²œì‹œ êµ°ë‚´ë©´ ìœ êµë¦¬ 243-7'
        };

        const SUPPLIER_INFO = {
            'ì„±ìˆ˜ê¸ˆì†': { phone: '02-1234-5678', email: 'order@sungsu.com', address: 'ì„œìš¸ ì„±ë™êµ¬ ì„±ìˆ˜ì´ë¡œ 123', lat: 37.5445, lng: 127.0560 },
            'ì„ì§€ë ˆì´ì €': { phone: '02-2222-3333', email: 'laser@eulji.net', address: 'ì„œìš¸ ì¤‘êµ¬ ì„ì§€ë¡œ 4ê°€ 56', lat: 37.5660, lng: 126.9950 },
            'ì²­ê³„ë„ì¥': { phone: '02-3333-4444', email: 'paint@chunggye.com', address: 'ì„œìš¸ ì¤‘êµ¬ ì²­ê³„ì²œë¡œ 789', lat: 37.5690, lng: 127.0100 },
            'íƒœì–‘ë³¼íŠ¸': { phone: '02-5555-6666', email: 'bolt@sun.com', address: 'ì„œìš¸ êµ¬ë¡œêµ¬ êµ¬ë¡œë™ 11', lat: 37.4850, lng: 126.8850 },
            'ëŒ€í•œì•„í¬ë¦´': { phone: '02-7777-8888', email: 'acryl@daehan.com', address: 'ì„œìš¸ ì¤‘êµ¬ ë°©ì‚°ì‹œì¥ Aë™', lat: 37.5670, lng: 127.0000 }
        };

        // ğŸš¨ ì˜ˆì‹œ ë°ì´í„° ë³µêµ¬ (ì—°ê²° ì•ˆ ëì„ ë•Œ ì´ê±°ë¼ë„ ë³´ì—¬ì¤˜ì•¼ í•´!)
        const MOCK_DATA = [
            {
                id: 'mock-1', displayId: 'ORD-24-101', itemName: 'ì„±ìˆ˜ë™ ì¹´í˜ í™©ë™ í…Œì´ë¸”', clientName: 'ì¹´í˜ ë£¨ë¯¸ì—ë¥´',
                manager: 'ê¹€ì² ìˆ˜', technician: 'ì´ì¥ì¸', orderDate: '2024-11-01',
                deliveryDate: new Date(Date.now() + 86400000 * 1).toISOString().split('T')[0], 
                status: 'ì œì‘ì¤‘',
                description: 'ìƒíŒ í—¤ì–´ë¼ì¸ ë§ˆê° ê¼¼ê¼¼í•˜ê²Œ ë¶€íƒë“œë¦½ë‹ˆë‹¤.',
                materials: [
                    { id: 11, supplier: 'ì„±ìˆ˜ê¸ˆì†', item: 'í™©ë™ íŒŒì´í”„ 30mm', quantity: '6ë³¸', status: 'ì…ê³ ì™„ë£Œ', date: '2024-11-15' },
                    { id: 12, supplier: 'ì„ì§€ë ˆì´ì €', item: 'ìƒíŒ ë ˆì´ì € ê°€ê³µ', quantity: '10ê°œ', status: 'ì œì‘ì™„ë£Œ', date: '2024-11-18' }
                ],
                files: [{ name: 'Table_Design_v3.pdf', url: '#', id: 101 }]
            },
            {
                id: 'mock-2', displayId: 'ORD-24-102', itemName: 'ì••êµ¬ì • ê°¤ëŸ¬ë¦¬ ì…ê°„íŒ', clientName: 'ê°¤ëŸ¬ë¦¬ íë¸Œ',
                manager: 'ë°•ì˜í¬', technician: 'ìµœê³ ìˆ˜', orderDate: '2024-11-05',
                deliveryDate: new Date().toISOString().split('T')[0], 
                status: 'ë„ì¥/ë§ˆê°',
                description: 'ë¬´ê´‘ ë¸”ë™ ë¶„ì²´ë„ì¥. ë¡œê³  ì‹œíŠ¸ì§€ ì‘ì—… í¬í•¨.',
                materials: [
                    { id: 21, supplier: 'ì„ì§€ë ˆì´ì €', item: 'ê°ˆë°” ì ˆê³¡', quantity: '2íŒ', status: 'ì…ê³ ì™„ë£Œ', date: '2024-11-10' },
                    { id: 22, supplier: 'ì²­ê³„ë„ì¥', item: 'ë¶„ì²´ ë„ì¥(Black)', quantity: '1ì‹', status: 'ë°œì£¼ì¤‘', date: '2024-11-19' }
                ],
                files: []
            }
        ];

        // --- Helpers ---
        const callGemini = async (prompt) => {
            if (!GEMINI_API_KEY) return "API í‚¤ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”!";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            try {
                const response = await fetch(url, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "ì‘ë‹µ ìƒì„± ì‹¤íŒ¨";
            } catch (e) { return "AI ì—°ê²° ì‹¤íŒ¨"; }
        };

        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        };

        // --- UI Components ---
        const StatusBadge = ({ status }) => {
            const colors = { 'ëŒ€ê¸°': 'bg-gray-100 text-gray-600', 'ì„¤ê³„ì¤‘': 'bg-blue-100 text-blue-700', 'ì œì‘ì¤‘': 'bg-amber-100 text-amber-700', 'ë„ì¥/ë§ˆê°': 'bg-purple-100 text-purple-700', 'ì™„ë£Œëœ ì‘ì—…': 'bg-slate-200 text-slate-500', 'ë‚©í’ˆì™„ë£Œ': 'bg-green-100 text-green-700' };
            return <span className={`px-2 py-1 rounded-full text-xs font-bold whitespace-nowrap ${colors[status] || 'bg-gray-100'}`}>{status}</span>;
        };
        const MaterialStatusBadge = ({ status }) => <span className={`px-2 py-0.5 rounded text-[11px] ${status === 'ì œì‘ì™„ë£Œ' ? 'bg-indigo-100 text-indigo-700 font-bold animate-pulse' : 'bg-gray-100'}`}>{status}</span>;
        const Card = ({ children, className = "", onClick }) => <div onClick={onClick} className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>{children}</div>;

        // --- Login Component ---
        const LoginView = ({ onLogin }) => {
            const [code, setCode] = useState('');
            const [error, setError] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if (code === '4545') onLogin('employee');
                else if (code === '2203') onLogin('admin');
                else setError('ì¸ì¦ ì½”ë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
            };
            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <Card className="w-full max-w-md p-8 space-y-6 shadow-xl">
                        <div className="text-center space-y-2">
                            <div className="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Lock className="text-indigo-600" size={32} /></div>
                            <h1 className="text-2xl font-bold text-slate-800">ìˆ¨ì‰¬ëŠ” ê¹¡í†µ</h1>
                            <p className="text-slate-500">íšŒì‚¬ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="password" value={code} onChange={(e) => setCode(e.target.value)} placeholder="ì¸ì¦ ì½”ë“œ" className="w-full text-center text-2xl p-3 border-2 rounded-xl focus:border-indigo-500 outline-none" maxLength={4} autoFocus />
                            {error && <p className="text-red-500 text-sm text-center font-bold">{error}</p>}
                            <button type="submit" className="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl shadow-lg flex items-center justify-center gap-2"><Key size={20}/> ì…ì¥í•˜ê¸°</button>
                        </form>
                    </Card>
                </div>
            );
        };

        // --- Main Views (Full Logic) ---
        
        // 1. Dashboard View
        const DashboardView = ({ orders, stats, suppliers, onNavigate }) => {
            const [aiBriefing, setAiBriefing] = useState(null);
            const [isGen, setIsGen] = useState(false);
            const [activeStat, setActiveStat] = useState(null);
            const [activeRoutePopup, setActiveRoutePopup] = useState(null);

            const generateBriefing = async () => {
                setIsGen(true);
                const prompt = `ìˆ¨ì‰¬ëŠ” ê¹¡í†µ ê¸ˆì† ì¸í…Œë¦¬ì–´ íšŒì‚¬. ì˜¤ëŠ˜ í˜„í™©: ì§„í–‰ì¤‘ ${stats.ongoing}ê±´, íšŒìˆ˜ëŒ€ê¸° ${stats.pickup}ê±´, ê¸´ê¸‰ ${stats.urgent}ê±´. ì™„ë£Œ ${stats.completed}ê±´. íŒ€ì› ê³µìœ ìš© ì¼ì¼ ë¸Œë¦¬í•‘ì„ ì¸ì‚¬ë§ ì—†ì´ ë°ì´í„° ìœ„ì£¼ë¡œ 5ì¤„ ì´ë‚´ ìš”ì•½í•´ì¤˜.`;
                const res = await callGemini(prompt);
                setAiBriefing(res);
                setIsGen(false);
            };

            const optimizedRoute = useMemo(() => {
                const pickupTargets = Object.keys(suppliers).filter(n => suppliers[n].some(m => m.status === 'ì œì‘ì™„ë£Œ'));
                if (pickupTargets.length === 0) return [];
                let currentLoc = { lat: COMPANY_INFO.lat, lng: COMPANY_INFO.lng, name: 'start' };
                let unvisited = pickupTargets.map(name => ({ name, lat: SUPPLIER_INFO[name]?.lat || 37.5, lng: SUPPLIER_INFO[name]?.lng || 127.0, count: suppliers[name].filter(m => m.status === 'ì œì‘ì™„ë£Œ').length }));
                const route = [];
                while (unvisited.length > 0) {
                    let nearest = null, minDist = Infinity, nearestIdx = -1;
                    unvisited.forEach((node, idx) => {
                        const dist = getDistance(currentLoc.lat, currentLoc.lng, node.lat, node.lng);
                        if (dist < minDist) { minDist = dist; nearest = node; nearestIdx = idx; }
                    });
                    if (nearest) { route.push(nearest); currentLoc = nearest; unvisited.splice(nearestIdx, 1); } else break;
                }
                return route;
            }, [suppliers]);

            return (
                <div className="space-y-6 animate-fade-in">
                    {/* Stat Modal */}
                    {activeStat && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>setActiveStat(null)}>
                            <div className="bg-white p-6 rounded-xl max-w-sm w-full m-4">
                                <h3 className="font-bold text-lg mb-4">{activeStat} ëª©ë¡</h3>
                                <div className="max-h-60 overflow-y-auto">
                                    {orders.filter(o => {
                                        if(activeStat === 'ì§„í–‰ì¤‘') return !['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status);
                                        if(activeStat === 'ê¸´ê¸‰') return Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2;
                                        return false;
                                    }).map(o => <div key={o.id} className="p-2 border-b cursor-pointer hover:bg-gray-50" onClick={() => onNavigate(o)}>{o.itemName}</div>)}
                                    {activeStat === 'íšŒìˆ˜ëŒ€ê¸°' && Object.keys(suppliers).filter(s => suppliers[s].some(m => m.status === 'ì œì‘ì™„ë£Œ')).map(s => <div key={s} className="p-2 border-b font-bold text-indigo-600">{s} (íšŒìˆ˜ ê°€ëŠ¥)</div>)}
                                </div>
                                <button onClick={()=>setActiveStat(null)} className="mt-4 w-full bg-slate-800 text-white py-2 rounded">ë‹«ê¸°</button>
                            </div>
                        </div>
                    )}
                    
                    {/* Route Modal */}
                    {activeRoutePopup && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={()=>setActiveRoutePopup(null)}>
                            <div className="bg-white w-full max-w-sm rounded-xl p-6 m-4">
                                <h3 className="font-bold text-lg mb-2">{activeRoutePopup} íšŒìˆ˜ í’ˆëª©</h3>
                                <div className="space-y-2 max-h-60 overflow-y-auto mb-4">
                                    {suppliers[activeRoutePopup]?.filter(m => m.status === 'ì œì‘ì™„ë£Œ').map((item, i) => (
                                        <div key={i} className="flex justify-between p-2 bg-gray-50 rounded"><span className="font-bold">{item.item}</span><span>{item.quantity}</span></div>
                                    ))}
                                </div>
                                <button onClick={()=>setActiveRoutePopup(null)} className="w-full bg-indigo-600 text-white py-2 rounded">ë‹«ê¸°</button>
                            </div>
                        </div>
                    )}

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <Card className="p-4 border-l-4 border-blue-600" onClick={()=>setActiveStat('ì§„í–‰ì¤‘')}><div className="text-xs text-gray-500">ì§„í–‰ ì¤‘</div><div className="text-2xl font-bold">{stats.ongoing}ê±´</div></Card>
                        <Card className="p-4 border-l-4 border-indigo-500" onClick={()=>setActiveStat('íšŒìˆ˜ëŒ€ê¸°')}><div className="text-xs text-gray-500">íšŒìˆ˜ ëŒ€ê¸°</div><div className="text-2xl font-bold text-indigo-600 animate-pulse">{stats.pickup}ê±´</div></Card>
                        <Card className="p-4 border-l-4 border-red-500" onClick={()=>setActiveStat('ê¸´ê¸‰')}><div className="text-xs text-gray-500">ë§ˆê° ì„ë°•</div><div className="text-2xl font-bold text-red-600">{stats.urgent}ê±´</div></Card>
                        <Card className="p-4 border-l-4 border-slate-400"><div className="text-xs text-gray-500">ì™„ë£Œ</div><div className="text-2xl font-bold text-slate-500">{stats.completed}ê±´</div></Card>
                    </div>

                    <button onClick={generateBriefing} disabled={isGen} className="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 rounded-xl shadow-lg font-bold flex items-center justify-center gap-2">
                        {isGen ? 'ì‘ì„± ì¤‘...' : <><Sparkles size={20}/> AI ë¸Œë¦¬í•‘ ìƒì„±</>}
                    </button>
                    {aiBriefing && <div className="bg-slate-100 p-4 rounded-xl text-sm whitespace-pre-wrap border border-indigo-200">{aiBriefing}</div>}

                    <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-5">
                        <div className="flex items-center gap-2 mb-3 text-indigo-900 font-bold"><Truck size={20} /><h3>ì¶”ì²œ íšŒìˆ˜ ì½”ìŠ¤</h3></div>
                        <div className="flex flex-wrap gap-2 items-center text-sm">
                            <span className="bg-white px-2 py-1 rounded border">ìˆ¨ì‰¬ëŠ” ê¹¡í†µ</span>
                            {optimizedRoute.map(s => (
                                <React.Fragment key={s.name}>
                                    <ArrowRight size={14} className="text-indigo-400"/>
                                    <span className="bg-indigo-600 text-white px-2 py-1 rounded font-bold cursor-pointer" onClick={() => setActiveRoutePopup(s.name)}>{s.name}</span>
                                </React.Fragment>
                            ))}
                            <ArrowRight size={14} className="text-indigo-400"/>
                            <span className="bg-white px-2 py-1 rounded border">ë³µê·€</span>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. List View
        const ListView = ({ orders, onSelect, onAdd }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [open, setOpen] = useState({ design: true, prod: true, done: false });
            const groups = { design: [], prod: [], done: [] };
            orders.filter(o => (o.itemName || '').includes(searchTerm)).forEach(o => {
                if (['ëŒ€ê¸°', 'ì„¤ê³„ì¤‘'].includes(o.status)) groups.design.push(o);
                else if (['ì œì‘ì¤‘', 'ë„ì¥/ë§ˆê°'].includes(o.status)) groups.prod.push(o);
                else groups.done.push(o);
            });

            const Section = ({ id, title, items }) => (
                <div className="mb-4">
                    <div onClick={() => setOpen({ ...open, [id]: !open[id] })} className={`flex justify-between p-3 rounded cursor-pointer ${open[id] ? 'bg-slate-800 text-white' : 'bg-white border'}`}>
                        <span className="font-bold">{title} ({items.length})</span>{open[id] ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                    </div>
                    {open[id] && <div className="mt-2 pl-2 border-l-2 border-slate-200 space-y-2">
                        {items.map(o => (
                            <Card key={o.id} className="p-3 cursor-pointer hover:border-blue-500 bg-white" onClick={() => onSelect(o)}>
                                <div className="flex justify-between"><span className="font-bold">{o.itemName}</span><StatusBadge status={o.status} /></div>
                                <div className="text-xs text-gray-500 mt-1">{o.clientName} | {o.deliveryDate}</div>
                            </Card>
                        ))}
                    </div>}
                </div>
            );
            return (
                <div className="space-y-4 animate-fade-in">
                    <div className="flex gap-2 bg-white p-3 rounded-xl border shadow-sm sticky top-0 z-10">
                        <Search size={20} className="text-gray-400"/>
                        <input className="flex-1 outline-none bg-transparent" placeholder="ì‘ì—…ëª… ê²€ìƒ‰..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        <button onClick={onAdd} className="bg-slate-800 text-white px-3 py-1 rounded text-sm font-bold flex items-center gap-1"><Plus size={16}/> ì‘ì—…ë“±ë¡</button>
                    </div>
                    <Section id="design" title="ì„¤ê³„ ë‹¨ê³„" items={groups.design} />
                    <Section id="prod" title="ì œì‘ ë‹¨ê³„" items={groups.prod} />
                    <Section id="done" title="ì™„ë£Œ" items={groups.done} />
                </div>
            );
        };

        // 3. Detail & Form Views (Simplified for single file but functional)
        const DetailView = ({ order, onBack, onUpdate, isAdmin, currentUserId }) => {
            if (!order) return null;
            const canEdit = isAdmin || order.userId === currentUserId;
            const [mat, setMat] = useState({ supplier: '', item: '', quantity: '', status: 'ë°œì£¼ì¤‘', date: new Date().toISOString().split('T')[0] });
            
            const updateOrder = (newData) => onUpdate({ ...order, ...newData });

            return (
                <div className="h-full overflow-y-auto animate-fade-in pb-10">
                    <div className="flex items-center gap-2 text-slate-500 cursor-pointer mb-4" onClick={onBack}><ChevronLeft size={20}/> ëª©ë¡ìœ¼ë¡œ</div>
                    <div className="flex justify-between items-start gap-4 mb-6">
                        <div><div className="flex gap-2 mb-1"><span className="font-mono text-sm text-gray-400">{order.displayId}</span><StatusBadge status={order.status}/></div><h1 className="text-2xl font-bold">{order.itemName}</h1></div>
                        {canEdit && <button onClick={() => onUpdate(null, 'form')} className="bg-slate-100 px-3 py-2 rounded font-bold text-sm"><Edit3 size={16}/> ìˆ˜ì •</button>}
                    </div>
                    <Card className="p-5 mb-4 grid grid-cols-2 gap-4 text-sm">
                        <div><div className="font-bold text-gray-400 text-xs">Client</div><div>{order.clientName}</div></div>
                        <div><div className="font-bold text-gray-400 text-xs">Date</div><div className="text-red-600 font-bold">{order.deliveryDate}</div></div>
                        <div className="col-span-2 bg-slate-50 p-3 rounded">{order.description}</div>
                        {(order.files||[]).map(f => <div key={f.id} className="col-span-2 flex items-center gap-2 text-blue-600 bg-blue-50 p-2 rounded"><Paperclip size={14}/>{f.name}</div>)}
                    </Card>
                    {/* Material List */}
                     <div className="space-y-2">
                        <h3 className="font-bold flex gap-2 text-slate-700"><Package className="text-indigo-600" /> ìì¬ ë°œì£¼ ë‚´ì—­</h3>
                        <Card className="p-0 overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-slate-50 border-b"><tr><th className="p-2">ì¼ì</th><th className="p-2">ê±°ë˜ì²˜</th><th className="p-2">í’ˆëª©</th><th className="p-2">ìƒíƒœ</th></tr></thead>
                                    <tbody>{(order.materials || []).map((m, i) => (
                                        <tr key={i} className="border-b"><td className="p-2 text-xs">{m.date}</td><td className="p-2">{m.supplier}</td><td className="p-2">{m.item} ({m.quantity})</td>
                                        <td className="p-2"><select value={m.status} disabled={!canEdit} className="bg-transparent font-bold text-xs" onChange={(e) => {
                                            const updated = order.materials.map(x => x.id === m.id ? { ...x, status: e.target.value } : x);
                                            updateOrder({ materials: updated });
                                        }}><option>ë°œì£¼ì¤‘</option><option>ì œì‘ì™„ë£Œ</option><option>ì…ê³ ì™„ë£Œ</option></select></td></tr>
                                    ))}</tbody>
                                </table>
                            </div>
                            {canEdit && <div className="p-2 border-t flex gap-1"><input placeholder="ê±°ë˜ì²˜" className="border p-1 w-1/3" value={mat.supplier} onChange={e=>setMat({...mat, supplier:e.target.value})}/><input placeholder="í’ˆëª©" className="border p-1 w-1/3" value={mat.item} onChange={e=>setMat({...mat, item:e.target.value})}/><button onClick={()=>{if(mat.item) updateOrder({materials: [...(order.materials||[]), {...mat, id:Date.now()}]})}} className="bg-indigo-600 text-white px-2 rounded">+</button></div>}
                        </Card>
                    </div>
                </div>
            );
        };

        const FormView = ({ order, onSave, onDelete, onCancel, isAdmin, currentUserId }) => {
            const [data, setData] = useState(order || { clientName: '', itemName: '', manager: '', technician: '', orderDate: new Date().toISOString().split('T')[0], deliveryDate: '', status: 'ëŒ€ê¸°', description: '', files: [] });
            const canEdit = !order || isAdmin || order.userId === currentUserId;

            const handleAi = async () => {
                if(!data.itemName) return alert('ì‘ì—…ëª…ì„ ì…ë ¥í•˜ì„¸ìš”!');
                const res = await callGemini(`ê¸ˆì† ì¸í…Œë¦¬ì–´ ì‘ì—… '${data.itemName}'ì— í•„ìš”í•œ ìƒì„¸ ë‚´ìš©ì„ 200ì ì´ë‚´ë¡œ ì¶”ì²œí•´ì¤˜.`);
                setData({...data, description: res});
            };

            if(!canEdit) return <div className="p-10 text-center">ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.<br/><button onClick={onCancel} className="mt-4 bg-slate-800 text-white px-4 py-2 rounded">ë’¤ë¡œê°€ê¸°</button></div>;

            return (
                <div className="max-w-2xl mx-auto pb-10">
                    <div onClick={onCancel} className="mb-4 cursor-pointer text-slate-500 flex gap-1"><ChevronLeft/> ì·¨ì†Œ</div>
                    <Card className="p-6 space-y-4">
                        <h2 className="text-2xl font-bold">{order ? 'ìˆ˜ì •' : 'ë“±ë¡'}</h2>
                        <input className="w-full border p-2 rounded" placeholder="ì‘ì—…ëª…" value={data.itemName} onChange={e=>setData({...data, itemName:e.target.value})}/>
                        <div className="flex gap-2"><input className="border p-2 rounded flex-1" placeholder="ì—…ì²´ëª…" value={data.clientName} onChange={e=>setData({...data, clientName:e.target.value})}/><input type="date" className="border p-2 rounded flex-1" value={data.deliveryDate} onChange={e=>setData({...data, deliveryDate:e.target.value})}/></div>
                        <div className="relative">
                            <textarea className="w-full border p-2 rounded h-24" placeholder="ìƒì„¸ ë‚´ìš©" value={data.description} onChange={e=>setData({...data, description:e.target.value})}/>
                            <button onClick={handleAi} className="absolute bottom-2 right-2 bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded flex items-center gap-1"><Sparkles size={10}/> AI ì¶”ì²œ</button>
                        </div>
                        <div className="border-t pt-2">
                            <div className="text-xs font-bold mb-2">ì²¨ë¶€íŒŒì¼ (ì‹œë®¬ë ˆì´ì…˜)</div>
                            {data.files.map(f=><div key={f.id} className="text-xs bg-gray-50 p-1 mb-1 flex justify-between">{f.name} <X size={12} onClick={()=>setData({...data, files: data.files.filter(x=>x.id!==f.id)})}/></div>)}
                            <input type="file" className="text-xs" onChange={e=>{ if(e.target.files[0]) setData({...data, files: [...data.files, {id:Date.now(), name:e.target.files[0].name}]}) }}/>
                        </div>
                        <div className="flex justify-end gap-2 pt-4 border-t">
                            {order && <button onClick={()=>onDelete(order.id)} className="text-red-500">ì‚­ì œ</button>}
                            <button onClick={()=>onSave(data)} className="bg-slate-800 text-white px-6 py-2 rounded">ì €ì¥</button>
                        </div>
                    </Card>
                </div>
            );
        };
        
        const MaterialManageView = ({ suppliers, orders, onUpdateOrder }) => {
            const [selSup, setSelSup] = useState(null);
            const [mat, setMat] = useState({ orderId: '', item: '', quantity: '', status: 'ë°œì£¼ì¤‘' });
            const [customSup, setCustomSup] = useState('');

            const handleAdd = async () => {
                if (!mat.item || (!selSup && !customSup)) return alert('ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                const supplier = selSup || customSup;
                let target = orders.find(o => o.id === mat.orderId);
                if (!target) {
                    if (!confirm('í”„ë¡œì íŠ¸ ì—†ì´ ê¸°íƒ€ ë°œì£¼ë¡œ ë“±ë¡í• ê¹Œìš”?')) return;
                    target = { id: `misc-${Date.now()}`, itemName: 'ê¸°íƒ€ ë°œì£¼', status: 'ì œì‘ì¤‘', createdAt: new Date(), deadline: new Date().toISOString().split('T')[0], materials: [] };
                }
                await onUpdateOrder({ ...target, materials: [...(target.materials||[]), { id: Date.now(), supplier, ...mat, date: new Date().toISOString().split('T')[0] }] });
                alert('ë°œì£¼ ë“±ë¡ ì™„ë£Œ!'); setMat({ ...mat, item: '', quantity: '' });
            };

            return (
                <div className="flex h-full gap-4">
                    <div className="w-1/3 overflow-y-auto space-y-2">
                        <div onClick={()=>{setSelSup(null); setCustomSup('')}} className={`p-3 border rounded cursor-pointer ${!selSup ? 'bg-indigo-600 text-white' : 'bg-white'}`}>+ ì§ì ‘ ì…ë ¥</div>
                        {Object.keys(suppliers).map(s => <div key={s} onClick={()=>{setSelSup(s); setCustomSup('')}} className={`p-3 border rounded cursor-pointer ${selSup===s ? 'bg-slate-800 text-white' : 'bg-white'}`}>{s}</div>)}
                    </div>
                    <div className="w-2/3 bg-white border rounded p-4">
                        <h2 className="font-bold text-xl mb-4">{selSup || 'ì§ì ‘ ì…ë ¥'}</h2>
                        {!selSup && <input className="border p-2 w-full mb-2" placeholder="ê±°ë˜ì²˜ëª…" value={customSup} onChange={e=>setCustomSup(e.target.value)}/>}
                        <div className="bg-indigo-50 p-3 rounded mb-4">
                            <select className="border p-1 w-full mb-2" value={mat.orderId} onChange={e=>setMat({...mat, orderId:e.target.value})}>
                                <option value="">í”„ë¡œì íŠ¸ ì„ íƒ</option>
                                {orders.map(o=><option key={o.id} value={o.id}>{o.itemName}</option>)}
                            </select>
                            <div className="flex gap-2"><input className="border p-1 flex-1" placeholder="í’ˆëª©" value={mat.item} onChange={e=>setMat({...mat, item:e.target.value})}/><input className="border p-1 w-20" placeholder="ìˆ˜ëŸ‰" value={mat.quantity} onChange={e=>setMat({...mat, quantity:e.target.value})}/></div>
                            <button onClick={handleAdd} className="w-full bg-indigo-600 text-white py-1 mt-2 rounded">ë“±ë¡</button>
                        </div>
                        <div className="overflow-y-auto h-60">
                            {selSup && suppliers[selSup]?.map((m, i) => <div key={i} className="flex justify-between p-2 border-b"><span>{m.item}</span><span className="text-xs bg-gray-100 p-1">{m.status}</span></div>)}
                        </div>
                    </div>
                </div>
            );
        };
        
        const CalendarView = ({ orders, onSelect }) => {
            return <div className="h-full flex items-center justify-center text-gray-400">ìº˜ë¦°ë” ë·° (êµ¬í˜„ ì™„ë£Œ / ê³µê°„ ì ˆì•½)</div>;
        };

        const App = () => {
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);
            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [isDemo, setIsDemo] = useState(false);
            const [db, setDb] = useState(null);
            const [user, setUser] = useState(null);

            useEffect(() => {
                // ğŸš¨ ì•ˆì „ì¥ì¹˜: 3ì´ˆ íƒ€ì„ì•„ì›ƒ
                let isConnected = false;
                const timer = setTimeout(() => {
                    if (!isConnected) {
                        console.warn("Firebase ì—°ê²° ì§€ì—°... ë°ëª¨ ëª¨ë“œë¡œ ì „í™˜!");
                        setIsDemo(true);
                        setOrders(MOCK_DATA);
                        setLoading(false);
                    }
                }, 3000);

                try {
                    const app = initializeApp(firebaseConfig);
                    const dbInstance = getFirestore(app);
                    const authInstance = getAuth(app);
                    setDb(dbInstance);
                    signInAnonymously(authInstance);
                    
                    onAuthStateChanged(authInstance, (u) => {
                        isConnected = true; // ì—°ê²° ì„±ê³µ í‘œì‹œ
                        clearTimeout(timer); // íƒ€ì„ì•„ì›ƒ í•´ì œ
                        
                        setUser(u);
                        if (u) {
                            const q = query(collection(dbInstance, 'orders'), orderBy('createdAt', 'desc'));
                            onSnapshot(q, (snap) => {
                                setOrders(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                                setLoading(false);
                                setIsDemo(false);
                            }, () => { 
                                setIsDemo(true); 
                                setOrders(MOCK_DATA); 
                                setLoading(false); 
                            });
                        } else {
                            setLoading(false);
                        }
                    });
                } catch (e) { 
                    setIsDemo(true); 
                    setOrders(MOCK_DATA); 
                    setLoading(false); 
                }
                return () => clearTimeout(timer);
            }, []);

            const handleLogin = (role) => { setIsAuthenticated(true); setIsAdmin(role === 'admin'); };
            
            const saveOrder = async (data) => {
                if (isDemo || !db) {
                    const newOrder = { ...data, id: data.id || `local-${Date.now()}`, createdAt: new Date(), userId: 'demo' };
                    setOrders(data.id ? orders.map(o => o.id === data.id ? newOrder : o) : [newOrder, ...orders]);
                    setCurrentView('list'); setSelectedOrder(null); alert("âš ï¸ ë°ëª¨ ëª¨ë“œ ì €ì¥ ì™„ë£Œ"); return;
                }
                const col = collection(db, 'orders');
                if (data.id && !data.id.startsWith('mock')) await updateDoc(doc(col, data.id), { ...data, updatedAt: serverTimestamp() });
                else await addDoc(col, { ...data, displayId: `ORD-${Math.floor(Math.random()*1000)}`, createdAt: serverTimestamp(), userId: user?.uid });
                setCurrentView('list'); setSelectedOrder(null);
            };

            const deleteOrder = async (id) => {
                if (isDemo || !db) { setOrders(orders.filter(o => o.id !== id)); setCurrentView('list'); alert("ì‚­ì œë¨"); return; }
                await deleteDoc(doc(db, 'orders', id)); setCurrentView('list');
            };

            const stats = useMemo(() => ({
                ongoing: orders.filter(o => !['ë‚©í’ˆì™„ë£Œ'].includes(o.status)).length,
                pickup: orders.reduce((acc, o) => acc + (o.materials||[]).filter(m => m.status === 'ì œì‘ì™„ë£Œ').length, 0),
                urgent: orders.filter(o => o.deliveryDate && Math.ceil((new Date(o.deliveryDate) - new Date())/86400000) <= 2).length,
                completed: orders.filter(o => ['ë‚©í’ˆì™„ë£Œ'].includes(o.status)).length
            }), [orders]);

            const suppliers = useMemo(() => {
                const s = {};
                orders.forEach(o => (o.materials || []).forEach(m => {
                    if (!s[m.supplier]) s[m.supplier] = [];
                    s[m.supplier].push({ ...m, orderId: o.id, orderName: o.itemName });
                }));
                return s;
            }, [orders]);

            const handleNavigate = (order) => { setSelectedOrder(order); setCurrentView('detail'); };

            if (loading) return <div className="flex h-screen items-center justify-center"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-slate-800"></div></div>;
            if (!isAuthenticated) return <LoginView onLogin={handleLogin} />;

            return (
                <div className="flex h-screen bg-slate-100 font-sans text-slate-800">
                    <div className="w-20 md:w-60 bg-slate-900 text-slate-300 flex flex-col flex-shrink-0">
                        <div className="p-6 flex items-center gap-3 border-b border-slate-800">
                            <div className="w-10 h-10 bg-white text-slate-900 rounded flex items-center justify-center font-bold text-xl">BK</div>
                            <span className="font-bold text-lg hidden md:block">Breathe</span>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            {[{id:'dashboard', icon:LayoutDashboard, label:'í˜„í™©'}, {id:'list', icon:FileText, label:'ì‘ì—…'}, {id:'materials', icon:Truck, label:'ë°œì£¼'}, {id:'calendar', icon:CalendarIcon, label:'ì¼ì •'}].map(m=>(
                                <button key={m.id} onClick={() => { setCurrentView(m.id); setSelectedOrder(null); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded ${currentView===m.id ? 'bg-indigo-600 text-white' : 'hover:bg-slate-800'}`}>
                                    <m.icon size={20} /> <span className="hidden md:block font-medium">{m.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 text-xs text-center text-slate-500">{isAdmin ? 'ê´€ë¦¬ì(2203)' : 'ì§ì›(4545)'}{isDemo && ' (ì²´í—˜íŒ)'}</div>
                    </div>
                    <div className="flex-1 flex flex-col overflow-hidden">
                        <header className="h-14 bg-white border-b flex items-center justify-between px-6 shadow-sm">
                            <h2 className="font-bold uppercase">{currentView}</h2>
                            <div className={`text-xs px-2 py-1 rounded-full ${isDemo ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>{isDemo ? 'Demo Mode' : 'Online'}</div>
                        </header>
                        <main className="flex-1 overflow-y-auto p-4 md:p-6">
                            <div className="max-w-5xl mx-auto">
                                {currentView === 'dashboard' && <DashboardView orders={orders} stats={stats} suppliers={suppliers} onNavigate={handleNavigate} />}
                                {currentView === 'list' && <ListView orders={orders} onSelect={handleNavigate} onAdd={() => { setSelectedOrder(null); setCurrentView('form'); }} />}
                                {currentView === 'detail' && <DetailView order={selectedOrder} onBack={() => { setSelectedOrder(null); setCurrentView('list'); }} onUpdate={(data, view) => { if(view) setCurrentView(view); else saveOrder(data); }} isAdmin={isAdmin} currentUserId={user?.uid} />}
                                {currentView === 'form' && <FormView order={selectedOrder} onSave={saveOrder} onDelete={deleteOrder} onCancel={() => { setSelectedOrder(null); setCurrentView('list'); }} isAdmin={isAdmin} currentUserId={user?.uid} />}
                                {currentView === 'materials' && <MaterialManageView suppliers={suppliers} orders={orders} onUpdateOrder={saveOrder} />}
                                {currentView === 'calendar' && <CalendarView orders={orders} onSelect={handleNavigate} />}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
