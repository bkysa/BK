<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ¨ì‰¬ëŠ” ê¹¡í†µ - í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    
    <!-- 1. Tailwind CSS (ë””ìì¸) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. í°íŠ¸ (Pretendard) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body { font-family: 'Pretendard', sans-serif; }
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ ì²˜ë¦¬ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* ì• ë‹ˆë©”ì´ì…˜ */
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>

    <!-- 3. Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.330.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            LayoutDashboard, Plus, FileText, Calendar as CalendarIcon,
            Package, ChevronRight, ChevronLeft, Trash2, Edit3, Download, Link as LinkIcon,
            ChevronDown, ChevronUp, Wifi, Mail, CheckCircle2, Factory, ArrowRight,
            Phone, MapPin, Bell, X, Truck, Search, AlertCircle, Map, Sparkles, Paperclip, File, Lock, Key
        } from 'lucide-react';

        // --- Firebase Imports ---
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import {
            getFirestore, collection, addDoc, updateDoc, deleteDoc,
            doc, onSnapshot, query, orderBy, serverTimestamp
        } from 'firebase/firestore';

        // ---------------------------------------------------------
        // âœ… Firebase ì„¤ì •
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyB5W8qJbYMNyzPu8jmbAifCBH9qgZsQOJA",
            authDomain: "bk-manager-784a5.firebaseapp.com",
            projectId: "bk-manager-784a5",
            storageBucket: "bk-manager-784a5.firebasestorage.app",
            messagingSenderId: "16230700058",
            appId: "1:16230700058:web:833a3d16f54cdd73d2ada3",
            measurementId: "G-PMGKK5F8CP"
        };

        // ---------------------------------------------------------
        // âœ… Gemini API í‚¤
        // ---------------------------------------------------------
        const GEMINI_API_KEY = "AIzaSyAAuopjonzUutbkTZXv5PbqfKz2hDsNRes";

        // --- Gemini API Helper ---
        const callGemini = async (prompt) => {
            const apiKey = GEMINI_API_KEY; 
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            let retries = 0;
            const maxRetries = 3;
            const delays = [1000, 2000, 4000];

            while (retries <= maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "ì‘ë‹µì„ ìƒì„±í•˜ì§€ ëª»í–ˆì–´ìš”.";
                } catch (e) {
                    retries++;
                    if (retries > maxRetries) {
                        console.error("Gemini API failed:", e);
                        return "AI ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                    }
                    await new Promise(resolve => setTimeout(resolve, delays[retries - 1]));
                }
            }
        };

        // --- Constants & Mock Data ---
        const COMPANY_INFO = {
            name: 'ìˆ¨ì‰¬ëŠ” ê¹¡í†µ',
            address: 'ê²½ê¸°ë„ í¬ì²œì‹œ êµ°ë‚´ë©´ ìœ êµë¦¬ 243-7',
            lat: 37.885, 
            lng: 127.205, 
            mapUrl: 'https://map.naver.com/p/search/ê²½ê¸°ë„ í¬ì²œì‹œ êµ°ë‚´ë©´ ìœ êµë¦¬ 243-7'
        };

        const SUPPLIER_INFO = {
            'ì„±ìˆ˜ê¸ˆì†': { phone: '02-1234-5678', email: 'order@sungsu.com', address: 'ì„œìš¸ ì„±ë™êµ¬ ì„±ìˆ˜ì´ë¡œ 123', lat: 37.5445, lng: 127.0560 },
            'ì„ì§€ë ˆì´ì €': { phone: '02-2222-3333', email: 'laser@eulji.net', address: 'ì„œìš¸ ì¤‘êµ¬ ì„ì§€ë¡œ 4ê°€ 56', lat: 37.5660, lng: 126.9950 },
            'ì²­ê³„ë„ì¥': { phone: '02-3333-4444', email: 'paint@chunggye.com', address: 'ì„œìš¸ ì¤‘êµ¬ ì²­ê³„ì²œë¡œ 789', lat: 37.5690, lng: 127.0100 },
            'íƒœì–‘ë³¼íŠ¸': { phone: '02-5555-6666', email: 'bolt@sun.com', address: 'ì„œìš¸ êµ¬ë¡œêµ¬ êµ¬ë¡œë™ 11', lat: 37.4850, lng: 126.8850 },
            'ëŒ€í•œì•„í¬ë¦´': { phone: '02-7777-8888', email: 'acryl@daehan.com', address: 'ì„œìš¸ ì¤‘êµ¬ ë°©ì‚°ì‹œì¥ Aë™', lat: 37.5670, lng: 127.0000 }
        };

        const MOCK_DATA = [
            {
                id: 'mock-1',
                displayId: 'ORD-24-101',
                itemName: 'í…ŒìŠ¤íŠ¸ ì‘ì—… (ì˜¤í”„ë¼ì¸ ì˜ˆì‹œ)',
                clientName: 'í…ŒìŠ¤íŠ¸ ì—…ì²´',
                status: 'ì œì‘ì¤‘',
                deliveryDate: new Date().toISOString().split('T')[0],
                description: 'ì„œë²„ ì—°ê²°ì´ ì›í™œí•˜ì§€ ì•Šì•„ í‘œì‹œë˜ëŠ” ì˜ˆì‹œ ë°ì´í„°ì…ë‹ˆë‹¤.',
                materials: []
            }
        ]; 

        // --- Helper Function: Distance Calculation (Haversine) ---
        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        };

        // --- Helper Components ---
        const StatusBadge = ({ status }) => {
            const colors = {
                'ëŒ€ê¸°': 'bg-gray-100 text-gray-600',
                'ì„¤ê³„ì¤‘': 'bg-blue-100 text-blue-700',
                'ì œì‘ì¤‘': 'bg-amber-100 text-amber-700',
                'ë„ì¥/ë§ˆê°': 'bg-purple-100 text-purple-700',
                'ì™„ë£Œëœ ì‘ì—…': 'bg-slate-200 text-slate-500 font-medium',
                'ë‚©í’ˆì™„ë£Œ': 'bg-green-100 text-green-700',
            };
            return <span className={`flex-shrink-0 px-2 py-1 rounded-full text-xs font-bold whitespace-nowrap ${colors[status] || 'bg-gray-100'}`}>{status}</span>;
        };

        const MaterialStatusBadge = ({ status }) => {
            const colors = {
                'ë°œì£¼ì¤‘': 'bg-yellow-100 text-yellow-700',
                'ì œì‘ì™„ë£Œ': 'bg-indigo-100 text-indigo-700 font-bold animate-pulse',
                'ì…ê³ ì™„ë£Œ': 'bg-green-100 text-green-700',
            };
            return <span className={`flex-shrink-0 px-2 py-0.5 rounded text-[11px] whitespace-nowrap ${colors[status] || 'bg-gray-100'}`}>{status}</span>;
        };

        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>{children}</div>
        );

        const FileBox = ({size}) => <Package size={size}/>;

        // --- Login Gate Component ---
        const LoginView = ({ onLogin }) => {
            const [code, setCode] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (code === '4545') {
                    onLogin('employee');
                } else if (code === '2203') {
                    onLogin('admin');
                } else {
                    setError('ì¸ì¦ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì•„! ë‹¤ì‹œ í™•ì¸í•´ ì¤˜ ğŸ¥º');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <Card className="w-full max-w-md p-8 space-y-6 shadow-xl">
                        <div className="text-center space-y-2">
                            <div className="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Lock className="text-indigo-600" size={32} />
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800">ìˆ¨ì‰¬ëŠ” ê¹¡í†µ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
                            <p className="text-slate-500">íšŒì‚¬ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <input 
                                    type="password" 
                                    value={code}
                                    onChange={(e) => {setCode(e.target.value); setError('');}}
                                    placeholder="ì¸ì¦ ì½”ë“œ ì…ë ¥ (4ìë¦¬)"
                                    className="w-full text-center text-2xl tracking-widest p-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all"
                                    maxLength={4}
                                    autoFocus
                                />
                                {error && <p className="text-red-500 text-sm text-center mt-2 font-bold animate-pulse">{error}</p>}
                            </div>
                            <button 
                                type="submit"
                                className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2"
                            >
                                <Key size={20}/> ì…ì¥í•˜ê¸°
                            </button>
                        </form>
                    </Card>
                </div>
            );
        };

        // --- Components (Restored) ---

        const Dashboard = ({ orders, stats, suppliers, onNavigate, isAdmin, currentUserId }) => {
            const [activeStat, setActiveStat] = useState(null);
            const [activeRoutePopup, setActiveRoutePopup] = useState(null);
            const [aiBriefing, setAiBriefing] = useState(null);
            const [isGeneratingBriefing, setIsGeneratingBriefing] = useState(false);

            const generateBriefing = async () => {
                setIsGeneratingBriefing(true);
                const urgentTasks = orders.filter(o => {
                    if (!o.deliveryDate || ['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status)) return false;
                    return Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2;
                }).map(o => `${o.itemName}(${o.deliveryDate}ë§ˆê°)`).join(', ');

                const prompt = `
                    ë„ˆëŠ” ê¸ˆì† ì¸í…Œë¦¬ì–´ íšŒì‚¬ 'ìˆ¨ì‰¬ëŠ” ê¹¡í†µ'ì˜ ë°ì´í„° ë¶„ì„ê°€ì•¼.
                    ì˜¤ëŠ˜ì˜ ì‘ì—… í˜„í™©ì„ ë°”íƒ•ìœ¼ë¡œ íŒ€ì›ë“¤ì—ê²Œ ê³µìœ í•  'ì¼ì¼ ë¸Œë¦¬í•‘'ì„ ì‘ì„±í•´ ì¤˜.
                    [ë°ì´í„°] ì§„í–‰ì¤‘:${stats.ongoing}, íšŒìˆ˜ëŒ€ê¸°:${stats.pickup}, ê¸´ê¸‰:${stats.urgent} (${urgentTasks || 'ì—†ìŒ'}).
                    ê°„ê²°í•˜ê²Œ 5ì¤„ ì´ë‚´ ê°œì¡°ì‹ìœ¼ë¡œ ì‘ì„±í•´.
                `;

                const result = await callGemini(prompt);
                setAiBriefing(result);
                setIsGeneratingBriefing(false);
            };

            const optimizedRoute = useMemo(() => {
                const pickupTargets = Object.keys(suppliers).filter(n => 
                    suppliers[n].some(m => m.status === 'ì œì‘ì™„ë£Œ')
                );
                if (pickupTargets.length === 0) return [];

                let currentLoc = { lat: COMPANY_INFO.lat, lng: COMPANY_INFO.lng, name: 'start' };
                let unvisited = pickupTargets.map(name => ({
                    name,
                    lat: SUPPLIER_INFO[name]?.lat || 37.5, 
                    lng: SUPPLIER_INFO[name]?.lng || 127.0,
                    count: suppliers[name].filter(m => m.status === 'ì œì‘ì™„ë£Œ').length
                }));

                const route = [];
                while (unvisited.length > 0) {
                    let nearest = null;
                    let minDist = Infinity;
                    let nearestIdx = -1;
                    unvisited.forEach((node, idx) => {
                        const dist = getDistance(currentLoc.lat, currentLoc.lng, node.lat, node.lng);
                        if (dist < minDist) {
                            minDist = dist;
                            nearest = node;
                            nearestIdx = idx;
                        }
                    });
                    if (nearest) {
                        route.push(nearest);
                        currentLoc = nearest; 
                        unvisited.splice(nearestIdx, 1);
                    } else {
                        break;
                    }
                }
                return route;
            }, [suppliers]);

            const statList = useMemo(() => {
                if (!activeStat) return [];
                if (activeStat === 'pickup') {
                    const list = [];
                    orders.forEach(o => (o.materials || []).forEach(m => {
                        if (m.status === 'ì œì‘ì™„ë£Œ') {
                            list.push({ ...m, orderName: o.itemName, orderId: o.id, type: 'material' });
                        }
                    }));
                    return list;
                }
                return orders.filter(o => {
                    if (activeStat === 'ongoing') return !['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status);
                    if (activeStat === 'urgent') {
                        if (!o.deliveryDate || ['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status)) return false;
                        return Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2;
                    }
                    if (activeStat === 'completed') {
                        const isDone = ['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status);
                        const oneMonthAgo = new Date();
                        oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);
                        const delDate = new Date(o.deliveryDate);
                        return isDone && delDate >= oneMonthAgo;
                    }
                    return false;
                });
            }, [activeStat, orders]);

            return (
                <div className="space-y-6 animate-fade-in pb-10 relative">
                {/* Stats Grid */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <Card className="p-4 border-l-4 border-blue-600 cursor-pointer hover:bg-blue-50" onClick={()=>setActiveStat('ongoing')}>
                        <div className="text-xs text-gray-500">ì§„í–‰ ì¤‘</div>
                        <div className="text-2xl font-bold">{stats.ongoing}ê±´</div>
                    </Card>
                    <Card className="p-4 border-l-4 border-indigo-500 cursor-pointer hover:bg-indigo-50" onClick={()=>setActiveStat('pickup')}>
                        <div className="text-xs text-gray-500">íšŒìˆ˜ ëŒ€ê¸°</div>
                        <div className="text-2xl font-bold text-indigo-600 animate-pulse">{stats.pickup}ê±´</div>
                    </Card>
                    <Card className="p-4 border-l-4 border-red-500 cursor-pointer hover:bg-red-50" onClick={()=>setActiveStat('urgent')}>
                        <div className="text-xs text-gray-500">ë§ˆê° ì„ë°•</div>
                        <div className="text-2xl font-bold text-red-600">{stats.urgent}ê±´</div>
                    </Card>
                    <Card className="p-4 border-l-4 border-slate-400 cursor-pointer hover:bg-slate-100" onClick={()=>setActiveStat('completed')}>
                        <div className="text-xs text-gray-500">ìµœê·¼ ì™„ë£Œ</div>
                        <div className="text-2xl font-bold text-slate-500">{stats.completed}ê±´</div>
                    </Card>
                </div>

                {/* Stat Modal Overlay */}
                {activeStat && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 animate-fade-in" onClick={()=>setActiveStat(null)}>
                        <div className="bg-white w-full max-w-md rounded-xl shadow-2xl p-4 max-h-[80vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                            <div className="flex justify-between mb-4">
                                <h3 className="font-bold text-lg">ìƒì„¸ ë‚´ì—­ ({statList.length})</h3>
                                <button onClick={()=>setActiveStat(null)}><X size={20}/></button>
                            </div>
                            <div className="space-y-2">
                                {statList.length === 0 && <div className="text-gray-400">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                                {statList.map((item, i) => (
                                    <div key={i} className="border p-3 rounded hover:bg-slate-50 cursor-pointer" onClick={()=>{
                                        const order = activeStat === 'pickup' ? orders.find(o=>o.id===item.orderId) : item;
                                        if(order) { onNavigate(order); setActiveStat(null); }
                                    }}>
                                        <div className="font-bold">{activeStat==='pickup' ? item.item : item.itemName}</div>
                                        <div className="text-xs text-gray-500">{activeStat==='pickup' ? `${item.supplier} - ${item.quantity}` : item.status}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                )}

                {/* Briefing Modal */}
                {aiBriefing && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={()=>setAiBriefing(null)}>
                        <div className="bg-white w-full max-w-md rounded-xl p-6" onClick={e=>e.stopPropagation()}>
                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Sparkles className="text-yellow-500"/> AI ë¸Œë¦¬í•‘</h3>
                            <div className="bg-slate-50 p-4 rounded text-sm mb-4 whitespace-pre-wrap font-mono">{aiBriefing}</div>
                            <button onClick={()=>setAiBriefing(null)} className="w-full bg-slate-800 text-white py-2 rounded font-bold">ë‹«ê¸°</button>
                        </div>
                    </div>
                )}
                
                {/* Route Modal */}
                {activeRoutePopup && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={()=>setActiveRoutePopup(null)}>
                        <div className="bg-white w-full max-w-sm rounded-xl p-4" onClick={e=>e.stopPropagation()}>
                            <h3 className="font-bold text-lg mb-2">{activeRoutePopup}</h3>
                            <div className="text-sm text-gray-500 mb-4">{SUPPLIER_INFO[activeRoutePopup]?.address}</div>
                            <div className="space-y-2 mb-4">
                                {(suppliers[activeRoutePopup] || []).filter(m=>m.status==='ì œì‘ì™„ë£Œ').map((item, i)=>(
                                    <div key={i} className="bg-slate-50 p-2 rounded text-sm flex justify-between">
                                        <span>{item.item}</span><span className="font-bold">{item.quantity}</span>
                                    </div>
                                ))}
                            </div>
                            <a href={`https://map.naver.com/p/search/${SUPPLIER_INFO[activeRoutePopup]?.address}`} target="_blank" className="block w-full bg-indigo-600 text-white text-center py-3 rounded font-bold">ì§€ë„ ì—´ê¸°</a>
                        </div>
                    </div>
                )}

                <button onClick={generateBriefing} disabled={isGeneratingBriefing} className="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 rounded-xl shadow-lg font-bold flex items-center justify-center gap-2 hover:opacity-90">
                    {isGeneratingBriefing ? 'AIê°€ ì‘ì„±ì¤‘...' : <><Sparkles size={18}/> AI ì¼ì¼ ë¸Œë¦¬í•‘ ìƒì„±</>}
                </button>

                <div>
                    <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2"><FileText size={18}/> ìµœì‹  ì‘ì—…</h3>
                    <div className="grid gap-3">
                    {orders.filter(o => !['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status)).slice(0, 3).map(o => (
                        <Card key={o.id} className="p-4 flex justify-between items-center cursor-pointer hover:border-blue-400" onClick={() => onNavigate(o)}>
                            <div className="flex-1">
                                <div className="flex items-center gap-2 mb-1"><StatusBadge status={o.status} /><span className="text-xs text-gray-400">{o.displayId}</span></div>
                                <div className="font-bold">{o.itemName}</div>
                            </div>
                            <div className="text-sm font-bold text-red-500">{o.deliveryDate} ë§ˆê°</div>
                        </Card>
                    ))}
                    </div>
                </div>

                <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-5">
                    <div className="flex items-center gap-2 text-indigo-900 font-bold mb-3"><Truck size={20} /><h3>ìµœì  íšŒìˆ˜ ë™ì„ </h3></div>
                    {optimizedRoute.length > 0 ? (
                    <div className="flex flex-wrap gap-2 items-center">
                        <span className="text-xs bg-white px-2 py-1 rounded border">ì¶œë°œ</span>
                        {optimizedRoute.map((stop, i) => (
                            <React.Fragment key={i}>
                                <ArrowRight size={14} className="text-indigo-300" />
                                <button onClick={() => setActiveRoutePopup(stop.name)} className="bg-indigo-600 text-white px-3 py-2 rounded shadow text-sm font-bold hover:bg-indigo-700">
                                    {i+1}. {stop.name} <span className="bg-white/20 px-1 rounded text-[10px] ml-1">{stop.count}</span>
                                </button>
                            </React.Fragment>
                        ))}
                        <ArrowRight size={14} className="text-indigo-300" />
                        <span className="text-xs bg-white px-2 py-1 rounded border">ë³µê·€</span>
                    </div>
                    ) : <div className="text-sm text-indigo-400">íšŒìˆ˜í•  ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
                </div>
                </div>
            );
        };

        const ListView = ({ orders, onSelect, onAdd }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [open, setOpen] = useState({ design: true, prod: true, done: false });
            const groups = { design: [], prod: [], done: [] };
            
            orders.filter(o => (o.itemName || '').toLowerCase().includes(searchTerm.toLowerCase())).forEach(o => {
                if (['ëŒ€ê¸°', 'ì„¤ê³„ì¤‘'].includes(o.status)) groups.design.push(o);
                else if (['ì œì‘ì¤‘', 'ë„ì¥/ë§ˆê°'].includes(o.status)) groups.prod.push(o);
                else groups.done.push(o);
            });

            const Section = ({ id, title, items }) => (
                <div className="mb-4">
                <div onClick={() => setOpen({ ...open, [id]: !open[id] })} className={`flex justify-between p-3 rounded cursor-pointer transition-colors ${open[id] ? 'bg-slate-800 text-white' : 'bg-white border hover:bg-slate-50'}`}>
                    <span className="font-bold">{title} ({items.length})</span>{open[id] ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
                </div>
                {open[id] && <div className="mt-2 pl-2 border-l-2 border-slate-200 space-y-2">
                    {items.map(o => (
                    <Card key={o.id} className="p-3 cursor-pointer hover:border-blue-500 bg-white transition-colors" onClick={() => onSelect(o)}>
                        <div className="flex justify-between items-center mb-1">
                        <span className="font-bold truncate mr-2">{o.itemName}</span>
                        <StatusBadge status={o.status} />
                        </div>
                        <div className="text-xs text-gray-500 flex justify-between">
                        <span>{o.clientName}</span>
                        <span>{o.deliveryDate} ë‚©í’ˆ</span>
                        </div>
                    </Card>
                    ))}
                    {items.length === 0 && <div className="text-sm text-gray-400 p-2">í•­ëª© ì—†ìŒ</div>}
                </div>}
                </div>
            );

            return (
                <div className="space-y-4 animate-fade-in pb-10">
                <div className="flex gap-2 bg-white p-3 rounded-xl border shadow-sm sticky top-0 z-10">
                    <Search size={20} className="text-gray-400"/>
                    <input 
                    className="flex-1 outline-none bg-transparent min-w-0" 
                    placeholder="ì‘ì—…ëª… ê²€ìƒ‰..." 
                    value={searchTerm} 
                    onChange={e => setSearchTerm(e.target.value)} 
                    />
                    <button onClick={onAdd} className="bg-slate-800 text-white px-3 py-1 rounded text-sm font-bold flex items-center gap-1 flex-shrink-0">
                    <Plus size={16} /> <span className="hidden sm:inline">ì‘ì—…ë“±ë¡</span>
                    </button>
                </div>
                <Section id="design" title="ì„¤ê³„ ë‹¨ê³„" items={groups.design} />
                <Section id="prod" title="ì œì‘ ë‹¨ê³„" items={groups.prod} />
                <Section id="done" title="ì™„ë£Œ" items={groups.done} />
                </div>
            );
        };

        const DetailView = ({ order, onBack, onUpdate, isAdmin, currentUserId }) => {
            if (!order) return null;
            const canEdit = isAdmin || order.userId === currentUserId;
            const [mat, setMat] = useState({ supplier: '', item: '', quantity: '', status: 'ë°œì£¼ì¤‘', date: new Date().toISOString().split('T')[0] });
            const [link, setLink] = useState({ name: '', url: '' });
            const [showSuggestions, setShowSuggestions] = useState(false);
            const supplierOptions = Object.keys(SUPPLIER_INFO);
            const filteredSuppliers = supplierOptions.filter(s => s.includes(mat.supplier));

            const updateOrder = (newData) => {
                onUpdate({ ...order, ...newData });
            };

            return (
                <div className="h-full overflow-y-auto animate-fade-in pb-10" onClick={()=>setShowSuggestions(false)}>
                    <div className="flex items-center gap-2 text-slate-500 cursor-pointer mb-4" onClick={onBack}>
                        <ChevronLeft size={20}/> <span className="text-sm font-bold">ëª©ë¡</span>
                    </div>
                    <div className="flex justify-between items-start mb-6">
                        <div>
                            <div className="flex items-center gap-2 mb-2"><span className="text-gray-400 text-sm">{order.displayId}</span><StatusBadge status={order.status} /></div>
                            <h1 className="text-2xl font-bold">{order.itemName}</h1>
                        </div>
                        {canEdit && <button onClick={() => onUpdate(null, 'form')} className="bg-slate-100 px-3 py-2 rounded flex gap-2 text-sm font-bold"><Edit3 size={16} /> ìˆ˜ì •</button>}
                    </div>

                    <Card className="p-5 mb-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div><div className="text-gray-400 text-xs uppercase mb-1">Client</div><div className="font-bold">{order.clientName}</div><div className="text-gray-500">{order.clientContact}</div></div>
                        <div><div className="text-gray-400 text-xs uppercase mb-1">Delivery</div><div className="font-bold text-red-600">{order.deliveryDate}</div></div>
                        <div><div className="text-gray-400 text-xs uppercase mb-1">Memo</div><div className="text-slate-700 whitespace-pre-wrap">{order.description || '-'}</div></div>
                    </Card>

                    {/* Files Section (Compact) */}
                    <div className="bg-white p-4 rounded-xl border border-slate-200 flex flex-col mb-4">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="font-bold text-sm text-slate-700 flex gap-2"><FileBox size={16} /> ë„ë©´/íŒŒì¼</h3>
                            <span className="text-xs text-gray-400">{(order.files || []).length}ê°œ</span>
                        </div>
                        
                        <div className="flex-1 space-y-2 mb-3 max-h-[150px] overflow-y-auto">
                            {(order.files || []).length === 0 && <div className="text-center text-xs text-gray-400 py-2">ë“±ë¡ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                            {(order.files || []).map((f, i) => (
                            <div key={i} className="flex justify-between items-center p-2 bg-blue-50 rounded text-xs group">
                                <div className="flex items-center gap-2 truncate flex-1 min-w-0">
                                {f.name.endsWith('.pdf') ? <FileText size={12} className="text-red-500 flex-shrink-0"/> : <File size={12} className="text-blue-500 flex-shrink-0"/>}
                                <span className="truncate text-blue-800 font-medium">{f.name}</span>
                                </div>
                                <a href={f.url} target="_blank" rel="noreferrer" className="bg-white p-1 rounded text-blue-600 hover:bg-blue-100 flex-shrink-0 ml-2">
                                <Download size={12} />
                                </a>
                            </div>
                            ))}
                        </div>

                        {/* Compact Add Form */}
                        {canEdit && (
                        <div className="flex gap-1 border-t pt-2">
                            <input placeholder="íŒŒì¼ëª…" className="w-1/3 border p-1.5 rounded text-xs bg-gray-50" value={link.name} onChange={e => setLink({ ...link, name: e.target.value })} />
                            <input placeholder="URL" className="flex-1 border p-1.5 rounded text-xs bg-gray-50" value={link.url} onChange={e => setLink({ ...link, url: e.target.value })} />
                            <button onClick={() => {
                                if (!link.name || !link.url) return;
                                updateOrder({ files: [...(order.files || []), { ...link, id: Date.now() }] });
                                setLink({ name: '', url: '' });
                            }} className="bg-slate-700 text-white px-3 rounded text-xs font-bold hover:bg-slate-800">ë“±ë¡</button>
                        </div>
                        )}
                    </div>

                    <h3 className="font-bold mb-2 flex items-center gap-2"><Package size={18}/> ìì¬ ë°œì£¼ ë‚´ì—­</h3>
                    <Card className="p-0 overflow-hidden mb-10">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 border-b"><tr><th className="p-2">ê±°ë˜ì²˜</th><th className="p-2">í’ˆëª©</th><th className="p-2">ìƒíƒœ</th></tr></thead>
                            <tbody>
                                {(order.materials || []).map((m, i) => (
                                    <tr key={i} className="border-b">
                                        <td className="p-2 font-bold">{m.supplier}</td>
                                        <td className="p-2">{m.item} ({m.quantity})</td>
                                        <td className="p-2">
                                            <select 
                                                value={m.status} 
                                                className="bg-transparent font-bold cursor-pointer text-xs outline-none" 
                                                disabled={!canEdit}
                                                onChange={(e) => {
                                                const updated = order.materials.map(x => x.id === m.id ? { ...x, status: e.target.value } : x);
                                                updateOrder({ materials: updated });
                                                }}
                                            >
                                                <option>ë°œì£¼ì¤‘</option><option>ì œì‘ì™„ë£Œ</option><option>ì…ê³ ì™„ë£Œ</option>
                                            </select>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {canEdit && (
                            <div className="p-3 bg-slate-50 border-t">
                                <div className="text-xs font-bold text-slate-500 mb-2">ìì¬ ì¶”ê°€</div>
                                <div className="flex flex-col md:flex-row gap-2 mb-2 items-start">
                                    <div className="relative flex-1 min-w-0 w-full" onClick={e=>e.stopPropagation()}>
                                    <input 
                                        placeholder="ê±°ë˜ì²˜ (í´ë¦­í•˜ì—¬ ì„ íƒ)" 
                                        className="border p-2 rounded w-full text-sm" 
                                        value={mat.supplier} 
                                        onFocus={()=>setShowSuggestions(true)}
                                        onChange={e => {
                                        setMat({ ...mat, supplier: e.target.value });
                                        setShowSuggestions(true);
                                        }} 
                                    />
                                    {showSuggestions && filteredSuppliers.length > 0 && (
                                        <ul className="absolute z-50 left-0 top-full mt-1 w-full bg-white border rounded-md shadow-lg max-h-40 overflow-y-auto">
                                        {filteredSuppliers.map((s, idx) => (
                                            <li key={idx} className="p-2 text-sm hover:bg-indigo-50 cursor-pointer text-slate-700 border-b last:border-0" onClick={() => { setMat({ ...mat, supplier: s }); setShowSuggestions(false); }}>
                                            {s}
                                            </li>
                                        ))}
                                        </ul>
                                    )}
                                    </div>
                                    <input placeholder="í’ˆëª©ëª…" className="border p-2 rounded flex-1 text-sm min-w-0 w-full" value={mat.item} onChange={e => setMat({ ...mat, item: e.target.value })} />
                                    <input placeholder="ìˆ˜ëŸ‰" className="border p-2 rounded w-full md:w-20 text-sm" value={mat.quantity} onChange={e => setMat({ ...mat, quantity: e.target.value })} />
                                </div>
                                <button onClick={()=>{
                                    if(!mat.supplier || !mat.item) return;
                                    onUpdate({ materials: [...(order.materials||[]), {...mat, id:Date.now()}] });
                                    setMat({...mat, supplier:'', item:'', quantity:''});
                                    setShowSuggestions(false);
                                }} className="bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold w-full">ì¶”ê°€</button>
                            </div>
                        )}
                    </Card>
                </div>
            );
        };

        const FormView = ({ order, onSave, onDelete, onCancel, isAdmin, currentUserId }) => {
            const [data, setData] = useState(order || {
                clientName: '', itemName: '', manager: '', technician: '',
                orderDate: new Date().toISOString().split('T')[0], 
                deliveryDate: '', status: 'ëŒ€ê¸°', description: '', clientContact: '', files: []
            });
            const [isAiSuggesting, setIsAiSuggesting] = useState(false);
            const fileInputRef = useRef(null);

            const canEdit = !order || isAdmin || order.userId === currentUserId;

            const handleAiSuggest = async () => {
                if (!data.itemName) return alert('ì‘ì—…ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
                setIsAiSuggesting(true);
                const prompt = `ê¸ˆì† íšŒì‚¬ ì‘ì—…ëª… '${data.itemName}'ì— í•„ìš”í•œ ìƒì„¸ ë‚´ìš©ì„ 200ì ì´ë‚´ë¡œ ì¶”ì²œí•´ ì¤˜.`;
                const suggestion = await callGemini(prompt);
                setData(prev => ({ ...prev, description: suggestion }));
                setIsAiSuggesting(false);
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                const mockFile = { id: Date.now(), name: file.name, url: '#' };
                setData(prev => ({ ...prev, files: [...(prev.files || []), mockFile] }));
                }
            };

            const removeFile = (fileId) => {
                setData(prev => ({ ...prev, files: prev.files.filter(f => f.id !== fileId) }));
            };

            if (!canEdit) return <div className="p-10 text-center">ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.<button onClick={onCancel} className="block mx-auto mt-4 bg-gray-200 px-4 py-2 rounded">ëŒì•„ê°€ê¸°</button></div>;

            return (
                <div className="max-w-2xl mx-auto animate-fade-in pb-10">
                    <div onClick={onCancel} className="mb-4 cursor-pointer text-slate-500 font-bold">ì·¨ì†Œ</div>
                    <Card className="p-6 space-y-4">
                        <h2 className="text-2xl font-bold">{order ? 'ìˆ˜ì •' : 'ìƒˆ ì‘ì—… ë“±ë¡'}</h2>
                        <div className="grid gap-4">
                            <input className="border p-2 rounded w-full" placeholder="ì‘ì—…ëª…" value={data.itemName} onChange={e=>setData({...data, itemName:e.target.value})}/>
                            <div className="grid grid-cols-2 gap-2">
                                <input className="border p-2 rounded" placeholder="ì—…ì²´ëª…" value={data.clientName} onChange={e=>setData({...data, clientName:e.target.value})}/>
                                <input className="border p-2 rounded" placeholder="ì—°ë½ì²˜" value={data.clientContact} onChange={e=>setData({...data, clientContact:e.target.value})}/>
                            </div>
                            <input type="date" className="border p-2 rounded w-full" value={data.deliveryDate} onChange={e=>setData({...data, deliveryDate:e.target.value})}/>
                            <select className="border p-2 rounded w-full" value={data.status} onChange={e=>setData({...data, status:e.target.value})}>
                                <option>ëŒ€ê¸°</option><option>ì„¤ê³„ì¤‘</option><option>ì œì‘ì¤‘</option><option>ë„ì¥/ë§ˆê°</option><option>ì™„ë£Œëœ ì‘ì—…</option><option>ë‚©í’ˆì™„ë£Œ</option>
                            </select>
                            <div>
                                <div className="flex justify-between mb-1">
                                    <label className="text-xs font-bold">ë©”ëª¨</label>
                                    <button onClick={handleAiSuggest} className="text-xs text-indigo-600 font-bold">{isAiSuggesting ? 'ìƒì„±ì¤‘...' : 'AI ì¶”ì²œ'}</button>
                                </div>
                                <textarea className="border p-2 rounded w-full h-24" value={data.description} onChange={e=>setData({...data, description:e.target.value})}/>
                            </div>

                            {/* File Attachment Section */}
                            <div className="border-t pt-4 mt-2">
                                <label className="text-xs font-bold text-gray-500 mb-2 block">ë„ë©´ / íŒŒì¼ ì²¨ë¶€</label>
                                <div className="space-y-2">
                                {(data.files || []).map(f => (
                                    <div key={f.id} className="flex justify-between items-center p-2 bg-slate-50 rounded border text-sm">
                                    <div className="flex items-center gap-2 truncate">
                                        <Paperclip size={14} className="text-gray-400"/>
                                        <span className="truncate">{f.name}</span>
                                    </div>
                                    <button onClick={() => removeFile(f.id)} className="text-red-500 hover:text-red-700"><X size={14}/></button>
                                    </div>
                                ))}
                                </div>
                                <div className="mt-2 flex items-center gap-2">
                                <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileChange} />
                                <button onClick={() => fileInputRef.current.click()} className="text-sm bg-gray-100 border border-gray-300 px-3 py-1.5 rounded flex items-center gap-2 hover:bg-gray-200">
                                    <Plus size={14}/> íŒŒì¼ ì¶”ê°€
                                </button>
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-end gap-2 pt-4 border-t">
                            {order && <button onClick={()=>onDelete(order.id)} className="text-red-500 text-sm font-bold px-4">ì‚­ì œ</button>}
                            <button onClick={()=>onSave(data)} className="bg-slate-800 text-white px-6 py-2 rounded font-bold">ì €ì¥</button>
                        </div>
                    </Card>
                </div>
            );
        };

        // --- Missing Components Restored: MaterialManageView, CalendarView ---

        const MaterialManageView = ({ suppliers, orders, onUpdateOrder }) => {
            const [selectedSupplier, setSelectedSupplier] = useState(null);
            const [isCustomMode, setIsCustomMode] = useState(false);
            const info = SUPPLIER_INFO[selectedSupplier];
            const [quickAdd, setQuickAdd] = useState(false);
            const [newMat, setNewMat] = useState({ orderId: '', item: '', quantity: '', status: 'ë°œì£¼ì¤‘', supplier: '' });

            useEffect(() => { 
                if (selectedSupplier && !isCustomMode) {
                setNewMat(prev => ({ ...prev, supplier: selectedSupplier }));
                }
            }, [selectedSupplier, isCustomMode]);

            const handleQuickAdd = async () => {
                if(!newMat.item) return alert("í’ˆëª©ì„ ì…ë ¥í•˜ì„¸ìš”");
                
                let targetOrder = orders.find(o => o.id === newMat.orderId);
                
                if (!targetOrder && !newMat.orderId) {
                if(window.confirm("ì„ íƒëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. 'ê¸°íƒ€ ë°œì£¼' í•­ëª©ìœ¼ë¡œ ìƒˆë¡œ ë§Œë“¤ê¹Œìš”?")) {
                    const miscTask = {
                        id: `misc-${Date.now()}`,
                        itemName: 'ê¸°íƒ€ ìì¬ ë°œì£¼',
                        clientName: 'ë‚´ë¶€',
                        status: 'ì œì‘ì¤‘',
                        createdAt: new Date(), 
                        deadline: new Date().toISOString().split('T')[0],
                        materials: []
                    };
                    targetOrder = miscTask;
                } else {
                    return;
                }
                }

                const finalSupplier = isCustomMode ? newMat.supplier : selectedSupplier;
                if(!finalSupplier) return alert("ê±°ë˜ì²˜ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”.");

                const materialData = {
                id: Date.now(), 
                supplier: finalSupplier, 
                item: newMat.item,
                quantity: newMat.quantity, 
                status: 'ë°œì£¼ì¤‘', 
                date: new Date().toISOString().split('T')[0]
                };

                const updatedMaterials = [...(targetOrder.materials || []), materialData];
                await onUpdateOrder({ ...targetOrder, materials: updatedMaterials });
                
                setQuickAdd(false);
                setNewMat({ ...newMat, item: '', quantity: '' });
                alert("ë°œì£¼ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            };

            return (
                <div className="flex h-full gap-4 animate-fade-in flex-col md:flex-row overflow-hidden">
                <div className="w-full md:w-1/3 overflow-y-auto space-y-2 pr-0 md:pr-2 max-h-[200px] md:max-h-full flex-shrink-0">
                    <div onClick={() => { setIsCustomMode(true); setSelectedSupplier(null); setNewMat(prev=>({...prev, supplier: ''})); }} className={`p-3 border rounded-lg cursor-pointer transition-all flex items-center gap-2 ${isCustomMode ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white hover:bg-slate-50'}`}>
                    <Plus size={16} />
                    <span className="font-bold">ì§ì ‘ ì…ë ¥ (ìƒˆ ê±°ë˜ì²˜)</span>
                    </div>
                    {Object.keys(suppliers).map(s => {
                    const items = suppliers[s];
                    const pickupCnt = items.filter(m => m.status === 'ì œì‘ì™„ë£Œ').length;
                    const activeCnt = items.filter(m => m.status === 'ë°œì£¼ì¤‘').length;
                    return (
                        <div key={s} onClick={() => { setSelectedSupplier(s); setIsCustomMode(false); }} className={`p-3 border rounded-lg cursor-pointer transition-all ${selectedSupplier === s && !isCustomMode ? 'bg-slate-800 text-white shadow-lg' : 'bg-white hover:bg-slate-50'}`}>
                        <div className="flex justify-between items-center mb-1">
                            <span className="font-bold">{s}</span>
                            {pickupCnt > 0 && <span className="bg-indigo-500 text-white text-[10px] px-1.5 py-0.5 rounded font-bold animate-pulse">íšŒìˆ˜ {pickupCnt}</span>}
                        </div>
                        <div className="text-xs opacity-70">ì‘ì—…ì¤‘ {activeCnt}ê±´ / ì´ {items.length}ê±´</div>
                        </div>
                    )
                    })}
                </div>

                <div className="w-full md:w-2/3 bg-white border rounded-xl p-4 md:p-6 flex flex-col overflow-hidden">
                    {selectedSupplier || isCustomMode ? <>
                    <div className="mb-4 pb-4 border-b flex-shrink-0">
                        <div className="flex justify-between items-start mb-2">
                        {isCustomMode ? (
                            <input className="text-2xl font-bold border-b border-gray-300 focus:border-indigo-500 outline-none placeholder-gray-300" placeholder="ê±°ë˜ì²˜ëª… ì…ë ¥" value={newMat.supplier} onChange={e => setNewMat({...newMat, supplier: e.target.value})}/>
                        ) : (
                            <h2 className="text-2xl font-bold truncate">{selectedSupplier}</h2>
                        )}
                        <button onClick={() => setQuickAdd(!quickAdd)} className="bg-indigo-600 text-white px-3 py-1.5 rounded text-sm font-bold flex items-center gap-1 flex-shrink-0"><Plus size={14} /> ìì¬ ë“±ë¡</button>
                        </div>
                        {!isCustomMode && info ? (
                        <div className="flex flex-wrap gap-4 text-xs md:text-sm text-gray-600 bg-slate-50 p-3 rounded">
                            <div className="flex items-center gap-1"><Phone size={14} /> {info.phone}</div>
                            <div className="flex items-center gap-1"><MapPin size={14} /> {info.address}</div>
                        </div>
                        ) : !isCustomMode ? <div className="text-sm text-gray-400">ì—°ë½ì²˜ ì •ë³´ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div> : null}
                    </div>

                    {(quickAdd || isCustomMode) && (
                        <div className="mb-4 p-3 bg-indigo-50 rounded border border-indigo-100 animate-fade-in flex-shrink-0">
                        <div className="text-sm font-bold text-indigo-800 mb-2">ìƒˆ ìì¬ ë°œì£¼ ì¶”ê°€</div>
                        <div className="flex flex-col md:flex-row gap-2 mb-2">
                            <select className="border p-2 rounded flex-1 text-sm min-w-0" value={newMat.orderId} onChange={e => setNewMat({ ...newMat, orderId: e.target.value })}>
                            <option value="">í”„ë¡œì íŠ¸ ì„ íƒ (ì—†ìœ¼ë©´ ê¸°íƒ€)</option>
                            {orders.filter(o => !['ë‚©í’ˆì™„ë£Œ'].includes(o.status)).map(o => <option key={o.id} value={o.id}>{o.itemName}</option>)}
                            </select>
                            <input placeholder="í’ˆëª©ëª…" className="border p-2 rounded flex-1 text-sm min-w-0" value={newMat.item} onChange={e => setNewMat({ ...newMat, item: e.target.value })} />
                            <input placeholder="ìˆ˜ëŸ‰" className="border p-2 rounded w-full md:w-20 text-sm" value={newMat.quantity} onChange={e => setNewMat({ ...newMat, quantity: e.target.value })} />
                        </div>
                        <button onClick={handleQuickAdd} className="w-full bg-indigo-600 text-white py-2 rounded text-sm font-bold hover:bg-indigo-700">ë“±ë¡í•˜ê¸°</button>
                        </div>
                    )}

                    <div className="flex-1 overflow-y-auto">
                        <table className="w-full text-sm text-left min-w-[300px]">
                        <thead className="bg-slate-50 border-b sticky top-0 z-10"><tr><th className="p-2">ìƒíƒœ</th><th className="p-2">í’ˆëª©/ìˆ˜ëŸ‰</th><th className="p-2 hidden md:table-cell">ê´€ë ¨ í”„ë¡œì íŠ¸</th><th className="p-2 text-right">ê´€ë¦¬</th></tr></thead>
                        <tbody>
                            {(!isCustomMode && suppliers[selectedSupplier]) ? suppliers[selectedSupplier].map((m, i) => (
                            <tr key={i} className="border-b hover:bg-slate-50">
                            <td className="p-2"><MaterialStatusBadge status={m.status} /></td>
                            <td className="p-2"><div className="font-bold text-slate-700">{m.item}</div><div className="text-xs text-gray-500">{m.quantity}</div><div className="md:hidden text-xs text-indigo-500 mt-1">{m.orderName}</div></td>
                            <td className="p-2 hidden md:table-cell text-gray-500 text-xs">{m.orderName}</td>
                            <td className="p-2 text-right">
                                {m.status === 'ì œì‘ì™„ë£Œ' && (
                                <button onClick={async () => {
                                    const order = orders.find(o => o.id === m.orderId);
                                    if (order) {
                                    const updated = order.materials.map(x => x.id === m.id ? { ...x, status: 'ì…ê³ ì™„ë£Œ' } : x);
                                    await onUpdateOrder({ ...order, materials: updated });
                                    }
                                }} className="bg-green-500 text-white px-2 py-1 rounded text-xs font-bold inline-flex items-center gap-1 hover:bg-green-600">
                                    <CheckCircle2 size={12} /> íšŒìˆ˜
                                </button>
                                )}
                            </td>
                            </tr>
                        )) : isCustomMode ? (
                            <tr><td colSpan="4" className="p-4 text-center text-gray-400">ë“±ë¡ëœ ìì¬ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ìƒˆë¡œ ë“±ë¡í•´ë³´ì„¸ìš”!</td></tr>
                        ) : null}
                        </tbody>
                        </table>
                    </div>
                    </> : <div className="flex h-full items-center justify-center text-gray-400">ì¢Œì¸¡ì—ì„œ ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ê±°ë‚˜ 'ì§ì ‘ ì…ë ¥'ì„ ëˆ„ë¥´ì„¸ìš”.</div>}
                </div>
                </div>
            );
        };

        const CalendarView = ({ orders, onSelect }) => {
            const [date, setDate] = useState(new Date());
            const days = [];
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < firstDay; i++) days.push(null);
            for (let i = 1; i <= lastDate; i++) days.push(new Date(year, month, i));

            return (
                <div className="h-full flex flex-col animate-fade-in pb-10">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-2xl font-bold">{year}ë…„ {month + 1}ì›”</h2>
                    <div className="flex gap-2">
                    <button onClick={() => setDate(new Date(year, month - 1, 1))} className="p-1 hover:bg-slate-200 rounded"><ChevronLeft /></button>
                    <button onClick={() => setDate(new Date())} className="text-sm border px-2 rounded hover:bg-slate-50">ì˜¤ëŠ˜</button>
                    <button onClick={() => setDate(new Date(year, month + 1, 1))} className="p-1 hover:bg-slate-200 rounded"><ChevronRight /></button>
                    </div>
                </div>
                <div className="flex-1 bg-white border rounded-xl overflow-hidden flex flex-col shadow-sm">
                    <div className="grid grid-cols-7 bg-slate-50 border-b text-center py-2 font-bold text-slate-600 text-sm">
                    <div className="text-red-500">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div className="text-blue-500">í† </div>
                    </div>
                    <div className="flex-1 grid grid-cols-7 grid-rows-5">
                    {days.map((d, i) => {
                        if (!d) return <div key={i} className="bg-slate-50 border-r border-b"></div>;
                        const dateStr = d.toISOString().split('T')[0];
                        const events = orders.filter(o => o.deliveryDate === dateStr);
                        const isToday = dateStr === new Date().toISOString().split('T')[0];
                        return (
                        <div key={i} className={`border-r border-b p-1 bg-white min-h-[60px] flex flex-col ${isToday ? 'bg-blue-50' : ''}`}>
                            <div className={`text-xs font-bold mb-1 text-center ${isToday ? 'text-blue-600' : 'text-gray-500'}`}>{d.getDate()}</div>
                            <div className="space-y-1 overflow-y-auto flex-1 no-scrollbar">
                            {events.map(ev => (
                                <div key={ev.id} onClick={() => onSelect(ev)} className="text-[10px] p-1 bg-red-50 text-red-800 border-l-2 border-red-500 truncate cursor-pointer rounded hover:opacity-80">
                                {ev.itemName}
                                </div>
                            ))}
                            </div>
                        </div>
                        )
                    })}
                    </div>
                </div>
                </div>
            )
        };

        // --- Main App Component ---

        function App() {
            const [user, setUser] = useState(null);
            const [orders, setOrders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isOnline, setIsOnline] = useState(false);
            
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);

            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [showNotiPanel, setShowNotiPanel] = useState(false);

            // Firebase Initialization
            const { auth, db, appId } = useMemo(() => {
                try {
                    const app = initializeApp(firebaseConfig);
                    return { 
                        auth: getAuth(app), 
                        db: getFirestore(app), 
                        appId: firebaseConfig.appId 
                    };
                } catch (e) { 
                    console.error("Firebase Init Error:", e);
                    return { auth: null, db: null, appId: null }; 
                }
            }, []);

            // Auth & Data Loading Logic (ìˆ˜ì •ë¨: ì‹¤íŒ¨ ì‹œì—ë„ ë¡œë”© í•´ì œ)
            useEffect(() => {
                let unsubAuth = null;
                let unsubData = null;

                const init = async () => {
                    if (!auth) {
                        // Firebaseê°€ ì—†ìœ¼ë©´ Mock Data ì‚¬ìš©
                        setOrders(MOCK_DATA);
                        setLoading(false);
                        return;
                    }

                    try {
                        // ë¡œê·¸ì¸ ì‹œë„
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨ (ì•„ë§ˆë„ ë„ë©”ì¸ ë¬¸ì œ):", error);
                        // ë¡œê·¸ì¸ì´ ì‹¤íŒ¨í•´ë„ ì•±ì´ ë©ˆì¶”ì§€ ì•Šë„ë¡ Mock Data ë¡œë“œ + ë¡œë”© í•´ì œ
                        setOrders(MOCK_DATA);
                        setLoading(false);
                        return;
                    }

                    // ì¸ì¦ ìƒíƒœ ê°ì§€
                    unsubAuth = onAuthStateChanged(auth, (u) => {
                        setUser(u);
                        if (!u) {
                             // ìœ ì €ê°€ ì—†ìœ¼ë©´ ë¡œë”© í•´ì œ (ì˜¤í”„ë¼ì¸ ëª¨ë“œ)
                             setOrders(MOCK_DATA);
                             setLoading(false);
                        }
                    });
                };

                init();

                return () => {
                    if (unsubAuth) unsubAuth();
                    if (unsubData) unsubData();
                }
            }, [auth]);

            // ìœ ì €ê°€ ë¡œê·¸ì¸ ëœ í›„ì—ë§Œ ì‹¤í–‰ë˜ëŠ” ë°ì´í„° ë¦¬ìŠ¤ë„ˆ
            useEffect(() => {
                if (!user || !db) return;

                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderBy('createdAt', 'desc'));
                
                const unsub = onSnapshot(q, (snap) => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setOrders(data.length > 0 ? data : MOCK_DATA);
                    setIsOnline(true); // ë°ì´í„° ìˆ˜ì‹  ì„±ê³µ -> ì˜¨ë¼ì¸
                    setLoading(false);
                }, (err) => {
                    console.warn("ë°ì´í„° ìˆ˜ì‹  ì‹¤íŒ¨:", err);
                    setIsOnline(false); // ì‹¤íŒ¨ -> ì˜¤í”„ë¼ì¸
                    setOrders(MOCK_DATA); // ì‹¤íŒ¨ì‹œ Mock Data
                    setLoading(false); // ë¡œë”©ì€ ë°˜ë“œì‹œ ëë‚´ì•¼ í•¨
                });

                return () => unsub();
            }, [user, db, appId]);

            const handleLogin = (role) => {
                setIsAuthenticated(true);
                setIsAdmin(role === 'admin');
            };

            const saveOrder = async (data) => {
                if (!isOnline || !db) {
                    // ì˜¤í”„ë¼ì¸ ìƒíƒœì¼ ë•Œ ë¡œì»¬ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸
                    alert("í˜„ì¬ ì˜¤í”„ë¼ì¸(ë˜ëŠ” ë°ëª¨) ëª¨ë“œì…ë‹ˆë‹¤. ë°ì´í„°ê°€ ì„œë²„ì— ì €ì¥ë˜ì§€ ì•Šê³  ì„ì‹œë¡œë§Œ ë³´ì…ë‹ˆë‹¤.");
                    if(data.id && !data.id.startsWith('mock')) setOrders(orders.map(o=>o.id===data.id?data:o));
                    else setOrders([...orders, {...data, id: `mock-new-${Date.now()}`, displayId: `ORD-TEMP`, createdAt: new Date().toISOString()}]);
                    setCurrentView('list');
                    setSelectedOrder(null);
                    return;
                }
                // ì˜¨ë¼ì¸ì¼ ë•Œ
                try {
                    const col = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                    if (data.id && !data.id.startsWith('mock')) {
                        await updateDoc(doc(col, data.id), { ...data, updatedAt: serverTimestamp() });
                    } else {
                        const { id, ...rest } = data; 
                        const displayId = `ORD-24-${Math.floor(100 + Math.random() * 900)}`;
                        await addDoc(col, { ...rest, displayId, createdAt: serverTimestamp(), userId: user?.uid });
                    }
                    setCurrentView('list');
                    setSelectedOrder(null);
                } catch (e) {
                    alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
                }
            };

            const deleteOrder = async (id) => {
                if (!db || id.startsWith('mock') || !isOnline) {
                    setOrders(orders.filter(o => o.id !== id));
                    setCurrentView('list'); 
                    return;
                }
                if(window.confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
                    setCurrentView('list');
                }
            };

            // Derived Stats
            const stats = useMemo(() => {
                return {
                    ongoing: orders.filter(o => !['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status)).length,
                    pickup: orders.reduce((acc, cur) => acc + (cur.materials || []).filter(m => m.status === 'ì œì‘ì™„ë£Œ').length, 0),
                    urgent: orders.filter(o => o.deliveryDate && !['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status) && Math.ceil((new Date(o.deliveryDate) - new Date()) / 86400000) <= 2).length,
                    completed: orders.filter(o => ['ë‚©í’ˆì™„ë£Œ', 'ì™„ë£Œëœ ì‘ì—…'].includes(o.status)).length
                };
            }, [orders]);

            const suppliers = useMemo(() => {
                const s = {};
                orders.forEach(o => (o.materials || []).forEach(m => {
                    if (!s[m.supplier]) s[m.supplier] = [];
                    s[m.supplier].push({ ...m, orderId: o.id, orderName: o.itemName });
                }));
                return s;
            }, [orders]);

            const handleNavigate = (order) => {
                setSelectedOrder(order);
                setCurrentView('detail');
            };

            if (!isAuthenticated) return <LoginView onLogin={handleLogin} />;
            
            // ë¡œë”© ì¤‘ í™”ë©´
            if (loading) return (
                <div className="flex h-screen items-center justify-center bg-slate-100 flex-col gap-4">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-slate-800"></div>
                    <p className="text-slate-500 text-sm animate-pulse">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            );

            return (
                <div className="flex h-screen bg-slate-100 font-sans text-slate-800 overflow-hidden">
                    <div className="w-16 md:w-60 bg-slate-900 text-slate-300 flex flex-col flex-shrink-0">
                        <div className="p-4 flex items-center gap-3 justify-center md:justify-start font-bold text-xl text-white"><div className="bg-white text-slate-900 rounded px-1">BK</div><span className="hidden md:block">Manager</span></div>
                        <nav className="flex-1 p-2 space-y-2">
                            {[
                                { id: 'dashboard', icon: LayoutDashboard, label: 'í˜„í™©' },
                                { id: 'calendar', icon: CalendarIcon, label: 'ì¼ì •' },
                                { id: 'list', icon: FileText, label: 'ì‘ì—…' },
                                { id: 'materials', icon: Truck, label: 'ë°œì£¼' },
                            ].map(m => (
                                <button key={m.id} onClick={() => { setCurrentView(m.id); setSelectedOrder(null); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded ${currentView === m.id ? 'bg-indigo-600 text-white' : 'hover:bg-slate-800'}`}>
                                    <m.icon size={20} /><span className="hidden md:block">{m.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 text-xs text-slate-500 text-center md:text-left">
                            {isAdmin ? 'Admin Mode' : 'Employee Mode'}
                            <div className={`mt-1 flex items-center gap-1 justify-center md:justify-start ${isOnline ? 'text-green-500' : 'text-red-500'}`}>
                                <Wifi size={10}/> {isOnline ? 'Online' : 'Offline (Demo)'}
                            </div>
                        </div>
                    </div>

                    <main className="flex-1 flex flex-col overflow-hidden relative bg-slate-100">
                        <header className="h-14 md:h-16 bg-white border-b flex items-center justify-between px-4 md:px-6 shadow-sm flex-shrink-0">
                            <h2 className="font-bold text-lg md:text-xl uppercase text-slate-800">
                                {currentView === 'dashboard' && 'í˜„í™©'}
                                {currentView === 'calendar' && 'ì¼ì •'}
                                {currentView === 'list' && 'ì‘ì—…'}
                                {currentView === 'materials' && 'ë°œì£¼'}
                                {currentView === 'detail' && 'ì‘ì—… ìƒì„¸'}
                                {currentView === 'form' && (selectedOrder ? 'ì‘ì—… ìˆ˜ì •' : 'ìƒˆ ì‘ì—… ë“±ë¡')}
                            </h2>
                        </header>

                        <div className="h-full overflow-y-auto p-4 md:p-6">
                            <div className="max-w-5xl mx-auto">
                                {currentView === 'dashboard' && <Dashboard orders={orders} stats={stats} suppliers={suppliers} onNavigate={handleNavigate} isAdmin={isAdmin} currentUserId={user?.uid} />}
                                {currentView === 'calendar' && <CalendarView orders={orders} onSelect={handleNavigate} />}
                                {currentView === 'list' && !selectedOrder && <ListView orders={orders} onSelect={handleNavigate} onAdd={() => { setSelectedOrder(null); setCurrentView('form'); }} />}
                                {currentView === 'detail' && <DetailView order={selectedOrder} onBack={() => { setSelectedOrder(null); setCurrentView('list'); }} onUpdate={(data, view) => { if(view) setCurrentView(view); else saveOrder(data); }} isAdmin={isAdmin} currentUserId={user?.uid} />}
                                {currentView === 'form' && <FormView order={selectedOrder} onSave={saveOrder} onDelete={deleteOrder} onCancel={() => { setSelectedOrder(null); setCurrentView('list'); }} isAdmin={isAdmin} currentUserId={user?.uid} />}
                                {currentView === 'materials' && <MaterialManageView suppliers={suppliers} orders={orders} onUpdateOrder={saveOrder} />}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
